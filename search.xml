<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>Consolidating the foundation of Linux, linux tips</title>
      <link href="2020/11/25/Linux/Consolidating-the-foundation-of-Linux-linux-tips/"/>
      <url>2020/11/25/Linux/Consolidating-the-foundation-of-Linux-linux-tips/</url>
      
        <content type="html"><![CDATA[<h1 id="Linux-Tips"><a href="#Linux-Tips" class="headerlink" title="Linux Tips"></a>Linux Tips</h1><p>Record the commands that I use more frequently in the form of a memo, and will continue to increase according to usage in the future.</p><a id="more"></a><table><thead><tr><th>#</th><th>Commands</th><th>Comment</th></tr></thead><tbody><tr><td><strong>Basis:</strong></td><td></td><td></td></tr><tr><td></td><td><code>apt update</code></td><td></td></tr><tr><td></td><td><code>apt upgrade</code></td><td></td></tr><tr><td></td><td><code>apt autoremove</code></td><td></td></tr><tr><td></td><td><code>apt install update-manager-core</code></td><td></td></tr><tr><td></td><td><code>do-release-upgrade</code></td><td></td></tr><tr><td></td><td><code>flameshot``flameshot gui</code></td><td>Capture screen</td></tr><tr><td></td><td><code>Ctrl + Alt + F1/../F7</code></td><td>Enter or quit terminal</td></tr><tr><td></td><td><code>killall &lt;nautilus&gt;</code></td><td>Kill file manager</td></tr><tr><td></td><td><code>pkill Xorg</code>, <code>restart lightdm</code></td><td>Log out</td></tr><tr><td>1</td><td><code>ls -alrRt</code></td><td><code>-r</code>: reverse, <code>-R</code>: Recursive</td></tr><tr><td></td><td><code>cp -ar(R)pv</code></td><td><code>-p</code> keep mode,ownership,timestamps; <code>-r</code> equals <code>-R</code></td></tr><tr><td></td><td><code>tail -nf</code></td><td>Output the last n line appended data as the file grows</td></tr><tr><td></td><td><code>more/less</code></td><td>File perusal filter for crt viewing, <code>less</code> opposite of more</td></tr><tr><td></td><td><code>wc</code></td><td>Print newline, word, and byte couts for each file,<code>-l</code> line</td></tr><tr><td></td><td><code>tar -czf/cjf</code></td><td><code>-j</code> bzip2, .tar.bz2, max compression; <code>-z</code> gzip, tar.gz</td></tr><tr><td></td><td><code>$(date &quot;+%Y%m%d-%H%M%S&quot;)</code></td><td>Get the current system time</td></tr><tr><td></td><td><code>sshfs user@ip:/dir name</code></td><td>mount sshfs</td></tr><tr><td></td><td><code>fuser mount -u name</code></td><td>unmount sshfs <name>, <code> umount -l name</code> for busy error</td></tr><tr><td><strong>Supper Mode</strong></td><td></td><td></td></tr><tr><td></td><td><code>find . -type f -exec cat &#123;&#125; +</code></td><td><code>find</code> and <code>cat</code> flies recursively</td></tr><tr><td></td><td><code>find . -type f -exec ls &#123;&#125; +</code></td><td><code>find . type f -exec ls &#123;&#125; \;</code></td></tr><tr><td></td><td><code>find ./ -type f -exec sed -i &#39;s/old/new/g&#39; &#123;&#125; \;</code></td><td>Replace all old in the current directory with new</td></tr><tr><td><strong>Performance:</strong></td><td></td><td></td></tr><tr><td></td><td><code>swapon --show</code></td><td>Check swap space</td></tr><tr><td></td><td><code>swapoff -a</code><br/><code>dd if=/dev/zero of=/swapfile bs=1G count=8</code><br/><code>mkswap /swapfile</code><br/><code>swapon /swapfile</code><br/><code>grep SwapTotal /proc/meminfo</code></td><td>Extend swap space to 8G</td></tr><tr><td></td><td><code>free -h</code></td><td></td></tr><tr><td></td><td><code>top</code>,<code>htop</code></td><td>Interactive process viewer</td></tr><tr><td></td><td><code>vmstat</code></td><td>Report virtual memory statistics</td></tr><tr><td></td><td><code>pmap</code></td><td>Report memory map of a process</td></tr><tr><td></td><td><code>kmemleak</code></td><td>Embeded memeory analysis tool</td></tr><tr><td><strong>Directory:</strong></td><td></td><td></td></tr><tr><td></td><td><code>/var/cache/apt/archives/</code></td><td>All archived debs</td></tr><tr><td></td><td><code>hexedit</code>,<code>hex</code></td><td>Hexdump</td></tr><tr><td></td><td><code>xxd</code></td><td>Make a hexdump or do the reverse</td></tr><tr><td></td><td><code>strings -a</code></td><td><code>-a</code> Scan the whole file</td></tr><tr><td></td><td><code>cpio -if</code></td><td>Copy files to and from archives</td></tr><tr><td><strong>Other</strong></td><td></td><td></td></tr><tr><td></td><td><code>addgroup lee vboxusers</code></td><td>Make virtual box recognize USB</td></tr><tr><td></td><td><code>*/?/[xyz]/[^xyz]/[!xyz]/[a~z]</code></td><td>Regular expression</td></tr><tr><td></td><td><code>make &gt; /dev/null</code></td><td></td></tr><tr><td></td><td>`while true; do adb shell cat /proc/interrupts</td><td>grep kgsl; sleep 0.5; done`</td></tr><tr><td></td><td><code>adb shell cd sdcard nohup watch -n 5 &#39;cat /sys/bus/cpu/devices/cpu0/online &gt;&gt; online.log&#39; &amp;</code></td><td></td></tr><tr><td></td><td><code>readelf -h vmlinux</code></td><td></td></tr><tr><td></td><td><code>nm</code></td><td>List symbols from object files， `nm -n vmlinux</td></tr><tr><td></td><td><code>ldd</code></td><td>Print shared object dependencies, list dynamic dependencies, likes xxx.so</td></tr><tr><td></td><td><code>objdump</code></td><td>Display information from object files, disassembler</td></tr><tr><td></td><td><code>ndisasm -u</code></td><td>The Netwide Disassembler, an 80x86 binary file disassembler</td></tr><tr><td></td><td><code>c++filt</code></td><td>Demangle C++ and Java symbols</td></tr><tr><td></td><td><code>hexdump, hd</code></td><td>ASCII, decimal, hexadecimal, octal dump， <code>hexdump -s 0x18408a8 -n 1024 vmlinux</code></td></tr><tr><td></td><td><code>file</code></td><td>Determine file type, <code>file *.img, *.mbn, *.bin ...</code></td></tr><tr><td></td><td><code>readelf</code></td><td>Displays information about ELF files,`readelf -hlSVAI vmlinux</td></tr><tr><td></td><td><code>objdump</code></td><td>Display information from object(files) <code>xxx-objdump -afphG vmlinux</code></td></tr><tr><td></td><td><code>objcopy</code></td><td>Copy and tranlate objects, eg:Generate zImage with vimlinux</td></tr><tr><td></td><td><code>[android-unpackbootimg](https://github.com/anestisb/android-unpackbootimg)  -i boot.img -o boot_img/</code></td><td></td></tr><tr><td></td><td><code>python3 [extract-dtb.py](https://github.com/PabloCastellano/extract-dtb)</code> kernel</td><td>Get dts from kernel</td></tr><tr><td></td><td><code>dtc -I dtb -O dts ... -o ...</code></td><td>Disassembler</td></tr><tr><td></td><td><code>od</code></td><td>Dump files in octal and other formats</td></tr><tr><td></td><td><code>vim -b file</code> + <code>:%!xxd -u</code> + <code>:%!xxd -r</code></td><td>Edit ELF file, <code>-u</code> to hex, <code>-r</code> to binary</td></tr><tr><td></td><td><code>ltrace</code></td><td>A library call tracer</td></tr><tr><td></td><td><code>strace</code></td><td>Trace system calls and signals</td></tr><tr><td></td><td><code>gdb</code></td><td>The GNU debugger</td></tr><tr><td></td><td><code>strip</code></td><td>Discard symbols from object files</td></tr><tr><td></td><td><code>lsof</code></td><td>List open files opened by processes</td></tr><tr><td></td><td><code>fuser</code></td><td>Identify processes using files or sockets</td></tr><tr><td></td><td><code>/proc</code></td><td>Process information pseudo-filesystem</td></tr><tr><td></td><td><code>ELF</code></td><td>Format of Executable and Linking Format(ELF) files</td></tr></tbody></table>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>Consolidating the foundation of Linux, vim tips</title>
      <link href="2020/11/19/Linux/Consolidating-the-foundation-of-Linux-vim-tips/"/>
      <url>2020/11/19/Linux/Consolidating-the-foundation-of-Linux-vim-tips/</url>
      
        <content type="html"><![CDATA[<h1 id="Vim-Tips"><a href="#Vim-Tips" class="headerlink" title="Vim Tips"></a>Vim Tips</h1><p>Record my commonly used commands in the form of a memo, and will continue to increase according to usage in the future.</p><a id="more"></a><table><thead><tr><th>#</th><th>Commands</th><th>Comment</th></tr></thead><tbody><tr><td><strong>Help:</strong></td><td></td><td></td></tr><tr><td>0</td><td><code>vimtutor</code></td><td>vim tutor with shell</td></tr><tr><td>1</td><td><code>:help user-manual</code></td><td>User manual overview</td></tr><tr><td>2</td><td><code>:help usr_02.txt</code></td><td>User manual</td></tr><tr><td>3</td><td><code>:help index</code></td><td>All commands for each mode</td></tr><tr><td>4</td><td><code>:help insert-index/visual-index/...</code></td><td>All commands for insert/visual/… mode</td></tr><tr><td>5</td><td><code>:help -t</code></td><td><code>vim -t &#123;tag&#125;</code></td></tr><tr><td>6</td><td><code>:help E37</code></td><td>‘error inf E37…’ explanation</td></tr><tr><td>7</td><td><code>:help &lt;command&gt;</code></td><td>Command’s manual</td></tr><tr><td>8</td><td><code>:help w</code></td><td>Common commands</td></tr><tr><td>9</td><td><code>:help c_Ctrl-D</code></td><td>Command-line Editing commands</td></tr><tr><td>10</td><td><code>:help vimrCtrl-intro</code></td><td>vimrc introduction</td></tr><tr><td>11</td><td><code>:r $VIMRUNTIME/vimrc_example.vim</code></td><td>Read vimrc example</td></tr><tr><td>12</td><td><code>Ctrl-A</code> or <code>Tab</code></td><td>Automaticly transfer $VIMRUNTIME as <code>:r /usr/share/vim/vim80/</code></td></tr><tr><td>13</td><td><code>:help helphelp</code></td><td>Help on help files</td></tr><tr><td>14</td><td><code>help help</code></td><td>help on help commands</td></tr><tr><td><strong>Command Line Editing:</strong></td><td><code>: / ? !</code> …</td><td></td></tr><tr><td>0</td><td><code>:help ex-edit-index</code></td><td>All commands for command-line</td></tr><tr><td>1</td><td><code>/</code> <code>?</code></td><td>Forward or reverse search,  <code>n, N</code> - next/previous</td></tr><tr><td>2</td><td><code>:e &lt;path/to/file&gt;</code></td><td>Open  &lt;path/to/file&gt; ,<code>:e</code> for reloading</td></tr><tr><td>3</td><td><code>:saveas &lt;path/to/file&gt;</code></td><td>Save to &lt;path/to/file&gt;</td></tr><tr><td>4</td><td><code>:x, ZZ , :wq</code></td><td>Save and quit (:x only save if necessary)</td></tr><tr><td>5</td><td><code>:q!</code></td><td>Quit without saving, also: :qa! to quit even if there are modified hidden buffers</td></tr><tr><td>6</td><td><code>:bn/bp</code></td><td>Next/previous file buffer</td></tr><tr><td>7</td><td><code>:[%]s/old/new/[gcI]</code></td><td>Replace,<code>%</code> - whole file, <code>gc</code> globally and confirm, <code>I</code> - ?</td></tr><tr><td>8</td><td><code>:3,5s/old/new/g</code></td><td>Replace from 3 to 5 line</td></tr><tr><td>9</td><td><code>:set hls[earch]/nonhls</code></td><td>highlight all matching phrases or not</td></tr><tr><td>10</td><td><code>:set [no]ic, &#39;ignorecase&#39;</code></td><td>ignore upper/lower case when searching or not</td></tr><tr><td>11</td><td><code>\c</code></td><td>Ignore capital, likes <code>/ignor\c</code>,<code>:s/old\c/new/g</code></td></tr><tr><td>12</td><td><code>:set [no]is, &#39;incsearch&#39;</code></td><td>show partial matches for a search phrase or not</td></tr><tr><td>13</td><td><code>sp[lit] vsp</code></td><td><code>:help split</code>,Split screen horizontal or vertical</td></tr><tr><td>14</td><td><code>：vertical res/res + num</code></td><td>Set the width or height</td></tr><tr><td>15</td><td><code>Ctrl-W + Ctrl-W/HJKL</code></td><td>Move between/among splitted screens</td></tr><tr><td>16</td><td><code>Ctrl-W _</code>(resp. <code>Ctrl-W |</code>)</td><td>Maximise the size of the split (resp. vertical split)</td></tr><tr><td>17</td><td><code>Ctrl-W +</code>(resp. <code>Ctrl-W -</code>)</td><td>Grow (resp. shrink) split</td></tr><tr><td>18</td><td><code>Ctrl-W =</code></td><td>Evenly allocate size</td></tr><tr><td>19</td><td><code>:set [no]scb, &#39;scrollbind&#39;</code></td><td>Sync the screens which this option is set</td></tr><tr><td>20</td><td><code>:Ctrl-D</code></td><td>Show a list of commands</td></tr><tr><td>21</td><td><code>&lt;TAB&gt;</code></td><td>Complete , likes <code>:edi[t]</code>,<code>:!fin[d]</code> and others. like name</td></tr><tr><td>22</td><td><code>:set showmode</code></td><td>Tell you which mode you are on the last line</td></tr><tr><td>23</td><td><code>:r !ls</code></td><td>Put ls’s output below the cursor</td></tr><tr><td>24</td><td><code>:r &lt;file&gt;</code></td><td>Put the contents of file below the cursor</td></tr><tr><td>25</td><td><code>:map Y y$</code></td><td>Map <code>Y</code> command yank to the end of line, map shortcut</td></tr><tr><td>26</td><td><code>:set [no]nu[mber]</code></td><td>Hider/display line number</td></tr><tr><td>27</td><td><code>:set mouse=[all]</code></td><td>Enable mouse usage (all modes)</td></tr><tr><td>28</td><td><code>:se[t]</code></td><td>Show all options that differ from their default value</td></tr><tr><td>29</td><td><code>:se[t] all</code></td><td>Show all but terminal options.</td></tr><tr><td><strong>Normal Mode:</strong></td><td><code>ESC Ctrl-[  Ctrl-C</code>…</td><td>Back to Normal Mode</td></tr><tr><td>0</td><td><code>:help normal-index</code></td><td>All commands for normal mode</td></tr><tr><td>1</td><td><code>[n]command</code></td><td>Excute n times command, likes <code>10itest</code>, insert 10 test</td></tr><tr><td>2</td><td><code>Ctrl-D/Ctrl-U</code>,<code>hjkl</code></td><td>Move down or up,…</td></tr><tr><td>3</td><td><code>0,^,$,g_</code></td><td>Go to the first/last column or non-blank character</td></tr><tr><td>4</td><td><code>[N]G, :N</code></td><td>Go to line N</td></tr><tr><td>5</td><td><code>gg</code>,<code>G</code></td><td>Go to the start of the file, to last line</td></tr><tr><td>6</td><td><code>w, e , b</code> <code>2w,3e</code></td><td>Go to the start/end of next word, start of previous word</td></tr><tr><td>7</td><td><code>W,E,B</code></td><td>Go to the start/end of next/previous Group</td></tr><tr><td>8</td><td><code>fa/F</code>,<code>,</code> <code>;</code></td><td>Go to next/previous ‘a’ on the line,<code>3fa</code> go to 3rd ‘a’, <code>,</code> <code>;</code> next/previous</td></tr><tr><td>9</td><td><code>t,/T</code> <code>,</code> <code>;</code></td><td>Go to before/after <code>,</code>, <code>,</code> <code>;</code> next/previous</td></tr><tr><td>10</td><td><code>%</code></td><td>Go to next corresponding item, likes <code>([&#123;&#125;],#ifdef/#endif</code>)</td></tr><tr><td>11</td><td><code>*,#</code></td><td>Go to next/previous occurence of the word, <code>:set hls</code> will highlight them</td></tr><tr><td>12</td><td><code>x</code>,<code>J</code></td><td>Delete char, rm line break</td></tr><tr><td>13</td><td><code>Ctrl-A</code></td><td>Increment the number</td></tr><tr><td>14</td><td><code>U/u</code>,<code>Ctrl-R</code></td><td>Undo all latest changes on one line or undo one changes, redo changes</td></tr><tr><td>15</td><td><code>Ctrl-O</code>,<code>Ctrl-I</code></td><td>Go to older/newer cursor possitons,support switching files</td></tr><tr><td>16</td><td><code>Ctrl-]</code></td><td>jumps to the location of the tag given by the word under the cursor</td></tr><tr><td>17</td><td><code>Ctrl-T</code></td><td>(pop tag) takes you back to the preceding position</td></tr><tr><td>18</td><td><code>Ctrl-G</code></td><td>Prints the current file name, the cursor position, etc.</td></tr><tr><td>19</td><td><code>Te(gt gT),Ve[!],He[!]</code></td><td>Create a Tab/Vertical/Horizontal page, gt/gT - next/previous, <code>!</code> -&gt; switch split place</td></tr><tr><td><strong>EX commands:</strong></td><td></td><td></td></tr><tr><td>0</td><td><code>:help ex-cmd-index</code></td><td>All commands for ex-cmd</td></tr><tr><td>1</td><td><code>man vim</code></td><td></td></tr><tr><td>2</td><td><code>:!&lt;command&gt;</code> <code>:！which shutdown</code></td><td>Excute shell command</td></tr><tr><td>3</td><td><code>Ctrl-Z</code> <code>fg</code></td><td>Pause vim, back to vim</td></tr><tr><td>4</td><td><code>vim -pO/o[N] files...</code></td><td>Open N/one(when N is omitted) tab page for each file,<code>o</code> Horizontal, <code>O</code>-Vertical</td></tr><tr><td>5</td><td><code>vim -n</code></td><td>No swap file will be used</td></tr><tr><td>6</td><td><code>Ctrl-Shift-C</code>,<code>Ctrl-Shift-V</code></td><td>Copy and Paste, supports outside of vim</td></tr><tr><td><strong>Insert Mode:</strong></td><td><code>a i r s</code> …</td><td>Enter Insert Mode</td></tr><tr><td>0</td><td><code>:help insert-index</code></td><td>All commands for insert mode</td></tr><tr><td>1</td><td><code>r,R gR</code></td><td>Replace mode,<code>gR</code>:visual mode replace</td></tr><tr><td>2</td><td><code>Ctrl-N, Ctrl-P</code></td><td>Completion,complete the word from start of word</td></tr><tr><td><strong>Visual Mode:</strong></td><td><code>v V Ctrl-V Ctrl-Q</code> …</td><td>Enter visual Mode, CTRL-Q insteads Ctrl-V(used to paste) in Insert and Command-line mode.</td></tr><tr><td>0</td><td><code>:help visual-index</code></td><td>All commands for visual mode</td></tr><tr><td>1</td><td><code>v/V/Ctrl-V</code></td><td>Select char/line/block</td></tr><tr><td>2</td><td><code>Ctrl-V</code> + <code>Shift-I</code> + <code>ESC</code></td><td>Add same content at beginning of all lines of block</td></tr><tr><td>3</td><td><code>Ctrl-V</code> + [<code>$</code>] + <code>Shift-A</code> + <code>ESC</code></td><td>Add same content at the end of block[or all lines]</td></tr><tr><td>4</td><td><code>y</code>,<code>d</code>…</td><td>Yank,delete selected content in visual mode</td></tr><tr><td>5</td><td><code>Y ,yy</code></td><td>Yank the current line</td></tr><tr><td>6</td><td><code>J</code></td><td>Join all lines together</td></tr><tr><td>7</td><td><code>&lt;</code>, <code>&gt;</code></td><td>Indent to the left, to the right</td></tr><tr><td>8</td><td><code>=</code></td><td>Auto indent</td></tr><tr><td><strong>Op pending Mode</strong></td><td><code>c d y &lt; &gt;</code> …</td><td></td></tr><tr><td>1</td><td><code>c[N]&#123;motion&#125; c2w,ce,c$</code></td><td>Delete motion text and start insert</td></tr><tr><td>2</td><td><code>y,d&#123;motion&#125; y$,d$,dt&#123;?&#125;</code>, <code>Np</code></td><td>Yank/Delete {motion} text, paste N times</td></tr><tr><td>3</td><td><code>y</code>,<code>d</code>…</td><td>Yank,delete the selected content</td></tr><tr><td>4</td><td><code>Y ,yy</code></td><td>Yank the current line</td></tr><tr><td>5</td><td><code>yl</code></td><td>Yanks a letter</td></tr><tr><td>6</td><td><code>yaw</code></td><td>Yanks a word</td></tr><tr><td>7</td><td><code>yas</code></td><td>Yanks a sentence</td></tr><tr><td>8</td><td><code>yi(</code></td><td>Yanks everything within ( and so on…</td></tr><tr><td>9</td><td><code>p</code></td><td>pastes something after the cursor</td></tr><tr><td>10</td><td><code>P</code></td><td>pastes something before the cursor</td></tr><tr><td>11</td><td><code>gp</code></td><td>same as p but puts the cursor after the pasted selection</td></tr><tr><td>12</td><td><code>gP</code></td><td>same as P and puts the cursor after the pasted selection</td></tr><tr><td>13</td><td><code>&lt;, &gt;</code></td><td>Undent and indent</td></tr><tr><td><strong>Supper Mode</strong></td><td></td><td></td></tr><tr><td>0</td><td><code>v</code>+<code>:</code>-&gt;<code>:&#39;&lt;,&#39;&gt;w flie</code></td><td>Save selected content in a new file</td></tr><tr><td>1</td><td><code>./N.</code></td><td>Repeat one/N times the last cmd</td></tr><tr><td>2</td><td><code>N&lt;command&gt;</code></td><td>Repeat the command N times,likes <code>2dd,3p</code></td></tr><tr><td>3</td><td><code>100icontent</code></td><td>Write 100 times <code>content</code>,<code>.</code>-&gt;100 times again, <code>3.</code>-&gt;3 times, not 300</td></tr><tr><td>4</td><td><code>&lt;start position&gt;&lt;command&gt;&lt;end position&gt;</code></td><td>Command from start positon to end position,<code>y,v (visual select), gU (uppercase), gu (lowercase) ...</code></td></tr><tr><td>5</td><td><code>0y$</code></td><td>Yank from beginning to end of this line</td></tr><tr><td>6</td><td><code>ye</code></td><td>Yank from here to end of word</td></tr><tr><td>7</td><td><code>y2/foo</code></td><td>Yank up to second foo</td></tr><tr><td>8</td><td><code>&lt;action&gt;a/i&lt;object&gt;</code></td><td>Only be used after an operator in visual mode,action:<code>y,d,v...</code>, object:<code>w,W,s,p,&quot;,&#39;,),&#125;,]</code></td></tr><tr><td>9</td><td><code>vis</code></td><td>Select the current sentence</td></tr><tr><td>10</td><td><code>vip</code></td><td>Select the current paragraph</td></tr><tr><td></td><td><strong>Suppose the cursor is on the first <code>o</code> of <code>(map (+) (&quot;foo&quot;))</code></strong></td><td></td></tr><tr><td>11</td><td><code>vi&quot;</code></td><td>Select <code>foo</code></td></tr><tr><td>12</td><td><code>va&quot;</code></td><td>Select <code>&quot;foo&quot;</code></td></tr><tr><td>13</td><td><code>vi)</code></td><td>Select <code>&quot;foo&quot;</code></td></tr><tr><td>14</td><td><code>va)</code></td><td>Select <code>(&quot;foo&quot;)</code></td></tr><tr><td>15</td><td><code>v2i)</code></td><td>Select <code>map (+) (&quot;foo&quot;)</code></td></tr><tr><td>16</td><td><code>v2a)</code></td><td>Select <code>(map (+) (&quot;foo&quot;))</code></td></tr><tr><td>17</td><td><code>:[n]cnext</code></td><td>To go to the [n] next one error</td></tr><tr><td>18</td><td><code>:copen </code></td><td>All matches are available in the quickfix window which can be opened</td></tr><tr><td></td><td><strong>Register</strong></td><td></td></tr><tr><td>19</td><td><code>qa,@a</code></td><td>Start recording your actions in a register, replay the action,</td></tr><tr><td>20</td><td><code>@@</code></td><td>A shortcut to replay the last executed macro</td></tr><tr><td>21</td><td><code>&quot;kyy</code></td><td>Copy the current line into k register</td></tr><tr><td>22</td><td><code>&quot;Kyy</code></td><td>Append the current line into  k register</td></tr><tr><td>23</td><td><code>&quot;kp</code></td><td>Paste k regiser</td></tr><tr><td>24</td><td><code>&quot;+p</code></td><td>Paste from system clipboard on Linux</td></tr><tr><td>25</td><td><code>&quot;*p</code></td><td>To paste from system clipboard on Windows (or from “mouse highlight” clipboard on Linux)</td></tr><tr><td>26</td><td><code>:reg</code></td><td>To access all currently defined registers type</td></tr><tr><td></td><td><strong>Suppose on a line containing only the number 1</strong></td><td></td></tr><tr><td>27</td><td><code>qaYp&lt;Ctrl-A&gt;q</code></td><td><code>qa</code> Start recording <code>Yp</code> duplicate this line <code>Ctrl-A</code> increment the number <code>q</code> stop recording</td></tr><tr><td>28</td><td><code>@a</code></td><td>Write 2 under the 1</td></tr><tr><td>29</td><td><code>@@</code></td><td>Write 3 under the 2</td></tr><tr><td>30</td><td><code>100@@</code></td><td>Create a list of increasing numbers until 103</td></tr><tr><td>31</td><td><strong>Global:</strong></td><td><code>:g</code>:<code>%</code></td></tr><tr><td>32</td><td><code>ggvG$</code></td><td>Select all content</td></tr><tr><td>33</td><td><code>:%d</code></td><td>delete every line</td></tr><tr><td>34</td><td><code>:%y</code></td><td>yank every line</td></tr><tr><td>35</td><td><code>:%normal! &gt;&gt;</code></td><td>indent every line</td></tr><tr><td>36</td><td><code>:g/^/d</code></td><td>delete every line</td></tr><tr><td>37</td><td><code>:g/^/y</code></td><td>yank every line</td></tr><tr><td>38</td><td><code>:g/^/normal! &gt;&gt;</code></td><td>indent every line</td></tr></tbody></table><!--more--><h1 id="Vim-cheat-sheet-for-programmers"><a href="#Vim-cheat-sheet-for-programmers" class="headerlink" title="Vim cheat sheet for programmers"></a>Vim cheat sheet for programmers</h1><p><img src="https://andylee-1258982386.cos.ap-chengdu.myqcloud.com/linux/vim/vim_cheat_sheet_for_programmers_print.png" alt="vim_cheat_sheet_for_programmers_print"></p><h1 id="Vim-common-cheat-sheet"><a href="#Vim-common-cheat-sheet" class="headerlink" title="Vim common cheat sheet"></a>Vim common cheat sheet</h1><p><img src="https://andylee-1258982386.cos.ap-chengdu.myqcloud.com/linux/vim/vi-vim-cheat-sheet.gif" alt="vi-vim-cheat-sheet"></p>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Tools </tag>
            
            <tag> Vim </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>How to develop and debug kernel?</title>
      <link href="2020/11/16/Linux/How-to-develop-and-debug-kernel/"/>
      <url>2020/11/16/Linux/How-to-develop-and-debug-kernel/</url>
      
        <content type="html"><![CDATA[<blockquote><p>此篇文章是基于高通 ODM BSP 开发做的一个简单总结，起初是用来对新人进行培训的。</p></blockquote><p>我觉得学习内核驱动时，最开始只需要 ‘Know what, not know how ’。 不用去探究细节，只需要知道整体的框架，知道有哪些需要我们重视的内容即可。</p><h1 id="何为-Linux-内核开发？"><a href="#何为-Linux-内核开发？" class="headerlink" title="何为 Linux 内核开发？"></a>何为 Linux 内核开发？</h1><h2 id="首先，初步认识下-Linux-kernel"><a href="#首先，初步认识下-Linux-kernel" class="headerlink" title="首先，初步认识下 Linux kernel"></a>首先，初步认识下 Linux kernel</h2><p><img src="https://andylee-1258982386.cos.ap-chengdu.myqcloud.com/linux/linux_intro.png" alt="linux_intro"></p><ul><li>Linux 内核的框架如上图。</li><li>设备子系统负责和硬件打交道。</li><li>大部分工作集中在设备子系统部分。</li></ul><a id="more"></a><h2 id="内核开发是什么？"><a href="#内核开发是什么？" class="headerlink" title="内核开发是什么？"></a>内核开发是什么？</h2><ul><li>广义上讲，新增或修改上图中内核部分的所有子系统。</li><li>非 Linux 源码贡献者，一般来说只修改设备子系统部分。</li></ul><p>接下来，简单聊聊初学者需要重点关注的三个部分：设备树，字符设备，平台设备驱动。</p><h2 id="设备树（DTS）"><a href="#设备树（DTS）" class="headerlink" title="设备树（DTS）"></a>设备树（DTS）</h2><p>设备树相当于一份软件中描述硬件结构的配置框图。假设下图为硬件框图：<br><img src="https://andylee-1258982386.cos.ap-chengdu.myqcloud.com/linux/dts_hw.png" alt="dts_hw"> </p><p>那么其软件描述的代码片段如下：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">/ &#123; <span class="comment">// root node</span></span><br><span class="line">    model = <span class="string">&quot;Qualcomm Technologies, Inc. SDM xxx&quot;</span>;</span><br><span class="line">    compatible = <span class="string">&quot;qcom,sdmxxx&quot;</span>;</span><br><span class="line">    cpus &#123;</span><br><span class="line">        ... </span><br><span class="line">        cpu@<span class="number">0</span> &#123;</span><br><span class="line">            ... </span><br><span class="line">        &#125;;</span><br><span class="line">        cpu@<span class="number">1</span> &#123;</span><br><span class="line">            ... </span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;;</span><br><span class="line">    usb@&lt;address&gt; &#123;</span><br><span class="line">        ... </span><br><span class="line">    &#125;;</span><br><span class="line">    serial@&lt;address&gt; &#123;</span><br><span class="line">        ... </span><br><span class="line">    &#125;;</span><br><span class="line">    gpio@&lt;address&gt; &#123;</span><br><span class="line">        ... </span><br><span class="line">    &#125;;</span><br><span class="line">    intc: interrupt-controller@&lt;address&gt; &#123;</span><br><span class="line">        ... </span><br><span class="line">    &#125;;</span><br><span class="line">    external-bus &#123;</span><br><span class="line">        ...</span><br><span class="line">        i2c@<span class="number">0</span>,<span class="number">0</span> &#123;</span><br><span class="line">            ... </span><br><span class="line">            xxx@&lt;address&gt; &#123; <span class="comment">// I2C Dev</span></span><br><span class="line">            .... </span><br><span class="line">            &#125;;</span><br><span class="line">        &#125;;</span><br><span class="line">        flash@<span class="number">1</span>,<span class="number">0</span> &#123;</span><br><span class="line">            ... </span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h2 id="字符设备驱动"><a href="#字符设备驱动" class="headerlink" title="字符设备驱动"></a>字符设备驱动</h2><ul><li>字符设备驱动是理解设备驱动的基础。</li><li>大多数设备都可以归于字符设备。  </li></ul><p><img src="https://andylee-1258982386.cos.ap-chengdu.myqcloud.com/linux/char_dev.png" alt="char_dev"></p><h2 id="平台设备驱动模型"><a href="#平台设备驱动模型" class="headerlink" title="平台设备驱动模型"></a>平台设备驱动模型</h2><ul><li>设备（或驱动）注册时，会通过总线去匹配对应的驱动（或设备）。</li><li>设备和驱动通常需要挂在一种实际总线上，除带有 I2C、SPI、USB 等的设备外，内核为没有实际总线的外设实现了虚拟的平台总线 。</li><li>平台设备驱动是独立于字符设备、网络设备等的一种抽象概念 。</li></ul><p><img src="https://andylee-1258982386.cos.ap-chengdu.myqcloud.com/linux/platform_dev.png" alt="platform_dev">  </p><h1 id="kernel-开发需要什么样的知识储备？"><a href="#kernel-开发需要什么样的知识储备？" class="headerlink" title="kernel 开发需要什么样的知识储备？"></a>kernel 开发需要什么样的知识储备？</h1><h2 id="C-语言"><a href="#C-语言" class="headerlink" title="C 语言"></a>C 语言</h2><p>良好的 C 语言能力， Linux 官方推荐了如下书籍。  </p><ul><li><a href="https://book.douban.com/subject/25735837/">The C Programming Language</a></li><li><a href="https://book.douban.com/subject/4743677/">Practical C Programming</a></li><li><a href="https://book.douban.com/subject/1767969/">C: A Reference Manual</a></li></ul><h2 id="GNU"><a href="#GNU" class="headerlink" title="GNU"></a>GNU</h2><p>内核由 GNU C 和 GNU toolchain 实现，所以如下两方面的知识是需要的。</p><ul><li>GNU C 的编码规则</li><li>GNU 工具链的使用</li></ul><h2 id="Linux-基本命令"><a href="#Linux-基本命令" class="headerlink" title="Linux 基本命令"></a>Linux 基本命令</h2><ul><li><a href="https://book.douban.com/subject/4889838/">鸟哥的 Linux 私房菜</a></li></ul><h2 id="设备驱动相关知识"><a href="#设备驱动相关知识" class="headerlink" title="设备驱动相关知识"></a>设备驱动相关知识</h2><ul><li><a href="https://book.douban.com/subject/1723151/">Linux 设备驱动程序</a></li></ul><h2 id="内核原理"><a href="#内核原理" class="headerlink" title="内核原理"></a>内核原理</h2><ul><li><a href="https://book.douban.com/subject/3229243/">Linux 内核完全注释</a></li><li><a href="https://book.douban.com/subject/1767120/">深入理解 Linux 内核</a></li></ul><h1 id="在我们的工作中，kernel-开发一般怎么做？"><a href="#在我们的工作中，kernel-开发一般怎么做？" class="headerlink" title="在我们的工作中，kernel 开发一般怎么做？"></a>在我们的工作中，kernel 开发一般怎么做？</h1><h2 id="Android-设备通常的开发周期"><a href="#Android-设备通常的开发周期" class="headerlink" title="Android 设备通常的开发周期"></a>Android 设备通常的开发周期</h2><p>在我们的工作中，kernel 开发主要集中在 Bringup、Integrate、Verify 三个阶段 。  </p><p><img src="https://andylee-1258982386.cos.ap-chengdu.myqcloud.com/linux/product_phase.png" alt="product_phase"></p><h2 id="源码获取"><a href="#源码获取" class="headerlink" title="源码获取"></a>源码获取</h2><ul><li>高通的代码分两部分：一部分是开源的，可以从 codeaurora.org 下载，还有一部分是高通产权的，需要从高通的网站上下载。</li><li>高通产权的代码存放路径：vendor/qcom/proprietary 。</li><li>实际工作中，SCM 一般会帮忙准备好 Base 代码。<blockquote><p>可以通过 <code>repo init -u https://android.googlesource.com/platform/manifest -b android-4.0.1_r1</code> 在 <a href="https://source.android.com/setup/build/downloading">Source.android</a> 下载 Google 官方源码。</p></blockquote></li></ul><h2 id="Bringup"><a href="#Bringup" class="headerlink" title="Bringup"></a>Bringup</h2><ul><li>根据需求实现各种外设模块的基本功能。</li><li>LCD、TP 、Sensor 、Charger 等功能正常，手机能进入 Launcher 界面，能正常使用，USB 连接正常。<br>这样 Bringup 工作就基本完成了。</li></ul><h2 id="Porting-和编写各种外设的驱动（需求的具体实现）"><a href="#Porting-和编写各种外设的驱动（需求的具体实现）" class="headerlink" title="Porting 和编写各种外设的驱动（需求的具体实现）"></a>Porting 和编写各种外设的驱动（需求的具体实现）</h2><ul><li>Porting 硬件相关配置，即实现 DTS 。</li><li>Porting 相关驱动 。</li><li>Sensor 和其他外设有一点差异 。</li><li>其分为 AP 侧驱动（厂商提供）和 ADSP 侧驱动（高通和厂商协同）两种方式 。</li><li>主要配置总线、 GPIO 及 Sensor 的属性 。</li></ul><h2 id="系统维护（解-BUG）"><a href="#系统维护（解-BUG）" class="headerlink" title="系统维护（解 BUG）"></a>系统维护（解 BUG）</h2><ul><li>对比机</li><li>阅读源码</li><li>善用调试工具</li><li><a href="https://createpoint.qti.qualcomm.com/">Createpoint</a> + <a href="https://qualcomm-cdmatech-support.my.salesforce.com/">QCOM Case</a> （<em>高通文档工具下载，及向高通在线寻求帮助。</em>）</li><li>搜索引擎</li><li>GTD （主动性）</li><li>文档（Read + Write）</li></ul><h1 id="kernel-调试的常用方式有哪些？"><a href="#kernel-调试的常用方式有哪些？" class="headerlink" title="kernel 调试的常用方式有哪些？"></a>kernel 调试的常用方式有哪些？</h1><h2 id="硬件调试"><a href="#硬件调试" class="headerlink" title="硬件调试"></a>硬件调试</h2><ul><li>示波器</li><li>程控电源</li><li>万用表</li><li>Power monitor </li></ul><h2 id="Logs"><a href="#Logs" class="headerlink" title="Logs"></a>Logs</h2><ul><li>串口日志</li><li>Logging System</li><li>logcat/kmsg… </li><li>Enhanced log</li><li>pstore</li><li>ramdump</li></ul><h2 id="Tools"><a href="#Tools" class="headerlink" title="Tools"></a>Tools</h2><ul><li>adb dumpsys</li><li>gdb</li><li>QPST</li><li>Get ramdump/adsp log/… - systrace</li><li>trace CPU/GPU/Function/Activity/… - powerTop</li><li>power consumption</li><li>kmemleak</li><li>vmstat + top/ps + pmap in android</li><li>out/soong/host/linux-x86/bin/ - simg2img/lpdump… </li><li>objdump</li></ul><h2 id="文件系统或节点"><a href="#文件系统或节点" class="headerlink" title="文件系统或节点"></a>文件系统或节点</h2><ul><li>sys</li><li>power/irq/gpio … </li><li>proc</li><li>内核信息</li><li>打印级别</li><li>dynamic debug</li><li>echo “file xxx.c +p” &gt; /sys/kernel/dynamic_debug/control</li></ul>]]></content>
      
      
      <categories>
          
          <category> Android </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>原来你是这样的 VCS！</title>
      <link href="2020/11/13/Git/vcs-repo-git/"/>
      <url>2020/11/13/Git/vcs-repo-git/</url>
      
        <content type="html"><![CDATA[<blockquote><p>本文的动态图皆来自于莉迪亚·哈莉（Lydia Hallie） 的文章 <a href="https://dev.to/lydiahallie/cs-visualized-useful-git-commands-37p1">CS Visualized: Useful Git Commands</a>。</p></blockquote><h1 id="VCS-的发展历史"><a href="#VCS-的发展历史" class="headerlink" title="VCS 的发展历史"></a>VCS 的发展历史</h1><p>首先，我们来聊聊 VCS， Version Control System， 即版本控制系统的发展历史。  </p><h2 id="Manual-VCS"><a href="#Manual-VCS" class="headerlink" title="Manual VCS"></a>Manual VCS</h2><p>最初的时候，大家都是通过复制目录来进行版本管理，如下图：  </p><p><img src="https://andylee-1258982386.cos.ap-chengdu.myqcloud.com/vcs/media/manual_vcs.png" alt="manual vcs">  </p><p>这样做的缺点显而易见：  </p><ul><li>难以维护</li><li>难以回溯</li></ul><a id="more"></a><h2 id="Central-VCS"><a href="#Central-VCS" class="headerlink" title="Central VCS"></a>Central VCS</h2><p>然后呢，就有了 svn ， 一种集中式版本控制系统，效率一下提升了很多，不过呢仍然有诸多不便，最明显的就是客户端功能较弱。  </p><p><img src="https://andylee-1258982386.cos.ap-chengdu.myqcloud.com/vcs/media/central_vcs.jpeg" alt="central_vcs"></p><ul><li>集中的版本管理服务器</li><li>支持版本管理与分支管理</li><li>客户端需要保持与服务器相连</li></ul><h2 id="Distributed-VCS"><a href="#Distributed-VCS" class="headerlink" title="Distributed VCS"></a>Distributed VCS</h2><p>再到后面，Linus 同学就出马了， 不得不说大神就是大神，一直是只能膜拜的存在， 开发了 linux 不说，觉得已有的 VCS 不好用，就自己花了一周多的时间开发了划时代的 git，一种分布式版本控制系统。  </p><p><img src="https://andylee-1258982386.cos.ap-chengdu.myqcloud.com/vcs/media/distributed_vcs.jpeg" alt="distributed_vcs"></p><ul><li>服务端和客户端都有完整的版本库</li><li>客户端可以在本地进行版本管理</li><li>能在本地进行回溯等大多数操作</li></ul><h1 id="Git-work-flow"><a href="#Git-work-flow" class="headerlink" title="Git work flow"></a>Git work flow</h1><p> 在工作流程方面来说的话， 我把 Git 看着四个层级，第一呢， working directory， 即工作区， 第二呢 staging area ，即暂存区，第三呢 local repository， 即本地仓库，第四呢，remote repository ，即远程仓库。  </p><p>当我们在本地做了修改，<code>git add</code> 之后，内容就提交到了暂存区，即 <code>index</code> 文件，<code>git commit</code> 之后呢，就提交到了本地仓库，<code>git push</code> 之后，就推到了远程仓库。  </p><p>反过来，我们可以通过 <code>git fetch/clone</code> 从远程仓库取到本地仓库，然后本地仓库的东西可以通过 <code>git reset --soft</code> 还原到暂存区，而暂存区的内容可以通过 <code>git restore --staged</code> 移交到工作区，工作区的修改我们可以通过 <code>git checkout/restore</code> 遗弃掉。  </p><p><img src="https://andylee-1258982386.cos.ap-chengdu.myqcloud.com/vcs/media/git_workflow.png" alt="git_workflow"></p><h1 id="Git-tips"><a href="#Git-tips" class="headerlink" title="Git tips"></a>Git tips</h1><p>接下来，针对我们比较常用的部分分享一些 tips。  </p><h2 id="Documentation"><a href="#Documentation" class="headerlink" title="Documentation"></a>Documentation</h2><p><a href="git-scm.com">官方文档</a>是我们第一时间应该关注的部分，可以看到上面不仅有教程，还有 cheat sheet 和视频，基本上我们想要的都可以从上面找到的。  </p><p><img src="https://andylee-1258982386.cos.ap-chengdu.myqcloud.com/vcs/media/git_official_doc.png" alt="git_official_doc"></p><h2 id="man"><a href="#man" class="headerlink" title="man"></a>man</h2><p>学过 Linux 的都应该比较熟悉这个命令，我们不可能记住所有的命令以及它们的用法，使用的时候就可以通过 <code>man</code> 命令去确认相关信息，  Git 这个文档不知道是谁写得，名字取得十分有特色：the stupid  content tracker。  </p><p><img src="https://andylee-1258982386.cos.ap-chengdu.myqcloud.com/vcs/media/man_git.png" alt="man_git"></p><p>另外一些比较常用的 help 命令：  </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">help</span>        <span class="comment"># 常用命令</span></span><br><span class="line">git <span class="built_in">help</span> -a     <span class="comment"># 所有命令</span></span><br><span class="line">git <span class="built_in">help</span> -g     <span class="comment"># 常用教程</span></span><br><span class="line"></span><br><span class="line">git &lt;<span class="built_in">command</span>&gt; --<span class="built_in">help</span></span><br><span class="line">git <span class="built_in">help</span> &lt;<span class="built_in">command</span>&gt; <span class="comment"># 指定命令</span></span><br></pre></td></tr></table></figure><h2 id="git-config"><a href="#git-config" class="headerlink" title="git config"></a>git config</h2><p><code>git config</code> 命令呢用来配置我们常用的 gitconfig 文件，分为 local，global，sytem 。  </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git config --<span class="built_in">local</span>      <span class="comment"># 当前 git 仓, .git/config</span></span><br><span class="line">git config --global     <span class="comment"># 当前用户, ~/.gitconfig</span></span><br><span class="line">git config --system     <span class="comment"># 当前电脑的所有用户, git 安装路径</span></span><br></pre></td></tr></table></figure><blockquote><p>Priority: local &gt; global &gt; system</p></blockquote><h2 id="git-log"><a href="#git-log" class="headerlink" title="git log"></a>git log</h2><p><code>git log</code> 算使用频率十分高的一个命令，用来查看提交历史。  </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">log</span> --oneline --all -n5 --graph <span class="comment"># oneline 代表单行显示， all 代表显示所有分支， graph 代表以图表展示</span></span><br><span class="line">git <span class="built_in">log</span> &lt;branch&gt;        <span class="comment"># 查看指定分支</span></span><br></pre></td></tr></table></figure><p><img src="https://andylee-1258982386.cos.ap-chengdu.myqcloud.com/vcs/media/git_log.png" alt="git_log"></p><h2 id="gitk"><a href="#gitk" class="headerlink" title="gitk"></a>gitk</h2><p>有时候用命令行的图形化查看提交历史不是那么形象，就可以通过 gitk 来直观的查看。  </p><p><img src="https://andylee-1258982386.cos.ap-chengdu.myqcloud.com/vcs/media/gitk.png" alt="gitk"></p><h2 id="git-diff"><a href="#git-diff" class="headerlink" title="git diff"></a>git diff</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">git diff [-- filename]          <span class="comment"># 比较工作区与暂存区</span></span><br><span class="line">git diff HEAD                   <span class="comment"># 比较工作区与 HEAD</span></span><br><span class="line">git diff --cached | --staged    <span class="comment"># 比较暂存区与 HEAD</span></span><br><span class="line"></span><br><span class="line">git diff HEAD HEAD~1 | HEAD^ / HEAD~2 | HEAD^^ | HEAD^2</span><br><span class="line"><span class="comment"># &#x27;^2&#x27;表示第二个父亲（譬如两个分支 merge 到一起，merged 的分支）, &#x27;~2&#x27; 表示父亲的父亲</span></span><br></pre></td></tr></table></figure><h2 id="git-checkout"><a href="#git-checkout" class="headerlink" title="git checkout"></a>git checkout</h2><p><code>git checkout</code> 呢主要就是基于当前基点创建新建一个指针，或者基于暂存区更新工作区。  </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git checkout -b &lt;branch&gt; [base SHA-1] <span class="comment"># 创建并切换分支</span></span><br><span class="line">git checkout . | [--] filename <span class="comment"># 基于暂存区更新工作区</span></span><br><span class="line">git checkout SHA-1 <span class="comment"># 以分离头指针形式切换到 SHA-1</span></span><br></pre></td></tr></table></figure><h2 id="git-merge"><a href="#git-merge" class="headerlink" title="git merge"></a>git merge</h2><h3 id="Fast-forward-–ff"><a href="#Fast-forward-–ff" class="headerlink" title="Fast-forward (–ff)"></a>Fast-forward (–ff)</h3><p><img src="https://andylee-1258982386.cos.ap-chengdu.myqcloud.com/vcs/media/git_merge_ff.GIF" alt="git_merge_ff"></p><h3 id="No-fast-foward-–no-ff"><a href="#No-fast-foward-–no-ff" class="headerlink" title="No-fast-foward (–no-ff)"></a>No-fast-foward (–no-ff)</h3><p><img src="https://andylee-1258982386.cos.ap-chengdu.myqcloud.com/vcs/media/git_merge_noff_confict.GIF" alt="git_merge_noff_confict"></p><h3 id="Merge-Conflicts"><a href="#Merge-Conflicts" class="headerlink" title="Merge Conflicts"></a>Merge Conflicts</h3><p><img src="https://andylee-1258982386.cos.ap-chengdu.myqcloud.com/vcs/media/git_merge_noff.GIF" alt="git_merge_noff"></p><h2 id="git-reset"><a href="#git-reset" class="headerlink" title="git reset"></a>git reset</h2><p>将本地仓库的 HEAD 指针指向指定的 commit。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">git reset --soft|hard|mixed &lt;commit&gt; [file]</span><br><span class="line">--soft: HEAD 指向 &lt;commit&gt;, 工作区和暂存区不变化</span><br><span class="line">--hard: 所有都指向 &lt;commit&gt;</span><br><span class="line">--mixed: 缺省值,HEAD 和暂存区指向 &lt;commit&gt;</span><br></pre></td></tr></table></figure><h3 id="git-reset-–hard"><a href="#git-reset-–hard" class="headerlink" title="git reset –hard"></a>git reset –hard</h3><p><img src="https://andylee-1258982386.cos.ap-chengdu.myqcloud.com/vcs/media/git_reset_hard.GIF" alt="git_reset_hard"></p><h3 id="git-reset-–soft"><a href="#git-reset-–soft" class="headerlink" title="git reset –soft"></a>git reset –soft</h3><p><img src="https://andylee-1258982386.cos.ap-chengdu.myqcloud.com/vcs/media/git_reset_soft.GIF" alt="git_reset_soft"></p><h2 id="git-rebase"><a href="#git-rebase" class="headerlink" title="git rebase"></a>git rebase</h2><p><code>git rebase</code> 也就是变基操作， 指定父指针进行变基，基本用法如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">git rebase [-i] start_sha-1 [end_sha-1]</span><br><span class="line"><span class="comment"># start_sha-1: 变基 commit 的父亲</span></span><br><span class="line"><span class="comment"># a. 如果有 end_sha-1, 则变基生成一个分离头指针。</span></span><br><span class="line"><span class="comment"># b. 如果没有 end_sha-1, 则先变基生成一个分离头指针,然后将HEAD 以及分支名等指向此分离头指针。</span></span><br></pre></td></tr></table></figure><p>当我们以 <code>git rebase -i</code> 的形式执行了变基操作后，就会弹出如下的交付界面，最新的 commit 列在最下面， 所有的操作，下面都有注释，个人觉得比较常用的是 <code>p, r, s,e,d</code> 这几个。  </p><p><img src="https://andylee-1258982386.cos.ap-chengdu.myqcloud.com/vcs/media/git_rebase_i.png" alt="git_rebase_i"></p><h3 id="rebase-branch"><a href="#rebase-branch" class="headerlink" title="rebase branch"></a>rebase branch</h3><p><img src="https://andylee-1258982386.cos.ap-chengdu.myqcloud.com/vcs/media/git_rebase_ff.GIF" alt="git_rebase_ff"></p><h3 id="rebase-drop"><a href="#rebase-drop" class="headerlink" title="rebase - drop"></a>rebase - drop</h3><p><img src="https://andylee-1258982386.cos.ap-chengdu.myqcloud.com/vcs/media/git_rebase_drop.GIF" alt="git_rebase_drop"></p><h3 id="rebase-squash"><a href="#rebase-squash" class="headerlink" title="rebase - squash"></a>rebase - squash</h3><p><img src="https://andylee-1258982386.cos.ap-chengdu.myqcloud.com/vcs/media/git_rebase_squash.GIF" alt="git_rebase_squash"></p><h2 id="git-stash"><a href="#git-stash" class="headerlink" title="git stash"></a>git stash</h2><p>stash 翻译过来就是存储的意思，可以理解为栈，当我们开发过程中突然插入了其他紧急情况时，可以把修改推入栈顶，完成任务后再出栈。  </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">git stash           <span class="comment"># 存储当前修改</span></span><br><span class="line">git stash list      <span class="comment"># 查看所有存储的修改</span></span><br><span class="line">git stash pop       <span class="comment"># 推出最新存储的修改</span></span><br><span class="line">git stash apply     <span class="comment"># 用最新存储的修改,但是不推出,仍然保存在栈顶</span></span><br></pre></td></tr></table></figure><h2 id="git-remote"><a href="#git-remote" class="headerlink" title="git remote"></a>git remote</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">git remote add origin remote.git        <span class="comment"># 关联远程仓库</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 指定远程分支名</span></span><br><span class="line">git branch --set-upstream-to=&lt;upstream&gt;</span><br><span class="line">git branch --track &lt;branchname&gt;</span><br><span class="line">git branch -u &lt;upstream&gt;                <span class="comment"># -u = set-upstream</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置本地分支名为远程分支名,并 push</span></span><br><span class="line">git push -u origin --all                <span class="comment"># push 所有分支</span></span><br><span class="line">git push set-upstream origin branch </span><br><span class="line"></span><br><span class="line">git pull &lt;remote&gt; &lt;branch&gt;              <span class="comment"># 指定 merge 的远程和本地分支</span></span><br></pre></td></tr></table></figure><h2 id="Search-history"><a href="#Search-history" class="headerlink" title="Search history"></a>Search history</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">log</span> --all --grep=<span class="string">&#x27;search content&#x27;</span></span><br><span class="line"></span><br><span class="line">git grep <span class="string">&#x27;search content&#x27;</span> $(git rev-list --all)</span><br><span class="line">git rev-list --all | xargs git grep <span class="string">&#x27;search content&#x27;</span></span><br></pre></td></tr></table></figure><h2 id="LearnGitBranching"><a href="#LearnGitBranching" class="headerlink" title="LearnGitBranching"></a>LearnGitBranching</h2><p><a href="https://learngitbranching.js.org/?NODEMO=&locale=zh_CN">pcottle/learnGitBranching</a>是一个比较好用的在线 Git 练习网站。  </p><p><img src="https://andylee-1258982386.cos.ap-chengdu.myqcloud.com/vcs/media/learninggitbranch.png" alt="learninggitbranch"></p><h2 id="gitconfig"><a href="#gitconfig" class="headerlink" title=".gitconfig"></a>.gitconfig</h2><p><a href="https://github.com/csswizardry/dotfiles/blob/master/.gitconfig">Template: dotfiles/.gitconfig</a> 是一个比较全的 gitconfig 模板，我们可以参考这个模板设计自己的 gitconfig，譬如如下是我的 gitconfig。  </p><p><img src="https://andylee-1258982386.cos.ap-chengdu.myqcloud.com/vcs/media/gitconfig.png" alt="gitconfig"></p><h1 id="git-directory"><a href="#git-directory" class="headerlink" title=".git directory"></a>.git directory</h1><p>我创建了一个简单的演示 demo，做了几次提交，创建了些文件夹和文件，如下：  </p><p><img src="https://andylee-1258982386.cos.ap-chengdu.myqcloud.com/vcs/media/git_demo_tree.png" alt="git_demo_tree"></p><h2 id="git-HEAD"><a href="#git-HEAD" class="headerlink" title=".git/HEAD"></a>.git/HEAD</h2><p><code>HEAD</code> 相当于是一个指针，指向当前工作的分支或者 commit。  </p><p><img src="https://andylee-1258982386.cos.ap-chengdu.myqcloud.com/vcs/media/git_head.png" alt="git_head"></p><h2 id="git-index"><a href="#git-index" class="headerlink" title=".git/index"></a>.git/index</h2><p><code>index</code> 就是我们所说的暂存区，其主要由如下四部分内容组成，不过我们可以不用太关心。  </p><ul><li>一个 12 字节的标头</li><li>排序的 index 条目</li><li>通过签名识别的扩展名</li><li>160 位 SHA-1</li></ul><p>通过下图我们可以看到 <code>index</code> 是一个二进制文件，我们很难从其内容中看出什么东西。  </p><p><img src="https://andylee-1258982386.cos.ap-chengdu.myqcloud.com/vcs/media/git_index.png" alt="git_index"></p><p>不过 <code>Git</code> 提供了 <code>ls-files</code> 命令来查看暂存区中的内容。  </p><p><img src="https://andylee-1258982386.cos.ap-chengdu.myqcloud.com/vcs/media/git_ls_files.png" alt="git_ls_files"></p><h2 id="git-config-1"><a href="#git-config-1" class="headerlink" title=".git/config"></a>.git/config</h2><p>最高优先级的 local configuration, 同一台电脑上的多个项目可以通过此文件进行差异化配置.  </p><p><img src="https://andylee-1258982386.cos.ap-chengdu.myqcloud.com/vcs/media/git_config.png" alt="git_config"></p><h2 id="git-refs"><a href="#git-refs" class="headerlink" title=".git/refs"></a>.git/refs</h2><p>这个文件夹里面存储的就是所有的 commit ‘指针’文件。  </p><p><img src="https://andylee-1258982386.cos.ap-chengdu.myqcloud.com/vcs/media/git_refs.png" alt="git_refs"></p><h2 id="git-logs"><a href="#git-logs" class="headerlink" title=".git/logs"></a>.git/logs</h2><p>此文件夹存放的是变更历史，可以看到 HEAD 指针， 分支，远程分支的内容都是一样的，只是远程分支的 message 一直是 ‘update by push’。  </p><p><img src="https://andylee-1258982386.cos.ap-chengdu.myqcloud.com/vcs/media/git_logs.png" alt="git_logs"></p><h2 id="git-objects"><a href="#git-objects" class="headerlink" title=".git/objects"></a>.git/objects</h2><p>此文件夹存放所有的对象，即我们管理的内容。  </p><p><img src="https://andylee-1258982386.cos.ap-chengdu.myqcloud.com/vcs/media/git_objects.png" alt="git_objects"></p><h2 id="commit-tree-blob"><a href="#commit-tree-blob" class="headerlink" title="commit, tree,blob"></a>commit, tree,blob</h2><p><code>commit, tree, blob</code> 是 Git 的三个基本单元, 比如我的 Demo 的提交历史如下.  </p><p><img src="https://andylee-1258982386.cos.ap-chengdu.myqcloud.com/vcs/media/git_log_demo.png" alt="git_log_demo"></p><p>我们可以通过 <code>git cat-file -p</code> 查看 Git 对象的内容，通过 <code>git cat-file -t</code> 查看 Git 对象的类型。</p><h3 id="从第二个-commit-726c6c0-看进去"><a href="#从第二个-commit-726c6c0-看进去" class="headerlink" title="从第二个 commit (726c6c0) 看进去"></a>从第二个 commit (726c6c0) 看进去</h3><p><img src="https://andylee-1258982386.cos.ap-chengdu.myqcloud.com/vcs/media/git_commit_content1.png" alt="git_commit_content1"></p><h3 id="从-HEAD-看进去"><a href="#从-HEAD-看进去" class="headerlink" title="从 HEAD 看进去"></a>从 HEAD 看进去</h3><p><img src="https://andylee-1258982386.cos.ap-chengdu.myqcloud.com/vcs/media/git_commit_content2.png" alt="git_commit_content2"></p><p>为了节约空间，任何相同内容的文件 ， 在 Git 看来都是同一个 blob  享元模式 ，享元模式是应用编程比较常见的一个概念，（Flyweight Pattern）主要用于减少创建对象的数量，以减少内存占用和提高性能。感兴趣的下来可以去了解下。享元模式和单例模式有点类似，不过它是针对对象，而单例模式是针对类。譬如相同字符串，只分配一次内存，地址一样，指向同一个对象，可以节省内存。<br>根目录下的 <code>README.md</code> 和 <code>doc/README.md</code> 文件内容相同，所以 Git 只存储一份，</p><h2 id="Detached-HEAD"><a href="#Detached-HEAD" class="headerlink" title="Detached HEAD"></a>Detached HEAD</h2><p>分离头指针，这个在实际开发中也比较容易见到，比如我的当前提交历史如下：  </p><p><img src="https://andylee-1258982386.cos.ap-chengdu.myqcloud.com/vcs/media/git_demo_log_graph.png" alt="git_demo_log_graph"></p><p>通过 <code>git checkout 8c19a38</code> 切到分离头指针。  </p><p><img src="https://andylee-1258982386.cos.ap-chengdu.myqcloud.com/vcs/media/git_detached_head.png" alt="git_detached_head"></p><p><code>git commit -am</code> 如下修改。   </p><p><img src="https://andylee-1258982386.cos.ap-chengdu.myqcloud.com/vcs/media/git_detached_head_diff.png" alt="git_detached_head_diff"></p><p><code>git commit</code> 后的状态如下图，在切换分支时如果我们不用分支或者 tags 关联此 commit，这部分内容就会被 git 回收掉。 不过很多时候分离头指针在 Git 里还是大有用处的，比如在 rebase 的时候。  </p><p><img src="https://andylee-1258982386.cos.ap-chengdu.myqcloud.com/vcs/media/git_detached_head_push.png" alt="git_detached_head_push"></p><h1 id="Repo-work-flow"><a href="#Repo-work-flow" class="headerlink" title="Repo work flow"></a>Repo work flow</h1><p>一般开始编码工作之前我都会通过 <code>repo start</code> 创建对应的 <code>Git Topic branch</code>， 完成开发工作后合入主分支，或者直接提交。  </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">- A - B - C - D - master .</span><br><span class="line">            \</span><br><span class="line">            E - F - G - topic234</span><br><span class="line">After merge:</span><br><span class="line">- A - B - C - D - master^ - master</span><br><span class="line">            \                /</span><br><span class="line">            E - F - G - topic234</span><br></pre></td></tr></table></figure><p><img src="https://andylee-1258982386.cos.ap-chengdu.myqcloud.com/vcs/media/repo_workflow.png" alt="repo_workflow"></p><h1 id="Repo-tips"><a href="#Repo-tips" class="headerlink" title="Repo tips"></a>Repo tips</h1><p>repo 的 tips 内容很简单，就下图的这些命令：</p><ul><li>给所有仓创建 topic 分支</li><li>清除本地修改，保持和远程仓库一致</li><li>回退到指定时间点</li><li>本地镜像多套代码</li></ul><p><img src="https://andylee-1258982386.cos.ap-chengdu.myqcloud.com/vcs/media/repo_tips.png" alt="repo_tips"></p><h1 id="repo-directory"><a href="#repo-directory" class="headerlink" title=".repo directory"></a>.repo directory</h1><p><img src="https://andylee-1258982386.cos.ap-chengdu.myqcloud.com/vcs/media/repo_dirctory.png" alt="repo_dirctory"></p><h2 id="repo"><a href="#repo" class="headerlink" title="repo"></a>repo</h2><p>repo 由 launcher 和 tool 两部分组成， launcher 是一个 python 脚本，也就是我们用到的 repo ， tool 由其下载 ， tool 也是一系列 python 脚本，我们平时执行 <code>repo xxx</code> 命令时，会把后面的参数转发给 tool ，由 tool 来执行。</p><p><img src="https://andylee-1258982386.cos.ap-chengdu.myqcloud.com/vcs/media/repo_launcher_tool.png" alt="repo_launcher_tool"></p><h2 id="repo-init"><a href="#repo-init" class="headerlink" title="repo init"></a>repo init</h2><p><code>repo init</code> 执行流程转换为命令形式如下：  </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">--------------------</span><br><span class="line">mkdir .repo; <span class="built_in">cd</span> .repo</span><br><span class="line">git <span class="built_in">clone</span> https://gerrit.googlesource.com/git-repo</span><br><span class="line">git <span class="built_in">clone</span> --bare <span class="variable">$URL</span> manifests.git</span><br><span class="line">mkdir -p manifests/.git; <span class="built_in">cd</span> manifests/.git</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> ../../manifests.git/*; <span class="keyword">do</span> ln -s <span class="variable">$i</span> .; <span class="keyword">done</span></span><br><span class="line"><span class="built_in">cd</span> ..</span><br><span class="line">git checkout <span class="variable">$BRANCH</span> -- .</span><br><span class="line"><span class="built_in">cd</span> ..</span><br><span class="line">ln -s manifests/<span class="variable">$MANIFEST</span> manifest.xml</span><br></pre></td></tr></table></figure><h2 id="repo-sync"><a href="#repo-sync" class="headerlink" title="repo sync"></a>repo sync</h2><ol><li>克隆 manifest.xml 中指定的 git 仓库到 .repo/projects。</li><li>基于.repo/projects 中的裸仓库创建工作路径及其中 .git 链接。</li><li>checkout manifest 中指定的分支到工作路径,并更新 .repo/project.list。</li></ol><h2 id="manifests"><a href="#manifests" class="headerlink" title="manifests"></a>manifests</h2><h3 id="manifests-repo"><a href="#manifests-repo" class="headerlink" title="manifests repo"></a>manifests repo</h3><p><img src="https://andylee-1258982386.cos.ap-chengdu.myqcloud.com/vcs/media/repo_manifest.png" alt="repo_manifest"></p><h3 id="manifest-format"><a href="#manifest-format" class="headerlink" title="manifest format"></a>manifest format</h3><p><img src="https://andylee-1258982386.cos.ap-chengdu.myqcloud.com/vcs/media/repo_manifest_format.png" alt="repo_manifest_format"></p><h2 id="repo-hook"><a href="#repo-hook" class="headerlink" title="repo hook"></a>repo hook</h2><p>Repo 提供了一种机制，使用自定义的 python 模块 hook 运行时的特定阶段。所有 hook 都位于一个 git 项目中，该项目基于 mainifests 在 <code>repo init</code> 时 checkout 。<code>repo hook</code> 在执行步骤之前(例如提交到Gerrit之前)运行 linters, 检查格式及进行单元测试, linter 简单来说就是分析源码，查找问题的工具。</p><p><a href="https://android.googlesource.com/platform/tools/repohooks">Android 项目</a> 中可以找到一个完整的示例。它可以很容易地被任何基于 repo 的项目使用，并不特定于Android。如下是一个 mainifest 设置范例。  </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;project path=<span class="string">&quot;tools/repohooks&quot;</span> name=<span class="string">&quot;platform/tools/repohooks&quot;</span> /&gt;</span><br><span class="line">&lt;repo-hooks in-project=<span class="string">&quot;platform/tools/repohooks&quot;</span> enabled-list=<span class="string">&quot;pre-upload&quot;</span> /&gt;</span><br></pre></td></tr></table></figure><h2 id="project-list"><a href="#project-list" class="headerlink" title="project.list"></a>project.list</h2><p>repo 跟踪的所有仓库:    </p><p><img src="https://andylee-1258982386.cos.ap-chengdu.myqcloud.com/vcs/media/repo_project_list.png" alt="repo_project_list"></p><h2 id="projects-project-objects"><a href="#projects-project-objects" class="headerlink" title="projects, project-objects"></a>projects, project-objects</h2><ul><li>projects: manifest 中指定的所有 project 的 git 裸仓库,repo 将基于此 git 仓库生成工作区。</li><li>project-objects:可以在多个本地 git 中安全共享的 Git 对象。</li></ul><p>i.e. : 将 foo/bar.git 的不同分支 checkout 到本地 foo/bar-master,foo/bar-release 等, 在 projects 下将为每一个分支创建路径,而 project-objects 下面将会只有一个路径。  </p><p><img src="https://andylee-1258982386.cos.ap-chengdu.myqcloud.com/vcs/media/projects_objects.png" alt="projects_objects"></p>]]></content>
      
      
      <categories>
          
          <category> Git </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Tools </tag>
            
            <tag> Repo </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Pstore 的一些记录</title>
      <link href="2020/11/13/Android/pstore/"/>
      <url>2020/11/13/Android/pstore/</url>
      
        <content type="html"><![CDATA[<h1 id="What-is-pstore？"><a href="#What-is-pstore？" class="headerlink" title="What is pstore？"></a>What is pstore？</h1><p><code>pstore, persistent storage</code>, 是一个存储内核日志或者内核 panic 的文件系统，内核会把相关信息存储在一个不能被其他用户重写的指定 RAM 区域，下一次启动时，这个区域会被挂载到 <code>/pstore</code>，一般在 <code>/sys/fs/pstore</code>, 这样我们就可以访问这些数据了。</p><p>pstore 在内核中的开关是 CONFIG_PSTORE，pstore 提供的是一套可扩展的机制，提供如下类型：</p><ul><li>PSTORE_TYPE_DMESG, 表示内核日志</li><li>PSTORE_TYPE_MCE, 表示硬件错误</li><li>PSTORE_TYPE_CONSOLE, 表示控制台输出,所有内核信息。</li><li>PSTORE_TYPE_FTRACE, 表示函数调用序列, ftrace 信息。</li></ul><p>ramoops 指的是采用 ram 保存 oops 信息的一个功能，这个功能从 3.10.40 开始采用 pstore 机制来实现，内核中的开关控制：</p><ul><li>PSTORE_PMSG，用户空间信息，/dev/pmsg0，pmsg-ramoops-<ID></li><li>PSTORE_CONSOLE，控制台输出，所有内核信息，console-ramoops-<ID></li><li>PSTORE_FTRACE，函数调用序列, ftrace 信息。</li><li>PSTORE_RAM， panic/oops 信息</li></ul><h1 id="How-to-config"><a href="#How-to-config" class="headerlink" title="How to config?"></a>How to config?</h1><a id="more"></a><p>用我本地的 SDM660 和 MSM8909 平台源码配置 pstore 时，按照如下方式可以实现：  </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// kernel/msm-4.14/arch/arm64/configs/vendor/sdm660_defconfig</span></span><br><span class="line">CONFIG_PSTORE=y</span><br><span class="line">CONFIG_PSTORE_CONSOLE=y</span><br><span class="line">CONFIG_PSTORE_RAM=y</span><br><span class="line">CONFIG_PSTORE_FTRACE=y</span><br><span class="line"></span><br><span class="line">CONFIG_DEBUG_FS=y</span><br><span class="line">CONFIG_FUNCTION_TRACER=y</span><br><span class="line"></span><br><span class="line"><span class="keyword">and</span> disable below config:</span><br><span class="line"># CONFIG_STRICT_MEMORY_RWX</span><br><span class="line"></span><br><span class="line"># kernel/msm<span class="number">-4.14</span>/fs/pstore/ram.c</span><br><span class="line">-<span class="keyword">static</span> ulong ramoops_console_size = MIN_MEM_SIZE;</span><br><span class="line">+<span class="keyword">static</span> ulong ramoops_console_size = <span class="number">256</span>*<span class="number">1024U</span>L;</span><br><span class="line"></span><br><span class="line">- <span class="keyword">static</span> ulong mem_address;</span><br><span class="line">+ <span class="keyword">static</span> ulong mem_address=<span class="number">0x9ff00000</span>;</span><br><span class="line"> module_param(mem_address, ulong, <span class="number">0400</span>);</span><br><span class="line"> MODULE_PARM_DESC(mem_address,</span><br><span class="line">         <span class="string">&quot;start of reserved RAM used to store oops/panic logs&quot;</span>);</span><br><span class="line"> </span><br><span class="line">- <span class="keyword">static</span> ulong mem_size;</span><br><span class="line">+ <span class="keyword">static</span> ulong mem_size=<span class="number">0x100000</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// kernel/msm-4.14/arch/arm64/boot/dts/qcom/sdm660.dtsi</span></span><br><span class="line"><span class="comment">// 在 RAM 中保留空间：       </span></span><br><span class="line">reserved-memory &#123;</span><br><span class="line"><span class="meta">#address-cells = <span class="meta-string">&lt;2&gt;;</span></span></span><br><span class="line"><span class="meta">#size-cells = <span class="meta-string">&lt;2&gt;;</span></span></span><br><span class="line">ranges;</span><br><span class="line">        ...</span><br><span class="line">+        pstore_reserve_mem: pstore_reserve_mem_region@<span class="number">0</span> &#123;</span><br><span class="line">+            linux,reserve-contiguous-region;</span><br><span class="line">+            linux,reserve-region;</span><br><span class="line">+            linux,remove-completely;</span><br><span class="line">+            reg = &lt;<span class="number">0x0</span> <span class="number">0x9ff00000</span> <span class="number">0x0</span> <span class="number">0x00100000</span>&gt;;</span><br><span class="line">+            label = <span class="string">&quot;pstore_reserve_mem&quot;</span>;</span><br><span class="line">+        &#125;;</span><br><span class="line">...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>基于我的实验，在 SM6125 平台按照如下方式修改可以使 ramoops 正常工作。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// arch/arm64/boot/dts/qcom/trinket.dtsi</span></span><br><span class="line">@@ <span class="number">-594</span>,<span class="number">6</span> +<span class="number">594</span>,<span class="number">18</span> @@</span><br><span class="line">size = &lt;<span class="number">0</span> <span class="number">0x2000000</span>&gt;;</span><br><span class="line">linux,cma-<span class="keyword">default</span>;</span><br><span class="line">&#125;;</span><br><span class="line">+</span><br><span class="line">+ <span class="comment">/* enabled pstore */</span></span><br><span class="line">+ ramoops: ramoops@ffc00000 &#123;</span><br><span class="line">+ compatible = <span class="string">&quot;removed-dma-pool&quot;</span>, <span class="string">&quot;ramoops&quot;</span>;</span><br><span class="line">+ no-<span class="built_in">map</span>;</span><br><span class="line">+ reg = &lt;<span class="number">0</span> <span class="number">0xffc00000</span> <span class="number">0</span> <span class="number">0x00100000</span>&gt;;</span><br><span class="line">+ record-size = &lt;<span class="number">0x1000</span>&gt;;</span><br><span class="line">+ console-size = &lt;<span class="number">0x40000</span>&gt;;</span><br><span class="line">+ ftrace-size = &lt;<span class="number">0x0</span>&gt;;</span><br><span class="line">+ msg-size = &lt;<span class="number">0x20000</span> <span class="number">0x20000</span>&gt;;</span><br><span class="line">+ cc-size = &lt;<span class="number">0x0</span>&gt;;</span><br><span class="line">+ &#125;;</span><br><span class="line">&#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// arch/arm64/configs/vendor/trinket-perf_defconfig</span></span><br><span class="line">CONFIG_SND_SOC_DBMDX_VA_I2S_MASTER=y</span><br><span class="line">CONFIG_SND_SOC_DBMDX_AEC_REF_32_TO_16_BIT=y</span><br><span class="line">CONFIG_ANT_CHECK=y</span><br><span class="line">+</span><br><span class="line">+# enable pstore</span><br><span class="line">+CONFIG_PSTORE=y</span><br><span class="line">+CONFIG_PSTORE_FTRACE=y</span><br><span class="line">+CONFIG_PSTORE_PMSG=y</span><br><span class="line">+CONFIG_PSTORE_RAM=y</span><br><span class="line">+CONFIG_PSTORE_CONSOLE=y</span><br><span class="line">-CONFIG_FREE_PAGES_RDONLY=y</span><br><span class="line"></span><br><span class="line"><span class="comment">//为了保持在 DDR 中保存 `pstore` 的内容，需要设备 WARM-RESET。</span></span><br><span class="line"># drivers/power/reset/msm-poweroff.c,</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> msm_restart_prepare(<span class="keyword">const</span> <span class="keyword">char</span> *cmd)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">bool</span> need_warm_reset = <span class="literal">false</span>;</span><br><span class="line">...</span><br><span class="line">+ <span class="comment">/* WARM-RESET is needed for keeping PSTORE content in DDR */</span></span><br><span class="line">+ need_warm_reset = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Hard reset the PMIC unless memory contents must be maintained. */</span></span><br><span class="line"><span class="keyword">if</span> (need_warm_reset) &#123;</span><br><span class="line">    qpnp_pon_system_pwr_off(PON_POWER_OFF_WARM_RESET);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    qpnp_pon_system_pwr_off(PON_POWER_OFF_HARD_RESET);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="Where-does-sysfs-create"><a href="#Where-does-sysfs-create" class="headerlink" title="Where does sysfs create?"></a>Where does sysfs create?</h1><p>我们可以在 <code>/sys/fs/pstore/*</code> 看到加载的 <code>pstore</code> 数据，如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ls /sys/fs/pstore/                                                                                                                                                                               </span><br><span class="line">console-ramoops-0 pmsg-ramoops-0  ...</span><br></pre></td></tr></table></figure><p>其来自于如下源码：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// /kernel/msm-4.4/fs/pstore/inode.c#300</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">pstore_mkfile</span><span class="params">(<span class="keyword">enum</span> pstore_type_id type, <span class="keyword">char</span> *psname, u64 id, <span class="keyword">int</span> count,</span></span></span><br><span class="line"><span class="function"><span class="params">  <span class="keyword">char</span> *data, <span class="keyword">bool</span> compressed, <span class="keyword">size_t</span> size,</span></span></span><br><span class="line"><span class="function"><span class="params">  struct timespec time, struct pstore_info *psi)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">...</span><br><span class="line"><span class="keyword">switch</span> (type) &#123;</span><br><span class="line"><span class="keyword">case</span> PSTORE_TYPE_DMESG:</span><br><span class="line">scnprintf(name, <span class="keyword">sizeof</span>(name), <span class="string">&quot;dmesg-%s-%lld%s&quot;</span>,</span><br><span class="line">  psname, id, compressed ? <span class="string">&quot;.enc.z&quot;</span> : <span class="string">&quot;&quot;</span>);</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> PSTORE_TYPE_CONSOLE:</span><br><span class="line">scnprintf(name, <span class="keyword">sizeof</span>(name), <span class="string">&quot;console-%s-%lld&quot;</span>, psname, id);</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> PSTORE_TYPE_FTRACE:</span><br><span class="line">scnprintf(name, <span class="keyword">sizeof</span>(name), <span class="string">&quot;ftrace-%s-%lld&quot;</span>, psname, id);</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> PSTORE_TYPE_MCE:</span><br><span class="line">scnprintf(name, <span class="keyword">sizeof</span>(name), <span class="string">&quot;mce-%s-%lld&quot;</span>, psname, id);</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> PSTORE_TYPE_PPC_RTAS:</span><br><span class="line">scnprintf(name, <span class="keyword">sizeof</span>(name), <span class="string">&quot;rtas-%s-%lld&quot;</span>, psname, id);</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> PSTORE_TYPE_PPC_OF:</span><br><span class="line">scnprintf(name, <span class="keyword">sizeof</span>(name), <span class="string">&quot;powerpc-ofw-%s-%lld&quot;</span>,</span><br><span class="line">  psname, id);</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> PSTORE_TYPE_PPC_COMMON:</span><br><span class="line">scnprintf(name, <span class="keyword">sizeof</span>(name), <span class="string">&quot;powerpc-common-%s-%lld&quot;</span>,</span><br><span class="line">  psname, id);</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> PSTORE_TYPE_PMSG:</span><br><span class="line">scnprintf(name, <span class="keyword">sizeof</span>(name), <span class="string">&quot;pmsg-%s-%lld&quot;</span>, psname, id);</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> PSTORE_TYPE_PPC_OPAL:</span><br><span class="line"><span class="built_in">sprintf</span>(name, <span class="string">&quot;powerpc-opal-%s-%lld&quot;</span>, psname, id);</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> PSTORE_TYPE_UNKNOWN:</span><br><span class="line">scnprintf(name, <span class="keyword">sizeof</span>(name), <span class="string">&quot;unknown-%s-%lld&quot;</span>, psname, id);</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">default</span>:</span><br><span class="line">scnprintf(name, <span class="keyword">sizeof</span>(name), <span class="string">&quot;type%d-%s-%lld&quot;</span>,</span><br><span class="line">  type, psname, id);</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure><h1 id="How-to-test"><a href="#How-to-test" class="headerlink" title="How to test?"></a>How to test?</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 检查 pstore 配置成功与否。</span></span><br><span class="line">cat /sys/module/pstore/parameters/*  </span><br><span class="line">ramoops <span class="comment"># backend</span></span><br><span class="line">-1      <span class="comment"># update_ms</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查相关预留 size 是否配置成功</span></span><br><span class="line">ls /sys/module/ramoops/parameters</span><br><span class="line">console_size ftrace_size mem_type         pmsg_pmc_size    record_size </span><br><span class="line">dump_oops    mem_address pmsg_events_size pmsg_radio_size  </span><br><span class="line">ecc          mem_size    pmsg_main_size   pmsg_system_size </span><br><span class="line">cat /sys/module/ramoops/parameters/*</span><br><span class="line">131072</span><br><span class="line">1</span><br><span class="line">1</span><br><span class="line">0</span><br><span class="line">2499805184</span><br><span class="line">1441792</span><br><span class="line">0</span><br><span class="line">262144</span><br><span class="line">262144</span><br><span class="line">262144</span><br><span class="line">262144</span><br><span class="line">262144</span><br><span class="line">0</span><br><span class="line"></span><br><span class="line"><span class="comment"># enable record ftrace</span></span><br><span class="line">mount -t debugfs debugfs /sys/kernel/debug/</span><br><span class="line"><span class="built_in">echo</span> 1 &gt; /sys/kernel/debug/pstore/record_ftrace</span><br><span class="line"></span><br><span class="line"><span class="comment"># `pstore` 配置成功后，不能自动重启并加载 pstore 数据的话，一般是由于配置了 panic 时进入 download mode。即 download_mode 为 1，定义于 `kernel/msm-4.14/drivers/power/reset/msm-poweroff.c`。</span></span><br><span class="line"><span class="comment"># disable download mode:</span></span><br><span class="line"><span class="built_in">echo</span> 0 &gt; /sys/module/msm_poweroff/parameters/download_mode</span><br><span class="line"><span class="built_in">echo</span> c &gt; /proc/sysrq-trigger</span><br><span class="line"></span><br><span class="line">ls /sys/fs/pstore/</span><br><span class="line">  console-ramoops</span><br><span class="line">  dmesg-ramoops-0</span><br><span class="line">  dmesg-ramoops-1</span><br><span class="line">  ftrace-ramoops</span><br><span class="line"></span><br><span class="line">cat /sys/fs/pstore/ftrace-ramoops</span><br><span class="line">0 c08bf830  c08bfbf0  do_page_fault.part.8 &lt;- do_page_fault+0x3c/0xa8</span><br><span class="line">0 c001b770  c08bfb48  fixup_exception &lt;- do_page_fault.part.8+0x32c/0x398</span><br><span class="line">0 c0045bb0  c001b780  search_exception_tables &lt;- fixup_exception+0x20/0x38</span><br><span class="line">0 c008914c  c0045bd8  search_module_extables &lt;- search_exception_tables+0x38/0x44</span><br><span class="line">0 c08bff5c  c008915c  add_preempt_count &lt;- search_module_extables+0x24/0xc0</span><br><span class="line">0 c08bfe78  c00891cc  sub_preempt_count &lt;- search_module_extables+0x94/0xc0</span><br><span class="line">0 c08b2e28  c08bfb64  __do_kernel_fault.part.7 &lt;- do_page_fault.part.8+0x348/0x398</span><br></pre></td></tr></table></figure><h1 id="How-to-debug"><a href="#How-to-debug" class="headerlink" title="How to debug?"></a>How to debug?</h1><ol><li><p>在 <code>msm_restart_probe</code> 中加日志确认 PMIC 是被配置为 warm reset mode。</p></li><li><p>如果需要为未知重启保存 <code>pstore</code> 日志，需要确认 <code>XBL</code> 中正确设置了 PSHOLD trigger 为 PMIC warm reset mode。</p></li><li><p>查看 <code>pstore</code> setup 流程：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ramoops_init</span><br><span class="line">ramoops_register_dummy</span><br><span class="line">ramoops_probe</span><br><span class="line">ramoops_register</span><br></pre></td></tr></table></figure></li><li><p>查看 <code>pstore</code> 数据保存流程：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">register</span> a pstore_dumper</span><br><span class="line"><span class="comment">// when panic happens, kmsg_dump is called</span></span><br><span class="line">call dumper-&gt;dump</span><br><span class="line">pstore_dump</span><br></pre></td></tr></table></figure></li><li><p>查看 <code>pstore</code> 数据读取流程：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">ramoops_probe</span><br><span class="line">persistent_ram_post_init</span><br><span class="line">pstore_register</span><br><span class="line">pstore_get_records</span><br><span class="line">ramoops_pstore_read</span><br><span class="line">pstore_decompress (only <span class="keyword">for</span> dmesg)</span><br><span class="line">pstore_mkfile (save to files)</span><br></pre></td></tr></table></figure></li></ol>]]></content>
      
      
      <categories>
          
          <category> Android </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>What is in the .repo?</title>
      <link href="2020/10/17/Git/What-is-in-the-repo/"/>
      <url>2020/10/17/Git/What-is-in-the-repo/</url>
      
        <content type="html"><![CDATA[<p><a href="http://huaqianlee.github.io/2019/09/15/Git/How-does-android-repo-work/">How does the repo of android source code work ?</a></p><h1 id="repo"><a href="#repo" class="headerlink" title=".repo"></a>.repo</h1><p>通常情况下， Android 的 <code>.repo</code> 里面有如下内容：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ ls .repo</span><br><span class="line">manifests  manifests.git  manifest.xml  project.list  project-objects  projects  repo</span><br></pre></td></tr></table></figure><h1 id="manifests"><a href="#manifests" class="headerlink" title="manifests"></a>manifests</h1><p><code>manifests</code> 路径是项目 manifest 仓的 <code>git checkout</code>，其中的 <code>.git</code> 是 <code>manifest.git</code> 的软链接，追踪 <code>repo init --manifest-branch</code> 指定的分支。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">.repo$ ls manifests/.git/</span><br><span class="line">config       HEAD   index  logs     ORIG_HEAD    refs      shallow</span><br><span class="line">description  hooks  info   objects  packed-refs  rr-cache  svn</span><br><span class="line"></span><br><span class="line">.repo$ ls manifests.git/</span><br><span class="line">branches  description  HEAD   info  objects      refs      svn</span><br><span class="line">config    FETCH_HEAD   hooks  logs  packed-refs  rr-cache</span><br></pre></td></tr></table></figure><p>不管远程分支名字是什么，<code>manifests</code> 的本地分支命名为 default。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">.repo$ cat manifests/.git/HEAD </span><br><span class="line">ref: refs/heads/default  </span><br><span class="line"></span><br><span class="line">.repo$ cat manifests.git/config  </span><br><span class="line"><span class="comment"># cat manifests/.git/config</span></span><br><span class="line">[core]</span><br><span class="line">repositoryformatversion = 0</span><br><span class="line">filemode = <span class="literal">true</span></span><br><span class="line">[filter <span class="string">&quot;lfs&quot;</span>]</span><br><span class="line">smudge = git-lfs smudge --skip -- %f</span><br><span class="line">[remote <span class="string">&quot;origin&quot;</span>]</span><br><span class="line">url = https://&lt;url&gt;/platform/manifest.git</span><br><span class="line">fetch = +refs/heads/*:refs/remotes/origin/*</span><br><span class="line">[branch <span class="string">&quot;default&quot;</span>]</span><br><span class="line">remote = origin</span><br><span class="line">merge = refs/heads/&lt;remote_branch_name&gt;</span><br></pre></td></tr></table></figure><h1 id="manifests-git"><a href="#manifests-git" class="headerlink" title="manifests.git"></a>manifests.git</h1><p><code>manifests.git</code> 是当前项目 <code>manifest</code> 仓的一个没有工作空间的 <code>checkout</code>，即只 <code>checkout</code> <code>.git</code> ，追踪<code>repo init --manifest-url</code> 指定的 Git 仓。不能手动修改这部分，如果需要修改的话，可重新运行 <code>repo init</code> 来更新设置。</p><h2 id="repo-config-json"><a href="#repo-config-json" class="headerlink" title=".repo_config.json"></a>.repo_config.json</h2><p>缓存 <code>manifests.git/config</code>，用来提升 <code>repo</code> 的速度。</p><h1 id="manifest-xml"><a href="#manifest-xml" class="headerlink" title="manifest.xml"></a>manifest.xml</h1><p><code>repo</code> 使用的 <code>manifest</code> ， 此文件由 <code>repo init --manifest-name</code> 指定链接到 <code>manifests</code> 中的哪一个文件，如下：  </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">manifest.xml -&gt; manifests/&lt;manifest-name&gt;.xml <span class="comment"># 指向用户希望用来同步源码的 manifest</span></span><br></pre></td></tr></table></figure><a id="more"></a><h2 id="Manifest-format"><a href="#Manifest-format" class="headerlink" title="Manifest format"></a>Manifest format</h2><p>以 <a href="https://android.googlesource.com/platform/manifest/+/master/default.xml">default.xml in Android</a> 为例简单介绍下 manifest 的格式。 </p><blockquote><p>详细格式介绍见 <a href="https://gerrit.googlesource.com/git-repo/+/master/docs/manifest-format.md">repo Manifest Format</a> 。</p></blockquote><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">manifest</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- </span></span><br><span class="line"><span class="comment">    name: 独一无二的一个名字， 用作每个项目中 .git/config 的 remote name, 自动用于 git fetch, git remote, git pull and git push 等命令， 大多数时候我们会定义为 ‘origin’.</span></span><br><span class="line"><span class="comment">    alias: 别名，重写 name。</span></span><br><span class="line"><span class="comment">    fetch: 用作所有使用此 remote 的 Git URL 前缀，在后面加上项目名就形成了 ’git clone‘ 需要的链接。</span></span><br><span class="line"><span class="comment">    pushurl: ’git push‘ 的链接前缀，若未定义，则使用 ’fetch‘ 属性。</span></span><br><span class="line"><span class="comment">    review: ’repo upload‘ 的 Gerrit 服务器主机名，此服务器主要用来 review ，如果不指定，’repo upload‘ 命令无效。</span></span><br><span class="line"><span class="comment">    revision: Git 分支名 (e.g. master or refs/heads/master)，若定义，将重写下方 default revision.</span></span><br><span class="line"><span class="comment">   --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">remote</span>  <span class="attr">name</span>=<span class="string">&quot;aosp&quot;</span></span></span><br><span class="line"><span class="tag">           <span class="attr">fetch</span>=<span class="string">&quot;..&quot;</span></span></span><br><span class="line"><span class="tag">           <span class="attr">review</span>=<span class="string">&quot;https://android-review.googlesource.com/&quot;</span> /&gt;</span></span><br><span class="line">  <span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">    默认属性，remote 或 project 未定义则使用此处定义属性。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    remote: projects 的默认 remote name，在前面 remote 中定义</span></span><br><span class="line"><span class="comment">    revision: projects 的默认分支名</span></span><br><span class="line"><span class="comment">    dest-branch: 默认 review 分支名，不设置则使用 revison 属性作为默认分支  </span></span><br><span class="line"><span class="comment">    upstream: sha1 的来源 Git ref 名，有时我们只需要同步到某 Git ref 指定的 sha1，而不用在 `-c mode` 同步整个 ref 空间，则用 upstream 指定 ref ，revision 指定 sha1.</span></span><br><span class="line"><span class="comment">    sync-j: 同步时的默认并行线程数</span></span><br><span class="line"><span class="comment">    sync-c: true， 表示只同步当前 revision， 而不是整个 ref 空间.</span></span><br><span class="line"><span class="comment">   --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">default</span> <span class="attr">revision</span>=<span class="string">&quot;master&quot;</span></span></span><br><span class="line"><span class="tag">           <span class="attr">remote</span>=<span class="string">&quot;aosp&quot;</span></span></span><br><span class="line"><span class="tag">           <span class="attr">sync-j</span>=<span class="string">&quot;4&quot;</span> /&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- </span></span><br><span class="line"><span class="comment">      </span></span><br><span class="line"><span class="comment">   --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">manifest-server</span> <span class="attr">url</span>=<span class="string">&quot;http://android-smartsync.corp.google.com/android.googlesource.com/manifestserver&quot;</span> /&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- </span></span><br><span class="line"><span class="comment">    path: 当前 project 的 git 工作路径</span></span><br><span class="line"><span class="comment">    revision: Git 分支名，可以来自 refs/heads (e.g. just “master”)， “refs/heads/master”， Tags， SHA-1s，如果不设定，则由 remote 或者 default 中的属性决定.</span></span><br><span class="line"><span class="comment">    dest-branch: repo upload 的 review 分支名. 如果这里和 default 都没有指定此属性，则使用 revision 属性</span></span><br><span class="line"><span class="comment">    groups: project 所属组， 多个组用空格或逗号隔开，所有 projects 都默认属于 “all” ，”name:name“， ”path:path“  </span></span><br><span class="line"><span class="comment">    upstream: 指定 sha1 的 Git ref 名</span></span><br><span class="line"><span class="comment">    copyfile: 复制文件到指定位置</span></span><br><span class="line"><span class="comment">    linkfile: 链接文件到指定位置</span></span><br><span class="line"><span class="comment">   --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">project</span> <span class="attr">path</span>=<span class="string">&quot;build/make&quot;</span> <span class="attr">name</span>=<span class="string">&quot;platform/build&quot;</span> <span class="attr">groups</span>=<span class="string">&quot;pdk&quot;</span> &gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">copyfile</span> <span class="attr">src</span>=<span class="string">&quot;core/root.mk&quot;</span> <span class="attr">dest</span>=<span class="string">&quot;Makefile&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">linkfile</span> <span class="attr">src</span>=<span class="string">&quot;CleanSpec.mk&quot;</span> <span class="attr">dest</span>=<span class="string">&quot;build/CleanSpec.mk&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">linkfile</span> <span class="attr">src</span>=<span class="string">&quot;buildspec.mk.default&quot;</span> <span class="attr">dest</span>=<span class="string">&quot;build/buildspec.mk.default&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">linkfile</span> <span class="attr">src</span>=<span class="string">&quot;core&quot;</span> <span class="attr">dest</span>=<span class="string">&quot;build/core&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">linkfile</span> <span class="attr">src</span>=<span class="string">&quot;envsetup.sh&quot;</span> <span class="attr">dest</span>=<span class="string">&quot;build/envsetup.sh&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">linkfile</span> <span class="attr">src</span>=<span class="string">&quot;target&quot;</span> <span class="attr">dest</span>=<span class="string">&quot;build/target&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">linkfile</span> <span class="attr">src</span>=<span class="string">&quot;tools&quot;</span> <span class="attr">dest</span>=<span class="string">&quot;build/tools&quot;</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">project</span> <span class="attr">path</span>=<span class="string">&quot;build/bazel&quot;</span> <span class="attr">name</span>=<span class="string">&quot;platform/build/bazel&quot;</span> <span class="attr">groups</span>=<span class="string">&quot;pdk&quot;</span> &gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">linkfile</span> <span class="attr">src</span>=<span class="string">&quot;bazel.WORKSPACE&quot;</span> <span class="attr">dest</span>=<span class="string">&quot;WORKSPACE&quot;</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">project</span> <span class="attr">path</span>=<span class="string">&quot;build/blueprint&quot;</span> <span class="attr">name</span>=<span class="string">&quot;platform/build/blueprint&quot;</span> <span class="attr">groups</span>=<span class="string">&quot;pdk,tradefed&quot;</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">project</span> <span class="attr">path</span>=<span class="string">&quot;build/soong&quot;</span> <span class="attr">name</span>=<span class="string">&quot;platform/build/soong&quot;</span> <span class="attr">groups</span>=<span class="string">&quot;pdk,tradefed&quot;</span> &gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">linkfile</span> <span class="attr">src</span>=<span class="string">&quot;root.bp&quot;</span> <span class="attr">dest</span>=<span class="string">&quot;Android.bp&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">linkfile</span> <span class="attr">src</span>=<span class="string">&quot;bootstrap.bash&quot;</span> <span class="attr">dest</span>=<span class="string">&quot;bootstrap.bash&quot;</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">project</span> <span class="attr">path</span>=<span class="string">&quot;art&quot;</span> <span class="attr">name</span>=<span class="string">&quot;platform/art&quot;</span> <span class="attr">groups</span>=<span class="string">&quot;pdk&quot;</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">project</span> <span class="attr">path</span>=<span class="string">&quot;bionic&quot;</span> <span class="attr">name</span>=<span class="string">&quot;platform/bionic&quot;</span> <span class="attr">groups</span>=<span class="string">&quot;pdk&quot;</span> /&gt;</span></span><br><span class="line">...</span><br><span class="line">  <span class="tag">&lt;<span class="name">project</span> <span class="attr">path</span>=<span class="string">&quot;tools/treble&quot;</span> <span class="attr">name</span>=<span class="string">&quot;platform/tools/treble&quot;</span> <span class="attr">groups</span>=<span class="string">&quot;tools,pdk&quot;</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">project</span> <span class="attr">path</span>=<span class="string">&quot;tools/trebuchet&quot;</span> <span class="attr">name</span>=<span class="string">&quot;platform/tools/trebuchet&quot;</span> <span class="attr">groups</span>=<span class="string">&quot;tools,cts,pdk,pdk-cw-fs,pdk-fs&quot;</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">repo-hooks</span> <span class="attr">in-project</span>=<span class="string">&quot;platform/tools/repohooks&quot;</span> <span class="attr">enabled-list</span>=<span class="string">&quot;pre-upload&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">manifest</span>&gt;</span></span><br><span class="line">```  </span><br><span class="line"></span><br><span class="line">## repo hook</span><br><span class="line"></span><br><span class="line">[hook](https://android.googlesource.com/platform/tools/repohooks) 主要在允许执行步骤之前（例如在将提交上载到Gerrit之前），运行 linters，检查格式和运行单元测试。</span><br><span class="line"></span><br><span class="line">&gt; linter 的维基百科解释是：a tool that analyzes source code to flag programming errors, bugs, stylistic errors, and suspicious constructs.<span class="tag">&lt;<span class="name">br</span>/&gt;</span>简单来说就是分析源码，查找问题。</span><br><span class="line"></span><br><span class="line">如下是一个 Android 中的使用范例，在战’pre-upload&#x27;（即，`repo upload`） 阶段运行名为 ’platform/tools/repohooks‘ 的 hook 。</span><br><span class="line">```xml</span><br><span class="line"> <span class="tag">&lt;<span class="name">project</span> <span class="attr">path</span>=<span class="string">&quot;tools/repohooks&quot;</span> <span class="attr">name</span>=<span class="string">&quot;platform/tools/repohooks&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">repo-hooks</span> <span class="attr">in-project</span>=<span class="string">&quot;platform/tools/repohooks&quot;</span> <span class="attr">enabled-list</span>=<span class="string">&quot;pre-upload&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure><h1 id="project-list"><a href="#project-list" class="headerlink" title="project.list"></a>project.list</h1><p><code>repo sync</code> 基于此文件内容增删 projects ，并更新对应的 <code>checkout</code> 工作路径。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">.repo$ more project.list </span><br><span class="line">art</span><br><span class="line">bionic</span><br><span class="line">bootable/bootloader/edk2</span><br><span class="line">bootable/recovery</span><br><span class="line">build/blueprint</span><br><span class="line">build/kati</span><br><span class="line">build/make</span><br><span class="line">build/soong</span><br><span class="line">cts</span><br><span class="line">dalvik</span><br><span class="line">developers/build</span><br><span class="line">...</span><br><span class="line">device/qcom/common</span><br><span class="line">device/qcom/sepolicy</span><br><span class="line">...</span><br></pre></td></tr></table></figure><h1 id="projects"><a href="#projects" class="headerlink" title="projects"></a>projects</h1><p>存放 repo 克隆的 manifest 中指定的所有 project 的 git 仓库，repo 将基于此 git 仓库链接 .git 并创建工作路径，然后 checkout 对应分支，并更新 .repo/project.list。一些 git 将进一步拆分到如下的 project-objects。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">.repo$ ls projects</span><br><span class="line">art.git     dalvik.git       frameworks           packages              shortcut-fe.git  vendor</span><br><span class="line">bionic.git  developers       hardware             pdk.git               system</span><br><span class="line">bootable    development.git  kernel               platform_testing.git  <span class="built_in">test</span></span><br><span class="line">build       device           libcore.git          prebuilts             toolchain</span><br><span class="line">cts.git     external         libnativehelper.git  sdk.git               tools</span><br></pre></td></tr></table></figure><h1 id="project-objects"><a href="#project-objects" class="headerlink" title="project-objects"></a>project-objects</h1><p>可以在多个 <code>git chekcout</code> 中安全共享的 Git 对象，例如，可以将 foo/bar.git 的不同分支 <code>checkout</code> 到 foo/bar-master，foo/bar-release 等， 在 projects 下将为每一个分支创建路径，而  project-objects 下面将会只有一个路径。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">.repo$ ls project-objects/</span><br><span class="line">abl  device  kernel  platform  toolchain</span><br></pre></td></tr></table></figure><h1 id="repo-1"><a href="#repo-1" class="headerlink" title="repo"></a>repo</h1><p>完整的 Repo 工具，接收并处理 Repo-Launcher 转发的命令。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ ls .repo/repo/</span><br><span class="line">color.py    command.pyc  editor.py   error.pyc        git_config.py   gitc_utils.pyc  git_ssh  manifest_xml.py   pager.pyc     project.py    pyversion.pyc  repoc                  tests      wrapper.py</span><br><span class="line">color.pyc   COPYING      editor.pyc  git_command.py   git_config.pyc  git_refs.py     hooks    manifest_xml.pyc  progress.py   project.pyc   README.md      subcmds                trace.py   wrapper.pyc</span><br><span class="line">command.py  docs         error.py    git_command.pyc  gitc_utils.py   git_refs.pyc    main.py  pager.py          progress.pyc  pyversion.py  repo           SUBMITTING_PATCHES.md  trace.pyc</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Git </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Tools </tag>
            
            <tag> Repo </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>How to build intranet gitbook with docker</title>
      <link href="2020/10/10/Git/How-to-build-intranet-gitbook-with-docker/"/>
      <url>2020/10/10/Git/How-to-build-intranet-gitbook-with-docker/</url>
      
        <content type="html"><![CDATA[<p>之前折腾局域网搭建 Gitbook，并写了一篇简易教程：<a href="http://huaqianlee.github.io/2019/05/05/Git/gitlab-jenkins-gitbook-to-create-LAN-gitbook/">Gitbook + Jenkins + Gitlab 搭建内网自动构建的 Gitbook</a>。最近兴趣使然又用 docker 搭建了一套方便部署的内网 Gitbook 镜像，因此也总结一篇简易教程如下。</p><h1 id="Install-Docker"><a href="#Install-Docker" class="headerlink" title="Install Docker"></a>Install Docker</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install docker</span><br></pre></td></tr></table></figure><h1 id="Gitbook"><a href="#Gitbook" class="headerlink" title="Gitbook"></a>Gitbook</h1><h2 id="Gitbook-Image"><a href="#Gitbook-Image" class="headerlink" title="Gitbook Image"></a>Gitbook Image</h2><p>下载 Gitbook Docker 镜像，我选择了 <a href="https://hub.docker.com/r/billryan/gitbook">billryan/gitbook 镜像</a>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull billryan/gitbook</span><br></pre></td></tr></table></figure><p><code>mkdir gitbook</code> 创建一个 gitbook 路径，我们也可以将启动的镜像存储为另一个镜像：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># init</span></span><br><span class="line">docker run --rm -v <span class="string">&quot;<span class="variable">$PWD</span>/gitbook:/gitbook&quot;</span> -p 4000:4000 billryan/gitbook gitbook init</span><br><span class="line"><span class="comment"># serve</span></span><br><span class="line">docker run --rm -v <span class="string">&quot;<span class="variable">$PWD</span>/gitbook:/gitbook&quot;</span> -p 4000:4000 billryan/gitbook gitbook serve</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">docker ps <span class="comment"># Get CONTAINER ID of gitbook</span></span><br><span class="line">docker commit &lt;CONTAINER ID&gt; andylee/gitbook:1.0</span><br></pre></td></tr></table></figure><a id="more"></a><p>存储一个本地 docker 镜像，方便迁移到其他机器，存储和加载命令如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Save docker image</span></span><br><span class="line">docker save -o &lt;path <span class="keyword">for</span> generated tar file&gt; &lt;image name&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Load docker image</span></span><br><span class="line">docker load -i &lt;path to image tar file&gt; </span><br></pre></td></tr></table></figure><h2 id="Gitbook-build"><a href="#Gitbook-build" class="headerlink" title="Gitbook build"></a>Gitbook build</h2><p>我做了一个脚本 <code>gitbook.sh</code> 给 <code>Jenkins</code> 提供执行脚本，内容如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#GITBOOK_HOME=/home/lee/docker/gitbook/src</span></span><br><span class="line"><span class="comment"># Jenkins gitbook workspace</span></span><br><span class="line">GITBOOK_HOME=/home/lee/docker/jenkins/jenkins_home/workspace/gitbook</span><br><span class="line"><span class="comment"># Nginx static html</span></span><br><span class="line">STATIC_HTML=/home/lee/docker/nginx/static_html</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#rm -rf $GITBOOK_HOME/_book</span></span><br><span class="line">docker run --rm  -v <span class="variable">$GITBOOK_HOME</span>:/gitbook -p 4000:4000 andylee/gitbook:1.0 gitbook build</span><br><span class="line"><span class="comment"># docker run as root, so host can&#x27;t rewrite _book, which means gitbook only can be built one times. </span></span><br><span class="line"><span class="comment"># The following are two ways to fix this issue.</span></span><br><span class="line"><span class="comment"># 1. add &#x27;--user &quot;$(id -u):$(id -g)&quot;&#x27; , run docker as current user group, but fails to create /gitbook in docker.  ~Not work.</span></span><br><span class="line"><span class="comment"># 2. chown _book as current user group with root permission. ~Work.</span></span><br><span class="line">sudo -S su - &lt;&lt;EOF</span><br><span class="line">chown -R lee:lee <span class="variable">$GITBOOK_HOME</span>/_book</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment">#docker run  --rm -v $GITBOOK_HOME:/gitbook -p 4000:4000 andylee/gitbook:1.0 gitbook serve</span></span><br><span class="line"><span class="comment">#echo &quot;Execute docker with &#x27;$GITBOOK_HOME&#x27; successfully!&quot;</span></span><br><span class="line"></span><br><span class="line">rm -rf <span class="variable">$STATIC_HTML</span>/*</span><br><span class="line"><span class="comment"># Copy _book static html to Nginx server.</span></span><br><span class="line">cp -rf <span class="variable">$GITBOOK_HOME</span>/_book/* <span class="variable">$STATIC_HTML</span></span><br></pre></td></tr></table></figure><p>如果我们不用脚本或者想以一种简单的方式执行 docker，可以在 <code>.bashrc</code> 里添加别名。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">alias</span> gitbook=<span class="string">&#x27;docker run --rm  -v $GITBOOK_HOME:/gitbook -p 4000:4000 andylee/gitbook:1.0 gitbook&#x27;</span></span><br><span class="line"><span class="comment"># init</span></span><br><span class="line">gitbook init</span><br><span class="line"><span class="comment"># serve</span></span><br><span class="line">gitbook serve</span><br><span class="line"><span class="comment"># build</span></span><br><span class="line">gitbook build</span><br><span class="line"><span class="comment"># pdf output</span></span><br><span class="line">gitbook pdf .</span><br></pre></td></tr></table></figure><h1 id="GitLab"><a href="#GitLab" class="headerlink" title="GitLab"></a>GitLab</h1><h2 id="GitLab-Image"><a href="#GitLab-Image" class="headerlink" title="GitLab Image"></a>GitLab Image</h2><h3 id="Dockerfile"><a href="#Dockerfile" class="headerlink" title="Dockerfile"></a>Dockerfile</h3><p><code>mkdir gitlab</code> 创建一个 gitlab 路径，为了保证 <code>Clone with HTTP</code> 能正常使用，利用官方镜像做一个指定容器端口的镜像（官方默认为 80 ，一般会被占用），编写 Dockerfile 如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Use the official image</span></span><br><span class="line">FROM gitlab/gitlab-ee</span><br><span class="line"><span class="comment"># Add listening port of container</span></span><br><span class="line">EXPOSE 4002</span><br></pre></td></tr></table></figure><h3 id="Build-Docker"><a href="#Build-Docker" class="headerlink" title="Build Docker"></a>Build Docker</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker build --tag andylee/gitlab:1.0 . <span class="comment"># Execute in the folder where Dockerfile is</span></span><br></pre></td></tr></table></figure><h2 id="Run-GitLab-Docker"><a href="#Run-GitLab-Docker" class="headerlink" title="Run GitLab Docker"></a>Run GitLab Docker</h2><p>我做了一个<code>gitlab.sh</code>脚本来运行 GitLab Docker，如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line">GITLAB_CONFIG=/home/lee/docker/gitlab/config</span><br><span class="line">GITLAB_LOGS=/home/lee/docker/gitlab/logs</span><br><span class="line">GITLAB_DATA=/home/lee/docker/gitlab/data</span><br><span class="line"></span><br><span class="line">docker run -d -p 4043:443 -p 4002:4002 -p 4022:22 --name andylee-gitlab --restart always -v <span class="variable">$GITLAB_CONFIG</span>:/etc/gitlab -v <span class="variable">$GITLAP_LOGS</span>:/var/<span class="built_in">log</span>/gitlab -v <span class="variable">$GITLAB_DATA</span>:/var/opt/gitlab andylee/gitlab:1.0</span><br></pre></td></tr></table></figure><h2 id="Config-GitLab"><a href="#Config-GitLab" class="headerlink" title="Config GitLab"></a>Config GitLab</h2><p>配置 <code>gitlab.rb</code>.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># config/gitlab.rb</span></span><br><span class="line"><span class="comment"># 端口为容器中的端口</span></span><br><span class="line">external_url <span class="string">&#x27;http://192.168.81.64:4002&#x27;</span>  <span class="comment"># 如果不配置此项，Clone with HTTP 中的链接将有由容器 ID 代替，如 http://e6012f4a2630/gitlab-instance-de9e956b/monitoring.git</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 不配置如下内容，Clone with SSH 中链接将由容器 ID 代替，如 ssh://git@5ba03b6cd640/root/document.git</span></span><br><span class="line">gitlab_rails[<span class="string">&#x27;gitlab_ssh_host&#x27;</span>] = <span class="string">&#x27;192.168.81.64&#x27;</span></span><br><span class="line">gitlab_rails[<span class="string">&#x27;gitlab_shell_ssh_port&#x27;</span>] = 4022</span><br><span class="line"><span class="comment"># gitlab_rails[&#x27;gitlab_ssh_user&#x27;] = &#x27;root&#x27; . 可不配置</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># LDAP， Config LDAP authentication.</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="Issues"><a href="#Issues" class="headerlink" title="Issues"></a>Issues</h2><p><strong>问题一：</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gitlab Import url is blocked: <span class="string">&quot;Requests to the local network are not allowed&quot;</span></span><br></pre></td></tr></table></figure><p><strong>Solution:</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Admin -&gt; Settings -&gt; Network -&gt; Outbound Requests -&gt; Allow requests to the <span class="built_in">local</span> network from hooks and services</span><br></pre></td></tr></table></figure><p><strong>问题二：</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Cloning into &#39;document&#39;...</span><br><span class="line">ssh: connect to host 192.168.81.64 port 2202: Connection refused</span><br><span class="line">fatal: Could not read from remote repository.</span><br><span class="line"></span><br><span class="line">Please make sure you have the correct access rights</span><br></pre></td></tr></table></figure><p><strong>Solution:</strong><br>配置的 ssh 访问端口需要与启动容器时的映射端口保持一致，当前问题是由于 <code>gitlab.rb</code> 中错把端口配置为了 2202.</p><h1 id="Jenkins"><a href="#Jenkins" class="headerlink" title="Jenkins"></a>Jenkins</h1><h2 id="Jenkins-Image"><a href="#Jenkins-Image" class="headerlink" title="Jenkins Image"></a>Jenkins Image</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">docker pull jenkins/jenkins</span><br><span class="line"></span><br><span class="line">docker ps <span class="comment"># Get CONTAINER ID of jenkins</span></span><br><span class="line">docker commit &lt;CONTAINER ID&gt; andylee/jenkins:1.0</span><br></pre></td></tr></table></figure><h2 id="Run-Jenkins-Docker"><a href="#Run-Jenkins-Docker" class="headerlink" title="Run Jenkins Docker"></a>Run Jenkins Docker</h2><p>我做了一个<code>jenkins.sh</code>脚本来运行 Jenkins Docker，如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">JENKINS_HOME=/home/lee/docker/jenkins/jenkins_home</span><br><span class="line"></span><br><span class="line">docker run --name andylee-jenkins -d -v <span class="variable">$JENKINS_HOME</span>:/var/jenkins_home -p 4003:8080 -p 50000:50000 andylee/jenkins:1.0</span><br></pre></td></tr></table></figure><h2 id="Config"><a href="#Config" class="headerlink" title="Config"></a>Config</h2><p>这里只说一下注意事项和变化点，详细配置方式见<a href="http://huaqianlee.github.io/2019/05/05/Git/gitlab-jenkins-gitbook-to-create-LAN-gitbook/">Gitbook + Jenkins + Gitlab 搭建内网自动构建的 Gitbook</a>。</p><ol><li><p>Configure system -&gt; gitlab, 需要注意<code>Gitlab host URL</code>只需要填 server 地址。</p></li><li><p>Configure of project.  </p></li></ol><ul><li>Build Triggers<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 选中如下选项</span></span><br><span class="line">Build when a change is pushed to GitLab. GitLab webhook URL: http://192.168.81.64:4003/project/gitbook</span><br></pre></td></tr></table></figure></li><li>Build-&gt;Execute shell<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 首先需要将容器中的 ~/.ssh/id_rsa.pub 的内容追加到主机的 ～/.ssh/authorized_keys 中，不然会要求输入 ssh 密码。</span></span><br><span class="line"><span class="comment"># 通过 ssh 在主机中执行 gitbook.sh 脚本</span></span><br><span class="line">ssh -n -l lee 192.168.81.64 <span class="string">&quot;gitbook.sh&quot;</span></span><br></pre></td></tr></table></figure><blockquote><p>jenkins_home/jobs/gitbook/config.xml: <code>&lt;command&gt;ssh -n -l lee 192.168.81.64 &amp;quot;gitbook.sh&amp;quot;&lt;/command&gt;</code></p></blockquote></li></ul><ol start="3"><li>因为新版本的 Jenkins(当前使用的是 2.249) 已经不支持 disable CSRF， 我们必须在 Gitlab project 中的 webhook 配置上用户名，详细见如下问题二。</li></ol><h2 id="Issue"><a href="#Issue" class="headerlink" title="Issue"></a>Issue</h2><p><strong>问题一：</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">An error occurred during installation: No such plugin: cloudbees-folder</span><br></pre></td></tr></table></figure><p><strong>Solution:</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">1. modify https as http <span class="keyword">in</span> /var/lib/docker/volumes/jenkins-data/_data/hudson.model.UpdateCenter.xml </span><br><span class="line">2. http://localhost:4003/restart OR service jenkins restart</span><br></pre></td></tr></table></figure><p><strong>问题二：</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">HTTP ERROR 403 No valid crumb was included <span class="keyword">in</span> the request</span><br></pre></td></tr></table></figure><p><strong>Solution:</strong></p><ol><li>在<code>Jenkins</code> 中，通过<code>USER -&gt; Configure -&gt; API Token</code> 增加并保存 token 值（api key）。</li><li>在 <code>GitLab project</code> 的 <code>Setting -&gt;Webhooks</code>按照如下要求添加 webhook ，按照要求（此处要注意格式，需要第一步 Jenkins 额外创建一个api key ，让 GitLab 能够有权限触发 Jenkins）<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">URL:</span><br><span class="line">http://username:apikey@jenkins.url/project/myPullrequest/</span><br><span class="line"></span><br><span class="line">Secret Token: <span class="comment"># 似乎不是必须的</span></span><br><span class="line">apikey</span><br><span class="line"></span><br><span class="line">Example:</span><br><span class="line">http://root:1146cb664bbe589fd1a88fe42d24b64315@192.168.81.64:4003/project/gitbook</span><br></pre></td></tr></table></figure></li></ol><h1 id="Nginx"><a href="#Nginx" class="headerlink" title="Nginx"></a>Nginx</h1><h2 id="Nginx-Image"><a href="#Nginx-Image" class="headerlink" title="Nginx Image"></a>Nginx Image</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">docker pull nginx</span><br><span class="line"></span><br><span class="line">docker ps <span class="comment"># Get CONTAINER ID of nginx</span></span><br><span class="line">docker commit &lt;CONTAINER ID&gt; andylee/nginx:1.0</span><br></pre></td></tr></table></figure><h2 id="Run-Nginx-Docker"><a href="#Run-Nginx-Docker" class="headerlink" title="Run Nginx Docker"></a>Run Nginx Docker</h2><p>我做了一个<code>nginx.sh</code>脚本来运行 nginx Docker，如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line">STATIC_HTML=/home/lee/docker/nginx/static_html</span><br><span class="line"><span class="comment"># NGINX_CONFIG=/home/lee/docker/nginx/nginx.conf</span></span><br><span class="line"></span><br><span class="line">docker run --name andylee-nginx -p 4001:80 -v <span class="variable">$STATIC_HTML</span>:/usr/share/nginx/html:ro -d andylee/nginx:1.0</span><br><span class="line"><span class="comment"># docker run --name nginx -p 4001:80 -v $STATIC_HTML:/usr/share/nginx/html:ro -v $NGINX_CONFIG:/etc/nginx/nginx.conf:ro -d nginx</span></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Git </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>Oh, the Git! - detached HEAD</title>
      <link href="2020/03/08/Git/Some-knowledge-about-git-detached-HEAD/"/>
      <url>2020/03/08/Git/Some-knowledge-about-git-detached-HEAD/</url>
      
        <content type="html"><![CDATA[<p><code>detached HEAD</code> is a common situation, sometimes useful, sometimes dangerous. It doesn’t point to any branches, so it will be cleaned by <code>git</code>.</p><p>The current commit history is as follows:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">$ git <span class="built_in">log</span> --oneline --all --graph</span><br><span class="line">* 5ea3cec (HEAD -&gt; master) Modify README.md of src</span><br><span class="line">* 2b6e826 Same file, same blob</span><br><span class="line">* 1ff08f2 Modify README.md.</span><br><span class="line">* 8c19a38 Add Copyright notice.</span><br><span class="line">* 318c11a Copy css to lib.</span><br><span class="line">| * 1134f9e (dev) Make graph more readability</span><br><span class="line">| * 71c40d3 Modify README.md <span class="keyword">in</span> dev branch.</span><br><span class="line">|/</span><br><span class="line">* ce4297f Add image.</span><br><span class="line">| * 2cb23ac (dev-1.0) README <span class="keyword">for</span> dev-1.0 branch.</span><br><span class="line">|/</span><br><span class="line">* 6fc4b44 (tag: kikoff_tag) Copy doc README.md</span><br><span class="line">* 726c6c0 Add <span class="built_in">source</span> README.md</span><br><span class="line">* c8ff9c5 Add README</span><br></pre></td></tr></table></figure><a id="more"></a><h2 id="Create-detached-HEAD"><a href="#Create-detached-HEAD" class="headerlink" title="Create detached HEAD"></a>Create detached HEAD</h2><p>Create a detached HEAD by <code>git checkout</code> cmd.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$ git checkout 8c19a38</span><br><span class="line">Note: checking out <span class="string">&#x27;8c19a38&#x27;</span>.</span><br><span class="line"></span><br><span class="line">You are <span class="keyword">in</span> <span class="string">&#x27;detached HEAD&#x27;</span> state. You can look around, make experimental</span><br><span class="line">changes and commit them, and you can discard any commits you make <span class="keyword">in</span> this</span><br><span class="line">state without impacting any branches by performing another checkout.</span><br><span class="line"></span><br><span class="line">If you want to create a new branch to retain commits you create, you may</span><br><span class="line"><span class="keyword">do</span> so (now or later) by using -b with the checkout <span class="built_in">command</span> again. Example:</span><br><span class="line"></span><br><span class="line">  git checkout -b &lt;new-branch-name&gt;</span><br><span class="line"></span><br><span class="line">HEAD is now at 8c19a38 Add Copyright notice.</span><br></pre></td></tr></table></figure><blockquote><p>The note of git is important, it provides a lot information.</p></blockquote><h2 id="Check-the-current-HEAD"><a href="#Check-the-current-HEAD" class="headerlink" title="Check the current HEAD"></a>Check the current <code>HEAD</code></h2><p>We can see the current <code>HEAD</code> pointer points to ‘8c19a38’ by the following.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">$ cat .git/HEAD</span><br><span class="line">8c19a3856e27ff8e29171e49ccccdc042f1de32e</span><br><span class="line"></span><br><span class="line">$ git <span class="built_in">log</span> --oneline --all --graph</span><br><span class="line">* 5ea3cec (master) Modify README.md of src</span><br><span class="line">* 2b6e826 Same file, same blob</span><br><span class="line">* 1ff08f2 Modify README.md.</span><br><span class="line">* 8c19a38 (HEAD) Add Copyright notice. <span class="comment"># HEAD pointer, detached HEAD</span></span><br><span class="line">* 318c11a Copy css to lib.</span><br><span class="line">| * 1134f9e (dev) Make graph more readability</span><br><span class="line">| * 71c40d3 Modify README.md <span class="keyword">in</span> dev branch.</span><br><span class="line">|/</span><br><span class="line">* ce4297f Add image.</span><br><span class="line">| * 2cb23ac (dev-1.0) README <span class="keyword">for</span> dev-1.0 branch.</span><br><span class="line">|/</span><br><span class="line">* 6fc4b44 (tag: kikoff_tag) Copy doc README.md</span><br><span class="line">* 726c6c0 Add <span class="built_in">source</span> README.md</span><br><span class="line">* c8ff9c5 Add README</span><br></pre></td></tr></table></figure><h2 id="Add-a-commit"><a href="#Add-a-commit" class="headerlink" title="Add a commit"></a>Add a commit</h2><ul><li>Apply the following patch.</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">diff --git a/README.md b/README.md</span><br><span class="line">index a687b4c..16b8b3f 100644</span><br><span class="line">--- a/README.md</span><br><span class="line">+++ b/README.md</span><br><span class="line">@@ -1,3 +1,6 @@</span><br><span class="line"> Demonstration</span><br><span class="line"> ===</span><br><span class="line">+</span><br><span class="line">+detached HEAD.</span><br><span class="line">+</span><br></pre></td></tr></table></figure><ul><li>Generate commit <code>2457088</code> by <code>git add</code> and <code>git commit</code>.</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">$ git add .;git commit -m <span class="string">&quot;detached HEAD&quot;</span></span><br><span class="line">[detached HEAD 2457088] detached HEAD</span><br><span class="line"> 1 file changed, 3 insertions(+)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Check new HEAD.</span></span><br><span class="line">$ git <span class="built_in">log</span> --oneline --all --graph</span><br><span class="line">* 2457088 (HEAD) detached HEAD</span><br><span class="line">| * 5ea3cec (master) Modify README.md of src</span><br><span class="line">| * 2b6e826 Same file, same blob</span><br><span class="line">| * 1ff08f2 Modify README.md.</span><br><span class="line">|/</span><br><span class="line">* 8c19a38 Add Copyright notice.</span><br><span class="line">* 318c11a Copy css to lib.</span><br><span class="line">| * 1134f9e (dev) Make graph more readability</span><br><span class="line">| * 71c40d3 Modify README.md <span class="keyword">in</span> dev branch.</span><br><span class="line">|/</span><br><span class="line">* ce4297f Add image.</span><br><span class="line">| * 2cb23ac (dev-1.0) README <span class="keyword">for</span> dev-1.0 branch.</span><br><span class="line">|/</span><br><span class="line">* 6fc4b44 (tag: kikoff_tag) Copy doc README.md</span><br><span class="line">* 726c6c0 Add <span class="built_in">source</span> README.md</span><br><span class="line">* c8ff9c5 Add README</span><br></pre></td></tr></table></figure><h2 id="Switch-branch"><a href="#Switch-branch" class="headerlink" title="Switch branch"></a>Switch branch</h2><p>When we switch to master branch, <code>git</code> prompts us to create a branch for detached HEAD.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$ git checkout master</span><br><span class="line">Warning: you are leaving 1 commit behind, not connected to</span><br><span class="line">any of your branches:</span><br><span class="line"></span><br><span class="line">  2457088 detached HEAD</span><br><span class="line"></span><br><span class="line">If you want to keep it by creating a new branch, this may be a good time</span><br><span class="line">to <span class="keyword">do</span> so with:</span><br><span class="line"></span><br><span class="line"> git branch &lt;new-branch-name&gt; 2457088</span><br><span class="line"></span><br><span class="line">Switched to branch <span class="string">&#x27;master&#x27;</span></span><br></pre></td></tr></table></figure><h2 id="Check-commit-2457088"><a href="#Check-commit-2457088" class="headerlink" title="Check commit 2457088"></a>Check commit <code>2457088</code></h2><p>When I switch branches, commit <code>2457088</code> is gone, this is the dangerous part.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">$ git <span class="built_in">log</span> --oneline --all --graph</span><br><span class="line">* 5ea3cec (HEAD -&gt; master) Modify README.md of src</span><br><span class="line">* 2b6e826 Same file, same blob</span><br><span class="line">* 1ff08f2 Modify README.md.</span><br><span class="line">* 8c19a38 Add Copyright notice.</span><br><span class="line">* 318c11a Copy css to lib.</span><br><span class="line">| * 1134f9e (dev) Make graph more readability</span><br><span class="line">| * 71c40d3 Modify README.md <span class="keyword">in</span> dev branch.</span><br><span class="line">|/</span><br><span class="line">* ce4297f Add image.</span><br><span class="line">| * 2cb23ac (dev-1.0) README <span class="keyword">for</span> dev-1.0 branch.</span><br><span class="line">|/</span><br><span class="line">* 6fc4b44 (tag: kikoff_tag) Copy doc README.md</span><br><span class="line">* 726c6c0 Add <span class="built_in">source</span> README.md</span><br><span class="line">* c8ff9c5 Add README</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Git </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Tools </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Oh, the Git! - local .git</title>
      <link href="2020/03/07/Git/Some-knowledge-about-git-local-git/"/>
      <url>2020/03/07/Git/Some-knowledge-about-git-local-git/</url>
      
        <content type="html"><![CDATA[<p><code>.git</code> directory acts a major role in <code>git</code> VCS. We can do local verson management directly depended on <code>.git</code> directory. I will parse <code>.git</code> in current topic. </p><h1 id="Directory-tree"><a href="#Directory-tree" class="headerlink" title="Directory tree"></a>Directory tree</h1><p>First, I created a project and managed it through <code>git</code>, its directory tree is as follows:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">├── doc</span><br><span class="line">│   └── README.md</span><br><span class="line">├── .git</span><br><span class="line">│   ├── COMMIT_EDITMSG</span><br><span class="line">│   ├── config</span><br><span class="line">│   ├── description</span><br><span class="line">│   ├── HEAD</span><br><span class="line">│   ├── hooks</span><br><span class="line">│   │   ├── applypatch-msg.sample</span><br><span class="line">│   │   ├── commit-msg.sample</span><br><span class="line">│   │   ├── fsmonitor-watchman.sample</span><br><span class="line">│   │   ├── post-update.sample</span><br><span class="line">│   │   ├── pre-applypatch.sample</span><br><span class="line">│   │   ├── pre-commit.sample</span><br><span class="line">│   │   ├── prepare-commit-msg.sample</span><br><span class="line">│   │   ├── pre-push.sample</span><br><span class="line">│   │   ├── pre-rebase.sample</span><br><span class="line">│   │   ├── pre-receive.sample</span><br><span class="line">│   │   └── update.sample</span><br><span class="line">│   ├── index</span><br><span class="line">│   ├── info</span><br><span class="line">│   │   └── exclude</span><br><span class="line">│   ├── logs</span><br><span class="line">│   │   ├── HEAD</span><br><span class="line">│   │   └── refs</span><br><span class="line">│   │       └── heads</span><br><span class="line">│   │           ├── dev</span><br><span class="line">│   │           ├── dev-1.0</span><br><span class="line">│   │           └── master</span><br><span class="line">│   ├── objects</span><br><span class="line">│   │   ├── 02</span><br><span class="line">│   │   │   ├── 40351d75b3f451e0ec4b399c38c3758f007152</span><br><span class="line">│   │   │   └── d8eae705ebf203142fd2f381d3b216dde2b28f</span><br><span class="line">|   |   |...</span><br><span class="line">│   │   ├── c8</span><br><span class="line">│   │   │   └── ff9c55ce2651d8380a14bee5b43b37e14fa7fc</span><br><span class="line">│   │   ├── f0</span><br><span class="line">│   │   │   └── 45488f3fa9a350ac01f48f2b000fe51a53f5aa</span><br><span class="line">│   │   ├── info</span><br><span class="line">│   │   └── pack</span><br><span class="line">│   ├── ORIG_HEAD</span><br><span class="line">│   └── refs</span><br><span class="line">│       ├── heads</span><br><span class="line">│       │   ├── dev</span><br><span class="line">│       │   ├── dev-1.0</span><br><span class="line">│       │   └── master</span><br><span class="line">│       └── tags</span><br><span class="line">│           └── kikoff_tag</span><br><span class="line">├── img</span><br><span class="line">│   └── check.png</span><br><span class="line">├── lib</span><br><span class="line">│   └── css_practice_1.html</span><br><span class="line">├── README.md</span><br><span class="line">└── src</span><br><span class="line">    └── README.md</span><br></pre></td></tr></table></figure><a id="more"></a><h1 id="git-introduction"><a href="#git-introduction" class="headerlink" title=".git introduction"></a>.git introduction</h1><h2 id="git-HEAD"><a href="#git-HEAD" class="headerlink" title=".git/HEAD"></a>.git/HEAD</h2><p>It indicates which branch or commit the project works on. When the project works on a branch, the valuse of <code>.git/HEAD</code> is one reference. The details are as follows:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">$ cat .git/HEAD</span><br><span class="line">ref: refs/heads/dev-1.0</span><br><span class="line"></span><br><span class="line">$ git checkout master</span><br><span class="line">Switched to branch <span class="string">&#x27;master&#x27;</span></span><br><span class="line"></span><br><span class="line">$ cat .git/HEAD</span><br><span class="line">ref: refs/heads/master</span><br><span class="line"></span><br><span class="line">$ git checkout 8c19a3856 <span class="comment"># detached HEAD, 分离头指针</span></span><br><span class="line">Note: checking out <span class="string">&#x27;8c19a38&#x27;</span>.</span><br><span class="line">...</span><br><span class="line">HEAD is now at 8c19a38 Add Copyright notice.</span><br><span class="line"></span><br><span class="line">$ cat .git/HEAD  <span class="comment"># Point to commit when the project works on detached HEAD</span></span><br><span class="line">8c19a3856e27ff8e29171e49ccccdc042f1de32e</span><br></pre></td></tr></table></figure><h2 id="git-config"><a href="#git-config" class="headerlink" title=".git/config"></a>.git/config</h2><p><code>.git/config</code> is local git configuration,it has the highest priority, it will cover global and system configuration. As follows:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$ cat .git/config</span><br><span class="line">[core]</span><br><span class="line">        repositoryformatversion = 0</span><br><span class="line">        filemode = <span class="literal">false</span></span><br><span class="line">        bare = <span class="literal">false</span></span><br><span class="line">        logallrefupdates = <span class="literal">true</span></span><br><span class="line">        symlinks = <span class="literal">false</span></span><br><span class="line">        ignorecase = <span class="literal">true</span></span><br><span class="line">[user]</span><br><span class="line">        name = lihq0416</span><br><span class="line">        email = lihq0416@alsa.com</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>My global configuration is as follows:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">E:\code\Git\Demonstration&gt;git config --global --list</span><br><span class="line">user.name=huaqianlee</span><br><span class="line">user.email=huaqianlee@gmail.com</span><br></pre></td></tr></table></figure><p>The working configuration(user) is as follows:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ git <span class="built_in">log</span> -n1</span><br><span class="line">commit 8c19a3856e27ff8e29171e49ccccdc042f1de32e (HEAD -&gt; master)</span><br><span class="line">Author: lihq0416 &lt;lihq0416@alsa.com&gt;  <span class="comment"># the local user.</span></span><br><span class="line">Date:   Sun Mar 8 11:14:06 2020 +0800</span><br><span class="line"></span><br><span class="line">    Add Copyright notice.</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="git-refs"><a href="#git-refs" class="headerlink" title=".git/refs/"></a>.git/refs/</h2><p><code>.git/refs/</code> saves git reference, it replaces <code>SHA-1</code> with a simple string.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ ls .git/refs/</span><br><span class="line">heads/  tags/</span><br><span class="line"></span><br><span class="line">heads - branch HEAD  </span><br><span class="line">tags - milestone, tag reference</span><br></pre></td></tr></table></figure><h2 id="index"><a href="#index" class="headerlink" title="index"></a>index</h2><p>Git puts the file size, creation time, and last modification information in the index. </p><p>Git judges whether the blob has changed by comparing the current status with the content of index.</p><h3 id="git-refs-heads"><a href="#git-refs-heads" class="headerlink" title=".git/refs/heads/"></a>.git/refs/heads/</h3><p><code>.git/refs/heads</code> saves all branch name, as follows:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ ls .git/refs/heads/</span><br><span class="line">dev  dev-1.0  master</span><br></pre></td></tr></table></figure><p>we can get the original SHA-1 value by <code>cat</code>.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$ cat .git/refs/heads/master</span><br><span class="line">1ff08f245a3eaae8c5404cf3da2977a4637d3d68</span><br><span class="line"></span><br><span class="line">$ git cat-file -t 1ff08f2 <span class="comment"># cat type of object.</span></span><br><span class="line">commit</span><br><span class="line"></span><br><span class="line">$ cat .git/refs/heads/dev</span><br><span class="line">1134f9ee07daf1589ec9cc424dec587d119f8477</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$ cat .git/refs/heads/dev-1.0</span><br><span class="line">2cb23acda7fc092152fd63c5c13bda287765d9da</span><br></pre></td></tr></table></figure><p>Check the content <code>.git/refs/heads/master</code>.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">$ git cat-file -p 1ff08f2 <span class="comment"># cat content of object.</span></span><br><span class="line">tree ccb86ecb23a86d363868ede3f8597dade731aeac</span><br><span class="line">parent 8c19a3856e27ff8e29171e49ccccdc042f1de32e</span><br><span class="line">author lihq0416 &lt;lihq0416@alsa.com&gt; 1583640484 +0800</span><br><span class="line">committer lihq0416 &lt;lihq0416@alsa.com&gt; 1583640484 +0800</span><br><span class="line"></span><br><span class="line">Modify README.md.</span><br><span class="line"></span><br><span class="line">$ git show 1ff08f2 <span class="comment"># show the details.</span></span><br><span class="line">commit 1ff08f245a3eaae8c5404cf3da2977a4637d3d68 (HEAD -&gt; master)</span><br><span class="line">Author: lihq0416 &lt;lihq0416@alsa.com&gt;</span><br><span class="line">Date:   Sun Mar 8 12:08:04 2020 +0800</span><br><span class="line"></span><br><span class="line">    Modify README.md.</span><br><span class="line"></span><br><span class="line">diff --git a/README.md b/README.md</span><br><span class="line">index a687b4c..401b9a8 100644</span><br><span class="line">--- a/README.md</span><br><span class="line">+++ b/README.md</span><br><span class="line">@@ -1,3 +1,3 @@</span><br><span class="line"> Demonstration</span><br><span class="line"> ===</span><br><span class="line">-</span><br><span class="line">+For master.</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>The SHA-1 in <code>.git/refs/heads</code> is the HEAD pointer of every branch.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">$ git <span class="built_in">log</span> --oneline --all --graph</span><br><span class="line">* 1134f9e (dev) Make graph more readability <span class="comment"># dev HEAD</span></span><br><span class="line">* 71c40d3 Modify README.md <span class="keyword">in</span> dev branch.</span><br><span class="line">| * 1ff08f2 (HEAD -&gt; master) Modify README.md. <span class="comment"># master HEAD</span></span><br><span class="line">| * 8c19a38 Add Copyright notice.</span><br><span class="line">| * 318c11a Copy css to lib.</span><br><span class="line">|/</span><br><span class="line">* ce4297f Add image.</span><br><span class="line">| * 2cb23ac (dev-1.0) README <span class="keyword">for</span> dev-1.0 branch. <span class="comment"># dev-1.0 HEAD</span></span><br><span class="line">|/</span><br><span class="line">* 6fc4b44 (tag: kikoff_tag) Copy doc README.md</span><br><span class="line">* 726c6c0 Add <span class="built_in">source</span> README.md</span><br><span class="line">* c8ff9c5 Add README</span><br><span class="line"></span><br><span class="line">$ git branch -av</span><br><span class="line">  dev     1134f9e Make graph more readability</span><br><span class="line">  dev-1.0 2cb23ac README <span class="keyword">for</span> dev-1.0 branch.</span><br><span class="line">* master  1ff08f2 Modify README.md.</span><br></pre></td></tr></table></figure><h3 id="git-refs-tags"><a href="#git-refs-tags" class="headerlink" title=".git/refs/tags"></a>.git/refs/tags</h3><p><code>.git/refs/tags</code> save all tags, next, we analyze the <code>tag</code> reference. </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ cat .git/refs/tags/kikoff_tag</span><br><span class="line">6fc4b448eede8b86e0dff1156797a8b76b661c98</span><br></pre></td></tr></table></figure><p>Again, let’s look at the details of the <code>tag</code> object.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ git cat-file -t 6fc4b44</span><br><span class="line">commit</span><br><span class="line"></span><br><span class="line">$ git cat-file -p 6fc4b44</span><br><span class="line">tree e38a164f48baba5a6b6251d77926be66e77ae1c0</span><br><span class="line">parent 726c6c01c5bdfee5c477962f69f5313d868398db</span><br><span class="line">author lihq0416 &lt;lihq0416@alsa.com&gt; 1583636454 +0800</span><br><span class="line">committer lihq0416 &lt;lihq0416@alsa.com&gt; 1583636454 +0800</span><br><span class="line"></span><br><span class="line">Copy doc README.md</span><br></pre></td></tr></table></figure><p>it is the SHA-1 of <code>kikoff_tag</code> tag.</p><h2 id="git-objects"><a href="#git-objects" class="headerlink" title=".git/objects"></a>.git/objects</h2><p><code>.git/objects</code> saves all git objects.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ ls -l .git/objects/</span><br><span class="line">total 0</span><br><span class="line">drwxr-xr-x 1 Lee 197121 0 三月    8 11:45 02/</span><br><span class="line">drwxr-xr-x 1 Lee 197121 0 三月    8 12:10 11/</span><br><span class="line">...</span><br><span class="line">drwxr-xr-x 1 Lee 197121 0 三月    7 18:20 c8/</span><br><span class="line">drwxr-xr-x 1 Lee 197121 0 三月    8 11:45 dd/</span><br><span class="line">drwxr-xr-x 1 Lee 197121 0 三月    8 11:00 e3/</span><br><span class="line"><span class="comment"># if `02/,11/ ...` are too much, pack them into pack/, otherwise `info and pack are empty.</span></span><br><span class="line">drwxr-xr-x 1 Lee 197121 0 三月    7 18:16 info/</span><br><span class="line">drwxr-xr-x 1 Lee 197121 0 三月    7 18:16 pack/ </span><br></pre></td></tr></table></figure><p>List the contens of <code>c8/</code> and <code>dd/</code>, the content appends path name to the SHA-1.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ ls -l .git/objects/c8/</span><br><span class="line">total 1</span><br><span class="line">-r--r--r-- 1 Lee 197121 132 三月    7 18:20 ff9c55ce2651d8380a14bee5b43b37e14fa7fc</span><br><span class="line"></span><br><span class="line">$ ls .git/objects/dd/</span><br><span class="line">5ab753d33087eb06bd69b3a9317674638e6685  9f4c82726240a5289b5e6e33028bbcee8ac540</span><br></pre></td></tr></table></figure><p>Cat the contents of SHA-1.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">1. c8/ directory</span><br><span class="line"><span class="comment"># SHA-1: c8 + ff9c55ce2651d8380a14bee5b43b37e14fa7fc</span></span><br><span class="line">$ git cat-file -t c8ff9c55</span><br><span class="line">commit</span><br><span class="line"></span><br><span class="line">$ git cat-file -p c8ff9c55</span><br><span class="line">tree 567fa4f607ea3685f7957cf42d1569ada65eb53b</span><br><span class="line">author lihq0416 &lt;lihq0416@alsa.com&gt; 1583576427 +0800</span><br><span class="line">committer lihq0416 &lt;lihq0416@alsa.com&gt; 1583576427 +0800</span><br><span class="line"></span><br><span class="line">Add README</span><br><span class="line"></span><br><span class="line">2. dd/ directory</span><br><span class="line"><span class="comment"># SHA-1: dd + 5ab753d33087eb06bd69b3a9317674638e6685</span></span><br><span class="line">$ git cat-file -t dd5ab753</span><br><span class="line">tree </span><br><span class="line"></span><br><span class="line">$ git cat-file -p dd5ab753</span><br><span class="line">100644 blob 9bdec0343dd1dee61d37be2a4d678c1a43c20b69    README.md</span><br><span class="line">$ git cat-file -t 9bdec0343</span><br><span class="line">blob</span><br><span class="line">$ git cat-file -p 9bdec0343</span><br><span class="line">Hello, <span class="built_in">source</span> code!    <span class="comment"># Contents of README.md</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># SHA-1: dd + 9f4c82726240a5289b5e6e33028bbcee8ac540</span></span><br><span class="line">$ git cat-file -t dd9f4c82</span><br><span class="line">blob</span><br><span class="line">$ git cat-file -p dd9f4c82</span><br><span class="line">Demonstration</span><br><span class="line">===</span><br><span class="line"></span><br><span class="line">For dev-1.0.</span><br></pre></td></tr></table></figure><p>There are mainly three objects:</p><ul><li>tree : indicates a directory.</li><li>commit : indicates a commit(SHA-1).</li><li>blob: indicates a file, if the contents of two files are same, they saves as a same blob.</li></ul><h1 id="More-in-git"><a href="#More-in-git" class="headerlink" title="More in .git"></a>More in .git</h1><p># Todo</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">config       FETCH_HEAD   hooks/       info/        objects/     packed-refs</span><br><span class="line">description  HEAD         index        logs/        ORIG_HEAD    refs/</span><br></pre></td></tr></table></figure><h1 id="commit-tree-and-blob"><a href="#commit-tree-and-blob" class="headerlink" title="commit, tree and blob"></a>commit, tree and blob</h1><p><code>commit</code>, <code>tree</code> and <code>blob</code> are three main components of <code>.git</code>. I will introduce them by two examples.</p><p>The current commit history is as follows:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ git <span class="built_in">log</span> --oneline</span><br><span class="line">5ea3cec (HEAD -&gt; master) Modify README.md of src</span><br><span class="line">2b6e826 Same file, same blob</span><br><span class="line">1ff08f2 Modify README.md.</span><br><span class="line">8c19a38 Add Copyright notice.</span><br><span class="line">318c11a Copy css to lib.</span><br><span class="line">ce4297f Add image.</span><br><span class="line">6fc4b44 (tag: kikoff_tag) Copy doc README.md</span><br><span class="line">726c6c0 Add <span class="built_in">source</span> README.md</span><br><span class="line">c8ff9c5 Add README</span><br></pre></td></tr></table></figure><h2 id="Simple-one"><a href="#Simple-one" class="headerlink" title="Simple one"></a>Simple one</h2><p>First, list relationship flowchart.</p><p><img src="https://andylee-1258982386.cos.ap-chengdu.myqcloud.com/vcs/commit_tree_blob_first.png" alt="commit_tree_blob_first"></p><ul><li><p>Select the second commit <code>726c6c0</code> as benchmark.</p></li><li><p>Get the type and content of second commit <code>726c6c0</code>.</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ git cat-file -t 726c6c0</span><br><span class="line">commit</span><br><span class="line"></span><br><span class="line">$ git cat-file -p 726c6c0</span><br><span class="line">tree c72f3764e2179a8c61f0b948aca0b3720624b818</span><br><span class="line">parent c8ff9c55ce2651d8380a14bee5b43b37e14fa7fc</span><br><span class="line">author lihq0416 &lt;lihq0416@alsa.com&gt; 1583636339 +0800</span><br><span class="line">committer lihq0416 &lt;lihq0416@alsa.com&gt; 1583636339 +0800</span><br><span class="line"></span><br><span class="line">Add <span class="built_in">source</span> README.md</span><br></pre></td></tr></table></figure><ul><li>Get the content of <code>tree</code> object.</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ git cat-file -p  c72f3764</span><br><span class="line">100644 blob a687b4c895de1b963fd4648cd12d7b1040b406c0    README.md</span><br><span class="line">040000 tree dd5ab753d33087eb06bd69b3a9317674638e6685    src</span><br></pre></td></tr></table></figure><blockquote><p><code>100644</code> - blob; <code>040000</code> - tree</p></blockquote><ul><li>Get the contents of <code>blob</code> and <code>tree</code>.</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ git cat-file -p a687b4c</span><br><span class="line">Demonstration</span><br><span class="line">===</span><br><span class="line"></span><br><span class="line">$ git cat-file -p dd5ab75 <span class="comment"># tree</span></span><br><span class="line">100644 blob 9bdec0343dd1dee61d37be2a4d678c1a43c20b69    README.md</span><br><span class="line"></span><br><span class="line">$ git cat-file -p 9bdec03 <span class="comment"># Content of new blob.</span></span><br><span class="line">Hello, <span class="built_in">source</span> code!</span><br></pre></td></tr></table></figure><h2 id="Complex-one"><a href="#Complex-one" class="headerlink" title="Complex one"></a>Complex one</h2><p>First, list the relationship flowchart too.<br><img src="https://andylee-1258982386.cos.ap-chengdu.myqcloud.com/vcs/commit_tree_blob_second.png" alt="commit_tree_blob_second"></p><ul><li><p>Select a later commit <code>5ea3cec</code> to make the structure a bit more complicated.</p></li><li><p>Get the content of <code>commit</code>.</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ git cat-file -p 5ea3cec</span><br><span class="line">tree eda5671a377d2fcd258cfabbe13d0eaaff59a69a</span><br><span class="line">parent 2b6e8269574c910b51492ce4c6731a1820b8b5da</span><br><span class="line">author lihq0416 &lt;lihq0416@alsa.com&gt; 1583652333 +0800</span><br><span class="line">committer lihq0416 &lt;lihq0416@alsa.com&gt; 1583652333 +0800</span><br><span class="line"></span><br><span class="line">Modify README.md of src</span><br></pre></td></tr></table></figure><ul><li>Get the content of <code>tree</code>.</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ git cat-file -p eda567</span><br><span class="line">100644 blob 401b9a8be1ba5ce77df18d4038a58dbfa29e3122    README.md</span><br><span class="line">040000 tree 04a87dd49ac3c928b872613bb07e8545ba08493a    doc</span><br><span class="line">040000 tree bd5e80e9c3527d86ffdf7669521082ec282043d9    img</span><br><span class="line">040000 tree b2713206c3d2f15dd71b25d124189edd2e8beab8    lib</span><br><span class="line">040000 tree 8a55fe88f7a7129f5467d791e4f077c22c3b3bbd    src</span><br></pre></td></tr></table></figure><ul><li>Get the contents of <code>trees</code> and <code>blob</code>.</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">1. README.md</span><br><span class="line">$ git cat-file -p 401b9a8b</span><br><span class="line">Demonstration</span><br><span class="line">===</span><br><span class="line">For master.</span><br><span class="line"></span><br><span class="line">2. doc</span><br><span class="line">$ git cat-file -p  04a87dd4</span><br><span class="line">100644 blob 401b9a8be1ba5ce77df18d4038a58dbfa29e3122    README.md</span><br><span class="line"></span><br><span class="line"><span class="comment"># Because `doc/README.md` has the same content as root `README.md`</span></span><br><span class="line"><span class="comment"># Only one `blob` is saved to save space.</span></span><br><span class="line">$ git cat-file -p 401b9a8b</span><br><span class="line">Demonstration</span><br><span class="line">===</span><br><span class="line">For master.</span><br><span class="line"></span><br><span class="line">3. img</span><br><span class="line">$ git cat-file -p bd5e80e9</span><br><span class="line">100644 blob 5d3c270574c1ee7b58851757c7b09b45b0cca460    check.png</span><br><span class="line"></span><br><span class="line"><span class="comment"># The image is a binary</span></span><br><span class="line">$ git cat-file -p 5d3c270</span><br><span class="line">▒PNG</span><br><span class="line"></span><br><span class="line">IHDR&#123;T▒▒▒IDATx▒▒yx▒U▒▒<span class="comment">#k-▒f▒▒7▒8▒(t▒&amp;▒▒Vh▒▒▒▒▒2&quot;(茈▒▒▒▒A\▒.,▒</span></span><br><span class="line"></span><br><span class="line">4. lib</span><br><span class="line">$ git cat-file -p b271320</span><br><span class="line">100644 blob d1cd12a7b5b0fa570662c360a0aa5cacf2c11c85    css_practice_1.html</span><br><span class="line"></span><br><span class="line">$ git cat-file -p d1cd12a</span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">        &lt;head&gt;</span><br><span class="line">                &lt;title&gt;Boxes&lt;/title&gt;</span><br><span class="line">                        &lt;p&gt;</span><br><span class="line">                                Copyright by Lee.</span><br><span class="line">                        &lt;/p&gt;</span><br><span class="line">                &lt;/div&gt;</span><br><span class="line">        &lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br><span class="line"></span><br><span class="line">5. src</span><br><span class="line">$ git cat-file -p 8a55fe8</span><br><span class="line">100644 blob f045488f3fa9a350ac01f48f2b000fe51a53f5aa    README.md</span><br><span class="line"></span><br><span class="line">$ git cat-file -p f045488</span><br><span class="line">Hello, <span class="built_in">source</span> code!</span><br><span class="line"></span><br><span class="line">This is a demonstration of git.</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Git </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Tools </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Consolidating the foundation of Linux, vim</title>
      <link href="2020/02/06/Linux/Consolidating-the-foundation-of-Linux-vim/"/>
      <url>2020/02/06/Linux/Consolidating-the-foundation-of-Linux-vim/</url>
      
        <content type="html"><![CDATA[<h2 id="vim"><a href="#vim" class="headerlink" title="vim"></a>vim</h2><p>Global config.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/vimrc</span><br></pre></td></tr></table></figure><a id="more"></a><h2 id="Mode"><a href="#Mode" class="headerlink" title="Mode"></a>Mode</h2><h3 id="Normal-Mode"><a href="#Normal-Mode" class="headerlink" title="Normal Mode"></a>Normal Mode</h3><h4 id="Enter-insert-mode"><a href="#Enter-insert-mode" class="headerlink" title="Enter insert mode"></a>Enter insert mode</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">I/i</span><br><span class="line">i - Before cursor</span><br><span class="line">I - Beginning of line</span><br><span class="line"></span><br><span class="line">A/a</span><br><span class="line">a - After cursor</span><br><span class="line">A - End of line</span><br><span class="line"></span><br><span class="line">O/o</span><br><span class="line">o - Next line</span><br><span class="line">O - Last line</span><br><span class="line"></span><br><span class="line">cw -  Replace from the cursor to eh end of the word</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="Moves"><a href="#Moves" class="headerlink" title="Moves"></a>Moves</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Move around</span></span><br><span class="line">Use the arrow cursor keys , or <span class="string">&quot;h&quot;</span> to go left, <span class="string">&quot;j&quot;</span> to go down, <span class="string">&quot;k&quot;</span> to go up, <span class="string">&quot;l&quot;</span> to go right.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">0 - Go to the first column</span><br><span class="line">^ - Go to the first non-blank character of the line</span><br><span class="line">$ - Go to the last column</span><br><span class="line">g_ - Got to the last non-blank character of line</span><br><span class="line">fa - Go to next occurence of the letter `a` on the line.</span><br><span class="line">    , - Find the next occurrence</span><br><span class="line">    ; - Find the previous occurrence</span><br><span class="line">t, - Go to just before the character `,`</span><br><span class="line">3fa - Find the 3rd occurrence of `a` on this line</span><br><span class="line">F/T - Like `f` and `t` but backward</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">G -  Go last line</span><br><span class="line">gg -  Go first line</span><br><span class="line"></span><br><span class="line"><span class="comment"># Go specified line.</span></span><br><span class="line">NG  - Go to line N</span><br><span class="line">:N  - Go to line N</span><br><span class="line"></span><br><span class="line">w - Go to the start of the following word</span><br><span class="line">e - Go to the end of this word</span><br><span class="line"></span><br><span class="line">% - Go to the corresponding (, &#123;, [</span><br><span class="line"></span><br><span class="line">* - Go to next occurrence of the word under the cursor</span><br><span class="line"><span class="comment"># - Go to previous occurrence of the word under the cursor</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># search for pattern</span></span><br><span class="line">/pattern  </span><br><span class="line">n next </span><br><span class="line">N  above</span><br></pre></td></tr></table></figure><h4 id="Copy-Paste"><a href="#Copy-Paste" class="headerlink" title="Copy/Paste"></a>Copy/Paste</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">y -  Copy the content from the current cursor to next cursor. Controled by arrow keys or `h\j\k\l`</span><br><span class="line">yy -  Copy the current line </span><br><span class="line">3yy - Copy the following three lines.</span><br><span class="line">y$ -  Copy content from cursor to end of line.</span><br><span class="line"></span><br><span class="line">d  -  Delet the content from the current cursor to next cursor. Controled by arrow keys or `h\j\k\l`</span><br><span class="line">dd  -  Delete (and copy) the current line</span><br><span class="line">d$ -  Cut content from cursor to end of line.</span><br><span class="line"></span><br><span class="line">p -  Paste</span><br></pre></td></tr></table></figure><h4 id="Modify"><a href="#Modify" class="headerlink" title="Modify"></a>Modify</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">r -  Replace</span><br><span class="line">R -  Continuous replacement</span><br><span class="line">x  -  Delete one char</span><br><span class="line"></span><br><span class="line">dt<span class="string">&quot; - Remove everything until `&quot;</span>`</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="Undo-Redo"><a href="#Undo-Redo" class="headerlink" title="Undo/Redo"></a>Undo/Redo</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">u -  Undo</span><br><span class="line">Ctrl + r  -  Redo</span><br></pre></td></tr></table></figure><h4 id="Repeat-commands"><a href="#Repeat-commands" class="headerlink" title="Repeat commands"></a>Repeat commands</h4><ol><li><code>.</code> will repeat the last command.  </li><li><code>N&lt;command&gt;</code> will repeat the command N times  </li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># examples</span></span><br><span class="line">2dd  -  will delete 2 lines</span><br><span class="line">3p  -  will paste the text 3 <span class="built_in">times</span></span><br><span class="line">100idesu [ESC]  -  will write “desu desu desu desu desu desu desu desu desu desu desu desu desu desu desu desu desu desu desu desu desu desu desu desu desu desu desu desu desu desu desu desu desu desu desu desu desu desu desu desu desu desu desu desu desu desu desu desu desu desu desu desu desu desu desu desu desu desu desu desu desu desu desu desu desu desu desu desu desu desu desu desu desu desu desu desu desu desu desu desu desu desu desu desu desu desu desu desu desu desu desu desu desu desu desu desu desu desu desu desu”</span><br><span class="line">.  -  Just after the last <span class="built_in">command</span> will write again the 100 “desu”.</span><br><span class="line">3.  -  Will write 3 “desu” (and not 300, how clever).</span><br></pre></td></tr></table></figure><h4 id="Combination-command"><a href="#Combination-command" class="headerlink" title="Combination command"></a>Combination command</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">&lt;start position&gt;&lt;<span class="built_in">command</span>&gt;&lt;end position&gt;</span><br><span class="line">0y$ means</span><br><span class="line"></span><br><span class="line">0  -  go to the beginning of this line</span><br><span class="line">y  -  yank from here</span><br><span class="line">$  -  up to the end of this line</span><br><span class="line"></span><br><span class="line">ye - yank from here to the end of the word</span><br><span class="line">y2/foo - yank up to the second occurrence of “foo”.</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="comment"># These command can only be used after an operator in visual mode</span></span><br><span class="line">&lt;action&gt;a&lt;object&gt; </span><br><span class="line">&lt;action&gt;i&lt;object&gt;</span><br><span class="line"></span><br><span class="line">action: d (delete), y (yank), v (select <span class="keyword">in</span> visual mode)</span><br><span class="line">object:  `w` a word, `W` a WORD (extended word), `s` a sentence, `p` a paragraph. But also, natural character such as `<span class="string">&quot;, &#x27;, ), &#125;, ]`.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Suppose the cursor is on the first o of `(map (+) (&quot;</span>foo<span class="string">&quot;))`.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">vi&quot;</span> -  will select foo.</span><br><span class="line">va<span class="string">&quot;  -  will select &quot;</span>foo<span class="string">&quot;.</span></span><br><span class="line"><span class="string">vi)  -  will select &quot;</span>foo<span class="string">&quot;.</span></span><br><span class="line"><span class="string">va)  -  will select (&quot;</span>foo<span class="string">&quot;).</span></span><br><span class="line"><span class="string">v2i)  -  will select map (+) (&quot;</span>foo<span class="string">&quot;)</span></span><br><span class="line"><span class="string">v2a)  -  will select (map (+) (&quot;</span>foo<span class="string">&quot;))</span></span><br></pre></td></tr></table></figure><h3 id="Insert-Mode"><a href="#Insert-Mode" class="headerlink" title="Insert Mode"></a>Insert Mode</h3><p><code>Insert Mode</code> is edit mode, there is nothing to write.</p><h3 id="Command-Mode"><a href="#Command-Mode" class="headerlink" title="Command Mode"></a>Command Mode</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">:<span class="built_in">help</span></span><br><span class="line">:<span class="built_in">help</span> &lt;<span class="built_in">command</span>&gt;</span><br><span class="line"></span><br><span class="line">:<span class="built_in">set</span> nu (number)</span><br><span class="line">:<span class="built_in">set</span> nonu</span><br><span class="line"></span><br><span class="line">:<span class="built_in">set</span> mouse=a</span><br><span class="line"></span><br><span class="line">:<span class="built_in">set</span> hls[earch]    <span class="comment"># highlight seaching result</span></span><br><span class="line">:<span class="built_in">set</span> nohlsearch  <span class="comment"># Cancel highlighting</span></span><br><span class="line"></span><br><span class="line">:e &lt;patch/to/file&gt;  <span class="comment"># Open file.</span></span><br><span class="line">:saveas &lt;patch/to/file&gt; <span class="comment"># Save to/as &lt;patch/to/file&gt;</span></span><br><span class="line">:w filename , save as filename</span><br><span class="line">:q! <span class="comment"># Quit without saving</span></span><br><span class="line">:qa! <span class="comment"># Quit even if there are modified hidden buffers</span></span><br><span class="line">:wq, :x, or ZZ <span class="comment"># Save and quite,(:x only save if necessary)</span></span><br><span class="line">    Vim  写隐藏文件 .swap ，保存时才替换</span><br><span class="line"></span><br><span class="line"><span class="comment"># vi x.file y.file    </span></span><br><span class="line">:bn <span class="comment"># Show next file(buffer)</span></span><br><span class="line">:bp <span class="comment"># Show previous file(buffer)</span></span><br></pre></td></tr></table></figure><h3 id="Use-shell-commands-temporarily-in-Vim"><a href="#Use-shell-commands-temporarily-in-Vim" class="headerlink" title="Use shell commands temporarily in Vim."></a>Use shell commands temporarily in Vim.</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Convenient to copy patch information, etc.</span></span><br><span class="line">:! (eg, :!ifconfig) </span><br><span class="line">:！<span class="built_in">which</span> shutdown</span><br></pre></td></tr></table></figure><h3 id="Replace"><a href="#Replace" class="headerlink" title="Replace"></a>Replace</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">:s/old/new      <span class="comment"># Replace first ‘old’ of current line.</span></span><br><span class="line">:s/old/new/g    <span class="comment"># Replace all &#x27;old&#x27; of current line.</span></span><br><span class="line">:%s/old/new     <span class="comment"># Replace first &#x27;old&#x27; of every line of current file.</span></span><br><span class="line">:%s/old/new/g   <span class="comment"># Replace globally all &#x27;old&#x27; of current file.</span></span><br><span class="line">:3,5s/old/new(/g) <span class="comment"># Replace (all) &#x27;old&#x27; between 3 and 5 line.</span></span><br></pre></td></tr></table></figure><h3 id="Visual-Mode"><a href="#Visual-Mode" class="headerlink" title="Visual Mode"></a>Visual Mode</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># enter visual mode</span></span><br><span class="line">v <span class="comment"># Character visual mode, operate in units of characters.</span></span><br><span class="line">V <span class="comment"># Line visual mode, Operate in uinits of lines.</span></span><br><span class="line">Ctrl + v <span class="comment"># Block visual mode, Operate in uinits of blocks.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># operating cmd</span></span><br><span class="line"><span class="string">&#x27;I&#x27;</span>     <span class="comment"># Insert content in the upper left corner of the block.</span></span><br><span class="line"><span class="string">&#x27;Esc&#x27;</span>   <span class="comment"># Press behind `I` in succession, insert the same content at the beginning of the block line.</span></span><br><span class="line"><span class="string">&#x27;d&#x27;</span>     <span class="comment"># Delete the block.</span></span><br></pre></td></tr></table></figure><h2 id="More"><a href="#More" class="headerlink" title="More"></a>More</h2><p><a href="http://huaqianlee.github.io/2020/11/19/Linux/Consolidating-the-foundation-of-Linux-vim-tips/">Consolidating the foundation of Linux, vim tips</a>.</p><h1 id="CMDs"><a href="#CMDs" class="headerlink" title="CMDs"></a>CMDs</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># fun cmds</span><br><span class="line">:h!</span><br><span class="line">:h 42</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Tools </tag>
            
            <tag> Vim </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Consolidating the foundation of Linux, basic cmds</title>
      <link href="2020/02/06/Linux/Consolidating-the-foundation-of-Linux-basic-cmds/"/>
      <url>2020/02/06/Linux/Consolidating-the-foundation-of-Linux-basic-cmds/</url>
      
        <content type="html"><![CDATA[<h2 id="Command-Interface"><a href="#Command-Interface" class="headerlink" title="Command Interface"></a>Command Interface</h2><p>We can enter command interface via the following ways.</p><ol><li>Excute <code>init 3</code> with root. <blockquote><p>init run at runlevel 3.  </p></blockquote></li><li>Hotkey: Ctrl + ALt + F1/2/3/…</li></ol><h3 id="init"><a href="#init" class="headerlink" title="init"></a>init</h3><p><code>init</code> is the first process, it commonly locates on <code>/sbin/init</code>, if kernel can’t find <code>init</code>, it will try to run <code>/bin/sh</code>, if the operation fails , the OS will fail to start successfully. </p><p><code>init</code> has 7 runlevels, we can check the default runlevel and runlevels in <code>/etc/inittab</code>. As follows:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># Default runlevel. The runlevels used are:</span><br><span class="line">#   0 - halt (Do NOT set initdefault to this)</span><br><span class="line">#   1 - Single user mode(root)</span><br><span class="line">#   2 - Multiuser, without NFS (The same as 3, if you do not have networking)</span><br><span class="line">#   3 - Full multiuser mode(standard runlevel)</span><br><span class="line">#   4 - unused(secure mode)</span><br><span class="line">#   5 - X11(user interface)</span><br><span class="line">#   6 - reboot (Do NOT set initdefault to this)</span><br><span class="line">#</span><br><span class="line">id:5:initdefault:</span><br></pre></td></tr></table></figure><a id="more"></a><h3 id="Command-related-Directoriesran"><a href="#Command-related-Directoriesran" class="headerlink" title="Command-related Directoriesran"></a>Command-related Directoriesran</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;etc - configuration file directory</span><br><span class="line">&#x2F;bin - command directory</span><br><span class="line">&#x2F;sbin -  management command directory</span><br><span class="line">&#x2F;usr&#x2F;bin &amp; &#x2F;usr&#x2F;sbin Other commands pre-installed on the system</span><br></pre></td></tr></table></figure><h2 id="Help-Commands"><a href="#Help-Commands" class="headerlink" title="Help Commands"></a>Help Commands</h2><p>This part is very important, we can learn all the commands with the following help commands.</p><h3 id="man-manual"><a href="#man-manual" class="headerlink" title="man(manual)"></a>man(manual)</h3><p><code>man</code> has 9 setctions, we can check them via <code>man man</code>, as follows:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">MANUAL SECTIONS</span><br><span class="line">The standard sections of the manual include:</span><br><span class="line"></span><br><span class="line">       1      User Commands</span><br><span class="line"></span><br><span class="line">       2      System Calls</span><br><span class="line"></span><br><span class="line">       3      C Library Functions</span><br><span class="line"></span><br><span class="line">       4      Devices and Special Files</span><br><span class="line"></span><br><span class="line">       5      File Formats and Conventions</span><br><span class="line"></span><br><span class="line">       6      Games et. Al.</span><br><span class="line"></span><br><span class="line">       7      Miscellanea</span><br><span class="line"></span><br><span class="line">       8      System Administration tools and Daemons</span><br><span class="line"></span><br><span class="line">       9      Kernel routines</span><br></pre></td></tr></table></figure><p>Manual sections are used to distinguish different parameters. For example, when there is a parameter with the same name, that the category is different. we can specify by sections.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">man (1) man <span class="comment"># default is 1</span></span><br></pre></td></tr></table></figure><p>When we do not know the classification, all manuals can be got as follows.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">man -a passwd</span><br></pre></td></tr></table></figure><h3 id="help"><a href="#help" class="headerlink" title="help"></a>help</h3><p>Before introducing this command, we need to figure out two concepts. As follows:</p><ol><li>Builtin commands : come with shell.</li><li>External commands : the others.</li></ol><p>We can figure out what type a command belongs to depend on the following way:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">type</span> &lt;<span class="built_in">command</span>&gt;  <span class="comment"># print the type of command</span></span><br><span class="line"></span><br><span class="line">example:</span><br><span class="line">[lee@lee-server bin]$ <span class="built_in">type</span> ls</span><br><span class="line">ls is aliased to `ls --color=auto<span class="string">&#x27;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[lee@lee-server bin]$ type cd</span></span><br><span class="line"><span class="string">cd is a shell builtin</span></span><br></pre></td></tr></table></figure><p>Different types of commands have different execution formats, as follows:<br>Builtin commands:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">help</span> &lt;<span class="built_in">command</span>&gt;</span><br><span class="line"><span class="built_in">help</span> <span class="built_in">cd</span></span><br></pre></td></tr></table></figure><p>External commands:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;<span class="built_in">command</span>&gt; --<span class="built_in">help</span></span><br><span class="line">ls --<span class="built_in">help</span></span><br></pre></td></tr></table></figure><h3 id="info"><a href="#info" class="headerlink" title="info"></a>info</h3><p><code>info</code> is more detailed command than <code>help.</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">info &lt;<span class="built_in">command</span>&gt;</span><br><span class="line">info ls</span><br></pre></td></tr></table></figure><h2 id="Basic-commands"><a href="#Basic-commands" class="headerlink" title="Basic commands"></a>Basic commands</h2><h3 id="Switch-Account"><a href="#Switch-Account" class="headerlink" title="Switch Account"></a>Switch Account</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">su - &lt;usr&gt;</span><br></pre></td></tr></table></figure><h3 id="pwd"><a href="#pwd" class="headerlink" title="pwd"></a>pwd</h3><p><code>man pwd</code>:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">NAME</span><br><span class="line">       <span class="built_in">pwd</span> - <span class="built_in">print</span> name of current/working directory</span><br><span class="line"></span><br><span class="line">SYNOPSIS</span><br><span class="line">       <span class="built_in">pwd</span> [OPTION]...</span><br><span class="line"></span><br><span class="line">DESCRIPTION</span><br><span class="line">       Print the full filename of the current working directory.</span><br><span class="line"></span><br><span class="line">       -L, --logical</span><br><span class="line">              use PWD from environment, even <span class="keyword">if</span> it contains symlinks</span><br><span class="line"></span><br><span class="line">       -P, --physical</span><br><span class="line">              avoid all symlinks</span><br><span class="line"></span><br><span class="line">       --<span class="built_in">help</span> display this <span class="built_in">help</span> and <span class="built_in">exit</span></span><br><span class="line"></span><br><span class="line">       --version</span><br><span class="line">              output version information and <span class="built_in">exit</span></span><br><span class="line"></span><br><span class="line">       NOTE:  your  shell may have its own version of <span class="built_in">pwd</span>, <span class="built_in">which</span> Commonly supersedes the version described here.  Please refer to your shell’s</span><br><span class="line">       documentation <span class="keyword">for</span> details about the options it supports.</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="ls"><a href="#ls" class="headerlink" title="ls"></a>ls</h3><p>Basic usage:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[lee@lee-server bin]$ ls /home / /home/*</span><br><span class="line">[sudo] password <span class="keyword">for</span> lee: </span><br><span class="line">/:</span><br><span class="line">bin  boot  devetc  home  liblost+found  media  misc  mnt  net  optproc  root  sbin  selinux  srvsys  tmp  usr  var</span><br><span class="line"></span><br><span class="line">/home:</span><br><span class="line">lee  lost+found</span><br><span class="line"></span><br><span class="line">/home/lee:</span><br><span class="line">bin  blog  Desktop  Documents  Downloads  lee  mbr2.bin  mbr.bin  Music  Pictures  Public  script  server  Templates  Videos</span><br><span class="line"></span><br><span class="line">/home/lost+found:</span><br></pre></td></tr></table></figure><p>Common options:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">-a, --all</span><br><span class="line">      <span class="keyword">do</span> not ignore entries starting with .</span><br><span class="line">-l    use a long listing format</span><br><span class="line">-r, --reverse</span><br><span class="line">      reverse order <span class="keyword">while</span> sorting</span><br><span class="line">-R, --recursive</span><br><span class="line">      list subdirectories recursively</span><br><span class="line">-t    sort by modification time</span><br></pre></td></tr></table></figure><h3 id="cd"><a href="#cd" class="headerlink" title="cd"></a>cd</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> - <span class="comment"># change to $(OLDPWD)</span></span><br></pre></td></tr></table></figure><h3 id="mkdir"><a href="#mkdir" class="headerlink" title="mkdir"></a>mkdir</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">mkdir - Create the DIRECTORY(ies), <span class="keyword">if</span> they <span class="keyword">do</span> not already exist.</span><br><span class="line">rmdir - Remove the DIRECTORY(ies), <span class="keyword">if</span> they are empty.</span><br><span class="line"></span><br><span class="line">Option:</span><br><span class="line">-p, --parents   create/remove DIRECTORY and its ancestors; e.g., `mkdir/rmdir -p a/b/c<span class="string">&#x27; is</span></span><br><span class="line"><span class="string">                    similar to `mkdir/rmdir a/b/c a/b a&#x27;</span></span><br><span class="line"></span><br><span class="line">rm  - Remove (unlink) the FILE(s).</span><br><span class="line"></span><br><span class="line">Option:</span><br><span class="line">  -f, --force           ignore nonexistent files, never prompt</span><br><span class="line">  -r, -R, --recursive   remove directories and their contents recursively</span><br></pre></td></tr></table></figure><h3 id="cp"><a href="#cp" class="headerlink" title="cp"></a>cp</h3><p>Common options:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">-a, --archive</span><br><span class="line">        same as -dR --preserve=all; 保留源文件所有信息</span><br><span class="line">-p     same as --preserve=mode,ownership,timestamps; 保留源文件时间</span><br><span class="line">-R, -r, --recursive</span><br><span class="line">        copy directories recursively</span><br><span class="line">-v, --verbose</span><br><span class="line">        explain what is being <span class="keyword">done</span></span><br></pre></td></tr></table></figure><h3 id="cat"><a href="#cat" class="headerlink" title="cat"></a>cat</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">cat - Concatenate FILE(s), or standard input, to standard output.</span><br><span class="line"></span><br><span class="line">head - output the first part of files</span><br><span class="line">        With no FILE, or when FILE is -, <span class="built_in">read</span> standard input. </span><br><span class="line">    -n   output the fist n lines instead of the first 10(default value)</span><br><span class="line"></span><br><span class="line">tail - output the last part of files</span><br><span class="line">    -n  output the last n lines instead of the last 10(default value)</span><br><span class="line">    -f  output appended data as the file grows, eg, get the logs.</span><br><span class="line"></span><br><span class="line">wc - <span class="built_in">print</span> newline, word, and byte counts <span class="keyword">for</span> each file</span><br><span class="line">    -l, --lines</span><br><span class="line">        <span class="built_in">print</span> the newline counts</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">more - More is a filter <span class="keyword">for</span> paging through text one screenful at a time.</span><br><span class="line">less</span><br></pre></td></tr></table></figure><h3 id="Compression-and-decompression"><a href="#Compression-and-decompression" class="headerlink" title="Compression and decompression"></a>Compression and decompression</h3><p>Common commands:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># compression rate increases in turn.</span></span><br><span class="line">tar </span><br><span class="line">gzip</span><br><span class="line">bzip2</span><br></pre></td></tr></table></figure><p>Commond suffix:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">.tar.gz </span><br><span class="line">.tar.bz2 </span><br><span class="line">.tgz</span><br></pre></td></tr></table></figure><p>Compress:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">tar -c  </span><br><span class="line">tar czf ，integrate gzip，fast but low compression rate.  common suffix is <span class="string">&#x27;.tar.gz&#x27;</span></span><br><span class="line">tar cjf , integrate bzip2 , slow but high compression rate. Common suffix is <span class="string">&#x27;.tar.bz2&#x27;</span></span><br></pre></td></tr></table></figure><p>Extract:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">tar xf -C &lt;out_dir&gt; </span><br><span class="line">    zxf</span><br><span class="line">    jxf</span><br></pre></td></tr></table></figure><h3 id="Wildcard"><a href="#Wildcard" class="headerlink" title="Wildcard"></a>Wildcard</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">*  any string</span><br><span class="line">？ one char,  file? = filea, fileb  not fileab</span><br><span class="line">[xyz]  one of xyz</span><br><span class="line">[a~z]  range between a and z</span><br><span class="line">[!xyz] or [^xyz] not one of xyz</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Tools </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Ubuntu 卡死了怎么办？</title>
      <link href="2019/11/25/Linux/How-to-save-dead-ubuntu/"/>
      <url>2019/11/25/Linux/How-to-save-dead-ubuntu/</url>
      
        <content type="html"><![CDATA[<p>在使用 Ubuntu 的时候，有时候会遇到卡死的问题，然后电脑完全不能使用。这时候怎么办呢，我通常是通过如下两种方式进行处理：  </p><h2 id="Kill-process"><a href="#Kill-process" class="headerlink" title="Kill process"></a><code>Kill process</code></h2><p>当我们明确知道什么进程导致系统卡死的时候，譬如文件管理器，我们可以通过如下两种方式进入字符终端找到假死的进程然后 kill 掉。  </p><ol><li><code>Ctrl + Alt + F1</code> 进入，<code>Ctrl + Alt + F7</code>  回到 UI 。</li><li><code>ssh user@ip</code> 远程登入。</li></ol><p>杀死进程的方式，我常用的有三种，如下：</p><ol><li><code>Top</code> 或者 <code>htop</code> 找到造成假死的进程并 <code>kill</code>。</li><li>通过名字或者进程 PID 去杀进程。<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ps -A |grep nautilus  <span class="comment"># 查看文件管理器的 PID</span></span><br><span class="line"><span class="built_in">kill</span> PID</span><br><span class="line"></span><br><span class="line"><span class="comment"># 以名字的形式杀掉进程</span></span><br><span class="line">killall nautilus </span><br></pre></td></tr></table></figure></li></ol><h2 id="Log-out"><a href="#Log-out" class="headerlink" title="Log out"></a><code>Log out</code></h2><p>注销桌面重新登录：  </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo pkill Xorg</span><br><span class="line">或者</span><br><span class="line">sudo restart lightdm</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Issues </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Oh, the Git! - Basic</title>
      <link href="2019/11/17/Git/Some-knowledge-about-git/"/>
      <url>2019/11/17/Git/Some-knowledge-about-git/</url>
      
        <content type="html"><![CDATA[<h1 id="Preface"><a href="#Preface" class="headerlink" title="Preface"></a>Preface</h1><p>Git has always been a must-have skill for developers, I will submize a series of blogs related to it, although I don’t know too much about git now.</p><p><a href="https://git-scm.com/book/en/v2">Pro Git</a> is the best guide of git, I need to read it when I have plenty of time so that I can check for gaps.</p><h1 id="VCS-Version-Control-System"><a href="#VCS-Version-Control-System" class="headerlink" title="VCS(Version Control System)"></a>VCS(Version Control System)</h1><h2 id="Central-VCS"><a href="#Central-VCS" class="headerlink" title="Central VCS"></a>Central VCS</h2><p>Central VCS mainly includes <code>SVN</code> and <code>CVS</code>, its newwork architecture is client-server.<br><img src="https://andylee-1258982386.cos.ap-chengdu.myqcloud.com/vcs/Central%20VCS.jpg" alt="Central VCS"></p><a id="more"></a><p>Advantages:</p><ul><li>Centralized version management.</li><li>Supports file version management and branch management.</li></ul><p>Disadvantages:</p><ul><li>The client must remain connected to the server at all times.</li></ul><h2 id="Distributed-VCS"><a href="#Distributed-VCS" class="headerlink" title="Distributed VCS"></a>Distributed VCS</h2><p>Distributed VCS mainly includes <code>Git</code> and <code>Mercurial</code>,its network architecture is distributied.<br><img src="https://andylee-1258982386.cos.ap-chengdu.myqcloud.com/vcs/Distributed%20VCS.jpg" alt="Distributed VCS"></p><p>Advantages:</p><ul><li>Complete repositories on both server and client.</li><li>The client can manage the version independently.</li><li>Most operations without relying on the server.</li></ul><h1 id="Config"><a href="#Config" class="headerlink" title="Config"></a>Config</h1><h2 id="Config-user"><a href="#Config-user" class="headerlink" title="Config user"></a>Config user</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">git config --[ <span class="built_in">local</span> | global | system ] user.name <span class="string">&quot;your_name&quot;</span></span><br><span class="line">git config --[ <span class="built_in">local</span> | global | system ] user.email <span class="string">&quot;your_email@domain.com&quot;</span>   <span class="comment"># email notification</span></span><br><span class="line"></span><br><span class="line">git config --<span class="built_in">local</span> <span class="comment"># Valid for the current repository, if no option defualts to local</span></span><br><span class="line">git config --global <span class="comment"># Valid for the current user.</span></span><br><span class="line">git config --system <span class="comment"># Valid for all user.</span></span><br></pre></td></tr></table></figure><blockquote><p>local - .git/config.<br>global - ~/.gitconfig.<br>system - git installation path.</p></blockquote><h2 id="Check-configuration"><a href="#Check-configuration" class="headerlink" title="Check configuration"></a>Check configuration</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git config --list --<span class="built_in">local</span> <span class="comment"># Highest priority</span></span><br><span class="line">git config --list --global <span class="comment"># Higher priority</span></span><br><span class="line">git config --list --system <span class="comment"># Low priority</span></span><br></pre></td></tr></table></figure><h2 id="Clean-configuration"><a href="#Clean-configuration" class="headerlink" title="Clean configuration"></a>Clean configuration</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git config --<span class="built_in">unset</span> --<span class="built_in">local</span> user.name</span><br><span class="line">git config --<span class="built_in">unset</span> --global user.name</span><br><span class="line">git config --<span class="built_in">unset</span> --system user.name</span><br></pre></td></tr></table></figure><h1 id="Basic-usage"><a href="#Basic-usage" class="headerlink" title="Basic usage"></a>Basic usage</h1><h2 id="Init-git-repository"><a href="#Init-git-repository" class="headerlink" title="Init git repository"></a>Init git repository</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> &lt;project&gt;</span><br><span class="line">git init</span><br><span class="line"></span><br><span class="line">or </span><br><span class="line"></span><br><span class="line">git init &lt;project&gt;</span><br></pre></td></tr></table></figure><h2 id="Work-flow"><a href="#Work-flow" class="headerlink" title="Work flow"></a>Work flow</h2><p>Basic cmds:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">git add [&lt;file&gt; | .]  <span class="comment"># . : All unstracked files of current project.</span></span><br><span class="line">git commit [--allow-empty] [-m &lt;msg&gt;]</span><br><span class="line">git commit --amend <span class="comment"># apend the current staging area to last commit.</span></span><br><span class="line">git push</span><br></pre></td></tr></table></figure><p>Work flow:</p><p><img src="https://andylee-1258982386.cos.ap-chengdu.myqcloud.com/vcs/vcs_work_flow.jpg" alt="Work flow"></p><h1 id="Tips"><a href="#Tips" class="headerlink" title="Tips"></a>Tips</h1><p>I list some commands I often use as follows.</p><h2 id="help"><a href="#help" class="headerlink" title="help"></a>help</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">help</span> </span><br><span class="line">git <span class="built_in">help</span> -a/-g </span><br><span class="line">git &lt;<span class="built_in">command</span>&gt; --<span class="built_in">help</span></span><br><span class="line">git <span class="built_in">help</span> &lt;<span class="built_in">command</span>&gt;</span><br></pre></td></tr></table></figure><h2 id="Rename"><a href="#Rename" class="headerlink" title="Rename"></a>Rename</h2><p>We can rename one files as follows:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mv name new_name</span><br><span class="line">git add new_name</span><br><span class="line">git rm name</span><br></pre></td></tr></table></figure><p>The better way:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git mv name new_name</span><br></pre></td></tr></table></figure><h2 id="log"><a href="#log" class="headerlink" title="log"></a>log</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">log</span> --oneline -n&lt;number&gt; <span class="comment"># -n : last &lt;number&gt; record </span></span><br><span class="line">git <span class="built_in">log</span> --onelie --all -n5 --graph <span class="comment"># --all: all branches. </span></span><br><span class="line">git <span class="built_in">log</span> &lt;branch&gt; <span class="comment"># check specified branch</span></span><br></pre></td></tr></table></figure><h2 id="diff"><a href="#diff" class="headerlink" title="diff"></a>diff</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">git diff [-- filename] <span class="comment"># woking directory compares to staging area.</span></span><br><span class="line">git diff HEAD <span class="comment"># woking directory compares to HEAD</span></span><br><span class="line">git diff --cached | --staged  <span class="comment"># staging area compares to HEAD</span></span><br><span class="line"></span><br><span class="line">git diff HEAD  HEAD~1 | HEAD^ / HEAD~2 | HEAD^^ | HEAD^2</span><br><span class="line"><span class="comment"># &#x27;^2&#x27; means the second parent</span></span><br><span class="line"><span class="comment"># &#x27;~2&#x27; means the parent of its parent</span></span><br><span class="line"><span class="comment"># A node can contain multiple sub-nodes (checkout multiple branches)</span></span><br><span class="line"><span class="comment"># A node can have multiple parent nodes (multiple branches merged)</span></span><br></pre></td></tr></table></figure><blockquote><p><code>--</code> of <code>-- filename</code> is to disambiguate. </p></blockquote><h2 id="checkout"><a href="#checkout" class="headerlink" title="checkout"></a>checkout</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">git checkout -b &lt;branch&gt; <span class="comment"># Create and checkout &lt;branch&gt;</span></span><br><span class="line">git checkout <span class="comment"># Switch branches or restore working tree files</span></span><br><span class="line">git checkout . | [--] filename  <span class="comment"># Restore current git or specified files. </span></span><br><span class="line">git checkout SHA-1 <span class="comment"># Switch to SHA-1, detached HEAD situation.</span></span><br><span class="line">git checkout -b new_branch  base_branch_or_commit <span class="comment"># Create and swith new_branch based on branch or commit.</span></span><br></pre></td></tr></table></figure><h2 id="reset"><a href="#reset" class="headerlink" title="reset"></a>reset</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">git reset HEAD [-- filename]<span class="comment"># HEAD and Staging area ponit to HEAD, unstage files.</span></span><br><span class="line">git reset --hard <span class="comment"># clean staging area and working dirctory, </span></span><br><span class="line"></span><br><span class="line">git reset --soft|hard|mixed &lt;commit&gt;</span><br><span class="line">--soft: HEAD points to the specified commit, staging area and woking directory keep as they are. </span><br><span class="line">--hard: HEAD, Staging area and woking directory point to the specified commit.</span><br><span class="line">--mixed: default option, HEAD and Staging area point to the specified commit, woking directory keep as it is.</span><br></pre></td></tr></table></figure><h2 id="rebase"><a href="#rebase" class="headerlink" title="rebase"></a>rebase</h2><p>Works with <a href="http://huaqianlee.github.io/2020/03/08/Git/Some-knowledge-about-git-detached-HEAD/">detached HEAD</a>.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">git rebase -i start_sha-1  [end_sha-1]</span><br><span class="line"><span class="comment"># sha-1 is the oldest commit&#x27;s parent, whose we want to modify</span></span><br><span class="line"><span class="comment"># If the oldest commit is the first commit, choose the oldest one and add it manully in interactive interface.</span></span><br><span class="line"><span class="comment"># if we specify end_sha-1, one detached HEAD will be created.</span></span><br><span class="line"><span class="comment"># if end_sha-1 is not specified, use the lastest sha-1, all sha-1 from start_sha-1 will change, HEAD and &lt;branch&gt; will point to HEAD of detached HEAD.</span></span><br></pre></td></tr></table></figure><p>An interactive interface will pop up, as follows:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># When we finish the interactive interface, another new interface will pop up.</span></span><br><span class="line"><span class="comment"># The latest commit is at the bottom.</span></span><br><span class="line"></span><br><span class="line">pick 2dc628e modified resume link</span><br><span class="line">pick 0c11aed update resume</span><br><span class="line">pick 375c9df Update <span class="keyword">in</span> 2020.10</span><br><span class="line">pick 585c3e7 update resume.</span><br><span class="line"><span class="comment"># Commands:</span></span><br><span class="line"><span class="comment"># p, pick &lt;commit&gt; = use commit</span></span><br><span class="line"><span class="comment"># r, reword &lt;commit&gt; = use commit, but edit the commit message</span></span><br><span class="line"><span class="comment"># e, edit &lt;commit&gt; = use commit, but stop for amending</span></span><br><span class="line"><span class="comment"># s, squash &lt;commit&gt; = use commit, but meld into previous commit</span></span><br><span class="line"><span class="comment"># f, fixup &lt;commit&gt; = like &quot;squash&quot;, but discard this commit&#x27;s log message</span></span><br><span class="line"><span class="comment"># x, exec &lt;command&gt; = run command (the rest of the line) using shell</span></span><br><span class="line"><span class="comment"># b, break = stop here (continue rebase later with &#x27;git rebase --continue&#x27;)</span></span><br><span class="line"><span class="comment"># d, drop &lt;commit&gt; = remove commit</span></span><br><span class="line"><span class="comment"># l, label &lt;label&gt; = label current HEAD with a name</span></span><br><span class="line"><span class="comment"># t, reset &lt;label&gt; = reset HEAD to a label</span></span><br><span class="line"><span class="comment"># m, merge [-C &lt;commit&gt; | -c &lt;commit&gt;] &lt;label&gt; [# &lt;oneline&gt;]</span></span><br><span class="line"><span class="comment"># .       create a merge commit using the original merge commit&#x27;s</span></span><br><span class="line"><span class="comment"># .       message (or the oneline, if no original merge commit was</span></span><br><span class="line"><span class="comment"># .       specified). Use -c &lt;commit&gt; to reword the commit message.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># These lines can be re-ordered; they are executed from top to bottom.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># If you remove a line here THAT COMMIT WILL BE LOST.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># However, if you remove everything, the rebase will be aborted.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Note that empty commits are commented out</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="stash"><a href="#stash" class="headerlink" title="stash"></a>stash</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">git stash <span class="comment"># Stash the changes in a dirty working directory away.</span></span><br><span class="line">git stash list <span class="comment"># List all stash modifications.</span></span><br><span class="line">git stash pop <span class="comment"># Pop the lateset stashed changes.</span></span><br><span class="line">git stash apply <span class="comment"># Apply the lateset stashed changes, and keep it in list.</span></span><br><span class="line">git stash drop <span class="comment"># Delete stash files.</span></span><br></pre></td></tr></table></figure><h2 id="branch"><a href="#branch" class="headerlink" title="branch"></a>branch</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">git branch -v <span class="comment"># Check all local branches.</span></span><br><span class="line">git branch -av <span class="comment"># Check all branch included remote branches.</span></span><br><span class="line">git branch -d | -D brnach </span><br><span class="line">git branch branch_name old_branch | sha1  <span class="comment"># Create branch_name based on sha1</span></span><br><span class="line">git checkout -b new_branch old_branch | sha1</span><br></pre></td></tr></table></figure><h2 id="UI"><a href="#UI" class="headerlink" title="UI"></a>UI</h2><p>We can check the information of repository through UI as long as we install <code>gitk</code>.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">gitk <span class="comment"># open graphical interface.</span></span><br><span class="line">gitk file</span><br></pre></td></tr></table></figure><h2 id="More"><a href="#More" class="headerlink" title="More"></a>More</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># info from remote repository.</span></span><br><span class="line">author <span class="comment"># who did the first commission, `git cherry-pick` won&#x27;t change it</span></span><br><span class="line">committer <span class="comment"># who did the last commission.</span></span><br><span class="line">tag <span class="comment"># tag for project stage.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># cmds</span></span><br><span class="line">git <span class="built_in">help</span> --web cmd  <span class="comment"># View cmd&#x27;s help by web</span></span><br><span class="line">git tag [-d] &lt;tagname&gt; [&lt;commit&gt;] <span class="comment"># Create [delete] a tag reference in refs/tags/.</span></span><br><span class="line">git commit -am <span class="comment"># git add + git commit -m, not suggested.</span></span><br><span class="line">git reflog <span class="comment"># check history version, record when the tips of branches and other references were updated in the local repository.</span></span><br><span class="line"></span><br><span class="line">git show <span class="comment"># Shows one or more objects (blobs, trees, tags and commits).</span></span><br><span class="line">git blame <span class="comment"># Show what revision and author last modified each line of a file.</span></span><br><span class="line"></span><br><span class="line">git cat-file -t <span class="comment"># Check type of object.</span></span><br><span class="line">git cat-file -p <span class="comment"># Check content of object</span></span><br><span class="line">find [dir] -<span class="built_in">type</span> f <span class="comment"># Find all files in current/[dir] directory.</span></span><br></pre></td></tr></table></figure><blockquote><p><code>-</code> : single char options, like -m , -a;<br> <code>--</code>: multi char options, like –web, –hard; </p></blockquote><h1 id="gitignore"><a href="#gitignore" class="headerlink" title=".gitignore"></a>.gitignore</h1><p><a href="https://github.com/github/gitignore">github/gitignore</a>.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># c.gitignore</span></span><br><span class="line"><span class="comment"># Prerequisites</span></span><br><span class="line">*.d</span><br><span class="line"></span><br><span class="line"><span class="comment"># Object files</span></span><br><span class="line">*.o</span><br><span class="line">*.ko</span><br><span class="line">*.obj</span><br><span class="line">*.elf</span><br><span class="line"></span><br><span class="line"><span class="comment"># Linker output</span></span><br><span class="line">*.ilk</span><br><span class="line">*.map</span><br><span class="line">*.exp</span><br><span class="line"></span><br><span class="line"><span class="comment"># Precompiled Headers</span></span><br><span class="line">*.gch</span><br><span class="line">*.pch</span><br><span class="line"></span><br><span class="line"><span class="comment"># Libraries</span></span><br><span class="line">*.lib</span><br><span class="line">*.a</span><br><span class="line">*.la</span><br><span class="line">*.lo</span><br><span class="line"></span><br><span class="line"><span class="comment"># Shared objects (inc. Windows DLLs)</span></span><br><span class="line">*.dll</span><br><span class="line">*.so</span><br><span class="line">*.so.*</span><br><span class="line">*.dylib</span><br><span class="line"></span><br><span class="line"><span class="comment"># Executables</span></span><br><span class="line">*.exe</span><br><span class="line">*.out</span><br><span class="line">*.app</span><br><span class="line">*.i*86</span><br><span class="line">*.x86_64</span><br><span class="line">*.hex</span><br><span class="line"></span><br><span class="line"><span class="comment"># Debug files</span></span><br><span class="line">*.dSYM/</span><br><span class="line">*.su</span><br><span class="line">*.idb</span><br><span class="line">*.pdb</span><br><span class="line"></span><br><span class="line"><span class="comment"># Kernel Module Compile Results</span></span><br><span class="line">*.mod*</span><br><span class="line">*.cmd</span><br><span class="line">.tmp_versions/</span><br><span class="line">modules.order</span><br><span class="line">Module.symvers</span><br><span class="line">Mkfile.old</span><br><span class="line">dkms.conf</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Git </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Tools </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>The ninth week of ARTS</title>
      <link href="2019/10/23/ARTS/Ninth-week-of-ARTS/"/>
      <url>2019/10/23/ARTS/Ninth-week-of-ARTS/</url>
      
        <content type="html"><![CDATA[<h1 id="Algorithm"><a href="#Algorithm" class="headerlink" title="Algorithm"></a>Algorithm</h1><p>Title: <a href="https://leetcode.com/problems/remove-element/">Remove Element</a>.<br>Solution: <a href="https://github.com/huaqianlee/LeetcodeSolutions/blob/master/algorithms/java/RemoveElement.java">Java</a>.</p><h1 id="Review"><a href="#Review" class="headerlink" title="Review"></a>Review</h1><p>I found a usage of “repo init … –reference” this week, I want to know more, so I read <a href="https://forum.xda-developers.com/android/software/guide-android-repo-mirroring-t3170869">Android Repo Mirroring</a> this week.</p><p>This article explains “repo mirroring” in a simple and clear way through examples.</p><a id="more"></a><h1 id="Tips"><a href="#Tips" class="headerlink" title="Tips"></a>Tips</h1><p>Download android code from local mirror(code). As follows:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">repo init -u url -b &lt;branch&gt; --reference=&lt;local_dir&gt;</span><br></pre></td></tr></table></figure><p>It could increase download speed and save the storage when we want to keep multiple sets of code.</p><h1 id="Share"><a href="#Share" class="headerlink" title="Share"></a>Share</h1><p><a href="http://huaqianlee.github.io/2020/10/10/Git/How-to-build-intranet-gitbook-with-docker/">How to build intranet gitbook with docker</a></p>]]></content>
      
      
      <categories>
          
          <category> ARTS </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Algorithm </tag>
            
            <tag> 成长 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>The eighth week of ARTs</title>
      <link href="2019/10/20/ARTS/Eighth-week-of-ARTs/"/>
      <url>2019/10/20/ARTS/Eighth-week-of-ARTs/</url>
      
        <content type="html"><![CDATA[<h1 id="Algorithm"><a href="#Algorithm" class="headerlink" title="Algorithm"></a>Algorithm</h1><p>Title: <a href="https://leetcode.com/problems/remove-duplicates-from-sorted-array/">Remove Duplicates from Sorted Array</a><br>Solution: <a href="https://github.com/huaqianlee/LeetcodeSolutions/blob/master/algorithms/java/RemoveDuplicatesfromSortedArray.java">Java</a></p><h1 id="Review"><a href="#Review" class="headerlink" title="Review"></a>Review</h1><a id="more"></a><h1 id="Tips"><a href="#Tips" class="headerlink" title="Tips"></a>Tips</h1><p>Patch the staged and untracked files via <code>git</code>.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git diff --cached // diff staged (after <span class="string">&#x27;git add&#x27;</span>)</span><br><span class="line">git add -N &lt;unstracked_file_name&gt;; git diff <span class="comment"># diff untracked file</span></span><br></pre></td></tr></table></figure><h1 id="Share"><a href="#Share" class="headerlink" title="Share"></a>Share</h1><p><a href="http://huaqianlee.github.io/2020/03/08/Git/Some-knowledge-about-git-detached-HEAD/">Oh, the Git! - detached HEAD</a></p>]]></content>
      
      
      <categories>
          
          <category> ARTS </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Algorithm </tag>
            
            <tag> 成长 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>The seventh week of ARTs</title>
      <link href="2019/10/13/ARTS/Seventh-week-of-ARTs/"/>
      <url>2019/10/13/ARTS/Seventh-week-of-ARTs/</url>
      
        <content type="html"><![CDATA[<h1 id="Algorithm"><a href="#Algorithm" class="headerlink" title="Algorithm"></a>Algorithm</h1><p>Title: <a href="https://leetcode.com/problems/merge-two-sorted-lists/">Merge Two Sorted Lists</a><br>Solution: <a href="https://github.com/huaqianlee/LeetcodeSolutions/blob/master/algorithms/java/MergeTwoSortedLists.java">Java</a></p><h1 id="Review"><a href="#Review" class="headerlink" title="Review"></a>Review</h1><a id="more"></a><h1 id="Tips"><a href="#Tips" class="headerlink" title="Tips"></a>Tips</h1><p>I forgot the following git cmds when I needed them.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git checkout -b topic-branch // checkout and branch a new topic branch.</span><br><span class="line">git branch --set-upstream-to=origin/branch topic-branch //  <span class="built_in">set</span> tracking information <span class="keyword">for</span> topic-branch.</span><br></pre></td></tr></table></figure><h1 id="Share"><a href="#Share" class="headerlink" title="Share"></a>Share</h1><p><a href="http://huaqianlee.github.io/2020/03/07/Git/Some-knowledge-about-git-local-git/">Oh, the Git! - local .git</a></p>]]></content>
      
      
      <categories>
          
          <category> ARTS </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Algorithm </tag>
            
            <tag> 成长 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>The sixth week of ARTs</title>
      <link href="2019/10/06/ARTS/Sixth-week-of-ARTs/"/>
      <url>2019/10/06/ARTS/Sixth-week-of-ARTs/</url>
      
        <content type="html"><![CDATA[<h1 id="Algorithm"><a href="#Algorithm" class="headerlink" title="Algorithm"></a>Algorithm</h1><p>Title: <a href="https://leetcode.com/problems/valid-parentheses/">Valid Parentheses</a><br>Solution: <a href="https://github.com/huaqianlee/LeetcodeSolutions/blob/master/algorithms/python/ValidParentheses.py">Python</a></p><h1 id="Review"><a href="#Review" class="headerlink" title="Review"></a>Review</h1><p>I read <a href="https://organizationsandmarkets.com/2010/08/31/how-to-read-an-academic-article/">How to Read an Academic Article</a> this week. It teaches me to read academic article by sharing handout. It simply summarizes the method of fast reading, a lot of them maybe be a cliche, but the summary is very helpful.</p><a id="more"></a><h1 id="Tips"><a href="#Tips" class="headerlink" title="Tips"></a>Tips</h1><p>Quickly replace all specified strings under the specified path.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find .&#x2F; -type f -exec sed -i &#39;s&#x2F;old_string&#x2F;new_string&#x2F;g&#39; &#123;&#125; \;</span><br></pre></td></tr></table></figure><h1 id="Share"><a href="#Share" class="headerlink" title="Share"></a>Share</h1><p><a href="http://huaqianlee.github.io/2020/02/06/Linux/Consolidating-the-foundation-of-Linux-vim/">Consolidating the foundation of Linux, vim</a></p>]]></content>
      
      
      <categories>
          
          <category> ARTS </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Algorithm </tag>
            
            <tag> 成长 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>The fifth week of ARTS</title>
      <link href="2019/09/29/ARTS/Fifth-week-of-ARTS/"/>
      <url>2019/09/29/ARTS/Fifth-week-of-ARTS/</url>
      
        <content type="html"><![CDATA[<h1 id="Algorithm"><a href="#Algorithm" class="headerlink" title="Algorithm"></a>Algorithm</h1><p>Title: <a href="https://leetcode.com/problems/longest-common-prefix/">Longest Common Prefix</a><br>Solution: <a href="https://github.com/huaqianlee/LeetcodeSolutions/blob/master/algorithms/java/LongestCommonPrefix.java">Java</a></p><h1 id="Review"><a href="#Review" class="headerlink" title="Review"></a>Review</h1><p>I always want to change the mind of my loves, but I didn’t use the good way to do it. So I read <a href="https://forge.medium.com/how-to-change-a-mind-1774681b9369">How to Change a Mind</a> this week.</p><p>To be honesty, I can’t get this article well, it is a little hard to me. But I got the following opinions from this topic.</p><ol><li>Firstly we should think or do like the people who we want to change.</li><li>For scams, we should let the people lose the faith in the person not in the scams, it will be a better way. Quote the sentence:  <blockquote><p>“Dylan did not need to lose his faith in what his elders were saying; he needed to lose his faith in them.” </p></blockquote><a id="more"></a><h1 id="Tips"><a href="#Tips" class="headerlink" title="Tips"></a>Tips</h1>This week I leaned the way to unmount <code>sshfs</code>. <code>sshfs</code> is used to map(mount) a remote server dir to the local pc.<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo fusermount -u remote_dir // unmount sshfs </span><br></pre></td></tr></table></figure></li></ol><p>BTW, I summarize the sample use of <code>sshfs</code> cmd as follows.</p><h2 id="mount"><a href="#mount" class="headerlink" title="mount"></a>mount</h2><p>mkdir ~/remote_dir<br>sshfs -o idmap=user $USER@far:/dir ~/remote_dir</p><h2 id="unmount"><a href="#unmount" class="headerlink" title="unmount"></a>unmount</h2><p>fusermount -u ~/dir</p><h2 id="To-add-it-to-your-etc-fstab"><a href="#To-add-it-to-your-etc-fstab" class="headerlink" title="To add it to your /etc/fstab"></a>To add it to your <code>/etc/fstab</code></h2><p>sshfs#$USER@<IP>:/dir /home/$USER/remote_dir fuse defaults,idmap=user 0 0</p><blockquote><p>sshfs $USER@<IP>:/dir /home/$USER/remote_dir // mount via terminal</p></blockquote><h1 id="Share"><a href="#Share" class="headerlink" title="Share"></a>Share</h1><p><a href="http://huaqianlee.github.io/2020/02/06/Linux/Consolidating-the-foundation-of-Linux-basic-cmds/">Consolidating the foundation of Linux, basic cmds</a></p>]]></content>
      
      
      <categories>
          
          <category> ARTS </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Algorithm </tag>
            
            <tag> 成长 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>The fourth week of ARTS</title>
      <link href="2019/09/22/ARTS/Fourth-week-of-ARTS/"/>
      <url>2019/09/22/ARTS/Fourth-week-of-ARTS/</url>
      
        <content type="html"><![CDATA[<h1 id="Algorithm"><a href="#Algorithm" class="headerlink" title="Algorithm"></a>Algorithm</h1><p>Title: <a href="https://leetcode.com/problems/roman-to-integer/">Roman to Integer</a><br>Solution: <a href="https://github.com/huaqianlee/LeetcodeSolutions/blob/master/algorithms/java/RomantoInteger.java">Java Solution:</a></p><h1 id="Review"><a href="#Review" class="headerlink" title="Review"></a>Review</h1><p>Today I access <a href="">Medium</a>,This article called <a href="https://medium.com/free-code-camp/code-comments-the-good-the-bad-and-the-ugly-be9cc65fbf83"><code>Putting comments in code: the good, the bad, and the ugly.</code></a> got into my eyes first. So I choose it as my <code>Review</code>.</p><p>This article mainly says the cliche <code>“Good code is self-documenting.”</code> It tells the good, the bad, and the ugly when it comes to commenting our code. </p><a id="more"></a><h1 id="Tips"><a href="#Tips" class="headerlink" title="Tips"></a>Tips</h1><p>In my job, I always build the android source code or capture some logs. I just named the logs manually before, forgot to named them automaticly. This week I remember the followsing way.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CMD | tee build-$(date <span class="string">&quot;+%Y%m%d-%H%M%S&quot;</span>).<span class="built_in">log</span> <span class="comment"># Generate build log</span></span><br></pre></td></tr></table></figure><h1 id="Share"><a href="#Share" class="headerlink" title="Share"></a>Share</h1><p>(Oh, the Git! - Basic)[<a href="http://huaqianlee.github.io/2019/11/17/Git/Some-knowledge-about-git/]">http://huaqianlee.github.io/2019/11/17/Git/Some-knowledge-about-git/]</a></p>]]></content>
      
      
      <categories>
          
          <category> ARTS </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Algorithm </tag>
            
            <tag> 成长 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>How does the repo of android source code work ?</title>
      <link href="2019/09/15/Git/How-does-android-repo-work/"/>
      <url>2019/09/15/Git/How-does-android-repo-work/</url>
      
        <content type="html"><![CDATA[<p>在 <code>android</code> 源码中，主要用 <a href="https://android.googlesource.com/tools/repo"><strong>Repo</strong></a> 和 <a href="https://git-scm.com/"><strong>Git</strong></a> 来进行版本管理。<code>Repo</code> 是一个由谷歌构建，运行在 Git 之上的仓库管理工具，其让多项目管理变得更容易，尤其对于基本的网络操作，譬如，下载由上百个项目组成的 Android 源码。</p><h1 id="Repo-的组成和基本使用"><a href="#Repo-的组成和基本使用" class="headerlink" title="Repo 的组成和基本使用"></a>Repo 的组成和基本使用</h1><h2 id="Repo-launcher"><a href="#Repo-launcher" class="headerlink" title="Repo launcher"></a>Repo launcher</h2><p><code>Repo</code> 的第一部分，其是一个 <code>Python</code> 脚本，主要用来获取完整的 <code>Repo</code> 工具并转发接收到的命令 .</p><h2 id="Repo-Tool"><a href="#Repo-Tool" class="headerlink" title="Repo Tool"></a>Repo Tool</h2><p><code>Repo</code> 的第二部分，由 <code>Repo launcher</code> 下载到 <code>$srcDir/.repo/repo</code>，其是主要功能部分，处理 <code>Repo launcher</code> 转发的命令。</p><a id="more"></a><h2 id="官方的获取方式"><a href="#官方的获取方式" class="headerlink" title="官方的获取方式"></a>官方的获取方式</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">mkdir ~/bin</span><br><span class="line">PATH=~/bin:<span class="variable">$PATH</span></span><br><span class="line"></span><br><span class="line">curl https://storage.googleapis.com/git-repo-downloads/repo &gt; ~/bin/repo</span><br><span class="line">chmod a+x ~/bin/repo</span><br><span class="line"></span><br><span class="line">or</span><br><span class="line"></span><br><span class="line">sudo apt-get install repo</span><br></pre></td></tr></table></figure><h2 id="官方源码下载方式"><a href="#官方源码下载方式" class="headerlink" title="官方源码下载方式"></a>官方源码下载方式</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">repo init -u https://android.googlesource.com/platform/manifest -b android-4.0.1_r1</span><br><span class="line">repo sync [-c --no-tags]</span><br></pre></td></tr></table></figure><h1 id="Repo-怎么工作"><a href="#Repo-怎么工作" class="headerlink" title="Repo 怎么工作"></a>Repo 怎么工作</h1><p>下载代码时 <code>repo</code> 主要工作流程如下：</p><ol><li><code>repo init</code> 在当前路径创建 <code>.repo</code> 文件夹并克隆 <a href="https://android.googlesource.com/tools/repo">repo 的 git 仓库</a>到 <code>.repo/repo</code>（即 <code>Repo Tool</code>）。</li><li>以 <a href="https://git-scm.com/book/en/v2/Git-on-the-Server-Getting-Git-on-a-Server#_getting_git_on_a_server"><code>--bare</code></a> 方式克隆 <code>-u</code> 选项指定的 <code>git</code> 仓库（没有工作空间的仓库）到 <code>.repo/manifests.git</code>。 </li><li>创建 <code>.repo/manifests</code> 目录，创建 <code>.repo/manifests/.git</code> 到 <code>.repo/manifests.git</code> 的符号链接，将 <code>manifests</code> 转换为 Git 仓库。 </li><li><strong>Checkout</strong> <code>-b</code> 选项指定的分支，并创建 <code>.repo/manifests</code> 目录中的指定文件（通过 <code>-m</code> 指定，通常默认为 <code>.repo/manifests/defualt.xml</code>）的符号链接 <code>.repo/manifest.xml</code>。</li><li><code>repo sync</code> 将 <code>manifest.xml</code> 和 <code>local_manifest.xml</code> 中每一个 <code>project</code> 的 <code>git</code> 仓库克隆到 <code>.repo/projects</code>。</li><li>通过链接到相应空仓库的 <code>.git</code> 创建工作路径， <strong>checkout</strong>  <code>manifest</code> 中指定的分支，并更新 <code>.repo/project.list</code>。 <blockquote><p>项目存在的情况下， 一般执行 <code>git pull [--rebase]</code>来下载更新源码。</p></blockquote></li></ol><p><code>repo init</code>的大体流程上如下:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">repo init -u $URL -b $BRANCH -m $MANIFEST</span><br><span class="line"> --------------------</span><br><span class="line"> mkdir .repo; cd .repo</span><br><span class="line"> git clone https:&#x2F;&#x2F;android.googlesource.com&#x2F;tools&#x2F;repo</span><br><span class="line"> git clone --bare $URL manifests.git</span><br><span class="line"> mkdir -p manifests&#x2F;.git; cd manifests&#x2F;.git</span><br><span class="line"> for i in ..&#x2F;..&#x2F;manifests.git&#x2F;*; do ln -s $i .; done</span><br><span class="line"> cd ..</span><br><span class="line"> git checkout $BRANCH -- .</span><br><span class="line"> cd ..</span><br><span class="line"> ln -s manifests&#x2F;$MANIFEST manifest.xml </span><br></pre></td></tr></table></figure><blockquote><p>我们可以通过 <code>repo --trace init ...</code> 来追踪执行过程  </p></blockquote><h1 id="VCS-Version-Control-System-的使用"><a href="#VCS-Version-Control-System-的使用" class="headerlink" title="VCS(Version Control System) 的使用"></a>VCS(Version Control System) 的使用</h1><h2 id="常见工作流程"><a href="#常见工作流程" class="headerlink" title="常见工作流程"></a>常见工作流程</h2><ol><li>repo start 创建一个新的 topic 分支</li><li>git add</li><li>git commit</li><li>repo upload (or: git push origin HEAD:refs/for/branch)</li></ol><h2 id="常见工作命令"><a href="#常见工作命令" class="headerlink" title="常见工作命令"></a>常见工作命令</h2><table><thead><tr><th align="left">Command</th><th align="left">Description</th></tr></thead><tbody><tr><td align="left">repo init</td><td align="left">Initializes a new client.</td></tr><tr><td align="left">repo sync</td><td align="left">Syncs the client to the repositories.</td></tr><tr><td align="left">repo start</td><td align="left">Starts a new branch.</td></tr><tr><td align="left">repo status</td><td align="left">Shows the status of the current branch.</td></tr><tr><td align="left">repo upload</td><td align="left">Uploads changes to the review server.</td></tr><tr><td align="left">git add</td><td align="left">Stages the files.</td></tr><tr><td align="left">git commit</td><td align="left">Commits the staged files.</td></tr><tr><td align="left">git branch</td><td align="left">Shows the current branches.</td></tr><tr><td align="left">git branch [branch]</td><td align="left">Creates a new topic branch.</td></tr><tr><td align="left">git checkout [branch]</td><td align="left">Switches HEAD to the specified branch.</td></tr><tr><td align="left">git merge [branch]</td><td align="left">Merges [branch] into current branch.</td></tr><tr><td align="left">git diff</td><td align="left">Shows diff of the unstaged changes.</td></tr><tr><td align="left">git diff –cached</td><td align="left">Shows diff of the staged changes.</td></tr><tr><td align="left">git log</td><td align="left">Shows the history of the current branch.</td></tr><tr><td align="left">git log m/[codeline]..</td><td align="left">Shows the commits that aren’t pushed.</td></tr></tbody></table><h2 id="help"><a href="#help" class="headerlink" title="help"></a>help</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">man repo</span><br><span class="line">repo <span class="built_in">help</span></span><br><span class="line">repo <span class="built_in">help</span> &lt;cmd&gt;</span><br><span class="line">repo &lt;<span class="built_in">command</span>&gt; --<span class="built_in">help</span></span><br></pre></td></tr></table></figure><h1 id="Topic-Branch"><a href="#Topic-Branch" class="headerlink" title="Topic Branch"></a>Topic Branch</h1><p>一般我会在本地创建不同的 topic 分支来维护不同的修改，</p><h2 id="Creating-topic-branches"><a href="#Creating-topic-branches" class="headerlink" title="Creating topic branches"></a>Creating topic branches</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ repo start branchname .</span><br></pre></td></tr></table></figure><h2 id="To-check-new-branch"><a href="#To-check-new-branch" class="headerlink" title="To check new branch"></a>To check new branch</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ repo status .</span><br></pre></td></tr></table></figure><h2 id="To-assign-the-branch-to-a-particular-project"><a href="#To-assign-the-branch-to-a-particular-project" class="headerlink" title="To assign the branch to a particular project"></a>To assign the branch to a particular project</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ repo start branchname project</span><br></pre></td></tr></table></figure><h2 id="切换分支"><a href="#切换分支" class="headerlink" title="切换分支"></a>切换分支</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ git checkout branchname</span><br></pre></td></tr></table></figure><h2 id="To-see-a-list-of-existing-branches"><a href="#To-see-a-list-of-existing-branches" class="headerlink" title="To see a list of existing branches"></a>To see a list of existing branches</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ git branch</span><br><span class="line">or...</span><br><span class="line">$ repo branches</span><br></pre></td></tr></table></figure><h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><p><a href="https://stackoverflow.com/questions/6149725/how-does-the-android-repo-manifest-repository-work">stack overflow.</a><br><a href="https://source.android.com/setup/develop">Source Control Tools.</a></p>]]></content>
      
      
      <categories>
          
          <category> Git </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Tools </tag>
            
            <tag> Repo </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>The third week of ARTS: Repo</title>
      <link href="2019/09/13/ARTS/Third-week-of-ARTS/"/>
      <url>2019/09/13/ARTS/Third-week-of-ARTS/</url>
      
        <content type="html"><![CDATA[<h1 id="Algorithm"><a href="#Algorithm" class="headerlink" title="Algorithm"></a>Algorithm</h1><p>Title：<a href="https://leetcode.com/problems/palindrome-number/">Palindrome Number</a><br>Solution：<a href="https://github.com/huaqianlee/LeetcodeSolutions/blob/master/algorithms/c/isPalindrome.c">C solution</a></p><h1 id="Review"><a href="#Review" class="headerlink" title="Review"></a>Review</h1><p>I always don’t kwnow enough about repo, so I read some articles about repo this week. These articles describe the repo Manifest format, usage of repo, repo &amp;&amp; git , etc in detail. It helps me a lot. But I have not absorbed them yet, I need more time.</p><p>The links are as follows:<br><a href="https://android.googlesource.com/tools/repo">repo</a></p><ul><li><a href="https://source.android.com/setup/develop">Source Control Tools</a></li><li><a href="https://source.android.com/setup/create/coding-tasks">Source Control Workflow</a></li><li><a href="https://source.android.com/setup/develop/repo">Repo Command Reference</a></li><li><a href="https://gerrit.googlesource.com/git-repo/+/master/docs/manifest-format.md">Repo Manifest Format</a></li><li><a href="https://android.googlesource.com/tools/repo/+/HEAD/docs/repo-hooks.md">Repo hooks</a></li><li><a href="https://mirrors.edge.kernel.org/pub/software/scm/git/docs/howto/separating-topic-branches.txt">How to separate topic branches</a>  </li></ul><a id="more"></a><h1 id="Tips"><a href="#Tips" class="headerlink" title="Tips"></a>Tips</h1><ul><li><p>Delete Files Using Extended Pattern Matching Operators.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># enable extglob</span></span><br><span class="line"><span class="built_in">shopt</span> -s extglob</span><br><span class="line"></span><br><span class="line">rm -v !(<span class="string">&quot;filename&quot;</span>)</span><br><span class="line">rm -v !(<span class="string">&quot;filename1&quot;</span>|<span class="string">&quot;filename2&quot;</span>) </span><br><span class="line"><span class="comment"># such as,</span></span><br><span class="line">rm -i !(*.zip)</span><br><span class="line">rm -v !(*.zip|*.odt)</span><br><span class="line"></span><br><span class="line"><span class="comment"># disable extglob</span></span><br><span class="line"><span class="built_in">shopt</span> -u extglob</span><br></pre></td></tr></table></figure></li><li><p>Delete Files Using Linux find Command</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">find /directory/ -<span class="built_in">type</span> f -not -name <span class="string">&#x27;PATTERN&#x27;</span> -delete</span><br><span class="line">find /directory/ -<span class="built_in">type</span> f -not -name <span class="string">&#x27;PATTERN&#x27;</span> -print0 | xargs -0 -I &#123;&#125; rm &#123;&#125;</span><br><span class="line">find /directory/ -<span class="built_in">type</span> f -not -name <span class="string">&#x27;PATTERN&#x27;</span> -print0 | xargs -0 -I &#123;&#125; rm [options] &#123;&#125;</span><br><span class="line"><span class="comment"># such as,</span></span><br><span class="line">find . -<span class="built_in">type</span> f -not -name <span class="string">&#x27;*.gz&#x27;</span>-delete</span><br><span class="line">find . -<span class="built_in">type</span> f -not -name <span class="string">&#x27;*gz&#x27;</span> -print0 | xargs -0  -I &#123;&#125; rm -v &#123;&#125;</span><br><span class="line">find . -<span class="built_in">type</span> f -not \(-name <span class="string">&#x27;*gz&#x27;</span> -or -name <span class="string">&#x27;*odt&#x27;</span> -or -name <span class="string">&#x27;*.jpg&#x27;</span> \) -delete</span><br></pre></td></tr></table></figure></li></ul><h1 id="Share"><a href="#Share" class="headerlink" title="Share"></a>Share</h1><p><a href="http://huaqianlee.github.io/2019/09/15/Git/How-does-android-repo-work/">How does the repo of android source code work ?</a></p>]]></content>
      
      
      <categories>
          
          <category> ARTS </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Algorithm </tag>
            
            <tag> 成长 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>A little basic knowledge of shell</title>
      <link href="2019/09/08/Linux/A-little-basic-knowledge-of-the-shell/"/>
      <url>2019/09/08/Linux/A-little-basic-knowledge-of-the-shell/</url>
      
        <content type="html"><![CDATA[<p>I don’t know what to share for ARTS this week. So I summarize a little knowledge of the shell.</p><h2 id="What-is-a-shell"><a href="#What-is-a-shell" class="headerlink" title="What is a shell"></a>What is a shell</h2><p>A shell is a software interface that is ofthen a command line interface that enables the user to interact with the computer. In linux, we can check all supported shell via the following way.</p><a id="more"></a><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">lee@lee-server:~$ sudo cat /etc/shells</span><br><span class="line">/bin/sh</span><br><span class="line">/bin/bash</span><br><span class="line">/sbin/nologin</span><br><span class="line">/bin/dash</span><br><span class="line">/bin/tcsh</span><br><span class="line">/bin/csh</span><br></pre></td></tr></table></figure><blockquote><p>bash( Bourne again shell) - rewrited sh, generating more functions.</p></blockquote><h2 id="What-is-the-differnce-between-script-execution"><a href="#What-is-the-differnce-between-script-execution" class="headerlink" title="What is the differnce between script execution"></a>What is the differnce between script execution</h2><h3 id="First-situation"><a href="#First-situation" class="headerlink" title="First situation"></a>First situation</h3><p>Execute as one child process, once the child process exists and back to parent shell, the related envs will disappear. Such as:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">bash script_name.sh</span><br><span class="line">./script_name.sh <span class="comment"># Need to add execute permission in advance. like, chmod u+x script_name.sh</span></span><br></pre></td></tr></table></figure><blockquote><p>envs: environmental variables.</p></blockquote><h3 id="Second-situation"><a href="#Second-situation" class="headerlink" title="Second situation"></a>Second situation</h3><p>Execute in the current shell. envs will always work before quit. Such as:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">source</span> script_name.sh</span><br><span class="line">. script_name.sh</span><br></pre></td></tr></table></figure><h2 id="Pip"><a href="#Pip" class="headerlink" title="Pip"></a>Pip</h2><p>The output of left cmd is used as the input to the right cmd. As follows:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">lee@lee-server:/boot/grub$ cat | ps -f <span class="comment"># Create one new process for every external cmd.</span></span><br><span class="line">UID        PID  PPID  C STIME TTY          TIME CMD</span><br><span class="line">lee      21193  4020  2 11:22 pts/3    00:00:00 bash -c <span class="built_in">cd</span> <span class="string">&quot;/boot/grub&quot;</span> &amp;&amp; bash -i -c <span class="string">&quot;cat | ps -f&quot;</span></span><br><span class="line">lee      21596 21193  4 11:22 pts/3    00:00:00 bash -i -c cat | ps -f</span><br><span class="line">lee      21775 21596  0 11:22 pts/3    00:00:00 cat</span><br><span class="line">lee      21776 21596  0 11:22 pts/3    00:00:00 ps -f</span><br></pre></td></tr></table></figure><p>We should avoid to use built-in cmd in pip ,such as , ls , cd ,etc.</p><blockquote><p>built-in cmd: execute in the current shell. <br/>external cmd: create one new process, like top. </p></blockquote><h2 id="Input-and-output-redirection"><a href="#Input-and-output-redirection" class="headerlink" title="Input and output redirection"></a>Input and output redirection</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;&lt;&quot;</span>   <span class="comment"># input redirection.</span></span><br><span class="line"><span class="string">&quot;&gt;&quot;</span>   <span class="comment"># output redirection</span></span><br><span class="line"><span class="string">&quot;&gt;&gt;&quot;</span>  <span class="comment"># output append redirection.</span></span><br><span class="line"><span class="string">&quot;2&gt;&quot;</span>  <span class="comment"># error output redirection.</span></span><br><span class="line"><span class="string">&quot;&amp;&gt;&quot;</span>  <span class="comment"># all output redirection.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># input + output redirection, EOF part redirect as input f cat.</span></span><br><span class="line">cat &gt; file.txt &lt;&lt;EOF</span><br><span class="line">Hello, Shell!</span><br><span class="line">EOF </span><br><span class="line"><span class="comment"># EOF can be any strings, it is only a conventional writing (End Of File)</span></span><br></pre></td></tr></table></figure><h2 id="Variable"><a href="#Variable" class="headerlink" title="Variable"></a>Variable</h2><h3 id="Definition-of-variables"><a href="#Definition-of-variables" class="headerlink" title="Definition of variables"></a>Definition of variables</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">var=value</span><br><span class="line"><span class="built_in">let</span> var=value</span><br><span class="line">l=ls</span><br><span class="line">var=$(ls -l /etc) </span><br><span class="line">or</span><br><span class="line">var=`ls -l /etc`</span><br></pre></td></tr></table></figure><blockquote><p>Note: ${var}, sometimes we can only use $var, sometimes we can’t, i.e., ${var}test != $vartest.</p></blockquote><h3 id="Scope-of-the-variable"><a href="#Scope-of-the-variable" class="headerlink" title="Scope of the variable"></a>Scope of the variable</h3><p>Variable only works in the current terminal or the current shell script. </p><p>If we want to use it in the child process, we need to export it as follows:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> var(=xxx)</span><br></pre></td></tr></table></figure><p>If we don’t need it anymore, we need to clear it as follows:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">unset</span> var</span><br></pre></td></tr></table></figure><h3 id="Env-and-others"><a href="#Env-and-others" class="headerlink" title="Env and others"></a>Env and others</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">set</span> <span class="comment"># display the current shell variable.</span></span><br><span class="line">env <span class="comment"># view all current env.</span></span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$var</span> <span class="comment"># view var.</span></span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$PS1</span> <span class="comment"># The current prompt terminal</span></span><br><span class="line">$?  <span class="comment"># The return value of the previous cmd</span></span><br><span class="line">$$  <span class="comment"># the current process&#x27;s PID</span></span><br><span class="line"><span class="variable">$0</span>  <span class="comment"># the current process name </span></span><br><span class="line"><span class="comment"># Get the parameters passed to the current process</span></span><br><span class="line"><span class="variable">$1</span> <span class="variable">$2</span> ... <span class="variable">$&#123;10&#125;</span> ... <span class="variable">$&#123;n&#125;</span></span><br><span class="line"><span class="comment"># Initial for null variable, avoid nothing to display.</span></span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$&#123;2&#125;</span>_   <span class="comment"># if [ -n &quot;$2&quot; ],then: display &#x27;_&#x27; else display &#x27;value_&#x27; fi # value --&gt; value of $2</span></span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$&#123;2-_&#125;</span>  <span class="comment"># if [ -n &quot;$2&quot; ],then:  display &#x27;_&#x27; else display &#x27;value&#x27; fi</span></span><br></pre></td></tr></table></figure><h2 id="Config-of-linux"><a href="#Config-of-linux" class="headerlink" title="Config of linux"></a>Config of linux</h2><h3 id="All-user’s-config"><a href="#All-user’s-config" class="headerlink" title="All user’s config"></a>All user’s config</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">/etc/profile</span><br><span class="line">/etc/profile.d/</span><br><span class="line">/etc/bashrc</span><br></pre></td></tr></table></figure><h3 id="Current-user’s-config"><a href="#Current-user’s-config" class="headerlink" title="Current user’s config"></a>Current user’s config</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~/.bash_profile</span><br><span class="line">~/.bashrc</span><br></pre></td></tr></table></figure><h3 id="Loading-order"><a href="#Loading-order" class="headerlink" title="Loading order"></a>Loading order</h3><p>su - root</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">/etc/profile</span><br><span class="line">~/.bash_profile</span><br><span class="line">~/.bashrc</span><br><span class="line">/etc/bashrc</span><br></pre></td></tr></table></figure><blockquote><p>It is a better way to switch account.</p></blockquote><p>su root</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~/.bashrc</span><br><span class="line">/etc/bashrc</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Tools </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>The second week of ARTS: Hurry</title>
      <link href="2019/09/07/ARTS/Second-week-of-ARTS-Hurry/"/>
      <url>2019/09/07/ARTS/Second-week-of-ARTS-Hurry/</url>
      
        <content type="html"><![CDATA[<h1 id="Algorithm"><a href="#Algorithm" class="headerlink" title="Algorithm"></a>Algorithm</h1><p>Title：<a href="https://leetcode.com/problems/reverse-integer/">Reverse Integer</a><br>Solution：<a href="https://github.com/huaqianlee/LeetcodeSolutions/blob/master/algorithms/c/reverseInteger.c">C solution</a></p><h1 id="Review"><a href="#Review" class="headerlink" title="Review"></a>Review</h1><p>Because I am learnning python, I was attracted by the <a href="https://medium.com/free-code-camp/learning-python-from-zero-to-hero-120ea540b567">Learning Python: From Zero to Hero</a> article of <a href="http://medium.com/">Medium</a>.  </p><p>This article is very good ,  it almost show all the python-related knowledge in a limited page. Such as , variables, conditional statements, looping, collection/array, key-value collection, iterate , classes and objects, encapsulation, inheritance, etc.</p><a id="more"></a><h1 id="Tips"><a href="#Tips" class="headerlink" title="Tips"></a>Tips</h1><h2 id="Get-the-patch-of-the-specified-commission"><a href="#Get-the-patch-of-the-specified-commission" class="headerlink" title="Get the patch of the specified commission."></a>Get the patch of the specified commission.</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git diff origin/master HEAD <span class="comment"># Get patch for all commits which are not merged</span></span><br><span class="line">git diff start_commit_id end_commit_id <span class="comment"># Get patch between start_commit_id and end_commit_id</span></span><br></pre></td></tr></table></figure><h2 id="A-way-to-avoid-that-security-issue-between-vendor-and-system"><a href="#A-way-to-avoid-that-security-issue-between-vendor-and-system" class="headerlink" title="A way to avoid that security issue between vendor and system."></a>A way to avoid that security issue between vendor and system.</h2><p>I am not sure when, if I am correct , there is security issues with file operations between vendor and system from Android O. I found a way to avoid it this week, that is, escape selinux verification in the following file.</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">external/selinux/libselinux/src/avc.c</span><br></pre></td></tr></table></figure><h1 id="Share"><a href="#Share" class="headerlink" title="Share"></a>Share</h1><p><a href="http://huaqianlee.github.io/2019/09/08/Shell/A-little-basic-knowledge-of-the-shell/">A little basic knowledge of the shell</a></p>]]></content>
      
      
      <categories>
          
          <category> ARTS </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Algorithm </tag>
            
            <tag> 成长 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Process and thread in linux</title>
      <link href="2019/08/31/Linux/Process-and-thread-in-linux/"/>
      <url>2019/08/31/Linux/Process-and-thread-in-linux/</url>
      
        <content type="html"><![CDATA[<blockquote><p>没有太多时间去查看详细源代码，所以仍然有很多不清晰或者理解不到位的地方，后续将 Linux 相关知识学习得更深入的时候再来更新一次。  </p></blockquote><h1 id="进程与线程"><a href="#进程与线程" class="headerlink" title="进程与线程"></a>进程与线程</h1><p>在 Linux 中，进程和线程几乎没有什么区别，主要的区别就是线程共享同样的虚拟内存地址空间。对于 kernel 来说，进程和线程都是一个可运行的 task 。</p><p>线程创建函数 pthread_create() 会调用 clone(), 而进程创建函数 fork() 最终也是调用 clone()。我们查看<a href="https://linux.die.net/man/2/clone">clone</a>函数的介绍时，可以看到 clone() 的参数 flags 用来指明子‘进程’和父‘进程’共享什么，所以可以说进程就是不共享任何东西的一个典型线程（一个不成熟的观点，不一定正确）。<br><img src="https://andylee-1258982386.cos.ap-chengdu.myqcloud.com/linux/process_thread_to_task.jpeg" alt="process_thread_to_task">  </p><blockquote><p>摘录线程库发展史：Linux threading libraries evolution: Linux Threads, NGPT, NPTL. The library is part of gilbc, programmer interface is POSIX pthreads.  </p></blockquote><h1 id="线程模型"><a href="#线程模型" class="headerlink" title="线程模型"></a>线程模型</h1><a id="more"></a><p>Linux 中的线程是 “1-1” 模型, 而不是 “1-N” 或者 “M-N” 模型。下面简单介绍一下线程模型。</p><h2 id="“1-1”-模型"><a href="#“1-1”-模型" class="headerlink" title="“1-1” 模型"></a>“1-1” 模型</h2><p>将每个用户级线程映射到一个内核级线程（即 task）。<br>优点：<br>消耗更少的资源，比如内存（虚拟的和物理的）和 内核对象（object）。并且也会更少地上下文切换，从而提高性能，在理想情况下，当你拥有和运行线程一样多的处理器的时候，将可能几乎没有上下文切换。<br>缺点：<br>可能是延迟更大：如果池中的所有线程都忙，并且您添加了新的短任务，则可能需要等待很长时间才能开始执行。</p><h2 id="“1-N”-模型"><a href="#“1-N”-模型" class="headerlink" title="“1-N” 模型"></a>“1-N” 模型</h2><p>将多个用户级线程映射到一个内核级线程,早期 OS 的线程实现方式。<br>优点:<br>内核不干涉线程的任何生命活动和上下文切换。线程的管理在用户空间进行,因而效率比较高;<br>缺点:<br>一个进程中的多个线程只能调度到一个CPU，这种约束限制了可用的并行总量，并且如果某个线程 block 了，其他线程都只能等着。</p><h2 id="“M-N”-模型"><a href="#“M-N”-模型" class="headerlink" title="“M-N” 模型"></a>“M-N” 模型</h2><p>在线程池里，将 M 个用户线程映射到 N 个内核线程 (M &gt;= N)，可以算结合上面两种方法的优势，但会牺牲一些额外的用户模式调度。</p>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>The first week of ARTS: Start</title>
      <link href="2019/08/31/ARTS/First-week-of-ARTS-Start/"/>
      <url>2019/08/31/ARTS/First-week-of-ARTS-Start/</url>
      
        <content type="html"><![CDATA[<h1 id="ARTS-简单介绍"><a href="#ARTS-简单介绍" class="headerlink" title="ARTS 简单介绍"></a>ARTS 简单介绍</h1><p>Algorithm：<br>主要是为了编程训练和学习。每周至少做一个 leetcode 的算法题（先从Easy开始，然后再Medium，最后才Hard）。进行编程训练，如果不训练你看再多的算法书，你依然不会做算法题，看完书后，你需要训练。</p><p>Review：<br>主要是为了学习英文，如果你的英文不行，你基本上无缘技术高手。所以，需要你阅读并点评至少一篇英文技术文章，我个人最喜欢去的地方是 <a href="http://medium.com/">Medium</a>（需要梯子）以及各个公司的技术 blog，如 Netflix 的。</p><p>Tip：<br>主要是为了总结和归纳你在是常工作中所遇到的知识点。学习至少一个技术技巧。你在工作中遇到的问题，踩过的坑，学习的点滴知识。</p><p>Share：<br>主要是为了建立你的影响力，能够输出价值观。分享一篇有观点和思考的技术文章。</p><a id="more"></a><h1 id="Algorithm"><a href="#Algorithm" class="headerlink" title="Algorithm"></a>Algorithm</h1><p>本周用 c 语言完成了两道算法题。<br>算法题目：<a href="https://leetcode.com/problems/two-sum/">Two Sum</a><br>我的代码：<a href="https://github.com/huaqianlee/LeetcodeSolutions/blob/master/algorithms/c/twoSum.c">C Solution</a>  </p><p>算法题目：<a href="https://leetcode.com/problems/add-two-numbers/">Add Two Numbers</a><br>我的代码：<a href="https://github.com/huaqianlee/LeetcodeSolutions/blob/master/algorithms/c/addTwoNumbers.c">C Solution</a>  </p><h1 id="Review"><a href="#Review" class="headerlink" title="Review"></a>Review</h1><p>因为自己想学习一下正则表达式，所以就找了一篇英文教程：<a href="https://medium.com/factory-mind/regex-tutorial-a-simple-cheatsheet-by-examples-649dc1c3f285">Regex tutorial — A quick cheatsheet by examples</a> 。 </p><p>这篇文章简单介绍了 topics 及相关实例，十分适合入门学习，而且通过这个网站我发现了一个<a href="https://regex101.com/r/cO8lqs/2">在线 regex 调试器</a> ，通过这个在线调试器我们就能很方便的进行正则表达式学习。</p><h1 id="Tips"><a href="#Tips" class="headerlink" title="Tips"></a>Tips</h1><p>这周学到了两个版本管理的技巧。</p><ul><li><p>快速撤销本地的所有修改和提交件</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">repo forall -vc <span class="string">&quot;git reset --hard; git clean -fdx&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># explanation</span></span><br><span class="line">forall - Execute <span class="keyword">for</span> all repos.</span><br><span class="line">v - Print the output of the <span class="built_in">command</span></span><br><span class="line">c - Command to execute,the actual <span class="built_in">command</span></span><br></pre></td></tr></table></figure></li><li><p>将版本回退到指定时间</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">repo forall -c <span class="string">&#x27;git checkout `git rev-list --all -n1 --before=&quot;2019-08-15 15:00&quot;`&#x27;</span></span><br></pre></td></tr></table></figure></li></ul><h1 id="Share"><a href="#Share" class="headerlink" title="Share"></a>Share</h1><p><a href="http://huaqianlee.github.io/2019/08/31/Linux/Process-and-thread-in-linux/">进程与线程</a></p>]]></content>
      
      
      <categories>
          
          <category> ARTS </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Algorithm </tag>
            
            <tag> 成长 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>UFP was modified as DRP when we unplug OTG</title>
      <link href="2019/08/27/Android/USB-port-error/"/>
      <url>2019/08/27/Android/USB-port-error/</url>
      
        <content type="html"><![CDATA[<h1 id="Term"><a href="#Term" class="headerlink" title="Term"></a>Term</h1><ul><li><p>DFP - Downstream Facing Port<br>下行端口，可以理解为 Host 的 Type-c 端口或者作为 Host 的 hub ，DFP 提供 VBUS，可以提供数据。在协议规范中 DFP 特指数据的下行传输，笼统意义上指的是数据下行和对外提供电源的设备。典型的 DFP 设备是电源适配器。</p></li><li><p>UFP - Upstream Facing port<br>上行端口，可以理解为 Device 上的 Type-c 端口或者连接到 Host/DFP of a hub ，UFP 从 VBUS 中取电，并可提供数据。典型设备是 U 盘，移动硬盘。</p></li><li><p>DRP - DUal Role Port (DFP + UFP)<br>双角色端口，DRP 既可以做 DFP(Host)，也可以做 UFP(Device)，也可以在 DFP 与 UFP 间动态切换。典型的DRP设备是笔记本电脑。</p></li></ul><blockquote><p>引用摘录：A DRP port is a port that can operate as either a sink or source.</p><p>source - takes the data role of a DFP.<br>sink - take the data role of a UFP.</p><p>A current sink is a port or circuit point that accepts negative current, e.g. current into the circuit which it drains to ground.<br>A current source is a port or circuit point that provides positive current. A good example of a current source is a DC power supply</p></blockquote><h1 id="Description"><a href="#Description" class="headerlink" title="Description"></a>Description</h1><p>逻辑：USB 默认为 UFP，不能使用 OTG ；若要使用需要通过 node 将其设为 DRP ， 但是在拔出后需要将其设回 UFP。 </p><p>问题： 当拔掉 OTG 之后，USB 仍然为 DRP ，导致不用设置 node 即可连接 OTG。</p><h1 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h1><a id="more"></a><h2 id="初步解析"><a href="#初步解析" class="headerlink" title="初步解析"></a>初步解析</h2><p>通过在 smblib_handle_typec_removal 函数设置 USB 端口模式的地方加日志读取端口状态，发现 DRP 是被成功设置了的，但是短暂时间后又被其他地方修改为 UFP 模式了。</p><p>通过寄存器相关关键字等各种方式皆不能找到其余修改的地方。</p><p>因为老版本（Android N）上是没有问题的，所以尝试在本问题版本（Android Q） one by one 烧写 N 的镜像，最终发现 pmic.elf 分区会让问题得以解决。</p><h2 id="方案一"><a href="#方案一" class="headerlink" title="方案一"></a>方案一</h2><p>对比代码发现如下两种修改方法可以解决问题：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">--------------------------------------------------------------</span><br><span class="line">diff --git a/QcomPkg/Library/PmicLib/target/sdm660_pm660_pm660l/psi/pm_config_target_pbs_ram.c b/QcomPkg/Library/PmicLib/target/sdm660_pm660_pm660l/psi/pm_config_target_pbs_ram.c</span><br><span class="line">index bfb32ba..cb012b4 <span class="number">100755</span></span><br><span class="line">--- a/QcomPkg/Library/PmicLib/target/sdm660_pm660_pm660l/psi/pm_config_target_pbs_ram.c</span><br><span class="line">+++ b/QcomPkg/Library/PmicLib/target/sdm660_pm660_pm660l/psi/pm_config_target_pbs_ram.c</span><br><span class="line">@@ <span class="number">-58</span>,<span class="number">7</span> +<span class="number">58</span>,<span class="number">7</span> @@ pm_pbs_seq [ ][PBS_RAM_DATA_SIZE] =</span><br><span class="line">      &#123; <span class="number">0x00</span>,  <span class="number">0x1B</span>,   <span class="number">0x01</span>,   <span class="number">0x18</span>&#125;,  <span class="comment">// W#1 -        0x804 Header offset, Header Version, PBS RAM Revision, PBS RAM Branch</span></span><br><span class="line">      &#123; <span class="number">0x2C</span>,  <span class="number">0x08</span>,   <span class="number">0xFF</span>,   <span class="number">0x83</span>&#125;,  <span class="comment">// W#2 -        0x808 Start of trigger jump table:</span></span><br><span class="line">      &#123; <span class="number">0x68</span>,  <span class="number">0x08</span>,   <span class="number">0xFF</span>,   <span class="number">0x83</span>&#125;,  <span class="comment">// W#3 -        0x80C</span></span><br><span class="line"># mothod first.</span><br><span class="line">-      &#123; <span class="number">0xC4</span>,  <span class="number">0x08</span>,   <span class="number">0xFF</span>,   <span class="number">0x83</span>&#125;,  <span class="comment">// W#4 -        0x810</span></span><br><span class="line">+      &#123; <span class="number">0xB8</span>,  <span class="number">0x08</span>,   <span class="number">0xFF</span>,   <span class="number">0x83</span>&#125;,  <span class="comment">// W#4 -        0x810</span></span><br><span class="line">OR </span><br><span class="line"># mothod second.</span><br><span class="line">-      &#123; <span class="number">0x38</span>,  <span class="number">0x09</span>,   <span class="number">0xFF</span>,   <span class="number">0x83</span>&#125;,  <span class="comment">// W#5 -        0x814</span></span><br><span class="line">+      &#123; <span class="number">0x2C</span>,  <span class="number">0x09</span>,   <span class="number">0xFF</span>,   <span class="number">0x83</span>&#125;,  <span class="comment">// W#5 -        0x814</span></span><br><span class="line">      &#123; <span class="number">0xC4</span>,  <span class="number">0x0F</span>,   <span class="number">0xFF</span>,   <span class="number">0x83</span>&#125;,  <span class="comment">// W#6 -        0x818 Fixed Offset = RAM-Base-Addr + 0x18 + 0x00 =&gt; SLEEP-SET</span></span><br><span class="line">      &#123; <span class="number">0xCC</span>,  <span class="number">0x0F</span>,   <span class="number">0xFF</span>,   <span class="number">0x83</span>&#125;,  <span class="comment">// W#7 -        0x81C Fixed Offset = RAM-Base-Addr + 0x18 + 0x04 =&gt; PON X Reasons</span></span><br><span class="line">--------------------------------------------------------------</span><br></pre></td></tr></table></figure><p>但是针对这个问题咨询高通得到的回复是：PSI 模块是不允许修改的，会导致难以预料的问题，所以这种方案作罢。因为没有找到相关资料，不清楚这个差异具体是什么，高通也未给出清晰的答案。</p><h2 id="方案二"><a href="#方案二" class="headerlink" title="方案二"></a>方案二</h2><p>拔掉时延时 5 毫秒才重置 USB 为 UFP 模式，试图在 PSI 之后修改，经过测试此修改方案能解决此问题。如下：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">diff --git a/drivers/power/supply/qcom/smb-lib.c b/drivers/power/supply/qcom/smb-lib.c</span><br><span class="line">--- a/drivers/power/supply/qcom/smb-lib.c</span><br><span class="line">+++ b/drivers/power/supply/qcom/smb-lib.c</span><br><span class="line">@@ <span class="number">-4378</span>,<span class="number">12</span> +<span class="number">4378</span>,<span class="number">28</span> @@</span><br><span class="line"> <span class="meta">#<span class="meta-keyword">ifdef</span> FEATURE__DET_DRIVER</span></span><br><span class="line"> <span class="comment">/* configure power role for default */</span></span><br><span class="line"> _power_role_val.intval = _det_get_default_power_role();</span><br><span class="line"></span><br><span class="line">+msleep(<span class="number">5</span>);  # 延时等 PSI 修改 USB 为 DRP 完成，然后我们再修改为 UFP</span><br><span class="line">rc = smblib_set_prop_typec_power_role(chg, &amp;_power_role_val);</span><br></pre></td></tr></table></figure><h2 id="方案三"><a href="#方案三" class="headerlink" title="方案三"></a>方案三</h2><p>此方案与方案二类似，</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">diff --git a/drivers/power/supply/qcom/smb-lib.c b/drivers/power/supply/qcom/smb-lib.c</span><br><span class="line">--- a/drivers/power/supply/qcom/smb-lib.c</span><br><span class="line">+++ b/drivers/power/supply/qcom/smb-lib.c</span><br><span class="line">@@ <span class="number">-4378</span>,<span class="number">12</span> +<span class="number">4378</span>,<span class="number">28</span> @@</span><br><span class="line"> <span class="meta">#<span class="meta-keyword">ifdef</span> FEATURE__DET_DRIVER</span></span><br><span class="line"> <span class="comment">/* configure power role for default */</span></span><br><span class="line"> _power_role_val.intval = _det_get_default_power_role();  <span class="comment">// 获取需要设定端口模式</span></span><br><span class="line">-rc = smblib_set_prop_typec_power_role(chg, &amp;_power_role_val);</span><br><span class="line">-<span class="keyword">if</span> (rc &lt; <span class="number">0</span>) &#123;</span><br><span class="line">-smblib_err(chg,</span><br><span class="line">-<span class="string">&quot;Couldn&#x27;t configure power role for %d rc=%d\n&quot;</span>, _power_role_val.intval, rc);</span><br><span class="line">+<span class="keyword">if</span>(_power_role_val.intval == POWER_SUPPLY_TYPEC_PR_SINK)&#123;</span><br><span class="line">+rc = smblib_masked_write(chg, TYPE_C_INTRPT_ENB_SOFTWARE_CTRL_REG, TYPEC_DISABLE_CMD_BIT, TYPEC_DISABLE_CMD_BIT);</span><br><span class="line">+<span class="keyword">if</span>(rc &lt; <span class="number">0</span>)</span><br><span class="line">+smblib_err(chg, <span class="string">&quot;Couldn&#x27;t disable type-c\n&quot;</span>);</span><br><span class="line">+</span><br><span class="line">+msleep(<span class="number">200</span>);  # 延时等 PSI 修改 USB 为 DRP 完成，然后我们再修改为 UFP</span><br><span class="line">+rc = smblib_masked_write(chg, TYPE_C_INTRPT_ENB_SOFTWARE_CTRL_REG, UFP_EN_CMD_BIT | DFP_EN_CMD_BIT, UFP_EN_CMD_BIT);</span><br><span class="line">+<span class="keyword">if</span>(rc &lt; <span class="number">0</span>)</span><br><span class="line">+smblib_err(chg, <span class="string">&quot;Couldn&#x27;t configure power role for %d rc=%d\n&quot;</span>, _power_role_val.intval, rc);</span><br><span class="line">+</span><br><span class="line">+msleep(<span class="number">10</span>);</span><br><span class="line">+rc = smblib_masked_write(chg, TYPE_C_INTRPT_ENB_SOFTWARE_CTRL_REG, TYPEC_DISABLE_CMD_BIT, <span class="number">0</span>);</span><br><span class="line">+<span class="keyword">if</span>(rc &lt; <span class="number">0</span>)</span><br><span class="line">+smblib_err(chg, <span class="string">&quot;Couldn&#x27;t enable type-c\n&quot;</span>);</span><br><span class="line">+&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">+rc = smblib_set_prop_typec_power_role(chg, &amp;_power_role_val); <span class="comment">// write 3 bit， if 中的内容部分算此函数的子集，只是提取出来添加了 TYPEC_DISABLE_CMD_BIT 和延时</span></span><br><span class="line">+<span class="keyword">if</span>(rc &lt; <span class="number">0</span>)</span><br><span class="line">+smblib_err(chg, <span class="string">&quot;Couldn&#x27;t configure power role for %d rc=%d\n&quot;</span>, _power_role_val.intval, rc);</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line"> <span class="comment">/* enable DRP */</span></span><br><span class="line"> rc = smblib_masked_write(chg, TYPE_C_INTRPT_ENB_SOFTWARE_CTRL_REG,</span><br><span class="line"></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Android </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Bug </tag>
            
            <tag> Qualcomm </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>一个 health service 不生效问题引出的一点知识</title>
      <link href="2019/05/16/Android/A-little-knowledge-about-health/"/>
      <url>2019/05/16/Android/A-little-knowledge-about-health/</url>
      
        <content type="html"><![CDATA[<p>从 Android P 开始，Google 开始推荐厂家再定制一个 health 。前不久遇到一个定制 health 中的信息未成功反应到 Framework 的问题，在分析解决问题的过程中，学习到了一点新知识，所以就在这篇文章里根据解决问题的流程做一个小小的记录。</p><blockquote><p>问题：定制 health service 中的一些 health 信息未成功反应到 Framework。</p></blockquote><blockquote><p>已知：定制 health 和 Google healthd 进程都运行于设备中，定制 health 主要重写 healthd_board_battery_update 函数，会通过库文件引用原生代码（system/core/healthd/）中的实现。</p></blockquote><h1 id="初步方案"><a href="#初步方案" class="headerlink" title="初步方案"></a>初步方案</h1><h2 id="简单介绍"><a href="#简单介绍" class="headerlink" title="简单介绍"></a>简单介绍</h2><p>服务创建时都编写了一个 x.rc 文件，用来描述 health service 的一些特点，其中就包括其启动时机。如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># system&#x2F;core&#x2F;healthd&#x2F;android.hardware.health@2.0-service.rc</span><br><span class="line">&#x2F;* sevice 类型的 setction 表示一个可执行程序（进程） *&#x2F;</span><br><span class="line">service health-hal-2-0 &#x2F;vendor&#x2F;bin&#x2F;hw&#x2F;android.hardware.health@2.0-service or healthd.rc</span><br><span class="line">class hal </span><br><span class="line">user system</span><br><span class="line">group system</span><br><span class="line">file &#x2F;dev&#x2F;kmsg w</span><br><span class="line"></span><br></pre></td></tr></table></figure><blockquote><p>启动顺序： hal-&gt; core-&gt; main -&gt; later</p></blockquote><a id="more"></a><h2 id="尝试性修改-health-service-启动时机"><a href="#尝试性修改-health-service-启动时机" class="headerlink" title="尝试性修改 health service 启动时机"></a>尝试性修改 health service 启动时机</h2><p>因为对 Framework 层的处理不熟悉，就根据经验判断定制 health 与 Google healthd 可能有时序冲突，对定制 health 做延迟启动处理，如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># device&#x2F;&lt;vendor&gt;&#x2F;health&#x2F;xxx.rc </span><br><span class="line">- class hal </span><br><span class="line">+ class main </span><br></pre></td></tr></table></figure><p>经过测试，此方案可行，但是这种说不出 root cause 的解决方案难以让人接受，所以也就拉通代码继续研究。</p><h1 id="最终方案"><a href="#最终方案" class="headerlink" title="最终方案"></a>最终方案</h1><h2 id="原理分析"><a href="#原理分析" class="headerlink" title="原理分析"></a>原理分析</h2><h3 id="Framework-层"><a href="#Framework-层" class="headerlink" title="Framework 层"></a>Framework 层</h3><p>首先最大疑问就是 FW 层怎么判断使用哪一个 health 的内容。因 health 信息最终会更新到 BatteryService.java, 尝试在此文件中寻找答案，最终找到如下关键代码：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># frameworks/base/services/core/java/com/android/server/BatteryService.java</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">HealthServiceWrapper</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String TAG = <span class="string">&quot;HealthServiceWrapper&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String INSTANCE_HEALTHD = <span class="string">&quot;backup&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String INSTANCE_VENDOR = <span class="string">&quot;default&quot;</span>;</span><br><span class="line">    <span class="comment">// All interesting instances, sorted by priority high -&gt; low.</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> List&lt;String&gt; sAllInstances =</span><br><span class="line">            Arrays.asList(INSTANCE_VENDOR, INSTANCE_HEALTHD);</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>通过这段代码知道系统是根据 service 的实例名来决定使用哪一个 health。</p><h3 id="service-的实例名"><a href="#service-的实例名" class="headerlink" title="service 的实例名"></a>service 的实例名</h3><h4 id="定制-health"><a href="#定制-health" class="headerlink" title="定制 health"></a>定制 health</h4><p>通过查看如下代码得知定制 health 的实例名为 “default”。</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># device/vendor/health/HealthService.cpp</span></span><br><span class="line"><span class="comment">/*通过库和如下函数引入 Google healthd 部分*/</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> health_service_main();</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta"># hardware/interfaces/health/2.0/utils/libhealthservice/HealthServiceCommon.cpp</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">health_service_main</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span>* instance)</span> </span>&#123;</span><br><span class="line">    gInstanceName = instance;</span><br><span class="line">    <span class="keyword">if</span> (gInstanceName.empty()) &#123;</span><br><span class="line">        gInstanceName = <span class="string">&quot;default&quot;</span>; <span class="comment">// 空白时实例名</span></span><br><span class="line">    &#125;</span><br><span class="line">    healthd_mode_ops = &amp;healthd_mode_service_2_0_ops;</span><br><span class="line">    LOG(INFO) &lt;&lt; LOG_TAG &lt;&lt; gInstanceName &lt;&lt; <span class="string">&quot;: Hal starting main loop...&quot;</span>;</span><br><span class="line">    <span class="keyword">return</span> healthd_main();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="Google-healthd"><a href="#Google-healthd" class="headerlink" title="Google healthd"></a>Google healthd</h4><p>通过查看如下代码得知 healthd 的实例名与定制 health 相同，所以在 Framework 层面，后加载的 service 生效。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"># system&#x2F;core&#x2F;healthd&#x2F;HealthServiceDefault.cpp</span><br><span class="line">&#x2F;* 此 service 实例名为 “default”*&#x2F;</span><br><span class="line">int main(void) &#123;</span><br><span class="line">    return health_service_main();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># system&#x2F;core&#x2F;healthd&#x2F;HealthServiceHealthd.cpp</span><br><span class="line">&#x2F;* 实例名为 “backup”*&#x2F;</span><br><span class="line">int main() &#123;</span><br><span class="line">    return health_service_main(&quot;backup&quot;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># system&#x2F;core&#x2F;healthd&#x2F;Android.bp</span><br><span class="line">&#x2F;* HealthServiceDefault 重写了 HealthServiceHealthd，所以 healthd 使用的实例名为“default”*&#x2F;</span><br><span class="line">cc_binary &#123;</span><br><span class="line">    name: &quot;android.hardware.health@2.0-service.override&quot;,</span><br><span class="line">    defaults: [&quot;android.hardware.health@2.0-service_defaults&quot;],</span><br><span class="line"></span><br><span class="line">    overrides: [</span><br><span class="line">        &quot;healthd&quot;,</span><br><span class="line">    ],</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h2><p>因为我们需要使用定制的 health，所以将原生的实例名改为“backup”，这样这个问题就得以解决了。</p><h2 id="花絮"><a href="#花絮" class="headerlink" title="花絮"></a>花絮</h2><p>我也尝试给定制 health 新建一个实例名，但是未成功，后发现似乎新添实例名需要按如下方式配置一下。但因为时间和研究的动力不足就没有继续了。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;hal format&#x3D;&quot;hidl&quot; optional&#x3D;&quot;true&quot;&gt;</span><br><span class="line">    &lt;name&gt;xxx.xxx&lt;&#x2F;name&gt;</span><br><span class="line">    &lt;version&gt;1.0&lt;&#x2F;version&gt;</span><br><span class="line">    &lt;interface&gt;</span><br><span class="line">        &lt;name&gt;xxx&lt;&#x2F;name&gt;</span><br><span class="line">        &lt;instance&gt;default&lt;&#x2F;instance&gt;</span><br><span class="line">        &lt;instance&gt;backup&lt;&#x2F;instance&gt; # 似乎可以这样添加实例名</span><br><span class="line">    &lt;&#x2F;interface&gt;</span><br><span class="line">&lt;&#x2F;hal&gt;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Android </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Bug </tag>
            
            <tag> Qualcomm </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>pmic voter</title>
      <link href="2019/05/15/Android/pmic-voter/"/>
      <url>2019/05/15/Android/pmic-voter/</url>
      
        <content type="html"><![CDATA[<p>前不久在高通 SDM450 平台接触了 voter 机制（投票机制）。最近终于得空，结合一个问题简单研究了一下。现将研究流程简单记录一下,由于时间有限，所以是实用为目的，没有做详细的分析，不过结合着这篇分析和源码一起参考，应该能快速地应用 voter 做一些事情。</p><h1 id="voter"><a href="#voter" class="headerlink" title="voter"></a>voter</h1><p>第一步是找到 voter 的实现代码，然后分析 voter 的机制。voter 的实现代码主要是为各种 voter 提供接口，我提炼了两个最关键的接口，如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"># kernel&#x2F;msm-4.9&#x2F;drivers&#x2F;power&#x2F;supply&#x2F;qcom&#x2F;pmic-voter.c</span><br><span class="line">&#x2F;*</span><br><span class="line">** vote 函数主要用来给 votable 添加投票选项</span><br><span class="line">** votable: 投票的对象</span><br><span class="line">** client_str: 投票者</span><br><span class="line">** enabled: 投票者的内容（val）是否参与投票</span><br><span class="line">** val: 投票内容</span><br><span class="line">**&#x2F;</span><br><span class="line">int vote(struct votable *votable, const char *client_str, bool enabled, int val)</span><br><span class="line">&#123;</span><br><span class="line">...</span><br><span class="line">    switch (votable-&gt;type) &#123; &#x2F;&#x2F; type 的值来自于 create_votable()</span><br><span class="line">case VOTE_MIN: &#x2F;&#x2F; 取投票对象所有内容的最小值</span><br><span class="line">vote_min(votable, client_id, &amp;effective_result, &amp;effective_id);</span><br><span class="line">break;</span><br><span class="line">case VOTE_MAX:</span><br><span class="line">vote_max(votable, client_id, &amp;effective_result, &amp;effective_id);</span><br><span class="line">break;</span><br><span class="line">case VOTE_SET_ANY:</span><br><span class="line">vote_set_any(votable, client_id,</span><br><span class="line">&amp;effective_result, &amp;effective_id);</span><br><span class="line">break;</span><br><span class="line">...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#x2F;* 投票相关参数，可以在此文件中搜索此结构体的成员找到其值从哪儿来*&#x2F;</span><br><span class="line">struct votable &#123;</span><br><span class="line">inttype;</span><br><span class="line">...</span><br><span class="line">int(*callback)(struct votable *votable,</span><br><span class="line">&#125;</span><br><span class="line">---&gt; </span><br><span class="line"></span><br><span class="line">struct votable *create_votable(const char *name,</span><br><span class="line">int votable_type,</span><br><span class="line">int (*callback)(struct votable *votable,..)</span><br><span class="line">&#123;</span><br><span class="line">    &#x2F;&#x2F; 创建 votable, 引入 votable type 和 callback 函数</span><br><span class="line">...</span><br><span class="line">    &#x2F;* 创建 debugfs*&#x2F;</span><br><span class="line">debug_root &#x3D; debugfs_create_dir(&quot;pmic-votable&quot;, NULL);</span><br><span class="line">...</span><br><span class="line">&#125;</span><br><span class="line">eg: 创建流入电池电流的投票对象</span><br><span class="line">chip-&gt;fcc_votable &#x3D; create_votable(&quot;FCC&quot;, VOTE_MIN,</span><br><span class="line">pl_fcc_vote_callback,</span><br><span class="line">chip);</span><br></pre></td></tr></table></figure><a id="more"></a><h1 id="pmic-voter-debugfs"><a href="#pmic-voter-debugfs" class="headerlink" title="pmic voter debugfs"></a>pmic voter debugfs</h1><p>通过 voter 的文件节点能够比较清晰的看出 voter 结构。如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"># &#x2F;sys&#x2F;kernel&#x2F;debug&#x2F;pmic-votable&#x2F;</span><br><span class="line">cat status</span><br><span class="line">FCC: HW_LIMIT_VOTER:en&#x3D;0 v&#x3D;-22</span><br><span class="line">FCC: BATT_PROFILE_VOTER:en&#x3D;1 v&#x3D;1500000</span><br><span class="line">FCC: SW_ICL_MAX_VOTER:en&#x3D;1 v&#x3D;1500000</span><br><span class="line">FCC: THERMAL_DAEMON_VOTER:en&#x3D;0 v&#x3D;0</span><br><span class="line">FCC: FCC_SOC_VOTER:en&#x3D;1 v&#x3D;1000000</span><br><span class="line">FCC: JEITA_VOTER:en&#x3D;1 v&#x3D;1500000</span><br><span class="line">FCC: STEP_CHG_VOTER:en&#x3D;0 v&#x3D;0</span><br><span class="line">FCC: TAPER_STEPPER_VOTER:en&#x3D;0 v&#x3D;0</span><br><span class="line">FCC: effective&#x3D;FCC_SOC_VOTER type&#x3D;Min v&#x3D;1000000</span><br><span class="line"></span><br></pre></td></tr></table></figure><h1 id="一个问题案例"><a href="#一个问题案例" class="headerlink" title="一个问题案例"></a>一个问题案例</h1><p><strong>[Description]</strong></p><p>设备在不同温度条件下有不同的电流限制，但是在测试设备时发现一个问题：电池温度升温过程中，设备并没有在 cool 零界限改变温度，而是再超过临界线 2~3 ℃ 的时候才做相应动作。</p><p><strong>[Root cause]</strong></p><p>默认的 jeita 标准相关代码有一个温度临界值保护并延迟改变电流值的设定，当达到临界值时并不马上改变电流限制，继续投票上一阶段的电流值，当温度达到定义的延迟温度时，再投票当前阶段的电流值。</p><p><strong>[Solution]</strong><br>如需要修改此问题的话，取消温度临界值保护（即将温度滞后值改为 0）即可。</p><p>详细情况如下：</p><h2 id="每个阶段温度和电流值的定义"><a href="#每个阶段温度和电流值的定义" class="headerlink" title="每个阶段温度和电流值的定义"></a>每个阶段温度和电流值的定义</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># kernel&#x2F;msm-4.9&#x2F;arch&#x2F;arm64&#x2F;boot&#x2F;dts&#x2F;qcom&#x2F;vendor&#x2F;qg-batterydata-xxx.dtsi</span><br><span class="line"></span><br><span class="line">qcom,jeita-fcc-ranges &#x3D; &lt;50   150  800000  &#x2F;&#x2F;阶段一  COOL</span><br><span class="line">151  450  1500000 &#x2F;&#x2F; 阶段二 GOOD</span><br><span class="line">451  500  1400000&gt;; &#x2F;&#x2F; 阶段三 Warm</span><br></pre></td></tr></table></figure><h2 id="关键源码"><a href="#关键源码" class="headerlink" title="关键源码"></a>关键源码</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"># kernel&#x2F;msm-4.9&#x2F;drivers&#x2F;power&#x2F;supply&#x2F;qcom&#x2F;step-chg-jeita.c</span><br><span class="line">&#x2F;* 定义 jeita 标准延迟设定相关参数 *&#x2F;</span><br><span class="line">chip-&gt;jeita_fcc_config-&gt;psy_prop &#x3D; POWER_SUPPLY_PROP_TEMP;</span><br><span class="line">chip-&gt;jeita_fcc_config-&gt;prop_name &#x3D; &quot;BATT_TEMP&quot;;</span><br><span class="line">chip-&gt;jeita_fcc_config-&gt;hysteresis &#x3D; 10;</span><br><span class="line"></span><br><span class="line">&#x2F;* jeita 生效函数 *&#x2F;</span><br><span class="line">static int handle_jeita(struct step_chg_info *chip)</span><br><span class="line">&#123;</span><br><span class="line">rc &#x3D; power_supply_get_property(chip-&gt;batt_psy,</span><br><span class="line">chip-&gt;jeita_fcc_config-&gt;psy_prop, &amp;pval);</span><br><span class="line">rc &#x3D; get_val(chip-&gt;jeita_fcc_config-&gt;fcc_cfg,</span><br><span class="line">chip-&gt;jeita_fcc_config-&gt;,</span><br><span class="line">chip-&gt;jeita_fcc_index,</span><br><span class="line">pval.intval,</span><br><span class="line">&amp;chip-&gt;jeita_fcc_index,</span><br><span class="line">&amp;fcc_ua);</span><br><span class="line"></span><br><span class="line">&#x2F;* 投票获取到的电流值 *&#x2F;</span><br><span class="line">vote(chip-&gt;fcc_votable, JEITA_VOTER, fcc_ua ? true : false, fcc_ua);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#x2F;* 获取当前应投票的电流值 *&#x2F;</span><br><span class="line">get_val(...) </span><br><span class="line">&#123;</span><br><span class="line">&#x2F;*</span><br><span class="line"> * Check for hysteresis if it in the neighbourhood</span><br><span class="line"> * of our current index.</span><br><span class="line"> *&#x2F;</span><br><span class="line">if (*new_index &#x3D;&#x3D; current_index + 1) &#123;</span><br><span class="line">    &#x2F;* 当温度小于临界值 + 延迟时，继续使用上一阶段的电流值</span><br><span class="line">if (threshold &lt; range[*new_index].low_threshold + hysteresis) &#123;</span><br><span class="line">&#x2F;*</span><br><span class="line"> * Stay in the current index, threshold is not higher</span><br><span class="line"> * by hysteresis amount</span><br><span class="line"> *&#x2F;</span><br><span class="line">*new_index &#x3D; current_index;</span><br><span class="line">*val &#x3D; range[current_index].value;</span><br><span class="line">&#125;</span><br><span class="line">&#125; else if (*new_index &#x3D;&#x3D; current_index - 1) &#123;</span><br><span class="line">if (threshold &gt; range[*new_index].high_threshold - hysteresis) &#123;</span><br><span class="line">&#x2F;*</span><br><span class="line"> * stay in the current index, threshold is not lower</span><br><span class="line"> * by hysteresis amount</span><br><span class="line"> *&#x2F;</span><br><span class="line">*new_index &#x3D; current_index;</span><br><span class="line">*val &#x3D; range[current_index].value;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Android </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Qualcomm </tag>
            
            <tag> 源码分析 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Gitbook + Jenkins + Gitlab 搭建内网自动构建的 Gitbook</title>
      <link href="2019/05/05/Git/gitlab-jenkins-gitbook-to-create-LAN-gitbook/"/>
      <url>2019/05/05/Git/gitlab-jenkins-gitbook-to-create-LAN-gitbook/</url>
      
        <content type="html"><![CDATA[<p>最近在本地搭建了一个 Gitbook ，用于内网访问。总结一下简单流程形成此文，细节设置可以参考官网。</p><h2 id="Gitbook"><a href="#Gitbook" class="headerlink" title="Gitbook"></a>Gitbook</h2><h3 id="Install-Git"><a href="#Install-Git" class="headerlink" title="Install Git"></a>Install Git</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install git</span><br></pre></td></tr></table></figure><a id="more"></a><h3 id="Install-Node-js"><a href="#Install-Node-js" class="headerlink" title="Install Node.js"></a>Install Node.js</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install Node.js</span><br></pre></td></tr></table></figure><h3 id="Install-npm"><a href="#Install-npm" class="headerlink" title="Install npm"></a>Install npm</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install npm</span><br></pre></td></tr></table></figure><h3 id="Install-gitbook"><a href="#Install-gitbook" class="headerlink" title="Install gitbook"></a>Install gitbook</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">npm install gitbook-cli -g</span><br><span class="line">gitbook -V</span><br></pre></td></tr></table></figure><h3 id="Test-gitbook-server-web"><a href="#Test-gitbook-server-web" class="headerlink" title="Test gitbook server-web"></a>Test gitbook server-web</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mkdir server</span><br><span class="line">cd server</span><br><span class="line">gitbook init</span><br><span class="line">gitbook build .</span><br><span class="line">gitbook serve .</span><br></pre></td></tr></table></figure><h2 id="Gitlab"><a href="#Gitlab" class="headerlink" title="Gitlab"></a>Gitlab</h2><h3 id="Install-and-configure-the-necessary-dependencies"><a href="#Install-and-configure-the-necessary-dependencies" class="headerlink" title="Install and configure the necessary dependencies"></a>Install and configure the necessary dependencies</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get update</span><br><span class="line">sudo apt-get install -y curl openssh-server ca-certificates</span><br></pre></td></tr></table></figure><h3 id="Install-Postfix-to-send-notification-emails"><a href="#Install-Postfix-to-send-notification-emails" class="headerlink" title="Install Postfix to send notification emails."></a>Install Postfix to send notification emails.</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install -y postfix</span><br></pre></td></tr></table></figure><h3 id="Add-the-GitLab-package-repository-and-install"><a href="#Add-the-GitLab-package-repository-and-install" class="headerlink" title="Add the GitLab package repository and install ."></a>Add the GitLab package repository and install .</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">curl https:&#x2F;&#x2F;packages.gitlab.com&#x2F;install&#x2F;repositories&#x2F;gitlab&#x2F;gitlab-ee&#x2F;script.deb.sh | sudo bash</span><br><span class="line">sudo EXTERNAL_URL&#x3D;&quot;https:&#x2F;&#x2F;gitlab.example.com&quot; apt-get install gitlab-ee</span><br></pre></td></tr></table></figure><h3 id="Config-gitlab"><a href="#Config-gitlab" class="headerlink" title="Config gitlab"></a>Config gitlab</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">sudo mkdir -p &#x2F;etc&#x2F;gitlab</span><br><span class="line">sudo touch &#x2F;etc&#x2F;gitlab&#x2F;gitlab.rb</span><br><span class="line">sudo chmod 600 &#x2F;etc&#x2F;gitlab&#x2F;gitlab.rb</span><br><span class="line">sudo vim &#x2F;etc&#x2F;gitlab&#x2F;gitlab.rb</span><br><span class="line"># external_url &#39;http:&#x2F;&#x2F;164.69.136.23&#39; , config as local ip or url.</span><br><span class="line"># Modification is suggested. If &#39;502 GitLab is not responding...&#39; error exists, modify &#39;unicorn[&#39;port&#39;]&#39; in gitlab.rb. </span><br><span class="line"></span><br><span class="line">sudo gitlab-ctl reconfigure # reconfigure and restart.</span><br><span class="line">sudo gitlab-ctl status</span><br></pre></td></tr></table></figure><h2 id="Jenkins"><a href="#Jenkins" class="headerlink" title="Jenkins"></a>Jenkins</h2><h3 id="Install-Java"><a href="#Install-Java" class="headerlink" title="Install Java"></a>Install Java</h3><p>推荐安装 openjdk-7-jre 和 openjdk-7-jdk ，但是其在 Ubuntu 16.04 和更高版本不再有效，可以安装 Java 8 或者 9 代替。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install openjdk-7-jre</span><br><span class="line">sudo apt-get install openjdk-7-jdk</span><br></pre></td></tr></table></figure><h3 id="Install-Jenkins"><a href="#Install-Jenkins" class="headerlink" title="Install Jenkins"></a>Install Jenkins</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">wget -q -O - https:&#x2F;&#x2F;pkg.jenkins.io&#x2F;debian&#x2F;jenkins-ci.org.key | sudo apt-key add -</span><br><span class="line">sudo sh -c &#39;echo deb http:&#x2F;&#x2F;pkg.jenkins.io&#x2F;debian-stable binary&#x2F; &gt; &#x2F;etc&#x2F;apt&#x2F;sources.list.d&#x2F;jenkins.list&#39;</span><br><span class="line">sudo apt-get update</span><br><span class="line">sudo apt-get install jenkins</span><br></pre></td></tr></table></figure><h3 id="Upgrade-Jenkins"><a href="#Upgrade-Jenkins" class="headerlink" title="Upgrade Jenkins"></a>Upgrade Jenkins</h3><p>Jenkins 更新比较快，如若过期，可以按如下命令更新。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get update</span><br><span class="line">sudo apt-get install jenkins</span><br></pre></td></tr></table></figure><h3 id="Config-Jenkins"><a href="#Config-Jenkins" class="headerlink" title="Config Jenkins"></a>Config Jenkins</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo vi &#x2F;etc&#x2F;init.d&#x2F;jenkins</span><br><span class="line"># Modify HTTP_PORT is suggested.</span><br><span class="line">sudo vi &#x2F;etc&#x2F;sudoers</span><br><span class="line"># jenkins ALL&#x3D;(ALL) NOPASSWD:ALL ; 赋予 Jenkins sudo 权限和无密权限</span><br></pre></td></tr></table></figure><h3 id="Install-plugin"><a href="#Install-plugin" class="headerlink" title="Install plugin"></a>Install plugin</h3><p>通过 web(eg:<a href="http://192.168.1.2:8080/">http://192.168.1.2:8080</a>)  访问Jenkins 并安装插件 Git plugin　和　Gitlab Hook Plugin 。 </p><blockquote><p>初次登陆时注意 check web 提示的密码地址。</p></blockquote><h2 id="Nginx"><a href="#Nginx" class="headerlink" title="Nginx"></a>Nginx</h2><h3 id="Install-nginx"><a href="#Install-nginx" class="headerlink" title="Install nginx"></a>Install nginx</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install nginx</span><br><span class="line"># upgrade</span><br><span class="line">sudo apt-add-repository ppa:nginx&#x2F;stable</span><br><span class="line">sudo apt-get update</span><br><span class="line">sudo apt-get upgrade nginx -y</span><br><span class="line"></span><br><span class="line">sudo service nginx start</span><br></pre></td></tr></table></figure><blockquote><p>nginx 默认使用 80 端口，打开浏览器输入：<a href="http://localhost/">http://localhost/</a></p></blockquote><h3 id="Config-nginx"><a href="#Config-nginx" class="headerlink" title="Config nginx"></a>Config nginx</h3><p>sudo vi /etc/nginx/nginx.conf ， 注释掉不需要的配置文件，并新配 server 。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"># comment to solve &quot;Welcome to nginx ...&quot; issue.</span><br><span class="line"># include &#x2F;etc&#x2F;nginx&#x2F;conf.d&#x2F;*.conf;</span><br><span class="line"># include &#x2F;etc&#x2F;nginx&#x2F;sites-enabled&#x2F;*;</span><br><span class="line">server &#123;</span><br><span class="line">        server_name localhost;</span><br><span class="line">        listen 8082; # config port</span><br><span class="line">        location &#x2F; &#123;</span><br><span class="line">                root &#x2F;home&#x2F;lee&#x2F;gitbook&#x2F;www&#x2F;mybook; # 自定义，用于存放 gitbook 内容</span><br><span class="line">                #index  index.html index.html;</span><br><span class="line"></span><br><span class="line">                #autoindex</span><br><span class="line">                autoindex on;</span><br><span class="line">                autoindex_exact_size on;</span><br><span class="line">                autoindex_localtime on;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line">nginx -t # 检查配置文件是否正常</span><br><span class="line">nginx -s reload # 重启</span><br><span class="line">若出现错误：</span><br><span class="line">nginx:[error] open() &quot;&#x2F;run&#x2F;nginx.pid&quot; failed (2: No such file or directory)</span><br><span class="line"></span><br><span class="line">nginx -c &#x2F;etc&#x2F;nginx&#x2F;nginx.conf</span><br><span class="line">nginx -s reload</span><br><span class="line">nginx -s stop</span><br></pre></td></tr></table></figure><h2 id="Automaticaly-trigger"><a href="#Automaticaly-trigger" class="headerlink" title="Automaticaly trigger"></a>Automaticaly trigger</h2><h3 id="Config-gitlab-1"><a href="#Config-gitlab-1" class="headerlink" title="Config gitlab"></a>Config gitlab</h3><h4 id="Add-access-token"><a href="#Add-access-token" class="headerlink" title="Add access token"></a>Add access token</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">user settings ---&gt; Access Tokens</span><br></pre></td></tr></table></figure><blockquote><p><em>记录下 token ，一旦关闭网页，此 token 将不再可见。</em></p></blockquote><h4 id="Create-mybook"><a href="#Create-mybook" class="headerlink" title="Create mybook"></a>Create mybook</h4><p>新建一个项目 <mybook>， 添加 webhooks.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">a. Settings ---&gt; Integrations </span><br><span class="line">b. add url: http:&#x2F;&#x2F;192.168.1.2:8082&#x2F;gitlab&#x2F;build_now (jenkins url) .</span><br><span class="line">c. Select push event.</span><br><span class="line">d. Add webhook.</span><br></pre></td></tr></table></figure><p>在本地项目路径执行 ‘gitbook init’ 生成 README.md 和 SUMMARY.md 两个文件， push 到 gitlab.</p><h3 id="Config-Jenkins-1"><a href="#Config-Jenkins-1" class="headerlink" title="Config Jenkins"></a>Config Jenkins</h3><h4 id="Add-tokens"><a href="#Add-tokens" class="headerlink" title="Add tokens"></a>Add tokens</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># 系统管理 ---&gt; 系统设置</span><br><span class="line">Gitlab:</span><br><span class="line">Connection name: gitlab</span><br><span class="line">Gitlab host url: gitlab url</span><br><span class="line">credentials: Add token, 填入上面 Access Tokens.</span><br><span class="line">Test connection.</span><br></pre></td></tr></table></figure><h4 id="Config-trigger"><a href="#Config-trigger" class="headerlink" title="Config trigger"></a>Config trigger</h4><p>新建任务 <mybook> —&gt; 构建一个自由风格的软件项目:</p><ol><li><p>源码管理: git</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Repository URL:</span><br><span class="line"></span><br><span class="line">http:&#x2F;&#x2F;192.168.1.2:8081&#x2F;root&#x2F;mybook.git</span><br><span class="line">Credentials ---&gt; Add , 填入 Gitlab 用户名和密码　</span><br></pre></td></tr></table></figure></li><li><p>构建 —&gt; 执行 shell</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">gitbook build</span><br><span class="line">sudo rm -rf  &#x2F;home&#x2F;lee&#x2F;gitbook&#x2F;www&#x2F;mybook</span><br><span class="line">sudo cp -a    _book  &#x2F;home&#x2F;lee&#x2F;gitbook&#x2F;www&#x2F;mybook</span><br><span class="line">sudo chmod  777  &#x2F;home&#x2F;lee&#x2F;gitbook&#x2F;www&#x2F;mybook</span><br></pre></td></tr></table></figure><p>　</p><h3 id="Preview"><a href="#Preview" class="headerlink" title="Preview"></a>Preview</h3><p>更新本地文件，然后 push 到 Gitlab, 查看 Jenkins 是否会自动触发构建。</p></li></ol><p>如果 OK ， 整个配置流程就完成了，也可以直接预览 Gitbook了。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;192.168.1.2:8082 (nginx port)</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Git </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>Three ways to dump usb register</title>
      <link href="2018/08/23/Android/Three-ways-to-dump-usb-register/"/>
      <url>2018/08/23/Android/Three-ways-to-dump-usb-register/</url>
      
        <content type="html"><![CDATA[<h3 id="Add-node"><a href="#Add-node" class="headerlink" title="Add node"></a>Add node</h3><p>此方法只为一个示例，有些平台不是使用此文件，如 SDM450（MSM8953）使用的 dwc3-qcom.c 。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"># kernel&#x2F;msm-4.9&#x2F;drivers&#x2F;usb&#x2F;phy&#x2F;phy-msm-usb.c</span><br><span class="line">@@ -51,6 +51,11 @@</span><br><span class="line"> </span><br><span class="line"> #include &lt;linux&#x2F;msm-bus.h&gt;</span><br><span class="line"> </span><br><span class="line">+#undef dev_dbg</span><br><span class="line">+#define dev_dbg dev_info</span><br><span class="line">+#undef pr_debug</span><br><span class="line">+#define pr_debug pr_info</span><br><span class="line">+</span><br><span class="line"> &#x2F;**</span><br><span class="line">  * Requested USB votes for BUS bandwidth</span><br><span class="line">  *</span><br><span class="line">@@ -3601,6 +3606,53 @@ static int msm_otg_setup_devices(struct</span><br><span class="line"> return retval;</span><br><span class="line"> &#125;</span><br><span class="line"> </span><br><span class="line">+</span><br><span class="line">+#define DUMP_ENTRIES152</span><br><span class="line">+</span><br><span class="line">+static ssize_t usbphy_regs_show(struct device *dev,</span><br><span class="line">+       struct device_attribute *attr, char *buf)</span><br><span class="line">+&#123;</span><br><span class="line">+struct msm_otg *motg &#x3D; the_msm_otg;</span><br><span class="line">+&#x2F;&#x2F;struct msm_otg_platform_data *pdata &#x3D; motg-&gt;pdata;</span><br><span class="line">+struct usb_phy *phy &#x3D; &amp;motg-&gt;phy;</span><br><span class="line">+u32 *dump;</span><br><span class="line">+unsigned int i,  n &#x3D; 0;</span><br><span class="line">+&#x2F;&#x2F;dbg_trace(&quot;[%s] %pK\n&quot;, __func__, buf);</span><br><span class="line">+if (attr &#x3D;&#x3D; NULL || buf &#x3D;&#x3D; NULL) &#123;</span><br><span class="line">+dev_err(dev, &quot;[%s] EINVAL\n&quot;, __func__);</span><br><span class="line">+return 0;</span><br><span class="line">+&#125;</span><br><span class="line">+if (atomic_read(&amp;motg-&gt;in_lpm))&#123;</span><br><span class="line">+        dev_err(dev, &quot;[%s] usb in lpm\n&quot;, __func__);</span><br><span class="line">+return 0;</span><br><span class="line">+        &#125;</span><br><span class="line">+dump &#x3D; kmalloc(sizeof(u8) * DUMP_ENTRIES, GFP_KERNEL);</span><br><span class="line">+if (!dump)</span><br><span class="line">+return 0;</span><br><span class="line">+</span><br><span class="line">+        for(i &#x3D; 0; i &lt; DUMP_ENTRIES -1; i++)</span><br><span class="line">+        dump[i] &#x3D; ulpi_read(phy, i);</span><br><span class="line">+</span><br><span class="line">+for (i &#x3D; 0; i &lt; DUMP_ENTRIES -1; i++) &#123;</span><br><span class="line">+n +&#x3D; scnprintf(buf + n, PAGE_SIZE - n,</span><br><span class="line">+       &quot;reg[0x%04X] &#x3D; 0x%04X\n&quot;,</span><br><span class="line">+       i, dump[i]);</span><br><span class="line">+&#125;</span><br><span class="line">+kfree(dump);</span><br><span class="line">+</span><br><span class="line">+return n;</span><br><span class="line">+&#125;</span><br><span class="line">+</span><br><span class="line">+static ssize_t usbphy_regs_store(struct device *dev,</span><br><span class="line">+struct device_attribute *attr, const char</span><br><span class="line">+*buf, size_t size)</span><br><span class="line">+&#123;</span><br><span class="line">+return size;</span><br><span class="line">+&#125;</span><br><span class="line">+</span><br><span class="line">+static DEVICE_ATTR(usbphy_regs, 0644,</span><br><span class="line">+usbphy_regs_show, usbphy_regs_store);</span><br><span class="line">+</span><br><span class="line"> static ssize_t dpdm_pulldown_enable_show(struct device *dev,</span><br><span class="line">        struct device_attribute *attr, char *buf)</span><br><span class="line"> &#123;</span><br><span class="line">@@ -4426,6 +4478,7 @@ static int msm_otg_probe(struct platform</span><br><span class="line"> motg-&gt;caps |&#x3D; ALLOW_HOST_PHY_RETENTION;</span><br><span class="line"> </span><br><span class="line"> device_create_file(&amp;pdev-&gt;dev, &amp;dev_attr_dpdm_pulldown_enable);</span><br><span class="line">+device_create_file(&amp;pdev-&gt;dev, &amp;dev_attr_usbphy_regs);</span><br><span class="line"> </span><br><span class="line"> if (motg-&gt;pdata-&gt;enable_lpm_on_dev_suspend)</span><br><span class="line"> motg-&gt;caps |&#x3D; ALLOW_LPM_ON_DEV_SUSPEND;</span><br><span class="line">@@ -4527,6 +4580,7 @@ otg_remove_devices:</span><br><span class="line"> remove_cdev:</span><br><span class="line"> pm_runtime_disable(&amp;pdev-&gt;dev);</span><br><span class="line"> device_remove_file(&amp;pdev-&gt;dev, &amp;dev_attr_dpdm_pulldown_enable);</span><br><span class="line">+device_remove_file(&amp;pdev-&gt;dev, &amp;dev_attr_usbphy_regs);</span><br><span class="line"> msm_otg_debugfs_cleanup();</span><br><span class="line"> phy_reg_deinit:</span><br><span class="line"> devm_regulator_unregister(motg-&gt;phy.dev, motg-&gt;dpdm_rdev);</span><br><span class="line">@@ -4619,6 +4673,7 @@ static int msm_otg_remove(struct platfor</span><br><span class="line"> usb_remove_phy(phy);</span><br><span class="line"> </span><br><span class="line"> device_remove_file(&amp;pdev-&gt;dev, &amp;dev_attr_dpdm_pulldown_enable);</span><br><span class="line">+device_remove_file(&amp;pdev-&gt;dev, &amp;dev_attr_usbphy_regs);</span><br><span class="line"> </span><br><span class="line"> &#x2F;*</span><br><span class="line">  * Put PHY in low power mode.</span><br></pre></td></tr></table></figure><a id="more"></a><h3 id="trace"><a href="#trace" class="headerlink" title="trace"></a>trace</h3><p>通过如下指令去 crash 设备，然后用 trace32 去读取寄存器值。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo c &gt; &#x2F;proc&#x2F;sysrq-triger</span><br></pre></td></tr></table></figure><h3 id="busybox"><a href="#busybox" class="headerlink" title="busybox"></a>busybox</h3><p>dump usb registers via busybox.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;data&#x2F;busybox devmem &lt;address&gt; 32</span><br><span class="line">or </span><br><span class="line">r &lt;address&gt;  # system&#x2F;core&#x2F;toolbox&#x2F;r.c , 比 busybox 轻量化的一个工具</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Android </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Qualcomm </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>17 小结，18 计划!</title>
      <link href="2018/02/12/Life/Bye-2017-Hi-2018/"/>
      <url>2018/02/12/Life/Bye-2017-Hi-2018/</url>
      
        <content type="html"><![CDATA[<p>时光总是匆匆，一转眼 18 年都已经 2 月份了，今天是农历新年前倒数第二天上班了。17 年过得不那么顺畅，自己想做的很多事都没做，很遗憾；18 年自己即将 30 岁，想想还是很惶恐，已到而立之年了。这些时间自己的懒散加上工作上的事情，很久没有写东西了，博客也好久没有更新过了，考虑到今年的状态，和明年一些决定，今天来写个小结，列个计划。</p><h2 id="遗憾的-17-年"><a href="#遗憾的-17-年" class="headerlink" title="遗憾的 17 年"></a>遗憾的 17 年</h2><p>17 年整体来说对自己是有些失望的，生活上遇到了一件让自己痛心的事情，也完成了人生一件最重要的事情，工作上除了薪资的涨幅，自己没有明显的进步，也没有什么成就感。</p><a id="more"></a><h3 id="徘徊"><a href="#徘徊" class="headerlink" title="徘徊"></a>徘徊</h3><p>本来17年就有回成都的计划了，但是受一些事情的牵绊，走不了，所以这一年很多时候自己处于比较迷茫，比较徘徊的心理状态。 在前公司最后一段时间，自己很早就觉得上班没意思应该要辞职的，但是受到私事的牵绊，也考虑到 18 年要回家发展了，自己就一直耗在公司没有辞职。到后面有朋友介绍工作，终于下定决心换个环境，阴差阳错进到了现在的公司，过来后换了新平台，到现在这几个月事情相对还是比较多，才没有时间去徘徊了。</p><h3 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h3><p>这一年本来有很多事情要去做的， 最重要的两件：学英语、锻炼。 这两件事没有坚持下来，是对自己失望的主因，业余阅读和写作没坚持下来也比较令人伤心，Android、Python等技术的提升没有坚持下来，考虑到外部环境和自己的时间，尚还能让自己接受。所以总的来说 17 年是有些遗憾和失望的。</p><h2 id="而立的-18-年"><a href="#而立的-18-年" class="headerlink" title="而立的 18 年"></a>而立的 18 年</h2><p>18 年是自己的而立之年了， 除了准备回家发展，应该还会是我真正成长的一年。希望今年不让自己失望，也要担负起整个家庭的责任了。</p><h3 id="习惯养成"><a href="#习惯养成" class="headerlink" title="习惯养成"></a>习惯养成</h3><p>按照如下模式培养一下自己的习惯，坚持下去。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">21天 -&gt; 100天 -&gt; 1 年 -&gt; Until disappear </span><br></pre></td></tr></table></figure><p>18 年按优先级加入如下任务：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">- 背单词</span><br><span class="line">- 锻炼</span><br><span class="line">- 冥想</span><br><span class="line">- 阅读</span><br></pre></td></tr></table></figure><p>还有如下以周为单位的坚持：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">- 博文（每周至少一篇技术 or 阅读 or 生活）</span><br><span class="line">- 陪老婆周边游散心</span><br><span class="line">-</span><br></pre></td></tr></table></figure><h3 id="生活"><a href="#生活" class="headerlink" title="生活"></a>生活</h3><h4 id="回成都"><a href="#回成都" class="headerlink" title="回成都"></a>回成都</h4><p>预计4~5月份回成都，开年后首要任务：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">- 解决工作问题</span><br><span class="line">- 处理回家相关事宜</span><br></pre></td></tr></table></figure><p>回家稳定后，首要任务：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">- 找一家健身房</span><br><span class="line">- 学习游泳</span><br><span class="line">- 买车</span><br></pre></td></tr></table></figure><h4 id="生活安排"><a href="#生活安排" class="headerlink" title="生活安排"></a>生活安排</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">- 节假日多陪陪家人，常回家看看</span><br><span class="line">- 为家人安排体检</span><br><span class="line">- 给自己（老婆）买保险</span><br><span class="line">- </span><br></pre></td></tr></table></figure><h4 id="几个着重注意点"><a href="#几个着重注意点" class="headerlink" title="几个着重注意点"></a>几个着重注意点</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">- 睡前阅读、冥想</span><br><span class="line">- 碎片时间利用，阅读或背单词</span><br><span class="line">- 早或晚锻炼，至少简单活动一下筋骨（颈椎和腰部是重点部位），尤其自己现在身体太僵硬</span><br></pre></td></tr></table></figure><h3 id="工作"><a href="#工作" class="headerlink" title="工作"></a>工作</h3><h4 id="新工作"><a href="#新工作" class="headerlink" title="新工作"></a>新工作</h4><p>首要任务就是找到一个合适的新工作，得满足：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">- 自己的工作有意义，有挑战</span><br><span class="line">- 公司有发展有潜力，或者不错的大公司</span><br><span class="line">- 薪酬福利不比深圳差太多</span><br></pre></td></tr></table></figure><h4 id="工作习惯"><a href="#工作习惯" class="headerlink" title="工作习惯"></a>工作习惯</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">- 排除干扰、拆分，复杂问题简单化</span><br><span class="line">- 控制变量法，单独提出问题部分，Demo 复现验证及解决</span><br><span class="line">- 知其然知其所以然，总结</span><br></pre></td></tr></table></figure><h4 id="工作计划"><a href="#工作计划" class="headerlink" title="工作计划"></a>工作计划</h4><p>这个得依据工作内容来确定，不过得做到：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">- 每天/周做好工作计划</span><br><span class="line">- 不无谓地浪费时间</span><br></pre></td></tr></table></figure><h3 id="学习"><a href="#学习" class="headerlink" title="学习"></a>学习</h3><h4 id="阅读内容"><a href="#阅读内容" class="headerlink" title="阅读内容"></a>阅读内容</h4><p>需要加入阅读内容的任务：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">- 古诗词</span><br><span class="line">- 医疗、法律相关书籍</span><br><span class="line">- 理财、优秀书籍</span><br><span class="line">- 英文原著</span><br><span class="line">- 技术书籍</span><br></pre></td></tr></table></figure><h4 id="一些计划"><a href="#一些计划" class="headerlink" title="一些计划"></a>一些计划</h4><p>一些需要好好实现的安排计划：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">- 针对每个时间段拟定合适的计划</span><br><span class="line">- 每周审视自己，做好更新/总结</span><br><span class="line">- 至少完成 20 本书籍的阅读，5 本英文原著 + 8 本技术书籍 + 7 本其他，技术书籍至少 3 本精读</span><br><span class="line">- 每阅读完成一本书籍，至少形成一片博文</span><br><span class="line">- 技术博客的选题和实现质量</span><br></pre></td></tr></table></figure><h4 id="学习的内容"><a href="#学习的内容" class="headerlink" title="学习的内容"></a>学习的内容</h4><h5 id="英语"><a href="#英语" class="headerlink" title="英语"></a>英语</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">- 背诵完成4、6级单词，后续再选扩展单词背诵</span><br><span class="line">- 阅读合适的英文原著，培养语感，熟悉单词</span><br><span class="line">- 平时技术上尽量看英文相关</span><br><span class="line">- 精读 2 本英文原著，看一些英文文章</span><br><span class="line">- 不限范围的泛听，每周精听一篇文章</span><br><span class="line">- 已购英文资料</span><br></pre></td></tr></table></figure><h5 id="技术学习"><a href="#技术学习" class="headerlink" title="技术学习"></a>技术学习</h5><p>考虑到回成都后我或许会小转行一下，这部分需要依据回成都的工作内容来定制，不过如下部分还是安排好时间：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">- 已购 Linux 书籍，多看精看</span><br><span class="line">- 分析源码（Android、Linux Kernel）</span><br><span class="line">- Android 应用 、 Python（不作高优先级）</span><br><span class="line">- 已购 Android 相关书籍</span><br></pre></td></tr></table></figure><p>18 年对于我来说注定会是忙碌的一年，有太多的事情需要处理，希望自己能都处理好并完成自己的计划。当然上面这些都是比较笼统的计划，所以自己还需要制定一个目标明确、详细的计划，这个计划还得根据实际情况反馈更新。</p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Android传感器（Sensor）架构简析 (╯_╰)</title>
      <link href="2017/12/17/Android/android-sensor-arch-analysis/"/>
      <url>2017/12/17/Android/android-sensor-arch-analysis/</url>
      
        <content type="html"><![CDATA[<blockquote><p>这真的是一篇简析。。。 (╯_╰)  本来准备详细分析整个 sensor 架构的，实在时间紧张，只能先简析了。</p></blockquote><p><em>Platform information： MTK6797（X20）+ Android 7.0</em></p><h1 id="Android-支持的传感器"><a href="#Android-支持的传感器" class="headerlink" title="Android 支持的传感器"></a>Android 支持的传感器</h1><p>现在 Android 支持多达数十种的各种各样的传感器，支持的类型如下：</p><p><img src="https://andylee-1258982386.cos.ap-chengdu.myqcloud.com/android/mtk/sensor_type.jpg" alt="Sensor_Type"></p><h1 id="Android-Sensor-架构"><a href="#Android-Sensor-架构" class="headerlink" title="Android Sensor 架构"></a>Android Sensor 架构</h1><a id="more"></a><p>因为功耗和效率等原因，高通后期平台将 sensor 部分放在 aDSP 中，与如下分析十分不同。</p><p>Android 传感器系统架构如下：</p><p><img src="https://andylee-1258982386.cos.ap-chengdu.myqcloud.com/android/mtk/sensor_arch.jpg" alt="sensor_arch"></p><p>传感器驱动一般会有如下五种数据传输形式：input event设备驱动、MISC驱动、SYS驱动、HWMON设备驱动以及ioctl。如下是一幅网上看到未知来源的图片，更清晰的描述了底层架构，如下：</p><p><img src="https://andylee-1258982386.cos.ap-chengdu.myqcloud.com/android/mtk/sensor_arch.png" alt="sensor_arch"></p><h1 id="源码分析"><a href="#源码分析" class="headerlink" title="源码分析"></a>源码分析</h1><p>传感器源码架构大致相同，本文就来分析陀螺仪部分源码。</p><h2 id="Kernel-部分"><a href="#Kernel-部分" class="headerlink" title="Kernel 部分"></a>Kernel 部分</h2><p>传感器几乎都是采用 I2C 总线， 所以先分析一下 I2C 部分。</p><h3 id="I2C-总线配置"><a href="#I2C-总线配置" class="headerlink" title="I2C 总线配置"></a>I2C 总线配置</h3><p>MTK 为GPIO、I2C等配置提供了 DCT 工具， 可以直接在 UI 里面配置好 I2C 相关定义（codegen.dws 文件中），配好后编译会自动生成一些相关的 DTS 文件和头文件（如 cust_i2c.dtsi）。</p><p><img src="https://andylee-1258982386.cos.ap-chengdu.myqcloud.com/android/mtk/i2c_dct.jpg" alt="i2c-dct"></p><blockquote><p>高通是直接在 dts 里面定义。另需要注意：一条 i2c 总线只支持一种速率，不同速率外设需要挂接到不同总线。</p></blockquote><p>MTK 是在 DCT 配好 i2c 相关（lk 和 kernel 都需要配）,如果有兼容 sensor 则配置在 dts 中，如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># alps\kernel-3.18\arch\arm64\boot\dts\mt6797.dtsi</span></span><br><span class="line">i2c0:i2c@11007000 &#123;</span><br><span class="line">compatible = <span class="string">&quot;mediatek,mt6797-i2c&quot;</span>;</span><br><span class="line">id = &lt;0&gt;;</span><br><span class="line">reg = &lt;0x11007000 0x1000&gt;,</span><br><span class="line">&lt;0x11000100 0x80&gt;;</span><br><span class="line">interrupts = &lt;GIC_SPI 84 IRQ_TYPE_LEVEL_LOW&gt;;</span><br><span class="line">clocks = &lt;&amp;infrasys INFRA_I2C0&gt;, &lt;&amp;infrasys INFRA_AP_DMA&gt;;</span><br><span class="line">clock-names = <span class="string">&quot;main&quot;</span>, <span class="string">&quot;dma&quot;</span>;</span><br><span class="line">clock-div = &lt;10&gt;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"><span class="comment"># alps\kernel-3.18\arch\arm64\boot\dts\aeon6797_6m_n.dts</span></span><br><span class="line">/* 兼容 sensor 配置*/</span><br><span class="line">i2c0@11007000 &#123;</span><br><span class="line">  cust_gyro@6b &#123; // name@i2c_address</span><br><span class="line">compatible = <span class="string">&quot;mediatek,xxx_gyro&quot;</span>;</span><br><span class="line">reg = &lt;0x6b&gt;;// i2c 地址</span><br><span class="line">....</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">cust_gyro@1 &#123; //name@0  为 first sensor 参数</span><br><span class="line">compatible= <span class="string">&quot;mediatek,bmi160_gyro&quot;</span>; // 驱动解析识别字符</span><br><span class="line">i2c_num= &lt;1&gt;;  // i2c channel，硬件决定</span><br><span class="line">i2c_addr= &lt;0x68 0 0 0&gt;; </span><br><span class="line">direction= &lt;6&gt;; // 映射坐标，见下图</span><br><span class="line">power_id= &lt;0xffff&gt;; // ldo id</span><br><span class="line">power_vol= &lt;0&gt;; // ldo voltage</span><br><span class="line">firlen= &lt;0&gt;; // 数据过滤长度， 通常为0</span><br><span class="line">is_batch_supported= &lt;0&gt;; </span><br><span class="line">&#125;;</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>关于上面 dts 中 方向参数 direction 取值依据参考下图：</p><p><img src="https://andylee-1258982386.cos.ap-chengdu.myqcloud.com/android/mtk/mapping_coordinate.jpg" alt="mapping_coordinate"></p><h3 id="Gyro-Driver"><a href="#Gyro-Driver" class="headerlink" title="Gyro Driver"></a>Gyro Driver</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># alps\kernel-3.18\drivers\misc\mediatek\gyroscope\bmi160_gyro\bmi160_gyro.c</span></span><br><span class="line">bmi160_gyro_init()</span><br><span class="line">    get_gyro_dts_func()  <span class="comment">// 从 dts 获取自定义的参数</span></span><br><span class="line">    gyro_driver_add(bmi160_gyro_init_info)</span><br><span class="line">    </span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">gyro_init_info</span> <span class="title">bmi160_gyro_init_info</span></span></span><br><span class="line"><span class="class">    <span class="title">bmi160_gyro_local_init</span>()</span></span><br><span class="line"><span class="class">        <span class="title">i2c_add_driver</span>(&amp;<span class="title">bmg_i2c_driver</span>)</span></span><br><span class="line"><span class="class">        </span></span><br><span class="line"><span class="class"><span class="title">static</span> <span class="title">struct</span> <span class="title">i2c_driver</span> <span class="title">bmg_i2c_driver</span>  </span></span><br><span class="line"><span class="class">    <span class="title">bmi160_gyro_i2c_probe</span>()</span></span><br><span class="line"><span class="class">        // 初始化结构体</span></span><br><span class="line"><span class="class">        <span class="title">hwmsen_get_convert</span>() // 获得坐标映射转换值</span></span><br><span class="line"><span class="class">        <span class="title">bmg_init_client</span>() // 初始化设备，如 <span class="title">ID</span> ， 范围，数据格式等</span></span><br><span class="line"><span class="class">        <span class="title">misc_register</span>() // <span class="title">bmg_open</span>\<span class="title">bmg_release</span>\<span class="title">bmg_unlocked_ioctl</span>;</span> 注册设备，<span class="keyword">for</span> factory mode , engineer mode , <span class="keyword">and</span> so on</span><br><span class="line">        bmg_create_attr() <span class="comment">// 创建platform_driver attr</span></span><br><span class="line">        gyro_register_control_path()  <span class="comment">// struct gyro_control_path，见下 Common 部分</span></span><br><span class="line">        gyro_register_data_path() <span class="comment">// struct gyro_data_path</span></span><br><span class="line">        device_register()</span><br><span class="line">        device_create_file()</span><br></pre></td></tr></table></figure><h3 id="Gyro-Common"><a href="#Gyro-Common" class="headerlink" title="Gyro Common"></a>Gyro Common</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># alps\kernel-3.18\drivers\misc\mediatek\gyroscope\inc\gyroscope.h    </span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">gyro_control_path</span> &#123;</span></span><br><span class="line"><span class="keyword">int</span> (*open_report_data)(<span class="keyword">int</span> open);</span><br><span class="line"><span class="keyword">int</span> (*enable_nodata)(<span class="keyword">int</span> en);</span><br><span class="line"><span class="keyword">int</span> (*set_delay)(u64 delay);</span><br><span class="line"><span class="keyword">bool</span> is_report_input_direct;</span><br><span class="line"><span class="keyword">bool</span> is_support_batch;</span><br><span class="line"><span class="keyword">int</span> (*gyro_calibration)(<span class="keyword">int</span> type, <span class="keyword">int</span> cali[<span class="number">3</span>]);</span><br><span class="line"><span class="keyword">bool</span> is_use_common_factory;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">gyro_data_path</span> &#123;</span></span><br><span class="line"><span class="keyword">int</span> (*get_data)(<span class="keyword">int</span> *x, <span class="keyword">int</span> *y, <span class="keyword">int</span> *z, <span class="keyword">int</span> *status);</span><br><span class="line"><span class="keyword">int</span> (*get_raw_data)(<span class="keyword">int</span> *x, <span class="keyword">int</span> *y, <span class="keyword">int</span> *z);</span><br><span class="line"><span class="keyword">int</span> vender_div;</span><br><span class="line">&#125;;    </span><br><span class="line">    </span><br><span class="line"><span class="meta"># alps\kernel-3.18\drivers\misc\mediatek\gyroscope\gyroscope.c    </span></span><br><span class="line">gyro_probe()</span><br><span class="line">    gyro_real_driver_init()</span><br><span class="line">    gyro_input_init() <span class="comment">// 初始化 input dev</span></span><br><span class="line">        input_register_device(dev)</span><br><span class="line"></span><br><span class="line">gyro_driver_add()</span><br><span class="line">    platform_driver_register()</span><br><span class="line">    </span><br><span class="line"><span class="meta"># alps\kernel-3.18\drivers\misc\mediatek\gyroscope\gyrohub\gyrohub.c  <span class="comment">// sensorhub   </span></span></span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># alps\vendor\mediatek\proprietary\hardware\sensor\sensors.c</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sensor_t</span> <span class="title">sSensorList</span>[] =</span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    &#123;</span><br><span class="line">        .name       = GYROSCOPE,</span><br><span class="line">        .vendor     = GYROSCOPE_VENDER,</span><br><span class="line">        .version    = <span class="number">3</span>, <span class="comment">// 软件版本</span></span><br><span class="line">        .handle     = ID_GYROSCOPE+ID_OFFSET, <span class="comment">// sensor handle（识别 ID）</span></span><br><span class="line">        .type       = SENSOR_TYPE_GYROSCOPE, <span class="comment">// sensor 类型</span></span><br><span class="line">        .maxRange   = GYROSCOPE_RANGE,<span class="comment">//34.91f, // 数据最大范围</span></span><br><span class="line">        .resolution = GYROSCOPE_RESOLUTION,<span class="comment">//0.0107f, // 数据精度</span></span><br><span class="line">        .power      = GYROSCOPE_POWER,<span class="comment">//6.1f, // 电流消耗（mA）</span></span><br><span class="line">        .minDelay   = GYROSCOPE_MINDELAY,   <span class="comment">// 最小数据上报延迟</span></span><br><span class="line">.maxDelay   = <span class="number">1000000</span>,               <span class="comment">// 最大延迟</span></span><br><span class="line">        .flags      = SENSOR_FLAG_CONTINUOUS_MODE,</span><br><span class="line">        .reserved   = &#123;&#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line">open_sensors()</span><br><span class="line">    init_nusensors()</span><br></pre></td></tr></table></figure><h1 id="附"><a href="#附" class="headerlink" title="附"></a>附</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># shell 文件路径</span></span><br><span class="line">/sys/bus/platform/drivers/xxx</span><br></pre></td></tr></table></figure><p>驱动数据和控制流：</p><p><img src="https://andylee-1258982386.cos.ap-chengdu.myqcloud.com/android/mtk/work_flow.jpg" alt="flow"></p>]]></content>
      
      
      <categories>
          
          <category> Android </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 源码分析 </tag>
            
            <tag> MTK </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Android/Linux  I2C 驱动架构分析</title>
      <link href="2017/12/03/Android/Android-Linux-i2c-driver-arch/"/>
      <url>2017/12/03/Android/Android-Linux-i2c-driver-arch/</url>
      
        <content type="html"><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>分析传感器源码的时候，发现对 I2C 的驱动也有些忘记了，所以就再分析一下并形成这篇博文。</p><h1 id="驱动架构"><a href="#驱动架构" class="headerlink" title="驱动架构"></a>驱动架构</h1><h2 id="I2C-驱动架构"><a href="#I2C-驱动架构" class="headerlink" title="I2C 驱动架构"></a>I2C 驱动架构</h2><p><img src="https://andylee-1258982386.cos.ap-chengdu.myqcloud.com/android/mtk/i2c_arch.jpg" alt="i2c-arch"></p><a id="more"></a><h1 id="源码分析"><a href="#源码分析" class="headerlink" title="源码分析"></a>源码分析</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># alps\kernel-3.18\drivers\i2c</span></span><br></pre></td></tr></table></figure><h2 id="重要的结构体"><a href="#重要的结构体" class="headerlink" title="重要的结构体"></a>重要的结构体</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># alps\kernel-3.18\include\linux\i2c.h</span></span><br><span class="line"></span><br><span class="line">/*</span><br><span class="line"> * 表示一个 i2c 适配器，即挂接在 i2c 总线上的 i2c 控制器</span><br><span class="line"> * i2c_adapter is the structure used to identify a physical i2c bus along</span><br><span class="line"> * with the access algorithms necessary to access it.</span><br><span class="line"> */</span><br><span class="line">struct i2c_adapter &#123;</span><br><span class="line">struct module *owner;</span><br><span class="line">unsigned int class;  /* classes to allow probing <span class="keyword">for</span> */</span><br><span class="line">const struct i2c_algorithm *algo; /* the algorithm to access the bus */</span><br><span class="line">struct device dev;/* the adapter device */</span><br><span class="line">....</span><br><span class="line"></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">/*</span><br><span class="line"> * 表示一个 i2c 设备驱动</span><br><span class="line"> */</span><br><span class="line">struct i2c_driver &#123;</span><br><span class="line">unsigned int class;</span><br><span class="line"></span><br><span class="line">/* Standard driver model interfaces */</span><br><span class="line">int (*probe)(struct i2c_client *, const struct i2c_device_id *); // 匹配 i2c 设备（i2c_client）</span><br><span class="line">int (*remove)(struct i2c_client *);</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">struct device_driver driver;   </span><br><span class="line">const struct i2c_device_id *id_table; // 此设备驱动服务的设备 ID</span><br><span class="line"></span><br><span class="line">int (*detect)(struct i2c_client *, struct i2c_board_info *);</span><br><span class="line">const unsigned short *address_list; // 此设备驱动支持的设备地址</span><br><span class="line">struct list_head clients;  // 挂接此设备驱动匹配成功 i2c_client</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">/*</span><br><span class="line"> * 表示一个 i2c 设备</span><br><span class="line"> */</span><br><span class="line">struct i2c_client &#123;</span><br><span class="line">unsigned short flags;/* div., see below*/</span><br><span class="line">unsigned short addr;/* chip address - NOTE: 7bit*/</span><br><span class="line">/* addresses are stored <span class="keyword">in</span> the*/</span><br><span class="line">/* _LOWER_ 7 bits*/</span><br><span class="line">char name[I2C_NAME_SIZE];</span><br><span class="line">struct i2c_adapter *adapter;/* the adapter we sit on*/</span><br><span class="line">struct device dev;/* the device structure*/</span><br><span class="line">int irq;/* irq issued by device*/</span><br><span class="line">struct list_head detected;</span><br><span class="line"><span class="comment">#ifdef CONFIG_MTK_I2C_EXTENSION</span></span><br><span class="line">__u32 timing;/* parameters of timings*/</span><br><span class="line">__u32 ext_flag;</span><br><span class="line"><span class="comment">#endif</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">/*</span><br><span class="line"> * 描述 i2c 设备信息</span><br><span class="line"> */</span><br><span class="line">struct i2c_board_info &#123;</span><br><span class="line">char<span class="built_in">type</span>[I2C_NAME_SIZE];</span><br><span class="line">unsigned shortflags;</span><br><span class="line">unsigned shortaddr;</span><br><span class="line">void*platform_data;</span><br><span class="line">struct dev_archdata*archdata;</span><br><span class="line">struct device_node *of_node;</span><br><span class="line">struct acpi_dev_node acpi_node;</span><br><span class="line">intirq;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># alps\kernel-3.18\include\uapi\linux\i2c.h</span></span><br><span class="line">/*</span><br><span class="line"> * 表示一个 i2c 数据包</span><br><span class="line"> */</span><br><span class="line">struct i2c_msg &#123;</span><br><span class="line">__u16 addr;     /* slave address */</span><br><span class="line">__u16 flags;</span><br><span class="line"><span class="comment">#define I2C_M_TEN0x0010/* this is a ten bit chip address */</span></span><br><span class="line">...</span><br><span class="line"><span class="comment">#define I2C_M_RECV_LEN0x0400/* length will be first received byte */</span></span><br><span class="line">__u16 len;/* msg length*/</span><br><span class="line">__u8 *buf;/* pointer to msg data*/</span><br><span class="line"><span class="comment">#ifdef CONFIG_MTK_I2C_EXTENSION</span></span><br><span class="line">__u32 timing;/* parameters of timings*/</span><br><span class="line">__u32 ext_flag;</span><br><span class="line"><span class="comment">#endif</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><blockquote></blockquote><h2 id="关键路径"><a href="#关键路径" class="headerlink" title="关键路径"></a>关键路径</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># alps\kernel-3.18\arch\arm64\boot\dts\mt6797.dtsi</span></span><br><span class="line"><span class="comment"># alps\kernel-3.18\arch\arm64\boot\dts\aeon6797_6m_n.dts</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># alps\kernel-3.18\drivers\i2c</span></span><br><span class="line">i2c-core.c：i2c核心层，设备驱动和总线驱动的桥梁</span><br><span class="line">i2c-dev.c：通用 i2c 设备驱动</span><br><span class="line">busses：开源的 adapter </span><br><span class="line">algos：i2c 通信算法</span><br><span class="line"></span><br><span class="line"><span class="comment"># alps\kernel-3.18\include\linux\i2c.h</span></span><br><span class="line"><span class="comment"># alps\kernel-3.18\include\uapi\linux\i2c.h</span></span><br></pre></td></tr></table></figure><h2 id="总线驱动层"><a href="#总线驱动层" class="headerlink" title="总线驱动层"></a>总线驱动层</h2><p>总线驱动层主要实现外设驱动部分，初始化硬件（i2c控制器）和提供操作硬件的方法，与 i2c-dev 相对应，其负责的部分通俗点讲就是：知道怎么发数据，但不知道发什么数据。<br>其关键流程如下：</p><ol><li>获取资源</li><li>注册中断、使能时钟等初始化工作</li><li>构建 i2c_adapter</li><li>设置 i2c_adapter</li><li>注册 i2c_adapter<blockquote><p>这部分源码就不在此文分析了，感兴趣的朋友可以参考外设系列</p></blockquote></li></ol><h2 id="核心层（i2c-core）"><a href="#核心层（i2c-core）" class="headerlink" title="核心层（i2c-core）"></a>核心层（i2c-core）</h2><p>构建一个 i2c 总线结构体,并且提供匹配方法和驱动用的结构体 ，如总线驱动层和设备驱动层的注册、注销等方法。此部分存在两个匹配过程：</p><ol><li>i2c 总线下的设备（i2c_client）与设备驱动（i2c_driver）之间的匹配。</li><li>i2c控制器（i2c_adapter）与设备之间的匹配。<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># alps\kernel-3.18\drivers\i2c\i2c-core.c</span></span><br><span class="line">struct bus_type i2c_bus_type = &#123;</span><br><span class="line">.name= <span class="string">&quot;i2c&quot;</span>,  // 总线名</span><br><span class="line">.match= i2c_device_match, // 匹配设备（i2c_client）与设备驱动（i2c_driver）</span><br><span class="line">.probe= i2c_device_probe,  // 注册挂载 i2c</span><br><span class="line">.remove= i2c_device_remove,</span><br><span class="line">.shutdown= i2c_device_shutdown,</span><br><span class="line">.pm= &amp;i2c_device_pm_ops,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"> __init i2c_init() // init 函数</span><br><span class="line">    <span class="comment"># kernel-3.18/drivers/base/bus.c</span></span><br><span class="line">    bus_register(&amp;i2c_bus_type) // 注册i2c总线  <span class="string">&quot;/sys/bus/i2c&quot;</span></span><br><span class="line">    i2c_add_driver(&amp;dummy_driver) // // 注册 i2c 驱动创建“/sys/bus/i2c/driver/dummy” </span><br><span class="line">        i2c_register_driver() // 注册 i2c 驱动</span><br><span class="line">            driver_register(&amp;driver-&gt;driver); // 注册设备驱动，创建上面的“dummy”设备文件</span><br><span class="line">            INIT_LIST_HEAD(&amp;driver-&gt;clients)</span><br><span class="line">        </span><br><span class="line">i2c_device_probe()</span><br><span class="line">    i2c_verify_client(dev) // 获取 i2c_client</span><br><span class="line">    to_i2c_driver(dev-&gt;driver) // 获取 i2c_driver</span><br><span class="line">    driver-&gt;probe(client, i2c_match_id(driver-&gt;id_table,client)) // 调用设备驱动层 probe，查询外设（client）对应的 id</span><br><span class="line">        </span><br><span class="line">i2c_device_match()</span><br><span class="line">client = i2c_verify_client(dev)// 通过 dev 获取 i2c_client</span><br><span class="line">of_driver_match_device(dev, drv) // 通过 of 方式匹配</span><br><span class="line">acpi_driver_match_device(dev, drv) // acpi 方式匹配</span><br><span class="line">/* <span class="keyword">if</span> 上述两种方式皆未成功 */</span><br><span class="line">driver = to_i2c_driver(drv); //通过 drv 获取 i2c_driver</span><br><span class="line">i2c_match_id(driver-&gt;id_table, client) // 通过查询 id_table 匹配</span><br><span class="line"></span><br><span class="line">i2c_master_send() // 发送一个 i2c 数据包</span><br><span class="line">    // 构建 i2c_msg</span><br><span class="line">    i2c_transfer()</span><br><span class="line">        __i2c_transfer()  // 发送数据包到总线驱动层</span><br><span class="line">i2c_master_recv()        </span><br><span class="line"></span><br><span class="line">/* 通过动态获取|指定 bus number 注册 i2c 控制器 */</span><br><span class="line">i2c_add_adapter()|i2c_add_numbered_adapter() </span><br><span class="line">    i2c_register_adapter(adapter)</span><br><span class="line">    dev_set_name(&amp;adap-&gt;dev, <span class="string">&quot;i2c-%d&quot;</span>, adap-&gt;nr); // 设置 adapter 名字 “i2c-%d”</span><br><span class="line">    adap-&gt;dev.bus = &amp;i2c_bus_type;</span><br><span class="line">    adap-&gt;dev.type = &amp;i2c_adapter_type;</span><br><span class="line">    /*</span><br><span class="line">     * 注册设备,  默认创建的设备文件是: /sys/devices/i2c-%d </span><br><span class="line">     * 若注册 adapter 时指定了父设备，则为：/sys/devices/platform/xxx/i2c-%d </span><br><span class="line">     */</span><br><span class="line">    device_register(&amp;adap-&gt;dev);</span><br><span class="line">    /*</span><br><span class="line">     * 扫描 __i2c_board_list 匹配 adapter 与 i2c 次设备信息，匹配成功则创建 i2c 设备 （i2c_client）</span><br><span class="line">     */</span><br><span class="line">    i2c_scan_static_board_info() </span><br><span class="line">        i2c_new_device() // 注册 i2c 设备</span><br><span class="line">            i2c_dev_set_name(adap, client) //  设置次设备名<span class="string">&quot; %d-%04x&quot;</span></span><br><span class="line">            device_register(&amp;client-&gt;dev) //  注册次设备<span class="string">&quot;/sys/devices/platform/xxx/i2c-%d/%d-%04x“ </span></span><br><span class="line"><span class="string"> </span></span><br><span class="line"><span class="string"># alps\kernel-3.18\include\linux\i2c.h</span></span><br><span class="line"><span class="string">i2c_add_driver(driver) </span></span><br><span class="line"><span class="string">    i2c_register_driver(THIS_MODULE, driver)</span></span><br><span class="line"><span class="string"></span></span><br></pre></td></tr></table></figure><blockquote><p>注：主设备表示特定的驱动程序；次设备表示使用该设备驱动的设备  </p></blockquote></li></ol><h2 id="设备驱动层（i2c-dev）"><a href="#设备驱动层（i2c-dev）" class="headerlink" title="设备驱动层（i2c-dev）"></a>设备驱动层（i2c-dev）</h2><p>设备驱动层主要是封装主机 i2c 的基本操作，给上层提供接口，与总线驱动层相对应，其：知道发什么数据，但不知道怎么发。   </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># alps\kernel-3.18\drivers\i2c\i2c-dev.c （也可以是其他设备驱动文件，如：ov9650.c等。）</span></span><br><span class="line">static const struct file_operations i2cdev_fops = &#123;</span><br><span class="line">.owner= THIS_MODULE,</span><br><span class="line">.llseek= no_llseek,</span><br><span class="line">.<span class="built_in">read</span>= i2cdev_read,</span><br><span class="line">.write= i2cdev_write,</span><br><span class="line">.unlocked_ioctl= i2cdev_ioctl,</span><br><span class="line">.open= i2cdev_open,</span><br><span class="line">.release= i2cdev_release,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">i2cdev_read()</span><br><span class="line">    i2c_master_recv()</span><br><span class="line">    copy_to_user()</span><br><span class="line">i2cdev_write()</span><br><span class="line">    memdup_user()  // 分配内核空间，用户态到内核态的拷贝</span><br><span class="line">        copy_from_user()</span><br><span class="line">    i2c_master_send()</span><br><span class="line">...</span><br><span class="line">i2cdev_open()</span><br><span class="line">    i2c_dev_get_by_minor()</span><br><span class="line">    i2c_get_adapter()</span><br><span class="line">    // 设置 i2c client</span><br><span class="line"></span><br><span class="line">i2c_dev_init()</span><br><span class="line">    register_chrdev(I2C_MAJOR, <span class="string">&quot;i2c&quot;</span>, &amp;i2cdev_fops)</span><br><span class="line">    i2cdev_attach_adapter() // 绑定存在的 i2c 控制器（adapter）</span><br><span class="line">        adap = to_i2c_adapter(dev);</span><br><span class="line">    i2c_dev = get_free_i2c_dev(adap);</span><br><span class="line">    /* register this i2c device with the driver core */</span><br><span class="line">    i2c_dev-&gt;dev = device_create(...<span class="string">&quot;i2c-%d&quot;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure><h1 id="用户空间"><a href="#用户空间" class="headerlink" title="用户空间"></a>用户空间</h1><p>这里只看一种通用的通过 JNI 操作 i2c 设备的方案，i2c-dev 提供的接口通过 JNI 给 APP 使用，如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># jni</span></span><br><span class="line">extern <span class="string">&quot;C&quot;</span> &#123;</span><br><span class="line">JNIEXPORT jint JNICALL Java_xxxxxx_xxx_I2c_open()</span><br><span class="line">JNIEXPORT jint JNICALL Java_xxxxxx_xxx_I2c_read()</span><br><span class="line">JNIEXPORT jint JNICALL Java_xxxxxx_xxx_I2c_write()</span><br><span class="line">...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># app</span></span><br><span class="line">I2c.open(“/dev/i2c-x”)</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">public static class I2c &#123;  </span><br><span class="line">        ...</span><br><span class="line">        public native int open(); </span><br><span class="line">        public native int <span class="built_in">read</span>(); </span><br><span class="line">        public native int write();  </span><br><span class="line">        ...</span><br><span class="line">&#125;  </span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Android </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 源码分析 </tag>
            
            <tag> MTK </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Android(Linux) 输入子系统解析</title>
      <link href="2017/11/23/Android/Android-Linux-input-system-analysis/"/>
      <url>2017/11/23/Android/Android-Linux-input-system-analysis/</url>
      
        <content type="html"><![CDATA[<p>Android 源码分析系列综述博文： <a href="http://huaqianlee.github.io/2100/11/21/Android/A-summary-of-Android-source-analysis/">Android 系统源码分析综述</a></p><h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>Android/Linux 输入设备总类繁杂，常见的有按键、键盘、触摸屏、鼠标、摇杆等，之前其驱动都是采用字符设备、misc 设备处理的，但是如此多的设备就导致驱动混乱，所以 Linux 引入了输入子系统在字符设备等上抽象出一层来统一输入设备的驱动。本文就基于 MTK Android 7.0 源码来分析一下输入子系统。</p><h1 id="输入子系统架构"><a href="#输入子系统架构" class="headerlink" title="输入子系统架构"></a>输入子系统架构</h1><p>输入子系统的系统架构如下图所示：<br><img src="https://andylee-1258982386.cos.ap-chengdu.myqcloud.com/android/mtk/%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1.png" alt="input_system_arch"></p><blockquote><p>Framework 层以上只是简单跟了一下源码，没有深入查看</p></blockquote><a id="more"></a><h1 id="输入子系统分层解析"><a href="#输入子系统分层解析" class="headerlink" title="输入子系统分层解析"></a>输入子系统分层解析</h1><h2 id="Hardware层"><a href="#Hardware层" class="headerlink" title="Hardware层"></a>Hardware层</h2><p>硬件层主要就是按键、触摸屏、Sensor等各种输入设备。</p><h2 id="Kernel层"><a href="#Kernel层" class="headerlink" title="Kernel层"></a>Kernel层</h2><p>Kernel 层主要分为三层，如下：</p><ol><li>Input 设备驱动层: 采集输入设备的数据信息，通过 Input Core 的 API 上报数据。</li><li>Input Core（核心层）：为事件处理层和设备驱动层提供接口API。</li><li>Event Handler（事件处理层）：通过核心层的API获取输入事件上报的数据，定义API与应用层交互。</li></ol><p>Kernel 层重要的数据结构如下：</p><table><thead><tr><th>数据结构</th><th>定义位置</th><th>简述</th></tr></thead><tbody><tr><td>struct input_dev</td><td>input.h</td><td>Input 设备驱动中实例化</td></tr><tr><td>struct evdev<br>struct mousedev<br>struct keybdev</td><td>evdev.c<br>mousedev.c<br>keybdev.c</td><td>Event Handler 层逻辑 input 设备的数据结构</td></tr><tr><td>struct input_handler</td><td>Input.h</td><td>Event handler 的结构，handler 层实例化</td></tr><tr><td>Struct input_handle</td><td>Input.h</td><td>用于创建驱动层 input_dev 和 handler 链表的链表项结构</td></tr></tbody></table><h3 id="数据结构部分"><a href="#数据结构部分" class="headerlink" title="数据结构部分"></a>数据结构部分</h3><figure class="highlight h"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># alps\kernel-3.18\<span class="meta-keyword">include</span>\linux\input.h</span></span><br><span class="line"><span class="comment">/* 输入设备的语言描述 */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">input_dev</span> &#123;</span>  <span class="comment">// 代表一个输入设备</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *name;  <span class="comment">// 设备名字，sys 文件名</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">input_id</span> <span class="title">id</span>;</span> <span class="comment">// 与 handler 匹配，总线类型、厂商、版本等信息</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* 输入设备支持事件的位图（bitmap）*/</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> evbit[BITS_TO_LONGS(EV_CNT)]; <span class="comment">// 所有事件</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> keybit[BITS_TO_LONGS(KEY_CNT)]; <span class="comment">// 按键事件</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> relbit[BITS_TO_LONGS(REL_CNT)]; <span class="comment">// 相对位移事件</span></span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> keycodemax;  <span class="comment">// 支持按键值个数</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> repeat_key; <span class="comment">// 最近一次按键值，用于连击</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> (*setkeycode)()   <span class="comment">// 修改当前 keymap</span></span><br><span class="line">    <span class="keyword">int</span> (*getkeycode)()   <span class="comment">// 检索keymap</span></span><br><span class="line">...</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> key[BITS_TO_LONGS(KEY_CNT)];<span class="comment">// 设备当前按键状态</span></span><br><span class="line">...</span><br><span class="line"><span class="keyword">int</span> (*open)()</span><br><span class="line"><span class="keyword">int</span> (*flush)();<span class="comment">// 处理传递给设备的事件，如：LED事件和声音事件</span></span><br><span class="line">    ...</span><br><span class="line">    </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">input_handle</span> __<span class="title">rcu</span> *<span class="title">grab</span>;</span> <span class="comment">// 当前占用该设备的 input_handle</span></span><br><span class="line">    </span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">list_head</span><span class="title">h_list</span>;</span> <span class="comment">// handle 链表，链接此input_dev</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">list_head</span><span class="title">node</span>;</span> <span class="comment">//  链入 input_dev_list</span></span><br><span class="line">...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 事件处理，类似于中断处理函数 */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">input_handler</span> &#123;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> *<span class="keyword">private</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> (*event)(); <span class="comment">// 处理设备驱动报告的事件</span></span><br><span class="line"><span class="keyword">int</span> (*connect)();  <span class="comment">// 连接 handler 和 input_dev</span></span><br><span class="line"><span class="keyword">void</span> (*disconnect)(); <span class="comment">// 断开连接</span></span><br><span class="line"><span class="keyword">void</span> (*start)();  <span class="comment">// 启动指定 handle 的 handler 函数</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">char</span> *name; <span class="comment">// handler 名</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">input_device_id</span> *<span class="title">id_table</span>;</span> <span class="comment">// 输入设备id列表，匹配 input_dev</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">list_head</span><span class="title">h_list</span>;</span> <span class="comment">// 链入handle 链表</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">list_head</span><span class="title">node</span>;</span>  <span class="comment">// 链入 input_handler_list</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* </span></span><br><span class="line"><span class="comment"> * 连接 input_dev 和 handler 的桥梁</span></span><br><span class="line"><span class="comment"> * 一个 input_dev 可以对应多个 handler ， 一个 handler 也可以对应多个dev</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">input_handle</span> &#123;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> open; <span class="comment">// 设备打开次数（上层访问次数）</span></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">char</span> *name;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">input_dev</span> *<span class="title">dev</span>;</span>  <span class="comment">// 所属 input_dev</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">input_handler</span> *<span class="title">handler</span>;</span> <span class="comment">// 所属 handler</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">list_head</span><span class="title">d_node</span>;</span> <span class="comment">// 链入对应 input_dev 的 h_list</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">list_head</span><span class="title">h_node</span>;</span> <span class="comment">// 链入对应 handler de h_list</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta"># alps/kernel-3.18/<span class="meta-keyword">include</span>/uapi/linux/input.h</span></span><br><span class="line"><span class="comment">/* 事件载体，输入子系统的事件包装为 input_event 上传到 Framework*/</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">input_event</span> &#123;</span></span><br><span class="line"> <span class="class"><span class="keyword">struct</span> <span class="title">timeval</span> <span class="title">time</span>;</span> <span class="comment">// 时间戳</span></span><br><span class="line"> __u16 type;  <span class="comment">// 事件类型</span></span><br><span class="line"> __u16 code;  <span class="comment">// 事件代码</span></span><br><span class="line"> __s32 value;  <span class="comment">// 事件值，如坐标的偏移值</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="Input-设备驱动层"><a href="#Input-设备驱动层" class="headerlink" title="Input 设备驱动层"></a>Input 设备驱动层</h3><p>这部分主要实现各种输入设备的自己硬件相关的驱动并上报事件，这部分驱动基本遵循如下流程：</p><ol><li>声明实例化input_dev 对象</li><li>注册 input_dev<ul><li>input_allocate_device() 给设备分配空间，设置dev （实现于 input.c）</li><li>通过 input_register_device() 注册 （实现于 input.c）</li></ul></li><li>硬件初始化，中断初始化，定义中断处理程序</li><li>设置input_dev对象</li><li>定义中断处理程序，上报事件</li></ol><p>由于我自己有个外设系列源码分析，这里就不详细查看相关源码了，主要分析输入子系统的通用部分。设备驱动路径：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">alps\kernel-3.18\drivers\input</span><br></pre></td></tr></table></figure><h3 id="Input-Core"><a href="#Input-Core" class="headerlink" title="Input Core"></a>Input Core</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># alps\kernel-3.18\drivers\input\input.c</span></span><br><span class="line">input_init()</span><br><span class="line">    class_register(&amp;input_class); <span class="comment">// 注册为输入设备类，创建 input_class</span></span><br><span class="line">    input_proc_init(); <span class="comment">// 创建 proc/bus/input 路径下设备文件</span></span><br><span class="line">        proc_mkdir(<span class="string">&quot;bus/input&quot;</span>, <span class="literal">NULL</span>);</span><br><span class="line">        proc_create(<span class="string">&quot;devices&quot;</span>..&amp;input_devices_fileops);  <span class="comment">// </span></span><br><span class="line">proc_create(<span class="string">&quot;handlers&quot;</span>..&amp;input_handlers_fileops);    </span><br><span class="line">    register_chrdev_region(MKDEV(INPUT_MAJOR, <span class="number">0</span>),INPUT_MAX_CHAR_DEVICES, <span class="string">&quot;input&quot;</span>);</span><br><span class="line"></span><br><span class="line">input_register_device() <span class="comment">// 通过 input core 注册 input_dev ，为设备驱动所调用 </span></span><br><span class="line">    __set_bit(EV_SYN, dev-&gt;evbit); <span class="comment">// 设为 EV_SYN/SYN_REPORT 事件，所有设备默认支持</span></span><br><span class="line">    __clear_bit(KEY_RESERVED, dev-&gt;keybit); <span class="comment">// KEY_RESERVED 事件不支持上传到用户空间</span></span><br><span class="line">    ... <span class="comment">// 设置 input_dev </span></span><br><span class="line">    device_add(&amp;dev-&gt;dev); <span class="comment">// 将 input_dev 注册到 sysfs</span></span><br><span class="line">    list_add_tail(&amp;dev-&gt;node, &amp;input_dev_list); <span class="comment">// 将 input_dev 加入input_dev_list</span></span><br><span class="line">list_for_each_entry(handler, &amp;input_handler_list, node)</span><br><span class="line">input_attach_handler(dev, handler);   <span class="comment">// 配对并 connect handler 和 input_dev</span></span><br><span class="line"></span><br><span class="line">input_attach_handler()</span><br><span class="line">    input_match_device(handler, dev) <span class="comment">// 配对handler 和 input_dev</span></span><br><span class="line">    handler-&gt;connect(handler, dev, id); <span class="comment">// connect</span></span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">input_register_handler  <span class="comment">// 注册一个 input_handler </span></span><br><span class="line">INIT_LIST_HEAD(&amp;handler-&gt;h_list);</span><br><span class="line">list_add_tail(&amp;handler-&gt;node, &amp;input_handler_list);</span><br><span class="line">list_for_each_entry(dev, &amp;input_dev_list, node)</span><br><span class="line">input_attach_handler(dev, handler);  <span class="comment">// 同上</span></span><br><span class="line"></span><br><span class="line">input_event() <span class="comment">// 上报新事件</span></span><br><span class="line">    input_handle_event()/input_repeat_key()</span><br><span class="line">      input_get_disposition <span class="comment">// 处理事件类型</span></span><br><span class="line">        input_pass_values()</span><br><span class="line">            input_to_handler()</span><br><span class="line">                handler-&gt;events() <span class="comment">// 对应 evdev.c 中 evdev_event()</span></span><br><span class="line">            input_start_autorepeat() <span class="comment">// 根据需要启动或停止自动重复上报</span></span><br><span class="line">            input_stop_autorepeat(dev)</span><br><span class="line">      input_handle_abs_event()      </span><br><span class="line">        input_abs_set_val(dev, ABS_MT_SLOT, mt-&gt;slot) <span class="comment">// 刷新等待槽事件</span></span><br><span class="line">input_start_autorepeat() <span class="comment">// 启动定时器，自动重复上报</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* 类似于 input_event() , 不过忽略已经被捕获的事件和非拥有 dev 注入事件 */</span></span><br><span class="line">input_inject_event() </span><br><span class="line">    input_handle_event()</span><br><span class="line"></span><br><span class="line">input_open_device</span><br><span class="line">    handle-&gt;open++</span><br><span class="line">    dev-&gt;open(dev) <span class="comment">// 设备 open</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">input_dev_suspend()    </span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="meta"># alps\kernel-3.18\<span class="meta-keyword">include</span>\linux\input.h</span></span><br><span class="line">input_report_xx() <span class="comment">// 上报事件，如键值</span></span><br><span class="line">input_event()</span><br><span class="line">input_sync <span class="comment">// 同步事件</span></span><br><span class="line">input_event()</span><br><span class="line"></span><br><span class="line"><span class="comment">/*********************************************************************</span></span><br><span class="line"><span class="comment"> * 基于 input system 封装了一层轮询设备，为需要轮询的设备驱动提供支持</span></span><br><span class="line"><span class="comment"> *********************************************************************/</span></span><br><span class="line"><span class="meta"># alps\kernel-3.18\<span class="meta-keyword">include</span>\linux\input-polldev.h</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">input_polled_dev</span></span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class"># <span class="title">alps</span>\<span class="title">kernel</span>-3.18\<span class="title">drivers</span>\<span class="title">input</span>\<span class="title">input</span>-<span class="title">polldev</span>.<span class="title">c</span></span></span><br><span class="line"><span class="class"><span class="title">input_register_polled_device</span>()</span></span><br><span class="line"><span class="class">    <span class="title">NIT_DELAYED_WORK</span>(&amp;<span class="title">dev</span>-&gt;<span class="title">work</span>, <span class="title">input_polled_device_work</span>);</span></span><br><span class="line">input_open_polled_device()</span><br><span class="line">input_polldev_set_poll()</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="Event-Handler"><a href="#Event-Handler" class="headerlink" title="Event Handler"></a>Event Handler</h3><p>Event Handler 层以通用的 evdev.c 为例来解析，上层和 Kernel 层的交互在此文件完成。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># alps\kernel-3.18\drivers\input\evdev.c</span></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">input_handler</span> <span class="title">evdev_handler</span> = &#123;</span>   <span class="comment">// input_handler</span></span><br><span class="line">.event= evdev_event,</span><br><span class="line">.events= evdev_events,</span><br><span class="line">.connect= evdev_connect,</span><br><span class="line">.disconnect= evdev_disconnect,</span><br><span class="line">.legacy_minors= <span class="literal">true</span>,</span><br><span class="line">.minor= EVDEV_MINOR_BASE,</span><br><span class="line">.name= <span class="string">&quot;evdev&quot;</span>,</span><br><span class="line">.id_table= evdev_ids,</span><br><span class="line">&#125;;</span><br><span class="line">truct file_operations evdev_fops = &#123;  <span class="comment">// 对应于上层的操作函数</span></span><br><span class="line">.owner= THIS_MODULE,</span><br><span class="line">.read= evdev_read,</span><br><span class="line">.write= evdev_write,</span><br><span class="line">.poll= evdev_poll,</span><br><span class="line">.open= evdev_open,</span><br><span class="line">...</span><br><span class="line">&#125;</span><br><span class="line">struct evdev_client &#123;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> head;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> tail;</span><br><span class="line">    ....</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">wake_lock</span> <span class="title">wake_lock</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">node</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">input_event</span> <span class="title">buffer</span>[];</span>  <span class="comment">// 事件存储 buffer</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">evdev_init()</span><br><span class="line">    input_register_handler(&amp;evdev_handler) <span class="comment">// 定义于 input.c</span></span><br><span class="line">    </span><br><span class="line">evdev_connect()    </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">evdev</span> *<span class="title">evdev</span>;</span></span><br><span class="line">    <span class="comment">/* 设置evdev */</span></span><br><span class="line">    dev_set_name(&amp;evdev-&gt;dev, <span class="string">&quot;event%d&quot;</span>, dev_no); <span class="comment">// 根据设备号命名handler</span></span><br><span class="line">    <span class="comment">/* 完成dev 和 handler 的连接关系*/</span></span><br><span class="line">    evdev-&gt;handle.dev = input_get_device(dev);</span><br><span class="line">    evdev-&gt;handle.handler = handler;</span><br><span class="line">    ...</span><br><span class="line">    </span><br><span class="line">    cdev_init(&amp;evdev-&gt;cdev, &amp;evdev_fops); <span class="comment">//绑定 File 操作函数 </span></span><br><span class="line">    device_add(&amp;evdev-&gt;dev);<span class="comment">//注册设备到内核，会在 /dev/input 生成设备</span></span><br><span class="line">    </span><br><span class="line">evdev_event()</span><br><span class="line">    evdev_events()</span><br><span class="line">        evdev_pass_values()</span><br><span class="line">            __pass_event() <span class="comment">// 将事件加入 evdev_client， 并加入EV_SYN</span></span><br><span class="line">            wake_up_interruptible(&amp;evdev-&gt;wait) <span class="comment">// 唤醒，让上层读取事件数据（存于 evdev buffer）</span></span><br><span class="line">            </span><br><span class="line">evdev_flush()</span><br><span class="line">    input_flush_device() <span class="comment">// input.c</span></span><br><span class="line">    </span><br><span class="line">evdev_write()   <span class="comment">// 上层写入数据</span></span><br><span class="line">    input_event_from_user()</span><br><span class="line">    input_inject_event()</span><br><span class="line">evdev_read()   <span class="comment">//  上层读取数据</span></span><br><span class="line">    </span><br><span class="line"><span class="comment">/* 内核与用户空间交互函数实现 */</span>    </span><br><span class="line"><span class="meta"># alps\kernel-3.18\drivers\input\input-compat.c </span></span><br><span class="line">input_event_from_user()</span><br><span class="line">    copy_from_user()  </span><br><span class="line">input_event_to_user()    </span><br><span class="line">    </span><br></pre></td></tr></table></figure><h2 id="Framework-层"><a href="#Framework-层" class="headerlink" title="Framework 层"></a>Framework 层</h2><p>Framework 层涉及面太广，内容也多，我现在阅读这部分上层源码也有些吃力，再加上时间原因，只简单跟读了几个关键文件。以后抽时间再跟读一下源码，产出一篇博客。</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* native 部分关键路径*/</span></span><br><span class="line"># alps\frameworks\native\services\inputflinger</span><br><span class="line"># alps\frameworks\native\libs\input</span><br><span class="line"><span class="comment">/* 从设备文件（/dev/input）获取信息）*/</span></span><br><span class="line"># alps\frameworks\native\services\inputflinger\EventHub.cpp</span><br><span class="line"># alps\frameworks\native\services\inputflinger\InputManager.cpp</span><br><span class="line"><span class="comment">/* 从 EventHub 获取事件信息*/</span></span><br><span class="line"># alps\frameworks\native\services\inputflinger\InputReader.cpp</span><br><span class="line"><span class="comment">/* 分发事件信息*/</span></span><br><span class="line"># alps\frameworks\native\services\inputflinger\InputDispatcher.cpp</span><br><span class="line"># alps\frameworks\native\services\inputflinger\InputListener.cpp</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/* framework 部分关键路径*/</span></span><br><span class="line"># alps\frameworks\base\services\core\java\com\android\server\input</span><br><span class="line"># alps\frameworks\base\services\core\java\com\android\server\wm</span><br><span class="line"></span><br><span class="line"># alps\frameworks\base\services\core\java\com\android\server\input\InputManagerService.java</span><br><span class="line"># alps\frameworks\base\services\core\java\com\android\server\wm\WindowManagerService.java</span><br></pre></td></tr></table></figure><h1 id="附-Shell-操作路径"><a href="#附-Shell-操作路径" class="headerlink" title="附 Shell 操作路径"></a>附 Shell 操作路径</h1><p>在 Kernel 层生成三个路径及相关设备文件，如下</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># /sys/class/input/</span></span><br><span class="line">event0  event11 event4 event7 input0  input11 input4 input7</span><br><span class="line">event1  event2  event5 event8 input1  input2  input5 input8</span><br><span class="line">event10 event3  event6 event9 input10 input3  input6 input9</span><br><span class="line"></span><br><span class="line"><span class="comment"># /dev/input </span></span><br><span class="line">event0 event10 event2 event4 event6 event8</span><br><span class="line">event1 event11 event3 event5 event7 event9</span><br><span class="line"></span><br><span class="line"><span class="comment"># /proc/bus/input  </span></span><br><span class="line">devices handlers</span><br><span class="line"><span class="comment"># cat devices  查看总线上的已经注册上的输入设备</span></span><br><span class="line">I: Bus=0019 Vendor=0000 Product=0000 Version=0000</span><br><span class="line">N: Name=<span class="string">&quot;ACCDET&quot;</span></span><br><span class="line">P: Phys=</span><br><span class="line">S: Sysfs=/devices/virtual/input/input0</span><br><span class="line">U: Uniq=</span><br><span class="line">H: Handlers=gpufreq_ib event0</span><br><span class="line">B: PROP=0</span><br><span class="line">B: EV=3</span><br><span class="line">B: KEY=40 0 0 0 0 0 0 1000000000 c000001800000 0</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">I: Bus=0019 Vendor=0000 Product=0000 Version=0001</span><br><span class="line">N: Name=<span class="string">&quot;fingerprint_key&quot;</span></span><br><span class="line">P: Phys=</span><br><span class="line">S: Sysfs=/devices/virtual/input/input2</span><br><span class="line">U: Uniq=</span><br><span class="line">H: Handlers=gpufreq_ib event2</span><br><span class="line">B: PROP=0</span><br><span class="line">B: EV=3</span><br><span class="line">B: KEY=2000100000000000 180001f 8000000000000000</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">cat handlers // 查看注册的handler</span><br><span class="line">N: Number=0 Name=gpufreq_ib</span><br><span class="line">N: Number=1 Name=evdev Minor=64</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Android </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 源码分析 </tag>
            
            <tag> MTK </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Android 电源管理之电池管理系统(BMS)</title>
      <link href="2017/11/21/Android/BMS-of-Android-Power-Management/"/>
      <url>2017/11/21/Android/BMS-of-Android-Power-Management/</url>
      
        <content type="html"><![CDATA[<blockquote><p>Android 源码分析系列综述博文： <a href="http://huaqianlee.github.io/2100/11/21/Android/A-summary-of-Android-source-analysis/">Android 系统源码分析综述</a></p></blockquote><p><em>Platform information： MTK6797（X20）+ Android 7.0</em></p><p>之前做高通的时候，对高通此部分做过粗略的分析，不过当时胡乱做的些笔记，只简单整理了几篇博客，感兴趣可以参考如下路径：</p><p><a href="http://huaqianlee.github.io/2015/08/15/Android/%E9%AB%98%E9%80%9A%E5%B9%B3%E5%8F%B0Android%E6%BA%90%E7%A0%81bootloader%E5%88%86%E6%9E%90%E4%B9%8Bsbl1-%E4%B8%80/">高通平台Android源码bootloader分析之sbl1(一)</a></p><p><a href="http://huaqianlee.github.io/2015/08/15/Android/%E9%AB%98%E9%80%9A%E5%B9%B3%E5%8F%B0Android%E6%BA%90%E7%A0%81bootloader%E5%88%86%E6%9E%90%E4%B9%8Bsbl1-%E4%BA%8C/">高通平台Android源码bootloader分析之sbl1(二)</a></p><p><a href="http://huaqianlee.github.io/2015/08/18/Android/%E9%AB%98%E9%80%9A%E5%B9%B3%E5%8F%B0Android%E6%BA%90%E7%A0%81bootloader%E5%88%86%E6%9E%90%E4%B9%8Bsbl1-%E4%B8%89/">高通平台Android源码bootloader分析之sbl1(三)</a></p><p><a href="http://huaqianlee.github.io/2015/01/21/Android/%E9%AB%98%E9%80%9AAndroid%E4%B8%8D%E5%B8%A6%E7%94%B5%E9%87%8F%E8%AE%A1%E7%9A%84%E7%94%B5%E9%87%8F%E8%AE%A1%E7%AE%97%E6%96%B9%E5%BC%8F/">Android不带电量计的电量计算</a></p><p><a href="http://huaqianlee.github.io/2015/05/30/Android/Android%E7%94%B5%E6%BA%90%E7%AE%A1%E7%90%86%E6%9E%B6%E6%9E%84/">Android 电源管理架构</a></p><p><a href="http://huaqianlee.github.io/2015/06/06/Android/Android%E7%94%B5%E6%B1%A0%E7%9B%91%E6%8E%A7%E7%B3%BB%E7%BB%9F-BMS-%E4%B9%8B%E7%94%B5%E6%B1%A0%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84/">Android电池监控系统-BMS-之电池系统架构 (有坑未填)</a></p><p><a href="http://huaqianlee.github.io/2015/06/24/Android/qaulcomm-bms-driver-analysis/">高通电池管理系统（BMS）驱动分析</a></p><p><a href="http://huaqianlee.github.io/2015/06/24/Android/smb135x-charger-driver/">高通 smb135x charger 驱动分析</a></p><p><a href="http://huaqianlee.github.io/2015/06/24/Android/qcom-pmic-driver/">高通 PMIC 架构简析</a></p><p><a href="http://huaqianlee.github.io/2015/06/24/Android/linear-charger-driver/">高通 linear charger 驱动分析</a></p><h1 id="充电简析"><a href="#充电简析" class="headerlink" title="充电简析"></a>充电简析</h1><h2 id="充电状态机"><a href="#充电状态机" class="headerlink" title="充电状态机"></a>充电状态机</h2><p>电池充电过程分为预充、恒流充电（CC模式）、恒压充电（CV模式）、涓流充电四个流程，MTK的状态机如下：</p><p><img src="https://andylee-1258982386.cos.ap-chengdu.myqcloud.com/android/mtk/chargind_state.jpg" alt="state"></p><a id="more"></a><h2 id="充电简要流程框图"><a href="#充电简要流程框图" class="headerlink" title="充电简要流程框图"></a>充电简要流程框图</h2><p><img src="https://andylee-1258982386.cos.ap-chengdu.myqcloud.com/android/mtkGauge_arch.jpg" alt="flow"></p><h1 id="BMS-架构"><a href="#BMS-架构" class="headerlink" title="BMS 架构"></a>BMS 架构</h1><p>MTK 的 BMS 架构如下：<br><img src="https://andylee-1258982386.cos.ap-chengdu.myqcloud.com/android/mtk/battery%20introduction.jpg" alt="bms"></p><p>我准备将BMS从硬件到APP分为不同的架构层来分析。接下来分别分析下不同的架构层。</p><h2 id="硬件层"><a href="#硬件层" class="headerlink" title="硬件层"></a>硬件层</h2><p>硬件层主要分为三个部分：PMIC，Fuel Gauge 和 ADC。本文主要分析软件，所以硬件就不准备深入研究了。</p><h3 id="1-1-1-PMIC"><a href="#1-1-1-PMIC" class="headerlink" title="1.1.1 PMIC"></a>1.1.1 PMIC</h3><p>智能手机方案一般都会有一个PMIC芯片，有些也还会采用外接充电IC，使不使用外接IC，软件驱动会有一些区别。</p><h3 id="Fuel-Gauge"><a href="#Fuel-Gauge" class="headerlink" title="Fuel Gauge"></a>Fuel Gauge</h3><p>Fuel Gauge 是 MTK 为充放电、电量算法提供服务的一个硬件电路，电路中的电阻比较重要。</p><h3 id="ADC"><a href="#ADC" class="headerlink" title="ADC"></a>ADC</h3><p>FGADC 和 AUXADC 分别采样电池的电流、电压（还会采样电池温度）。</p><h2 id="BootLoader层"><a href="#BootLoader层" class="headerlink" title="BootLoader层"></a>BootLoader层</h2><p>BootLoader部分没有在上图表现出来，也可以将其归为driver部分。</p><h3 id="1-2-1-Preloader层"><a href="#1-2-1-Preloader层" class="headerlink" title="1.2.1 Preloader层"></a>1.2.1 Preloader层</h3><p>此部分会对充电做一些初始设置，比如设置手机尽早开始充电以避免电池低电压不能进入接下来的充电状态，关键路径如下：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">alps\vendor\mediatek\proprietary\bootable\bootloader\preloader\platform\mt6797\src\drivers\platform.c</span><br></pre></td></tr></table></figure><h3 id="LK层"><a href="#LK层" class="headerlink" title="LK层"></a>LK层</h3><p>此部分主要针对充电主要做三件事：1. 启动方式、充电状态监测；2. 初始化充电IC；3. 充电器状态监测处理。</p><h4 id="启动方式、充电状态监测"><a href="#启动方式、充电状态监测" class="headerlink" title="启动方式、充电状态监测"></a>启动方式、充电状态监测</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># alps\vendor\mediatek\proprietary\bootable\bootloader\lk\platform\mt6797\<span class="meta-keyword">include</span>\platform\boot_mode.h</span></span><br><span class="line"><span class="meta"># alps\vendor\mediatek\proprietary\bootable\bootloader\lk\platform\mt6797\boot_mode.c</span></span><br><span class="line">boot_mode_select() <span class="comment">// 启动方式判断及处理</span></span><br><span class="line"></span><br><span class="line"><span class="meta"># alps\vendor\mediatek\proprietary\bootable\bootloader\lk\platform\mt6797\platform.c</span></span><br><span class="line">platform_init() &#123;</span><br><span class="line">    upmu_is_chr_det() <span class="comment">// 充电检测，Unplugged则关机</span></span><br><span class="line">    <span class="keyword">if</span> (kernel_charging_boot() == <span class="number">1</span>) &#123; <span class="comment">// 充电启动，显示关机充电信息</span></span><br><span class="line">        <span class="comment">/*判断充电设备和状态，显示充电图标和点亮充电指示灯*/</span></span><br><span class="line">        mt_disp_power(TRUE);</span><br><span class="line">mt_disp_show_low_battery();</span><br><span class="line">mt65xx_leds_brightness_set(<span class="number">6</span>, <span class="number">110</span>);</span><br><span class="line">    &#125;<span class="comment">// 否则，闹钟启动灯其他方式启动，显示开机界面</span></span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line">boot_mode_select(); <span class="comment">// 区分开机过程</span></span><br><span class="line"></span><br><span class="line"><span class="meta"># alps\vendor\mediatek\proprietary\bootable\bootloader\lk\platform\mt6797\mt_kernel_power_off_charging.c</span></span><br><span class="line">set_off_mode_charge_status()</span><br><span class="line">kernel_power_off_charging_detection(<span class="keyword">void</span>) &#123; <span class="comment">// 充电状态监测</span></span><br><span class="line">    get_off_mode_charge_status()</span><br><span class="line"><span class="keyword">if</span> (upmu_is_chr_det() == KAL_TRUE) &#123;</span><br><span class="line"><span class="keyword">if</span> (off_mode_status) &#123;</span><br><span class="line">g_boot_mode = KERNEL_POWER_OFF_CHARGING_BOOT;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">g_boot_mode = NORMAL_BOOT;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> TRUE;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">mt6575_power_off();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="初始化充电IC"><a href="#初始化充电IC" class="headerlink" title="初始化充电IC"></a>初始化充电IC</h4><p>充电IC的初始化工作，有些可以被kernel驱动覆盖，有些不能，所以有时候一些修改记得在LK和kernel里面都得完成。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># alps\vendor\mediatek\proprietary\bootable\bootloader\lk\platform\mt6797\mt_battery.c</span></span><br><span class="line">pchr_turn_on_charging() &#123; <span class="comment">//打开充电</span></span><br><span class="line">bq25890_hw_init();</span><br><span class="line">bq25890_charging_enable(bEnable);</span><br><span class="line">bq25890_dump_register();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta"># alps\vendor\mediatek\proprietary\bootable\bootloader\lk\platform\mt6797\rules.mk</span></span><br><span class="line">    ifeq ($(MTK_BQ25896_SUPPORT),yes)</span><br><span class="line">      OBJS +=$(LOCAL_DIR)/bq25890.o</span><br><span class="line">      DEFINES += MTK_BQ25896_SUPPORT</span><br><span class="line">      DEFINES += SWCHR_POWER_PATH</span><br><span class="line"></span><br><span class="line"># alps\vendor\mediatek\proprietary\bootable\bootloader\lk\platform\mt6797\include\platform\bq25890.h</span><br><span class="line"># alps\vendor\mediatek\proprietary\bootable\bootloader\lk\platform\mt6797\bq25890.c</span><br><span class="line"><span class="keyword">void</span> bq25890_hw_init(<span class="keyword">void</span>)</span><br><span class="line"># 充电IC初始化及电流电压等相关设置</span><br></pre></td></tr></table></figure><h4 id="1-2-2-3-充电器状态监测处理"><a href="#1-2-2-3-充电器状态监测处理" class="headerlink" title="1.2.2.3 充电器状态监测处理"></a>1.2.2.3 充电器状态监测处理</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># alps\vendor\mediatek\proprietary\bootable\bootloader\lk\app\mt_boot\mt_boot.c</span></span><br><span class="line">boot_linux_fdt() &#123;</span><br><span class="line">    <span class="keyword">if</span> (kernel_charging_boot() == <span class="number">-1</span>) </span><br><span class="line">    mt6575_power_off(); <span class="comment">// if Unplugged, 关机</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (kernel_charging_boot() == <span class="number">1</span>) &#123;</span><br><span class="line"><span class="keyword">if</span> (pmic_detect_powerkey()) &#123;</span><br><span class="line">mtk_arch_reset(<span class="number">1</span>); <span class="comment">// 跳转kernel前如果按键，重启</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="充电图标"><a href="#充电图标" class="headerlink" title="充电图标"></a>充电图标</h4><p>MTK之前很多方案是在lk里面绘制关机充电图标，然后采样IPO协议实现关机充电。不过现在已采取高通类似方案在Health部分绘制关机充电图标了。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># alps\vendor\mediatek\proprietary\bootable\bootloader\lk\platform\mt6755\mt_logo.c</span></span><br></pre></td></tr></table></figure><p>IPO方式流程图如下：<br><img src="https://andylee-1258982386.cos.ap-chengdu.myqcloud.com/android/mtk/power%20off%20charging.jpg" alt="IPO"></p><blockquote><p>由于初次接触MTK，又没有深入研究此部分，此部分如有错误，敬请谅解和指出。</p></blockquote><h2 id="Kernel层"><a href="#Kernel层" class="headerlink" title="Kernel层"></a>Kernel层</h2><p>Kernel 部分软件流程框图，不过此图是我从MTK文档上截取没有做修改，所以图片中外部充电IC代码为Fan5405，对应于我的代码应该为bq24290（bq24296）。如下：<br><img src="https://andylee-1258982386.cos.ap-chengdu.myqcloud.com/android/mtk/kernel_cod_arch.jpg" alt="arch"></p><h3 id="1-3-1-ADC部分"><a href="#1-3-1-ADC部分" class="headerlink" title="1.3.1 ADC部分"></a>1.3.1 ADC部分</h3><p>电流电压采样部分代码没有深入查看，主要看了如下一个文件：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># alps\kernel-3.18\drivers\misc\mediatek\power\mt6797\pmic_auxadc.c</span></span><br><span class="line">pmic_auxadc_init()</span><br><span class="line">PMIC_IMM_GetCurrent <span class="comment">// 算出电流</span></span><br></pre></td></tr></table></figure><h3 id="HAL部分"><a href="#HAL部分" class="headerlink" title="HAL部分"></a>HAL部分</h3><p>此 HAL 并不是真正的 HAL 层，实际是驱动部分，实现部分结构体，针对 MTK 不同充电方案提供支持，读取各项参数。我所阅读的代码使用了外接充电 IC BQ24296（switch charger），驱动不会走 linear_charging.c，走 switch_charging.c + bq25896 驱动部分。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># alps\kernel-3.18\drivers\misc\mediatek\power\mt6797\charging_hw_pmic.c</span></span><br><span class="line">charging_value_to_parameter()</span><br><span class="line">charging_parameter_to_value()</span><br><span class="line">charging_hw_init() <span class="comment">// PMIC初始化</span></span><br><span class="line">charging_get/set_current()</span><br><span class="line">charging_sw_init()</span><br><span class="line">chr_control_interface()</span><br><span class="line"></span><br><span class="line"><span class="meta"># alps\kernel-3.18\drivers\misc\mediatek\<span class="meta-keyword">include</span>\mt-plat\battery_meter_hal.h</span></span><br><span class="line">BATTERY_METER_CTRL_CMD</span><br><span class="line"></span><br><span class="line"><span class="meta"># alps\kernel-3.18\drivers\misc\mediatek\power\mt6797\battery_meter_hal.c</span></span><br><span class="line">get_hw_ocv</span><br><span class="line">read_adc_v_bat_sense()  <span class="comment">// 读取电池电压，根据宏判断 batsense 还是 isense</span></span><br><span class="line"></span><br><span class="line"><span class="meta"># alps\kernel-3.18\drivers\misc\mediatek\power\mt6797\bq25890.h</span></span><br><span class="line"><span class="comment">// 硬件定义及接口</span></span><br><span class="line"></span><br><span class="line"><span class="meta"># alps\kernel-3.18\drivers\misc\mediatek\power\mt6797\bq25890.c</span></span><br><span class="line">bq25890_driver_probe() <span class="comment">// 注册驱动</span></span><br><span class="line">bq25890_get_xx() <span class="comment">// get 接口</span></span><br><span class="line">bq25890_set_xx() <span class="comment">// set 接口</span></span><br><span class="line">bq25890_hw_init() </span><br><span class="line"></span><br><span class="line"><span class="meta"># alps\kernel-3.18\drivers\misc\mediatek\power\mt6797\charging_hw_bq25890.c</span></span><br><span class="line">is_chr_det() <span class="comment">// 充电器检测</span></span><br><span class="line">    val = pmic_get_register_value(MT6351_PMIC_RGS_CHRDET);</span><br><span class="line">charging_hw_init() <span class="comment">// 充电IC初始化     </span></span><br><span class="line">charging_sw_init() <span class="comment">// 充电IC初始化</span></span><br><span class="line">charging_get_xx() <span class="comment">// 封装后的 get 接口</span></span><br><span class="line">charging_get_charger_type() <span class="comment">// 获取充电器类型</span></span><br><span class="line">charging_set_xx() <span class="comment">// 封装后的 set 接口</span></span><br><span class="line">charging_set_current() <span class="comment">// 设置充电电流</span></span><br></pre></td></tr></table></figure><h3 id="Common部分"><a href="#Common部分" class="headerlink" title="Common部分"></a>Common部分</h3><p>PMIC充电控制、充电控制主线程、SW FG算法等内容在此部分实现。battery_common*.c 是一个关键文件，其是充电控制的主线程，battery 设备也由此文件注册。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># alps\kernel-3.18\drivers\misc\mediatek\<span class="meta-keyword">include</span>\mt-plat\charging.h</span></span><br><span class="line">CHARGING_CTRL_CMD</span><br><span class="line">CHARGER_TYPE</span><br><span class="line">BATTERY_VOLTAGE_ENUM</span><br><span class="line">CHR_CURRENT_ENUM</span><br><span class="line"><span class="comment">// 如上等电池相关宏定义</span></span><br><span class="line"></span><br><span class="line"><span class="meta"># alps\kernel-3.18\drivers\misc\mediatek\<span class="meta-keyword">include</span>\mt-plat\battery_common.h</span></span><br><span class="line"><span class="comment">// 充电等相关参数定义</span></span><br><span class="line"></span><br><span class="line"><span class="meta"># alps/kernel-3.18/drivers/power/mediatek/battery_common_fg_20.c </span></span><br><span class="line"><span class="comment">// 充电控制主线程</span></span><br><span class="line">power_supply_property xx <span class="comment">// 定义电池相关文件节点，后面接口函数对其更新</span></span><br><span class="line">upmu_is_chr_det() <span class="comment">// 充电状态监测</span></span><br><span class="line">wireless/ac/usb_get_get_property() <span class="comment">// 更新 charger</span></span><br><span class="line">battery_update() </span><br><span class="line">bat_routine_thread()</span><br><span class="line">    hrtimer_start() <span class="comment">// 开始定时器，定时更新数据</span></span><br><span class="line">battery_init() <span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="meta"># alps\kernel-3.18\drivers\misc\mediatek\<span class="meta-keyword">include</span>\mt-plat\battery_meter.h</span></span><br><span class="line"><span class="comment">// SW FG 算法相关定义</span></span><br><span class="line"><span class="meta"># alps/kernel-3.18/drivers/power/mediatek/battery_meter_fg_20.c </span></span><br><span class="line"><span class="comment">// SW FG算法,也即是OAM</span></span><br><span class="line">SW FG的原理：</span><br><span class="line">a.PMIC adc来获取raw vbat电压。</span><br><span class="line">b.通过ZCV表格，将vbat转换成OCV</span><br><span class="line">c.ocv-vbat/r 来获取电流I</span><br><span class="line">d.对电流i 进行积分，获取电量。</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * MTK vendor 封装了 FG2.0 算法，计算soc，然后通过netlink发送到Kernel</span></span><br><span class="line"><span class="comment"> * 算法部分可以参考FG1.0的代码（battery_meter.c）</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">BMT_status.SOC = battery_meter_get_battery_percentage()</span><br><span class="line">  gFG_capacity_by_c <span class="comment">//库仑计计算的电量值</span></span><br><span class="line">    bmd_ctrl_cmd_from_user（）<span class="comment">// meter  数据</span></span><br><span class="line">      <span class="built_in">memcpy</span>(&amp;gFG_capacity_by_c,...)</span><br><span class="line">        nl_data_handler（）-&gt;data = NLMSG_DATA(nlh)</span><br><span class="line"></span><br><span class="line">D0值：读取电池电压，将电池电压按对应电池的ZCV表查找对应的百分比，根据一定算法运算出的初始电量。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># alps\kernel<span class="number">-3.18</span>\drivers\power\mediatek\linear_charging.c</span><br><span class="line"><span class="comment">// PMIC充电控制， CC模式CV模式切换</span></span><br><span class="line">mtk_tuning_voltage()</span><br><span class="line"></span><br><span class="line"><span class="comment">/*linear_charging.c 和 switch_charging.c二选一*/</span></span><br><span class="line"># alps\kernel<span class="number">-3.18</span>\drivers\power\mediatek\switch_charging.c</span><br><span class="line"><span class="comment">// SW charger充电控制， CC模式CV模式切换</span></span><br><span class="line">set_chr_input_current_limit()</span><br><span class="line">set_bat_sw_cv_charging_current_limit()</span><br><span class="line">...</span><br><span class="line">charging_full_check()</span><br><span class="line"></span><br><span class="line"># alps\kernel<span class="number">-3.18</span>\drivers\misc\mediatek\power\mt6797\pmic_chr_type_det.c</span><br></pre></td></tr></table></figure><p>Fuel Gauge Control 和 Charging Control 框图如下：</p><p><img src="https://andylee-1258982386.cos.ap-chengdu.myqcloud.com/android/mtk/charging_control.jpg" alt="FG&amp;Charging Control"></p><h3 id="客制化部分"><a href="#客制化部分" class="headerlink" title="客制化部分"></a>客制化部分</h3><p>不同于高通将电池曲线合入DTS，MTK是以头文件的形式合入电池曲线（好像也有DTS方式）。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># alps\kernel-3.18\drivers\misc\mediatek\<span class="meta-keyword">include</span>\mt-plat\mt6797\<span class="meta-keyword">include</span>\mach\mt_battery_meter_table.h</span></span><br><span class="line"><span class="comment">// 充电IC温度检测上拉电阻配置</span></span><br><span class="line">BATTERY_PROFILE_STRUCT battery_profile_tx[] <span class="comment">// 合入不同温度下电池曲线的 DOD OCV</span></span><br><span class="line">R_PROFILE_STRUCT r_profile_t1[] <span class="comment">// 合入不同温度下电池曲线的电池内阻和OCV</span></span><br><span class="line"></span><br><span class="line"><span class="meta"># alps\kernel-3.18\drivers\misc\mediatek\<span class="meta-keyword">include</span>\mt-plat\mt6797\<span class="meta-keyword">include</span>\mach\mt_battery_meter.h</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SOC_BY_HW_FG  <span class="comment">// 定义默认使用 Fuel Gauge， FG算法</span></span></span><br><span class="line"><span class="comment">/*#define HW_FG_FORCE_USE_SW_OCV*/</span></span><br><span class="line"><span class="comment">/*#define SOC_BY_SW_FG*/</span></span><br><span class="line"><span class="comment">// 电池参数配置，部分值来源于电池曲线表</span></span><br><span class="line">CUST_POWERON_DELTA_CAPACITY_TOLRANCE <span class="comment">// 重启电量记录范围</span></span><br><span class="line"></span><br><span class="line"><span class="meta"># alps\kernel-3.18\drivers\misc\mediatek\<span class="meta-keyword">include</span>\mt-plat\mt6797\<span class="meta-keyword">include</span>\mach\mt_charging.h</span></span><br><span class="line"><span class="comment">// 充电控制，充电电流、温度等宏定义</span></span><br></pre></td></tr></table></figure><h3 id="文件节点"><a href="#文件节点" class="headerlink" title="文件节点"></a>文件节点</h3><p>电池状态、充电状态等文件节点的创建路径：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Power Supply Class Node </span></span><br><span class="line"><span class="meta"># alps\kernel-3.18\drivers\power\power_supply.h</span></span><br><span class="line"><span class="meta"># alps\kernel-3.18\drivers\power\power_supply_core.c</span></span><br><span class="line"><span class="meta"># alps\kernel-3.18\drivers\power\power_supply_sysfs.c</span></span><br><span class="line">power_supply_show_property()</span><br><span class="line">power_supply_attrs</span><br><span class="line"><span class="meta"># alps\kernel-3.18\drivers\power\power_supply_leds.c</span></span><br></pre></td></tr></table></figure><h3 id="Healthd模块"><a href="#Healthd模块" class="headerlink" title="Healthd模块"></a>Healthd模块</h3><p>Healtdh模块是一个单独的进程，这部分主要做两件事：1. 读取电池数据，上报（BatteryService.java）； 2. 绘制关机图标。</p><h4 id="Main函数"><a href="#Main函数" class="headerlink" title="Main函数"></a>Main函数</h4><p>healthd.cpp是Healthd模块的入口，也就是Main函数，如下：</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># alps\system\core\healthd\healthd.cpp</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 针对不同方式定义执行函数</span></span><br><span class="line"><span class="comment"> * android_ops  正常开机</span></span><br><span class="line"><span class="comment"> * charger_ops  关机充电</span></span><br><span class="line"><span class="comment"> * recovery_ops Recovery模式</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">healthd_mode_ops</span> <span class="title">android_ops</span> = &#123;</span></span><br><span class="line">    .init = healthd_mode_android_init,</span><br><span class="line">    .preparetowait = healthd_mode_android_preparetowait,</span><br><span class="line">    .heartbeat = healthd_mode_nop_heartbeat,</span><br><span class="line">    .battery_update = healthd_mode_android_battery_update,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">uevent_event() <span class="comment">// uevent 事件处理</span></span><br><span class="line">    uevent_kernel_multicast_recv(uevent_fd, msg, UEVENT_MSG_LEN) <span class="comment">// 接收底层事件，并返回事件数量</span></span><br><span class="line">    <span class="comment">/*遍历事件，POWER_SUPPLY_SUBSYSTEM*/</span></span><br><span class="line">    healthd_battery_update() <span class="comment">// 电池信息更新入口，此处根据返回 Charging ？，设置 poll 唤醒周期</span></span><br><span class="line">        gBatteryMonitor-&gt;update()   </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">main() <span class="comment">// main函数,单独的进程</span></span><br><span class="line">    healthd_mode_ops = &amp;android_ops/&amp;charger_ops/&amp;recovery_ops; <span class="comment">// 选择执行函数体</span></span><br><span class="line">    healthd_init</span><br><span class="line">        epoll_create(MAX_EPOLL_EVENTS); <span class="comment">// 使用epoll进行IO复用, 在一个线程管理所以 fd</span></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * 创建、注册监听三个事件，加入 epoll fd，每个事件都有其句柄函数</span></span><br><span class="line"><span class="comment">         * gBinderfd ：监听Binder通信事件，句柄：binder_event（healthd_mode_android.cpp）</span></span><br><span class="line"><span class="comment">         * uevent_fd： 监听底层电池 event，句柄:uevent_event()</span></span><br><span class="line"><span class="comment">         * wakealarm_fd：监听wakealarm事件，句柄：wakealarm_event</span></span><br><span class="line"><span class="comment">         * 在监听到事件后，epoll 就会在句柄函数里面做相应的更新操作，如上 uevent_event()</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        healthd_mode_ops-&gt;init(&amp;healthd_config)<span class="comment">// healthd_mode_android_init()</span></span><br><span class="line">        uevent_init()</span><br><span class="line">        wakealarm_init()</span><br><span class="line">        <span class="keyword">new</span> BatteryMonitor();</span><br><span class="line">    healthd_mainloop(); <span class="comment">// main函数，while(1) </span></span><br><span class="line">        <span class="keyword">if</span> (events[n].data.ptr) <span class="comment">// epoll遍历事件fd，调用处理函数</span></span><br><span class="line">                (*(<span class="keyword">void</span> (*)(<span class="keyword">int</span>))events[n].data.ptr)(events[n].events);</span><br><span class="line">        healthd_mode_ops-&gt;heartbeat();</span><br></pre></td></tr></table></figure><h4 id="正常开机"><a href="#正常开机" class="headerlink" title="正常开机"></a>正常开机</h4><p>正常开机时电池信息更新：<br><img src="https://andylee-1258982386.cos.ap-chengdu.myqcloud.com/android/mtk/bat_update_func.jpg" alt="update_battery"></p><p>正常开机部分源码分析：</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># alps\system\core\healthd\BatteryPropertiesRegistrar.cpp</span></span><br><span class="line">BatteryPropertiesRegistrar::publish()<span class="comment">//将&quot;batteryproperties&quot;这个Service加入ServiceManager</span></span><br><span class="line">BatteryPropertiesRegistrar::notifyListeners() <span class="comment">// 遍历 listener ，通知上层监听者，如 BatteryService</span></span><br><span class="line">BatteryPropertiesRegistrar::registerListener() <span class="comment">// 上层通过Binder注册回调</span></span><br><span class="line">     healthd_battery_update();<span class="comment">// healthd.cpp</span></span><br><span class="line">BatteryPropertiesRegistrar::getProperty() <span class="comment">//BatteryManager.java主动查询时的对应接口</span></span><br><span class="line"></span><br><span class="line"><span class="meta"># alps\system\core\healthd\healthd_mode_android.cpp</span></span><br><span class="line">healthd_mode_android_battery_update</span><br><span class="line">    gBatteryPropertiesRegistrar-&gt;notifyListeners(*props) </span><br><span class="line">    </span><br><span class="line">healthd_mode_android_init()</span><br><span class="line">    ProcessState::self()-&gt;setThreadPoolMaxThreadCount(<span class="number">0</span>);<span class="comment">// 线程池里最大线程数</span></span><br><span class="line">    IPCThreadState::self()-&gt;disableBackgroundScheduling(<span class="literal">true</span>);<span class="comment">// 禁用后台调度</span></span><br><span class="line">    IPCThreadState::self()-&gt;setupPolling(&amp;gBinderFd); <span class="comment">// 将Binder通信fd加入epoll</span></span><br><span class="line">    <span class="keyword">if</span> (healthd_register_event(gBinderFd, binder_event)) <span class="comment">//binder_event注册到gBinderFd</span></span><br><span class="line">    <span class="comment">/* 将&quot;batteryproperties&quot;加入ServiceManager */</span></span><br><span class="line">    gBatteryPropertiesRegistrar-&gt;publish(gBatteryPropertiesRegistrar);</span><br><span class="line"></span><br><span class="line"><span class="meta"># alps\system\core\healthd\BatteryMonitor.cpp </span></span><br><span class="line">BatteryMonitor::update(<span class="keyword">void</span>)</span><br><span class="line">    initBatteryProperties() <span class="comment">// 电池参数初始化</span></span><br><span class="line">    <span class="comment">/*获取文件节点数据封装于 BatteryProperties */</span></span><br><span class="line">    path.appendFormat(<span class="string">&quot;%s/%s/online&quot;</span>, POWER_SUPPLY_SYSFS_PATH, mChargerNames[i].<span class="built_in">string</span>());</span><br><span class="line">    ireadFromFile(path, buf, SIZE)</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * alps\system\core\healthd\healthd_board_default.cpp</span></span><br><span class="line"><span class="comment">     * 将电池实时信息记录到 kernel log 中</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    healthd_board_battery_update(&amp;props);</span><br><span class="line">    healthd_mode_ops-&gt;battery_update(&amp;props) <span class="comment">// healthd_mode_android.cpp中update</span></span><br><span class="line">    </span><br><span class="line">BatteryMonitor::getXX  <span class="comment">// 获取电池状态和Health状况等</span></span><br><span class="line">BatteryMonitor::dumpState()</span><br><span class="line">BatteryMonitor::init() <span class="comment">//获取文件节点值，初始化（譬如加上节点路径： /sys/class/power_supply）写入mHealthdConfig</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="关机充电"><a href="#关机充电" class="headerlink" title="关机充电"></a>关机充电</h4><p>关机充电部分主要就是更新电量、充电状态，更新UI。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># alps\system\core\healthd\healthd_mode_charger.cpp</span></span><br><span class="line">dump_last_kmsg() // dump前记录最后一份<span class="built_in">log</span></span><br><span class="line">/*绘制关机充电图标*/</span><br><span class="line">draw_xx()</span><br><span class="line">redraw_screen()</span><br><span class="line">healthd_mode_charger_heartbeat() // 获取最新电池状态，更新</span><br><span class="line">    handle_input_state(charger, now);</span><br><span class="line">    handle_power_supply_state(charger, now);</span><br><span class="line">    update_screen_state()  // 更新屏幕显示</span><br><span class="line">healthd_mode_charger_init()</span><br><span class="line">healthd_mode_charger_battery_update()</span><br></pre></td></tr></table></figure><h2 id="Framework层"><a href="#Framework层" class="headerlink" title="Framework层"></a>Framework层</h2><h3 id="Native层"><a href="#Native层" class="headerlink" title="Native层"></a>Native层</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># alps\frameworks\native\services\sensorservice\BatteryService.cpp</span></span><br><span class="line"><span class="comment">// 定义BatteryService.h中创建的BatteryService类的成员函数</span></span><br><span class="line"></span><br><span class="line"><span class="meta"># alps\frameworks\native\services\batteryservice\BatteryProperties.cpp</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 容器Parcel读写电池相关信息</span></span><br><span class="line"><span class="comment"> * 必须与frameworks/base/core/java/android/os/BatteryProperties.java 同步</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">BatteryProperties::readFromParcel()</span><br><span class="line">BatteryProperties::writeToParcel()</span><br><span class="line"></span><br><span class="line"><span class="meta"># alps\frameworks\native\services\batteryservice\BatteryProperty.cpp</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Parcel read/write code must be kept in sync with</span></span><br><span class="line"><span class="comment"> * frameworks/base/core/java/android/os/BatteryProperty.java</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">BatteryProperty::readFromParcel()</span><br><span class="line">BatteryProperty::writeToParcel()</span><br><span class="line"></span><br><span class="line"><span class="meta"># alps\frameworks\native\services\batteryservice\IBatteryPropertiesListener.cpp</span></span><br><span class="line"><span class="comment">// BatteryService.java中BatteryListener的父类</span></span><br><span class="line">batteryPropertiesChanged()</span><br><span class="line"></span><br><span class="line"><span class="meta"># alps\frameworks\native\services\batteryservice\IBatteryPropertiesRegistrar.cpp</span></span><br><span class="line"><span class="comment">// BatteryManager.java和BatteryService.java通过其获取 batteryproperties ，与healthd中同步</span></span><br></pre></td></tr></table></figure><h3 id="Framework部分"><a href="#Framework部分" class="headerlink" title="Framework部分"></a>Framework部分</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"># alps\frameworks\base\services\core\java\com\android\server\BatteryService.java</span><br><span class="line">onStart() &#123;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * 通过ServiceManager获取batteryproperties Service，</span></span><br><span class="line"><span class="comment">     * 然后将BatteryListener注册到batteryproperties中</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    IBinder b = ServiceManager.getService(<span class="string">&quot;batteryproperties&quot;</span>); </span><br><span class="line">    batteryPropertiesRegistrar.registerListener(<span class="keyword">new</span> BatteryListener());</span><br><span class="line">    publishBinderService(<span class="string">&quot;battery&quot;</span>, mBinderService);</span><br><span class="line">    publishLocalService(BatteryManagerInternal.class, <span class="keyword">new</span> LocalService());</span><br><span class="line">processValuesLocked     </span><br><span class="line">    shutdownIfNoPowerLocked() <span class="comment">// 低电 Unplugged 关机广播</span></span><br><span class="line">    shutdownIfOverTempLocked() <span class="comment">// 温度超出，关机广播</span></span><br><span class="line">    sendIntentLocked() <span class="comment">// 电池信息改变，信息广播</span></span><br><span class="line">    </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BatteryListener</span></span></span><br><span class="line"><span class="class">    <span class="title">batteryPropertiesChanged</span> // 监听到电池信息改变，更新信息</span></span><br><span class="line"><span class="class">        <span class="title">atteryService</span>.<span class="title">this</span>.<span class="title">update</span>(<span class="title">props</span>)</span></span><br><span class="line"><span class="class"><span class="title">class</span> <span class="title">Led</span> // 开机充电 <span class="title">LED</span> 控制类</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class"># <span class="title">alps</span>\<span class="title">frameworks</span>\<span class="title">base</span>\<span class="title">core</span>\<span class="title">java</span>\<span class="title">android</span>\<span class="title">os</span>\<span class="title">BatteryManager</span>.<span class="title">java</span></span></span><br><span class="line"><span class="class"><span class="title">queryProperty</span>() // 主动到 <span class="title">healthd</span> 查询电池信息</span></span><br><span class="line"><span class="class">    <span class="title">IBinder</span> <span class="title">b</span> </span>= ServiceManager.getService(<span class="string">&quot;batteryproperties&quot;</span>);<span class="comment">//获取batteryproperties Service  </span></span><br><span class="line">    mBatteryPropertiesRegistrar = IBatteryPropertiesRegistrar.Stub.asInterface(b);<span class="comment">//接口转化</span></span><br><span class="line">    mBatteryPropertiesRegistrar.getProperty(id, prop) <span class="comment">// 调用到Healthd BatteryPropertiesRegistrar.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/******************************************************************</span></span><br><span class="line"><span class="comment"> * 还有很多其他文件为上面两个文件提供服务，没有去详细分析了</span></span><br><span class="line"><span class="comment"> * 如下简单介绍一下。</span></span><br><span class="line"><span class="comment"> *****************************************************************/</span></span><br><span class="line"></span><br><span class="line"># alps\frameworks\base\services\core\java\com\android\server\am\BatteryStatsService.java</span><br><span class="line"><span class="comment">// 电池信息广播Intent（ACTION_BATTERY_CHANGED）用到的字符串和常量</span></span><br><span class="line"></span><br><span class="line"># alps\frameworks\base\core\java\android\os\BatteryManagerInternal.java</span><br><span class="line"># alps\frameworks\base\core\java\android\os\BatteryProperties.aidl</span><br><span class="line"># alps\frameworks\base\core\java\android\os\BatteryProperties.java</span><br><span class="line"><span class="comment">// 电池信息读写代码，与BatteryProperties.cpp同步</span></span><br><span class="line"># alps\frameworks\base\core\java\android\os\BatteryProperty.aidl</span><br><span class="line"># alps\frameworks\base\core\java\android\os\BatteryProperty.java</span><br><span class="line"><span class="comment">// 电池信息读写代码，与BatteryProperties.cpp同步</span></span><br><span class="line"></span><br><span class="line"># alps\frameworks\base\core\java\android\os\BatteryStats.java</span><br><span class="line"> <span class="comment">// 存取电池使用情况统计，包括wakelocks, processes, packages, and services等</span></span><br><span class="line"></span><br><span class="line"># alps\frameworks\base\core\java\com\android\internal\os\BatteryStatsImpl.aidl</span><br><span class="line"><span class="comment">// .aidl为接口定义文件， 定义电池状态信息及相关操作方法。</span></span><br><span class="line"></span><br><span class="line"># alps\frameworks\base\core\java\com\android\internal\os\BatteryStatsImpl.java</span><br><span class="line"><span class="comment">// 影响电池的所有信息及操作，时间以ms为单位</span></span><br></pre></td></tr></table></figure><h3 id="APP部分"><a href="#APP部分" class="headerlink" title="APP部分"></a>APP部分</h3><p>系统UI处理电流的部分路径主要如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"># alps\frameworks\base\core\java\com\android\internal\os\BatterySipper.java</span><br><span class="line"># alps\frameworks\base\core\java\com\android\internal\os\BatteryStatsHelper.java</span><br><span class="line"># alps\frameworks\base\packages\SystemUI\src\com\android\systemui\BatteryMeterDrawable.java</span><br><span class="line"># alps\frameworks\base\packages\SystemUI\src\com\android\systemui\BatteryMeterView.java</span><br><span class="line"><span class="comment">// 创建系统广播接收器，接收电池信息广播，绘制电池状态图标</span></span><br><span class="line"></span><br><span class="line"># alps\frameworks\base\packages\SystemUI\src\com\android\systemui\statusbar\policy\BatteryController.java</span><br><span class="line"><span class="comment">// 定义一个广播接收器并在构造器里注册接收电池信息广播，收到自己广播后回调修改pluged、level</span></span><br><span class="line"></span><br><span class="line"># alps\frameworks\base\packages\SystemUI\src\com\android\systemui\power\PowerUI.java</span><br><span class="line"><span class="comment">// 创建系统广播接收器，接收电池信息广播，弹出低电警告等</span></span><br><span class="line"></span><br><span class="line"># alps\frameworks\base\packages\SystemUI\src\com\android\systemui\qs\tiles\BatteryTile.java</span><br><span class="line"><span class="comment">// 定义电量百分比显示TextView类</span></span><br></pre></td></tr></table></figure><h1 id="关机充电流程"><a href="#关机充电流程" class="headerlink" title="关机充电流程"></a>关机充电流程</h1><p>关机充电也是在kernel里面充电，充电控制流程与开机是一致的，前面也分析到了。这里补充一个MTK软件流程图。如下：<br><img src="https://andylee-1258982386.cos.ap-chengdu.myqcloud.com/android/mtk/power%20off%20charging2.jpg" alt="charging flow"></p><h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>先留一个坑，等有时间了，再来绘制一个清晰易懂的流程框图。</p>]]></content>
      
      
      <categories>
          
          <category> Android </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 源码分析 </tag>
            
            <tag> MTK </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Android Selinux 权限及问题</title>
      <link href="2017/11/14/Android/Android-SELinux-Permison-and-Question/"/>
      <url>2017/11/14/Android/Android-SELinux-Permison-and-Question/</url>
      
        <content type="html"><![CDATA[<blockquote><p>由于现做的是MTK平台，源码路径基于MTK， 不过高通大同小异</p></blockquote><h2 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h2><p>Android 5.0以后完全引入了 SEAndroid/SELinux 安全机制，这样即使拥有 root 权限或 chmod 777 ，仍然无法再JNI以上访问内核节点。</p><blockquote><p>其实在 Android 4.4 就有限制的启用此安全机制了。后面内容都按照 5.0  以后介绍，4.4 会有些许差异。</p></blockquote><h2 id="SELinux-Mode"><a href="#SELinux-Mode" class="headerlink" title="SELinux Mode"></a>SELinux Mode</h2><p>SELinux 分为两种模式，Android 5.0 后所有进程都使用 enforcing mode。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">enforcing mode: 限制访问</span><br><span class="line">permissive mode: 只审查权限，不限制</span><br></pre></td></tr></table></figure><a id="more"></a><h2 id="SELinux-Policy文件路径"><a href="#SELinux-Policy文件路径" class="headerlink" title="SELinux Policy文件路径"></a>SELinux Policy文件路径</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Google 原生目录 </span></span><br><span class="line">external/sepolicy</span><br><span class="line"></span><br><span class="line"><span class="comment"># 厂家目录，高通将 mediatek 换为 qcom</span></span><br><span class="line">alps\device\mediatek\common\sepolicy</span><br><span class="line">alps\device\mediatek\&lt;platform&gt;\sepolicy</span><br></pre></td></tr></table></figure><blockquote><p>编译时将以合并的方式将厂家policy追加到Google原生。</p></blockquote><h2 id="Log"><a href="#Log" class="headerlink" title="Log"></a>Log</h2><p>没有权限时可以在内核找到如下 log ：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># avc: denied  &#123; 操作权限  &#125;  for pid=7201  comm=“进程名”  scontext=u:r:源类型:s0  tcontext=u:r:目标类型:s0  tclass=访问类型 permissive=0</span></span><br><span class="line"></span><br><span class="line">avc: denied &#123;getattr <span class="built_in">read</span>&#125; <span class="keyword">for</span> pid=7201 comm=<span class="string">&quot;xxx.xxx&quot;</span> scontext=u:r:system_app:s0 tcontext=u:r:shell_data_file:s0 tclass=dir permissive=0</span><br></pre></td></tr></table></figure><h2 id="权限修改"><a href="#权限修改" class="headerlink" title="权限修改"></a>权限修改</h2><p>主要有三种方式，前两种只能用来测试，第三种是推荐的正式处理方式。</p><h3 id="adb在线修改seLinux"><a href="#adb在线修改seLinux" class="headerlink" title="adb在线修改seLinux"></a>adb在线修改seLinux</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Enforcing - 表示已打开 ，Permissive - 表示已关闭</span></span><br><span class="line">getenforce;     //获取当前seLinux状态</span><br><span class="line">setenforce 1;   //打开seLinux</span><br><span class="line">setenforce 0;   //关闭seLinux</span><br></pre></td></tr></table></figure><h3 id="kernel中关闭"><a href="#kernel中关闭" class="headerlink" title="kernel中关闭"></a>kernel中关闭</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># alps\kernel-3.18\arch\arm64\configs\xxx_defconfig</span></span><br><span class="line">CONFIG_SECURITY_SELINUX=y // 屏蔽此配置项</span><br></pre></td></tr></table></figure><h3 id="SELinux-Sepolicy中添加权限"><a href="#SELinux-Sepolicy中添加权限" class="headerlink" title="SELinux Sepolicy中添加权限"></a>SELinux Sepolicy中添加权限</h3><p>修改相应源类型.te文件（基本以源进程名命名），添加如下一行语句：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 格式</span></span><br><span class="line">allow  源类型 目标类型:访问类型 &#123;操作权限&#125;; // 注意分号</span><br><span class="line"></span><br><span class="line"><span class="comment"># 实例，具体写法参考源码</span></span><br><span class="line">allow system_app shell_data_file:dir&#123;getattr <span class="built_in">read</span> write&#125;;</span><br><span class="line">allow mediaserver tfa9897_device:chr_file &#123; open <span class="built_in">read</span> write &#125;; </span><br><span class="line">allow system_server tfa9897_device:chr_file rw_file_perms; </span><br><span class="line"></span><br><span class="line">chr_file - 字符设备  file - 普通文件 dir - 目录</span><br></pre></td></tr></table></figure><blockquote><p>通常很少修改Google default 的policy, 推荐更新mediatek 下面的相关的policy. </p></blockquote><h3 id="新建节点"><a href="#新建节点" class="headerlink" title="新建节点"></a>新建节点</h3><p>如果是自己新建的节点，需要在 sepolicy 路径下的 file_contexts 文件中做如下添加：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 参考已有的格式</span></span><br><span class="line">/dev/goodix_fp                 u:object_r:goodixfp_device:s0</span><br></pre></td></tr></table></figure><blockquote><p>Android 5.0 修改的文件为device.te 和 file_contexts.be，而且device/mediatek/common/BoardConfig.mk 中的 BROAD_SEPOLICY_UNION 增加对应的xxxx.te。</p></blockquote><h2 id="编译"><a href="#编译" class="headerlink" title="编译"></a>编译</h2><pre><code class="bash"># 模块编译mmm external/sepolicymake -j24 ramdisk-nodeps &amp; make -j24 bootimage-nodeps# 整编make -j24</code></pre>]]></content>
      
      
      <categories>
          
          <category> Android </category>
          
      </categories>
      
      
        <tags>
            
            <tag> MTK </tag>
            
            <tag> App </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>常用的快充技术简介</title>
      <link href="2017/11/13/Android/What-is-fast-charge-now/"/>
      <url>2017/11/13/Android/What-is-fast-charge-now/</url>
      
        <content type="html"><![CDATA[<p>技术发展越来越快，快充技术也一样，那现在怎么样才能算快充，有哪些快充技术呢？</p><h2 id="高通方案"><a href="#高通方案" class="headerlink" title="高通方案"></a>高通方案</h2><h3 id="高通-Quick-Charge-方案"><a href="#高通-Quick-Charge-方案" class="headerlink" title="高通 Quick Charge 方案"></a>高通 Quick Charge 方案</h3><h4 id="QC-1-0"><a href="#QC-1-0" class="headerlink" title="QC 1.0"></a>QC 1.0</h4><p>最高支持 5V/2A 充电功率(目前已经被划分为慢充)，基本都是骁龙 600 平台。</p><a id="more"></a><h4 id="QC-2-0"><a href="#QC-2-0" class="headerlink" title="QC 2.0"></a>QC 2.0</h4><p>分为A版和B版，</p><ul><li><p>A版：包含 5V、9V 和 12V 三档，最大电流3A，适用于智能手机、平板电脑以及其它便携式电子设备，支持的平台包括了骁龙 200/400 /410/615/800/801/805/810，另外也授权给其他厂商使用，例如 Intel 的 Boost Master 快速充电技术其实也属于高通 QC2.0;</p></li><li><p>B版：支持20V电压，最大可以输出40w功率，应用于对充电速度要求更高的设备。</p></li></ul><h4 id="QC-3-0"><a href="#QC-3-0" class="headerlink" title="QC 3.0"></a>QC 3.0</h4><p>为了保证不出现过度发热的问题，QC3.0标准主要是比QC2.0标准增加了一个“最佳电压智能调节”算法，以200mV增量为一档，提供从 3.6V 到 20V 电压的灵活选择，让手机厂商能够根据自身需求调整最佳电压，达到预期电流，提供充电效率同时降低功耗和发热。QC3.0 兼容的平台包括了高通骁龙 820、620、618、 617 和 430，并且向下兼容 QC2.0 和 QC1.0 的设备。</p><h4 id="QC-4-0"><a href="#QC-4-0" class="headerlink" title="QC 4.0"></a>QC 4.0</h4><p>充电仅 15 分钟即可获得 50% 的电池电量。同时，QC4.0 还加入了对 USB Type-C 和 USB-PD 的支持。按照高通的说法来看，QC4.0 比 QC3.0 多了一项 Dual Charge 的技术。它能使充电速度提升20%，效率提升30%。除了以上这些，QC4.0 还优化了“最佳电压智能调节”的算法(INOV)，将电压继续细分，以 20mV 为一档;取消了 12V 的电压，5V 最大可输出 5.6A ，9V 最大可输出 3A。QC 4.0 兼容的平台包括了高通骁龙 835、660、630 和 635(635暂未发布) ，并且向下兼容 QC2.0 和 QC1.0 的设备.</p><p>在网上一张出自【电子发烧友】比较清晰明了的图，引用如下：<br><img src="https://andylee-1258982386.cos.ap-chengdu.myqcloud.com/android/qcom/fastcharge.png" alt="fastcharge"></p><h2 id="MTK方案"><a href="#MTK方案" class="headerlink" title="MTK方案"></a>MTK方案</h2><h3 id="MTP-Pump-Express"><a href="#MTP-Pump-Express" class="headerlink" title="MTP Pump Express"></a>MTP Pump Express</h3><ul><li>带Plus（Pump Express2.0）：可以支持到9V/12V，可以达到12V/3A,输出功率&gt;15W。</li><li>不带Plus：充电电流不超过2A，输出功率&lt;10W(目前已经被划分为慢充)。</li><li>Pump Express 3.0：开始使用低压直流的快速充电方式，如5.8V/6A的输出标准，最大输出功率可达34.8W。是全球首款采用USB Type-C接口进行充电的快充方案，可直接绕过手机充电电路，电流直接流入电池，降低充电时的发热。</li></ul><h2 id="厂家快充"><a href="#厂家快充" class="headerlink" title="厂家快充"></a>厂家快充</h2><p>现在市面上各厂家的快充基本都是基于上述高通和MTK快充技术演变而来，套了个壳，换了个名。</p>]]></content>
      
      
      <categories>
          
          <category> Android </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Qualcomm </tag>
            
            <tag> MTK </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Getting Started With RecyclerView and CardView on Android</title>
      <link href="2017/11/08/Android/Getting-Started-With-RecyclerView-and-CardView-on-Android/"/>
      <url>2017/11/08/Android/Getting-Started-With-RecyclerView-and-CardView-on-Android/</url>
      
        <content type="html"><![CDATA[<blockquote><p>偶然看到这篇文章，觉得写得很好，简单明了，所以尝试将其翻译一下。</p></blockquote><p>如果你想创作一个用列表显示数据的Android应用，Android L提供了两个让你更容易实现的新特性：RecyclerView和CardView。通过用这些控件，可以很容易让你的app符合Google的Material Design规范。</p><p>创作APP时一个模板参考的好地方：<a href="https://go.redirectingat.com/?id=1342X589339&site=code.tutsplus.com&xs=1&isjs=1&url=https://codecanyon.net/category/mobile/android?_ga=2.255032513.873197305.1503543294-826134730.1503543294&xguid=6c32060c165aa0d81cc926f785d03c1a&xuuid=40b87ed972cd06dc4bfc1a62b8c59465&xsessid=e18f51adda215e4913eb634122cf8895&xcreo=0&xed=0&sref=https://code.tutsplus.com/tutorials/getting-started-with-recyclerview-and-cardview-on-android--cms-23465&xtz=-480">Envato market</a>。你可以找到成千上万的APP模板，从<a href="https://go.redirectingat.com/?id=1342X589339&site=code.tutsplus.com&xs=1&isjs=1&url=https://codecanyon.net/item/layar-tancep-youtube-app-for-android/5190062?_ga=2.248270926.873197305.1503543294-826134730.1503543294&xguid=6c32060c165aa0d81cc926f785d03c1a&xuuid=40b87ed972cd06dc4bfc1a62b8c59465&xsessid=e18f51adda215e4913eb634122cf8895&xcreo=0&xed=0&sref=https://code.tutsplus.com/tutorials/getting-started-with-recyclerview-and-cardview-on-android--cms-23465&xtz=-480">Youtube</a>到<a href="https://go.redirectingat.com/?id=1342X589339&site=code.tutsplus.com&xs=1&isjs=1&url=https://codecanyon.net/item/flappybot-an-obstacle-avoidance-game/6827330?_ga=2.248270926.873197305.1503543294-826134730.1503543294&xguid=6c32060c165aa0d81cc926f785d03c1a&xuuid=40b87ed972cd06dc4bfc1a62b8c59465&xsessid=e18f51adda215e4913eb634122cf8895&xcreo=0&xed=0&sref=https://code.tutsplus.com/tutorials/getting-started-with-recyclerview-and-cardview-on-android--cms-23465&xtz=-480">obstacleavoidance game</a>。</p><p>或者你可以尝试一下<a href="https://codecanyon.net/item/universal-full-multipurpose-android-app/6512720?_ga=2.217207135.873197305.1503543294-826134730.1503543294">通用的Android app模板</a>,它能为你创作任何种类app提供一个坚实的基础。<br><img src="https://andylee-1258982386.cos.ap-chengdu.myqcloud.com/blog/recyclerview_cardview/Universal-Android-app.png" alt="Universal-Android-app"></p><a id="more"></a><h1 id="前提"><a href="#前提" class="headerlink" title="前提"></a>前提</h1><p>为了继续，你应该使用最新版本Android Studio。你可以从<a href="http://developer.android.com/sdk/index.html">Android 开发者官网</a>获得它。</p><h2 id="支持老版本"><a href="#支持老版本" class="headerlink" title="支持老版本"></a>支持老版本</h2><p>在写这篇文章时，只有少于2%的Android设备运行在Android L上。无论怎样，多亏v7 Support Library，你能使用RecyclerView和CardView控件运行在老版本的安卓设备上面，通过在你工程中build.grade文件添加如下依赖片段实现：</p><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">compile</span> <span class="string">&#x27;com.android.support:cardview-v7:21.0.+&#x27;</span></span><br><span class="line"><span class="keyword">compile</span> <span class="string">&#x27;com.android.support:recyclerview-v7:21.0.+&#x27;</span></span><br></pre></td></tr></table></figure><h2 id="创建CardView"><a href="#创建CardView" class="headerlink" title="创建CardView"></a>创建CardView</h2><p><em>CardView</em>是一个<em>ViewGroup</em>，像其他<em>ViewGroup</em>一样，它能通过Layout xml文件添加到你的 <em>Activity</em> 或者 <em>Fragment</em>。</p><p>为了创建一个空<em>CardView</em>，你应该添加如下代码片段到你的layout XML文件中：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">android.support.v7.widget.CardView</span></span></span><br><span class="line"><span class="tag">        <span class="attr">xmlns:card_view</span>=<span class="string">&quot;http://schemas.android.com/apk/res-auto&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">&quot;wrap_content&quot;</span>&gt;</span></span><br><span class="line"> </span><br><span class="line"><span class="tag">&lt;/<span class="name">android.support.v7.widget.CardView</span>&gt;</span></span><br></pre></td></tr></table></figure><p>最为一个更实际的例子，咱们创建一个<em>LinearLayout</em>并将<em>CardView</em>作为子控件放在里面。<em>CardView</em>可以代表一个人，包含如下信息：</p><ul><li><em>TextView</em> - 显示人名</li><li><em>TextView</em> - 显示年纪</li><li><em>ImageView</em> - 显示照片</li></ul><p>xml内容如下：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">LinearLayout</span> <span class="attr">xmlns:android</span>=<span class="string">&quot;http://schemas.android.com/apk/res/android&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_width</span>=<span class="string">&quot;match_parent&quot;</span> <span class="attr">android:layout_height</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:padding</span>=<span class="string">&quot;16dp&quot;</span></span></span><br><span class="line"><span class="tag">    &gt;</span></span><br><span class="line"> </span><br><span class="line">    <span class="tag">&lt;<span class="name">android.support.v7.widget.CardView</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">&quot;wrap_content&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">&quot;@+id/cv&quot;</span></span></span><br><span class="line"><span class="tag">        &gt;</span></span><br><span class="line"> </span><br><span class="line">        <span class="tag">&lt;<span class="name">RelativeLayout</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:layout_width</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:layout_height</span>=<span class="string">&quot;wrap_content&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:padding</span>=<span class="string">&quot;16dp&quot;</span></span></span><br><span class="line"><span class="tag">            &gt;</span></span><br><span class="line"> </span><br><span class="line">            <span class="tag">&lt;<span class="name">ImageView</span></span></span><br><span class="line"><span class="tag">                <span class="attr">android:layout_width</span>=<span class="string">&quot;wrap_content&quot;</span></span></span><br><span class="line"><span class="tag">                <span class="attr">android:layout_height</span>=<span class="string">&quot;wrap_content&quot;</span></span></span><br><span class="line"><span class="tag">                <span class="attr">android:id</span>=<span class="string">&quot;@+id/person_photo&quot;</span></span></span><br><span class="line"><span class="tag">                <span class="attr">android:layout_alignParentLeft</span>=<span class="string">&quot;true&quot;</span></span></span><br><span class="line"><span class="tag">                <span class="attr">android:layout_alignParentTop</span>=<span class="string">&quot;true&quot;</span></span></span><br><span class="line"><span class="tag">                <span class="attr">android:layout_marginRight</span>=<span class="string">&quot;16dp&quot;</span></span></span><br><span class="line"><span class="tag">                /&gt;</span></span><br><span class="line"> </span><br><span class="line">            <span class="tag">&lt;<span class="name">TextView</span></span></span><br><span class="line"><span class="tag">                <span class="attr">android:layout_width</span>=<span class="string">&quot;wrap_content&quot;</span></span></span><br><span class="line"><span class="tag">                <span class="attr">android:layout_height</span>=<span class="string">&quot;wrap_content&quot;</span></span></span><br><span class="line"><span class="tag">                <span class="attr">android:id</span>=<span class="string">&quot;@+id/person_name&quot;</span></span></span><br><span class="line"><span class="tag">                <span class="attr">android:layout_toRightOf</span>=<span class="string">&quot;@+id/person_photo&quot;</span></span></span><br><span class="line"><span class="tag">                <span class="attr">android:layout_alignParentTop</span>=<span class="string">&quot;true&quot;</span></span></span><br><span class="line"><span class="tag">                <span class="attr">android:textSize</span>=<span class="string">&quot;30sp&quot;</span></span></span><br><span class="line"><span class="tag">                /&gt;</span></span><br><span class="line"> </span><br><span class="line">            <span class="tag">&lt;<span class="name">TextView</span></span></span><br><span class="line"><span class="tag">                <span class="attr">android:layout_width</span>=<span class="string">&quot;wrap_content&quot;</span></span></span><br><span class="line"><span class="tag">                <span class="attr">android:layout_height</span>=<span class="string">&quot;wrap_content&quot;</span></span></span><br><span class="line"><span class="tag">                <span class="attr">android:id</span>=<span class="string">&quot;@+id/person_age&quot;</span></span></span><br><span class="line"><span class="tag">                <span class="attr">android:layout_toRightOf</span>=<span class="string">&quot;@+id/person_photo&quot;</span></span></span><br><span class="line"><span class="tag">                <span class="attr">android:layout_below</span>=<span class="string">&quot;@+id/person_name&quot;</span></span></span><br><span class="line"><span class="tag">                /&gt;</span></span><br><span class="line"> </span><br><span class="line">        <span class="tag">&lt;/<span class="name">RelativeLayout</span>&gt;</span></span><br><span class="line"> </span><br><span class="line">    <span class="tag">&lt;/<span class="name">android.support.v7.widget.CardView</span>&gt;</span></span><br><span class="line"> </span><br><span class="line"><span class="tag">&lt;/<span class="name">LinearLayout</span>&gt;</span></span><br></pre></td></tr></table></figure><p>如果这个xml文件被用作<em>Activity</em>的layout，并且给<em>TextView</em>和ImageView*设置有意义的值，那么在Android设备上面它看起来应该像这个样子：<br><img src="https://andylee-1258982386.cos.ap-chengdu.myqcloud.com/blog/recyclerview_cardview/device_2015.png" alt="device"></p><h2 id="创建RecyclerView"><a href="#创建RecyclerView" class="headerlink" title="创建RecyclerView"></a>创建RecyclerView</h2><h3 id="在Layout中定义它"><a href="#在Layout中定义它" class="headerlink" title="在Layout中定义它"></a>在Layout中定义它</h3><p>使用一个<em>RecyclerView</em>实例有一些复杂，但是在layout xml中定义它十分简单。可以定义如下：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">android.support.v7.widget.RecyclerView</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_width</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_height</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:id</span>=<span class="string">&quot;@+id/rv&quot;</span></span></span><br><span class="line"><span class="tag">    /&gt;</span></span><br></pre></td></tr></table></figure><p>通过如下代码片段在你的<em>Activity</em>中去获得句柄：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">RecyclerView rv = (RecyclerView)findViewById(R.id.rv);</span><br></pre></td></tr></table></figure><p>如果你确定<em>RecyclerView</em>的大小不会改变，你可以添加如下语句：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rv.setHasFixedSize(<span class="keyword">true</span>);</span><br></pre></td></tr></table></figure><h3 id="使用LayoutManager"><a href="#使用LayoutManager" class="headerlink" title="使用LayoutManager"></a>使用LayoutManager</h3><p>和<em>ListView</em>不一样，<em>RecyclerView</em>需要一个<em>LayoutManger</em>去管理其子项的位置。你可以通过继承<em>RecyclerView.LayoutManager</em>类定义自己的<em>LayoutManager</em>。不过，大多数案子里面，你直接使用如下预定义的<em>LayoutManager</em>子类就可以了：</p><ul><li>LinearLayoutManager</li><li>GridLayoutManager</li><li>StaggeredGridLayoutManager<br>在这篇教程里，我将使用<em>LinearLayoutManager</em>，它默认将让你的<em>RecyclerView</em>看起来像一个<em>ListView</em>。<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">LinearLayoutManager llm = <span class="keyword">new</span> LinearLayoutManager(context);</span><br><span class="line">rv.setLayoutManager(llm);</span><br></pre></td></tr></table></figure><h3 id="定义内容"><a href="#定义内容" class="headerlink" title="定义内容"></a>定义内容</h3>和<em>ListView</em>一样，<em>RecyclerView</em>也需要一个适配器去接入数据。但是在创建适配器前，我们先创建我们需要的数据。创建一个简单的类来代表一个人然后写一个方法来初始化一个<em>Person</em>对象集：<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span> </span>&#123;</span><br><span class="line">    String name;</span><br><span class="line">    String age;</span><br><span class="line">    <span class="keyword">int</span> photoId;</span><br><span class="line"> </span><br><span class="line">    Person(String name, String age, <span class="keyword">int</span> photoId) &#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">        <span class="keyword">this</span>.age = age;</span><br><span class="line">        <span class="keyword">this</span>.photoId = photoId;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">private</span> List&lt;Person&gt; persons;</span><br><span class="line"> </span><br><span class="line"><span class="comment">// This method creates an ArrayList that has three Person objects</span></span><br><span class="line"><span class="comment">// Checkout the project associated with this tutorial on Github if</span></span><br><span class="line"><span class="comment">// you want to use the same images.</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initializeData</span><span class="params">()</span></span>&#123;</span><br><span class="line">    persons = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    persons.add(<span class="keyword">new</span> Person(<span class="string">&quot;Emma Wilson&quot;</span>, <span class="string">&quot;23 years old&quot;</span>, R.drawable.emma));</span><br><span class="line">    persons.add(<span class="keyword">new</span> Person(<span class="string">&quot;Lavery Maiss&quot;</span>, <span class="string">&quot;25 years old&quot;</span>, R.drawable.lavery));</span><br><span class="line">    persons.add(<span class="keyword">new</span> Person(<span class="string">&quot;Lillie Watts&quot;</span>, <span class="string">&quot;35 years old&quot;</span>, R.drawable.lillie));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="创建适配器"><a href="#创建适配器" class="headerlink" title="创建适配器"></a>创建适配器</h3>要创建一个<em>RecyclerView</em>可以使用的适配器，你必须继承<em>RecyclerView.Adapter</em>。这个适配器遵循<strong>View holder</strong>设计模式，也就意味着你需要定义一个类继承与<em>RecyclerView.ViewHolder</em>。这种模式最大限度减少调用<em>findViewByIdea</em>方法。</li></ul><p>前面我们已经在 XML Layout中定义了一个<em>CardView</em>代表一个人。我们将重复利用此布局文件。在我们自定义<em>ViewHolder</em>的构造方法中，初始化此视图属于<em>RecyclerView</em>的子项。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RVAdapter</span> <span class="keyword">extends</span> <span class="title">RecyclerView</span>.<span class="title">Adapter</span>&lt;<span class="title">RVAdapter</span>.<span class="title">PersonViewHolder</span>&gt;</span>&#123;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">PersonViewHolder</span> <span class="keyword">extends</span> <span class="title">RecyclerView</span>.<span class="title">ViewHolder</span> </span>&#123;      </span><br><span class="line">        CardView cv;</span><br><span class="line">        TextView personName;</span><br><span class="line">        TextView personAge;</span><br><span class="line">        ImageView personPhoto;</span><br><span class="line"> </span><br><span class="line">        PersonViewHolder(View itemView) &#123;</span><br><span class="line">            <span class="keyword">super</span>(itemView);</span><br><span class="line">            cv = (CardView)itemView.findViewById(R.id.cv);</span><br><span class="line">            personName = (TextView)itemView.findViewById(R.id.person_name);</span><br><span class="line">            personAge = (TextView)itemView.findViewById(R.id.person_age);</span><br><span class="line">            personPhoto = (ImageView)itemView.findViewById(R.id.person_photo);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>接下来，为自定义适配器增加一个构造方法来处理<em>RecyclerView</em>显示的数据。我们的数据有<em>Person</em>对象集组成，添加如下代码：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">List&lt;Person&gt; persons;</span><br><span class="line"> </span><br><span class="line">RVAdapter(List&lt;Person&gt; persons)&#123;</span><br><span class="line">    <span class="keyword">this</span>.persons = persons;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><em>RecyclerView.Adapter</em>有三个抽象方法必须被重写。咱们从<em>getItemCount</em>方法开始。这个方法返回子项存在数据的数量。对于我们由<em>List</em>形成的数据，我们只需要调用<em>List</em>对象的*size()*方法即可：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getItemCount</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> persons.size();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>接下来，重写<em>onCreateViewHolder</em>方法。正如方法名所展示，当自定义<em>ViewHolder</em>需要被初始化时调用。我们指明<em>RecyclerView</em>每个子项使用的布局。通过使用<em>LayoutInflater</em>完成，传递着结果到自定义的<em>ViewHolder</em>的构造方法。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> PersonViewHolder <span class="title">onCreateViewHolder</span><span class="params">(ViewGroup viewGroup, <span class="keyword">int</span> i)</span> </span>&#123;</span><br><span class="line">    View v = LayoutInflater.from(viewGroup.getContext()).inflate(R.layout.item, viewGroup, <span class="keyword">false</span>);</span><br><span class="line">    PersonViewHolder pvh = <span class="keyword">new</span> PersonViewHolder(v);</span><br><span class="line">    <span class="keyword">return</span> pvh;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>重写<em>onBindViewHolder</em>方法去指明每一个<em>RecyclerView</em>子项的内容。这个反复与<em>ListView</em>的适配器的<em>getView</em>方法十分相似。在我们的例子中，你必须设置<em>CardView</em>中的名字、年纪以及照片。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onBindViewHolder</span><span class="params">(PersonViewHolder personViewHolder, <span class="keyword">int</span> i)</span> </span>&#123;</span><br><span class="line">    personViewHolder.personName.setText(persons.get(i).name);</span><br><span class="line">    personViewHolder.personAge.setText(persons.get(i).age);</span><br><span class="line">    personViewHolder.personPhoto.setImageResource(persons.get(i).photoId);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>最好，你需要重写<em>onAttachedToRecyclerView</em>方法。我们就简单实用地直接调用父类的实现。</p><blockquote><p>注：新版本已经不需要重写此方法。</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onAttachedToRecyclerView</span><span class="params">(RecyclerView recyclerView)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>.onAttachedToRecyclerView(recyclerView);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="实用适配器"><a href="#实用适配器" class="headerlink" title="实用适配器"></a>实用适配器</h3><p>现在适配器准备好了，接下来就是让<em>Activity</em>通过适配器构造函数和<em>RecyclerView</em>的<em>setAdapter</em>去初始化和使用这个适配器了。添加如下代码：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">RVAdapter adapter = <span class="keyword">new</span> RVAdapter(persons);</span><br><span class="line">rv.setAdapter(adapter);</span><br></pre></td></tr></table></figure><h3 id="编译及运行"><a href="#编译及运行" class="headerlink" title="编译及运行"></a>编译及运行</h3><p>当你在你的Android设备上运行这个例程时，你将会看类似如下图片的结果：<br><img src="https://andylee-1258982386.cos.ap-chengdu.myqcloud.com/blog/recyclerview_cardview/device-2015-02.png" alt="device"></p><h1 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h1><p>在这篇教程，你已经学会了怎么去使用在Android L中引入的<em>CardView</em>和<em>RecyclerView</em>控件。你也明白了在Material Design应用中怎么去使用这些控件。注意：通过<em>RecyclerView</em>可以做几乎所有<em>ListView</em>所做的事，不过为了更少的代码，使用<em>ListView</em>仍然是一个比较好的选择。</p><p>你可以参考Android Developers reference去获得更多关于<em>CardView</em>和<em>RecyclerView</em>类的信息。</p><p>最好，如果你想更快速地开发你的app，不要忘记在Envato Market查看Android app templates。</p><blockquote><p><a href="https://code.tutsplus.com/tutorials/getting-started-with-recyclerview-and-cardview-on-android--cms-23465">原文章地址。</a></p></blockquote>]]></content>
      
      
      <categories>
          
          <category> Android </category>
          
      </categories>
      
      
        <tags>
            
            <tag> App </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>纸币器和MDB协议</title>
      <link href="2017/11/08/Other/MDB-ICP-protocol/"/>
      <url>2017/11/08/Other/MDB-ICP-protocol/</url>
      
        <content type="html"><![CDATA[<h2 id="MDB协议"><a href="#MDB协议" class="headerlink" title="MDB协议"></a>MDB协议</h2><h3 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h3><p>MDB/ICP协议为一个主从接口的串口通信标准的协议， 规定波特率为9600bps，总线有唯一主机（vending machine controller, VMC）和最多32个从机外设，每个外设设有唯一的地址和命令，且由主机初始化。</p><p>电源上电、总线复位或外设收到一个复位命令，所对应的外设都被禁止。在顺序初始化外设期间，VMC通过外设的应答来选择被外设所支持的特征。</p><blockquote><p>协议推荐所以主控制器VMC和外设都需支持所有低等级标准</p></blockquote><a id="more"></a><h3 id="通信格式"><a href="#通信格式" class="headerlink" title="通信格式"></a>通信格式</h3><h4 id="字节格式"><a href="#字节格式" class="headerlink" title="字节格式"></a>字节格式</h4><p>一个字节定义为11位：1个起始位+8个数据位+1个模式位+1个停止位。</p><ul><li>VMC发送数据到外设：模式位 = 1 表示为地址字节， = 0 表示为数据字节</li><li>外设发送数据到VMC：模式位 = 1 表示所有字节发送完成</li></ul><h4 id="块格式"><a href="#块格式" class="headerlink" title="块格式"></a>块格式</h4><h5 id="主到从"><a href="#主到从" class="headerlink" title="主到从"></a>主到从</h5><p>主控制器VMC发送给从机的数据格式：1个地址字节+n个数据字节+1个校验和节（最大不超过36个字节）。地址字节由 高5位外设地址+低三位外设命令组成。</p><p>主控制器响应外设时发送 ：ACK（应答）、NAK（不应答）、RET（重发）。5ms超时不响应相当于NAK。如从机5ms无响应，VMC应重发相同或不同命令， 知道从机响应或达到最大响应时间（硬币器2S、纸币器5S）。在此期间VMC应该同时访问其他外设。</p><p><strong>主控器VMC可以通过拉低发送线100ms以上对总线进行复位。</strong></p><h4 id="从到主"><a href="#从到主" class="headerlink" title="从到主"></a>从到主</h4><p>从机发送到主控制器的数据格式：1数据块+1字节校验和（最大不超过36字节）。</p><p>从机外设响应主控制器发送数据时，主控制器VMC在5ms无响应时间内必须响应ACK、NAK或RET。否则外设需要重发数据或者在下一次会话时附加上数据。</p><h4 id="校验和"><a href="#校验和" class="headerlink" title="校验和"></a>校验和</h4><p>校验和为所有地址及数据字节的累加和（不包含校验和字节）。</p><h4 id="总线复位"><a href="#总线复位" class="headerlink" title="总线复位"></a>总线复位</h4><p>主控器VMC可以通过上拉激活发送线100ms以上对所有外设进行复位，复位后外设处于上电复位状态。</p><h4 id="一些标准"><a href="#一些标准" class="headerlink" title="一些标准"></a>一些标准</h4><p>响应码：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ACK - 00H   RET - AAH   NAK -  FFH</span><br></pre></td></tr></table></figure><p>外设地址：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">Address             Definition  </span><br><span class="line">-------------------------------------------------</span><br><span class="line">00000xxxB    (00H)  Reserved <span class="keyword">for</span> VMC </span><br><span class="line">00001xxxB    (08H)  Changer  </span><br><span class="line">00010xxxB    (10H)  Cashless Device <span class="comment">#1  </span></span><br><span class="line">00011xxxB    (18H)  Communications Gateway </span><br><span class="line">00100xxxB    (20H)  Display  </span><br><span class="line">00101xxxB    (28H)  Energy Management System </span><br><span class="line">00110xxxB    (30H)  Bill Validator  </span><br><span class="line">00111xxxB    (38H)  Reserved <span class="keyword">for</span> Future Standard Peripheral</span><br><span class="line">01000xxxB    (40H)  Universal Satellite Device <span class="comment">#1 </span></span><br><span class="line">01001xxxB    (48H)  Universal Satellite Device <span class="comment">#2 </span></span><br><span class="line">01010xxxB    (50H)  Universal Satellite Device <span class="comment">#3 </span></span><br><span class="line">01011xxxB    (58H)  Coin Hopper or Tube - Dispenser </span><br><span class="line">01100xxxB    (60H)  Cashless Device <span class="comment">#2</span></span><br><span class="line">01101xxxB    (68H)  Reserved <span class="keyword">for</span> Future Standard Peripherals</span><br><span class="line">...</span><br><span class="line">11011xxxB    (D8H)  Reserved <span class="keyword">for</span> Future Standard Peripherals</span><br><span class="line">11100xxxB    (E0H)  Experimental Peripheral <span class="comment">#1</span></span><br><span class="line">11101xxxB    (E8H)  Experimental Peripheral <span class="comment">#2 </span></span><br><span class="line">11110xxxB    (F0H)  Vending Machine Specific Peripheral <span class="comment">#1 </span></span><br><span class="line">11111xxxB    (F8H)  Vending Machine Specific Peripheral <span class="comment">#2</span></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Other </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Protocol </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>通过自定义侧边导航栏的RecyclerView动态加载布局</title>
      <link href="2017/08/18/Android/Dynamic-loading-layout-by-recyclerview-item/"/>
      <url>2017/08/18/Android/Dynamic-loading-layout-by-recyclerview-item/</url>
      
        <content type="html"><![CDATA[<h2 id="准备布局文件"><a href="#准备布局文件" class="headerlink" title="准备布局文件"></a>准备布局文件</h2><p>布局一：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">android.support.constraint.ConstraintLayout</span></span></span><br><span class="line"><span class="tag">        <span class="attr">xmlns:android</span>=<span class="string">&quot;http://schemas.android.com/apk/res/android&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">xmlns:tools</span>=<span class="string">&quot;http://schemas.android.com/tools&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">xmlns:app</span>=<span class="string">&quot;http://schemas.android.com/apk/res-auto&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">tools:context</span>=<span class="string">&quot;me.huaqianlee.forme.ToDoFragment&quot;</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">TextView</span> <span class="attr">android:layout_width</span>=<span class="string">&quot;match_parent&quot;</span> <span class="attr">android:layout_height</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">              <span class="attr">android:layout_marginTop</span>=<span class="string">&quot;50dp&quot;</span></span></span><br><span class="line"><span class="tag">              <span class="attr">android:textSize</span>=<span class="string">&quot;15sp&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:text</span>=<span class="string">&quot;This is Todo main view layout!&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">android.support.constraint.ConstraintLayout</span>&gt;</span></span><br></pre></td></tr></table></figure><a id="more"></a><p>布局二：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">android.support.constraint.ConstraintLayout</span></span></span><br><span class="line"><span class="tag">        <span class="attr">xmlns:android</span>=<span class="string">&quot;http://schemas.android.com/apk/res/android&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">xmlns:tools</span>=<span class="string">&quot;http://schemas.android.com/tools&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">xmlns:app</span>=<span class="string">&quot;http://schemas.android.com/apk/res-auto&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">tools:context</span>=<span class="string">&quot;me.huaqianlee.forme.ToDoFragment&quot;</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">ImageView</span> <span class="attr">android:layout_width</span>=<span class="string">&quot;match_parent&quot;</span> <span class="attr">android:layout_height</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">               <span class="attr">android:scaleType</span>=<span class="string">&quot;fitCenter&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:src</span>=<span class="string">&quot;@drawable/lee&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">android.support.constraint.ConstraintLayout</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="准备Fragment，加载布局"><a href="#准备Fragment，加载布局" class="headerlink" title="准备Fragment，加载布局"></a>准备Fragment，加载布局</h2><p>布局一：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DateEventFragment</span> <span class="keyword">extends</span> <span class="title">Fragment</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Nullable</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> View <span class="title">onCreateView</span><span class="params">(LayoutInflater inflater, <span class="meta">@Nullable</span> ViewGroup container, <span class="meta">@Nullable</span> Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> inflater.inflate(R.layout.fragment_date_event, container, <span class="keyword">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>布局二：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ToDoFragment</span> <span class="keyword">extends</span> <span class="title">Fragment</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Nullable</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> View <span class="title">onCreateView</span><span class="params">(LayoutInflater inflater, <span class="meta">@Nullable</span> ViewGroup container, <span class="meta">@Nullable</span> Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> inflater.inflate(R.layout.fragment_todo, container, <span class="keyword">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="实现切换布局方法"><a href="#实现切换布局方法" class="headerlink" title="实现切换布局方法"></a>实现切换布局方法</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 切换主界面视图工具类</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainViewSwitch</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">switchMainView</span><span class="params">(BaseActivity activity)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">switch</span> (SelectedNavItem.getSlectedNavItem()) &#123;</span><br><span class="line">            <span class="keyword">case</span> SelectedNavItem.TODO:</span><br><span class="line">                replaceFragment(<span class="keyword">new</span> ToDoFragment(),activity);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> SelectedNavItem.DATEEVENT:</span><br><span class="line">                replaceFragment(<span class="keyword">new</span> DateEventFragment(), activity);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">replaceFragment</span><span class="params">(Fragment fragment, BaseActivity activity)</span> </span>&#123;</span><br><span class="line">        FragmentManager fragmentManager = activity.getSupportFragmentManager();</span><br><span class="line">        FragmentTransaction transaction = fragmentManager.beginTransaction();</span><br><span class="line">        transaction.replace(R.id.main_view_layout, fragment);</span><br><span class="line">        transaction.commit();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="切换布局"><a href="#切换布局" class="headerlink" title="切换布局"></a>切换布局</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">adapter.setOnItemClickListener(<span class="keyword">new</span> NavFuncAdapter.OnItemClickListener() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onItemClick</span><span class="params">(View view, <span class="keyword">int</span> position)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">new</span> MainViewSwitch().switchMainView(MainActivity.<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>这篇博文只是一个简单粗糙的总结， RecyclerView点击事件的实现可以查看博客：<a href="">RecyclerView选中效果、Item点击事件的实现</a>。</p><h2 id="源码地址"><a href="#源码地址" class="headerlink" title="源码地址"></a>源码地址</h2><p><a href="https://github.com/huaqianlee/ForMe">ForMe</a></p><h2 id="效果"><a href="#效果" class="headerlink" title="效果"></a>效果</h2><p><img src="https://andylee-1258982386.cos.ap-chengdu.myqcloud.com/blog/app/dynamic_layout_effect.gif" alt="effect"></p>]]></content>
      
      
      <categories>
          
          <category> Android </category>
          
      </categories>
      
      
        <tags>
            
            <tag> App </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>按返回键只关闭DrawerLayout侧边栏不退出Activity的实现方案</title>
      <link href="2017/08/18/Android/hides-navigation-in-drawerlayou/"/>
      <url>2017/08/18/Android/hides-navigation-in-drawerlayou/</url>
      
        <content type="html"><![CDATA[<p>今天写自己的练习APP时，发现侧边导航栏可见时，我按返回键，Activity直接退出了， 可是我想要的是只是关闭侧边栏，研究了一下，其实解决办法挺简单。</p><p>只需要在Activity中重写onBackPressed()即可：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">private DrawerLayout mlayout; </span><br><span class="line"></span><br><span class="line">@Override</span><br><span class="line">public void <span class="function"><span class="title">onBackPressed</span></span>() &#123;</span><br><span class="line">    <span class="keyword">if</span> (mlayout.isDrawerOpen(findViewById(R.id.nav_left_layout)))</span><br><span class="line">        mlayout.closeDrawers();</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        super.onBackPressed();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># R.id.nav_left_layout为侧边栏显示部分顶层Layout</span></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Android </category>
          
      </categories>
      
      
        <tags>
            
            <tag> App </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>RecyclerView Item选中效果及点击事件的实现</title>
      <link href="2017/08/17/Android/the-selected-effect-of-recyclerview-item/"/>
      <url>2017/08/17/Android/the-selected-effect-of-recyclerview-item/</url>
      
        <content type="html"><![CDATA[<p>最近需要对RecyclerView的Item实现选中效果和Item点击事件，尝试了两种方式。</p><h1 id="受限的简易实现方案"><a href="#受限的简易实现方案" class="headerlink" title="受限的简易实现方案"></a>受限的简易实现方案</h1><h2 id="布局文件"><a href="#布局文件" class="headerlink" title="布局文件"></a>布局文件</h2><p>首先在Item的布局文件中加入如下代码：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">android:clickable=<span class="string">&quot;true&quot;</span></span><br><span class="line">android:focusableInTouchMode=<span class="string">&quot;true&quot;</span></span><br><span class="line">android:focusable=<span class="string">&quot;true&quot;</span></span><br><span class="line">android:background=<span class="string">&quot;@drawable/selector_item_selected&quot;</span></span><br></pre></td></tr></table></figure><p>完成selector_item_selected.xml：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;utf-8&quot;</span>?&gt;</span><br><span class="line">&lt;selector xmlns:android=<span class="string">&quot;http://schemas.android.com/apk/res/android&quot;</span>&gt;</span><br><span class="line">    &lt;item android:state_focused=<span class="string">&quot;true&quot;</span> android:drawable=<span class="string">&quot;@drawable/select&quot;</span>/&gt;</span><br><span class="line">    &lt;item android:state_focused=<span class="string">&quot;false&quot;</span> android:drawable=<span class="string">&quot;@drawable/un_select&quot;</span>/&gt;</span><br><span class="line">&lt;/selector&gt;</span><br></pre></td></tr></table></figure><a id="more"></a><p>实现select和unselect资源（也可以直接找两张图片）：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># unselect.xml</span></span><br><span class="line">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;utf-8&quot;</span>?&gt;</span><br><span class="line">&lt;shape xmlns:android=<span class="string">&quot;http://schemas.android.com/apk/res/android&quot;</span> &gt;</span><br><span class="line">    &lt;gradient</span><br><span class="line">            android:startColor=<span class="string">&quot;#FFF&quot;</span></span><br><span class="line">            android:endColor=<span class="string">&quot;#FFF&quot;</span></span><br><span class="line">            android:centerColor=<span class="string">&quot;#FFF&quot;</span></span><br><span class="line">    /&gt;</span><br><span class="line"></span><br><span class="line">&lt;/shape&gt;</span><br><span class="line"><span class="comment"># select.xml</span></span><br><span class="line">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;utf-8&quot;</span>?&gt;</span><br><span class="line">&lt;shape xmlns:android=<span class="string">&quot;http://schemas.android.com/apk/res/android&quot;</span> &gt;</span><br><span class="line">    &lt;gradient</span><br><span class="line">            android:startColor=<span class="string">&quot;@color/colorPrimary&quot;</span></span><br><span class="line">            android:endColor=<span class="string">&quot;@color/colorPrimary&quot;</span></span><br><span class="line">            android:centerColor=<span class="string">&quot;@color/colorPrimary&quot;</span></span><br><span class="line">    /&gt;</span><br><span class="line"></span><br><span class="line">&lt;/shape&gt;</span><br></pre></td></tr></table></figure><h2 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h2><p>只需要onBindViewHolder方法中添加如下代码即可：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onBindViewHolder</span><span class="params">(<span class="keyword">final</span> ViewHolder holder, <span class="keyword">int</span> position)</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    holder.itemView.setSelected(position == SelectedNavItem.getSlectedNavItem()); </span><br><span class="line">    <span class="comment">/*item点击事件的一种实现方式*/</span></span><br><span class="line">    holder.itemView.setOnClickListener(<span class="keyword">new</span> View.OnClickListener() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View v)</span> </span>&#123;</span><br><span class="line">            </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    holder.cardView.setOnClickListener(<span class="keyword">new</span> View.OnClickListener() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View v)</span> </span>&#123;</span><br><span class="line">            </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="更实用的实现方案"><a href="#更实用的实现方案" class="headerlink" title="更实用的实现方案"></a>更实用的实现方案</h1><p>上面的方案有挺多局限性， 这个方案主要通过注册按键事件来实现。</p><h2 id="布局"><a href="#布局" class="headerlink" title="布局"></a>布局</h2><p>删掉上一种方案加入属性：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">android:clickable=<span class="string">&quot;true&quot;</span></span><br><span class="line">android:focusableInTouchMode=<span class="string">&quot;true&quot;</span></span><br><span class="line">android:focusable=<span class="string">&quot;true&quot;</span></span><br><span class="line">android:background=<span class="string">&quot;@drawable/selector_item_selected&quot;</span></span><br></pre></td></tr></table></figure><h2 id="代码-1"><a href="#代码-1" class="headerlink" title="代码"></a>代码</h2><p>在adpter中定义可在其他地方使用的OnItemClickListener接口，如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> OnItemClickListener onItemClickListener = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*暴露给外部的方法*/</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setOnItemClickListener</span><span class="params">(OnItemClickListener listener)</span> </span>&#123;</span><br><span class="line">    onItemClickListener = listener;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">OnItemClickListener</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">onItemClick</span><span class="params">(View view, <span class="keyword">int</span> position)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>实现选中效果，然后为每个itemview添加并注册点击事件，并将点击事件传给外面的调用者，如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onBindViewHolder</span><span class="params">(<span class="keyword">final</span> ViewHolder holder, <span class="keyword">final</span> <span class="keyword">int</span> position)</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*设置选中状态*/</span></span><br><span class="line">    <span class="keyword">if</span> (position == SelectedNavItem.getSlectedNavItem()) &#123;</span><br><span class="line">        holder.itemView.setBackground(mContext.getResources().getDrawable(R.drawable.selected));</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        holder.itemView.setBackground(mContext.getResources().getDrawable(R.drawable.un_select));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    holder.itemView.setOnClickListener(<span class="keyword">new</span> View.OnClickListener() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View v)</span> </span>&#123;</span><br><span class="line">            onItemClickListener.onItemClick(holder.itemView, position);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Activity中的代码：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">adapter.setOnItemClickListener(<span class="keyword">new</span> NavFuncAdapter.OnItemClickListener() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onItemClick</span><span class="params">(View view, <span class="keyword">int</span> position)</span> </span>&#123;</span><br><span class="line">        SelectedNavItem.setSlectedNavItem(position);<span class="comment">//自定义的方法，告诉adpter被点击item</span></span><br><span class="line">        adapter.notifyDataSetChanged();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h1 id="源码地址"><a href="#源码地址" class="headerlink" title="源码地址"></a>源码地址</h1><p><a href="https://github.com/huaqianlee/ForMe">ForMe</a></p><h1 id="效果"><a href="#效果" class="headerlink" title="效果"></a>效果</h1><p><img src="https://andylee-1258982386.cos.ap-chengdu.myqcloud.com/blog/forme/select_item_effct.gif" alt="nav_item_selected"></p>]]></content>
      
      
      <categories>
          
          <category> Android </category>
          
      </categories>
      
      
        <tags>
            
            <tag> App </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>基于DrawerLayout打造卡片式Navigation</title>
      <link href="2017/08/17/Android/the-card-navigation-base-on-drawerlayout/"/>
      <url>2017/08/17/Android/the-card-navigation-base-on-drawerlayout/</url>
      
        <content type="html"><![CDATA[<p>前段时间开始了利用空闲时间做一个练习APP <a href="https://github.com/huaqianlee/ForMe">ForMe</a>。根据设计APP需要通过左边导航栏切换主界面功能，自己平时在使用Google的NewsTab，觉得很不错，就准备参考其界面来设计。</p><p><img src="https://andylee-1258982386.cos.ap-chengdu.myqcloud.com/blog/app/newstab_view.jpg" alt="newsTab"></p><a id="more"></a><h2 id="尝试通过NavigationView实现"><a href="#尝试通过NavigationView实现" class="headerlink" title="尝试通过NavigationView实现"></a>尝试通过NavigationView实现</h2><p>首选的是通过DrawerLayout和NavigationView来实现，首先引入依赖：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">compile <span class="string">&#x27;com.android.support:design:25.3.1&#x27;</span></span><br><span class="line">compile <span class="string">&#x27;de.hdodenhof:circleimageview:2.1.0&#x27;</span>  // 对头布局头像处理提供支持</span><br></pre></td></tr></table></figure><p>然后实现侧边栏头布局：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;utf-8&quot;</span>?&gt;</span><br><span class="line">&lt;RelativeLayout xmlns:android=<span class="string">&quot;http://schemas.android.com/apk/res/android&quot;</span></span><br><span class="line">                android:layout_width=<span class="string">&quot;match_parent&quot;</span></span><br><span class="line">                android:layout_height=<span class="string">&quot;180dp&quot;</span></span><br><span class="line">                android:padding=<span class="string">&quot;10dp&quot;</span></span><br><span class="line">                android:background=<span class="string">&quot;?attr/colorPrimary&quot;</span>&gt;</span><br><span class="line">   </span><br><span class="line">    &lt;de.hdodenhof.circleimageview.CircleImageView</span><br><span class="line">            android:id=<span class="string">&quot;@+id/nav_icon&quot;</span></span><br><span class="line">            android:layout_width=<span class="string">&quot;70dp&quot;</span></span><br><span class="line">            android:layout_height=<span class="string">&quot;70dp&quot;</span></span><br><span class="line">            android:layout_centerInParent=<span class="string">&quot;true&quot;</span></span><br><span class="line">            android:src=<span class="string">&quot;@drawable/lee&quot;</span>/&gt;</span><br><span class="line">    </span><br><span class="line">    &lt;TextView android:layout_width=<span class="string">&quot;wrap_content&quot;</span></span><br><span class="line">              android:layout_height=<span class="string">&quot;wrap_content&quot;</span></span><br><span class="line">              android:textColor=<span class="string">&quot;#fff&quot;</span></span><br><span class="line">              android:layout_above=<span class="string">&quot;@+id/mail&quot;</span></span><br><span class="line">              android:id=<span class="string">&quot;@+id/usr&quot;</span></span><br><span class="line">              android:textSize=<span class="string">&quot;15sp&quot;</span></span><br><span class="line">              android:text=<span class="string">&quot;@string/me&quot;</span>/&gt;</span><br><span class="line">    </span><br><span class="line">    &lt;TextView android:layout_width=<span class="string">&quot;wrap_content&quot;</span></span><br><span class="line">              android:layout_height=<span class="string">&quot;wrap_content&quot;</span></span><br><span class="line">              android:id=<span class="string">&quot;@+id/mail&quot;</span></span><br><span class="line">              android:text=<span class="string">&quot;huaqianlee@gmail.com&quot;</span></span><br><span class="line">              android:layout_alignParentBottom=<span class="string">&quot;true&quot;</span></span><br><span class="line">              android:textSize=<span class="string">&quot;15sp&quot;</span></span><br><span class="line">              android:textColor=<span class="string">&quot;#fff&quot;</span></span><br><span class="line">              /&gt;</span><br><span class="line">&lt;/RelativeLayout&gt;</span><br></pre></td></tr></table></figure><p>实现菜单：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;utf-8&quot;</span>?&gt;</span><br><span class="line">&lt;menu xmlns:android=<span class="string">&quot;http://schemas.android.com/apk/res/android&quot;</span>&gt;</span><br><span class="line">    &lt;group android:checkableBehavior=<span class="string">&quot;single&quot;</span>&gt; //指定这一组菜单项单选 , group可以添加横线</span><br><span class="line">        &lt;item</span><br><span class="line">                android:id=<span class="string">&quot;@+id/nav_call&quot;</span></span><br><span class="line">                android:icon=<span class="string">&quot;@drawable/nav_call&quot;</span></span><br><span class="line">                android:title=<span class="string">&quot;Call&quot;</span>/&gt;</span><br><span class="line">        &lt;item</span><br><span class="line">                android:id=<span class="string">&quot;@+id/nav_friends&quot;</span></span><br><span class="line">                android:icon=<span class="string">&quot;@drawable/nav_friends&quot;</span></span><br><span class="line">                android:title=<span class="string">&quot;Friends&quot;</span>/&gt;</span><br><span class="line">        &lt;item</span><br><span class="line">                android:id=<span class="string">&quot;@+id/nav_location&quot;</span></span><br><span class="line">                android:icon=<span class="string">&quot;@drawable/nav_location&quot;</span></span><br><span class="line">                android:title=<span class="string">&quot;Location&quot;</span>/&gt;</span><br><span class="line">        &lt;item</span><br><span class="line">                android:id=<span class="string">&quot;@+id/nav_mail&quot;</span></span><br><span class="line">                android:icon=<span class="string">&quot;@drawable/nav_mail&quot;</span></span><br><span class="line">                android:title=<span class="string">&quot;Mail&quot;</span>/&gt;</span><br><span class="line">        &lt;item</span><br><span class="line">                android:id=<span class="string">&quot;@+id/nav_task&quot;</span></span><br><span class="line">                android:icon=<span class="string">&quot;@drawable/nav_task&quot;</span></span><br><span class="line">                android:title=<span class="string">&quot;Tasks&quot;</span>/&gt;</span><br><span class="line">    &lt;/group&gt;</span><br><span class="line">&lt;/menu&gt;</span><br></pre></td></tr></table></figure><p>引入布局：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;utf-8&quot;</span>?&gt;</span><br><span class="line">&lt;android.support.v4.widget.DrawerLayout</span><br><span class="line">        xmlns:android=<span class="string">&quot;http://schemas.android.com/apk/res/android&quot;</span></span><br><span class="line">        xmlns:tools=<span class="string">&quot;http://schemas.android.com/tools&quot;</span></span><br><span class="line">        xmlns:app=<span class="string">&quot;http://schemas.android.com/apk/res-auto&quot;</span></span><br><span class="line">        android:id=<span class="string">&quot;@+id/drawer_layout&quot;</span></span><br><span class="line">        android:layout_width=<span class="string">&quot;match_parent&quot;</span></span><br><span class="line">        android:layout_height=<span class="string">&quot;match_parent&quot;</span></span><br><span class="line">        tools:context=<span class="string">&quot;me.huaqianlee.forme.MainActivity&quot;</span>&gt;</span><br><span class="line">    &lt;!--xmlns:app=<span class="string">&quot;http://schemas.android.com/apk/me.huaqianlee.forme&quot;</span>--&gt;</span><br><span class="line">    </span><br><span class="line">    &lt;android.support.design.widget.CoordinatorLayout</span><br><span class="line">            android:layout_width=<span class="string">&quot;match_parent&quot;</span></span><br><span class="line">            android:layout_height=<span class="string">&quot;match_parent&quot;</span>&gt;</span><br><span class="line">        </span><br><span class="line">        &lt;android.support.v7.widget.Toolbar</span><br><span class="line">                android:id=<span class="string">&quot;@+id/tool_bar&quot;</span></span><br><span class="line">                android:layout_width=<span class="string">&quot;match_parent&quot;</span></span><br><span class="line">                android:layout_height=<span class="string">&quot;?attr/actionBarSize&quot;</span></span><br><span class="line">                android:background=<span class="string">&quot;@color/colorPrimary&quot;</span></span><br><span class="line">                android:theme=<span class="string">&quot;@style/ThemeOverlay.AppCompat.Dark.ActionBar&quot;</span></span><br><span class="line">                app:popupTheme=<span class="string">&quot;@style/Theme.AppCompat.Light&quot;</span></span><br><span class="line">                app:layout_scrollFlags=<span class="string">&quot;enterAlways|snap|scroll&quot;</span></span><br><span class="line">        &gt;</span><br><span class="line">        &lt;/android.support.v7.widget.Toolbar&gt;</span><br><span class="line">    &lt;/android.support.design.widget.CoordinatorLayout&gt;        </span><br><span class="line">    &lt;android.support.design.widget.NavigationView</span><br><span class="line">        android:id=<span class="string">&quot;@+id/nav_view&quot;</span></span><br><span class="line">        android:layout_width=<span class="string">&quot;wrap_content&quot;</span></span><br><span class="line">        android:layout_height=<span class="string">&quot;wrap_content&quot;</span></span><br><span class="line">        app:headerLayout=<span class="string">&quot;@layout/nav_header&quot;</span></span><br><span class="line">        app:menu=<span class="string">&quot;@menu/nav_menu&quot;</span></span><br><span class="line">    /&gt;</span><br></pre></td></tr></table></figure><p>使能侧边栏提示图标：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">DrawerLayout mlayout = (DrawerLayout) findViewById(R.id.drawer_layout);</span><br><span class="line">ActionBar actionBar = getSupportActionBar();//获得ToolBar</span><br><span class="line"><span class="keyword">if</span> (actionBar != null) &#123;</span><br><span class="line">    actionBar.setDisplayHomeAsUpEnabled(<span class="literal">true</span>);</span><br><span class="line">    actionBar.setHomeAsUpIndicator(R.drawable.ic_menu); //设置图标，默认是一个箭头</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>好了，这样子效果就出来了：</p><p><img src="https://andylee-1258982386.cos.ap-chengdu.myqcloud.com/blog/app/navigation_view.jpg" alt="nav_view"></p><p>可是这样子只能做到菜单式的侧边栏，不能实现我的需求。我尝试着找到一种方式来实现卡片式显示，但是最终没能找到。</p><h2 id="自定义卡片式侧边栏"><a href="#自定义卡片式侧边栏" class="headerlink" title="自定义卡片式侧边栏"></a>自定义卡片式侧边栏</h2><p>既然用google提供库文件不能实现，就只好选择自定义来实现了.</p><p>在DrawerLayout中自己定义布局，将侧边栏头布局引入，然后通过RecyclerView来实现卡片式显示.<br>在开始前，首先得引入相应的依赖，如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">compile <span class="string">&#x27;com.android.support:recyclerview-v7:25.3.1&#x27;</span></span><br><span class="line">compile <span class="string">&#x27;com.android.support:cardview-v7:25.3.1&#x27;</span></span><br></pre></td></tr></table></figure><p>实现侧边栏的布局：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;utf-8&quot;</span>?&gt;</span><br><span class="line">&lt;android.support.v4.widget.DrawerLayout</span><br><span class="line">        xmlns:android=<span class="string">&quot;http://schemas.android.com/apk/res/android&quot;</span></span><br><span class="line">        xmlns:tools=<span class="string">&quot;http://schemas.android.com/tools&quot;</span></span><br><span class="line">        xmlns:app=<span class="string">&quot;http://schemas.android.com/apk/res-auto&quot;</span></span><br><span class="line">        android:id=<span class="string">&quot;@+id/drawer_layout&quot;</span></span><br><span class="line">        android:layout_width=<span class="string">&quot;match_parent&quot;</span></span><br><span class="line">        android:layout_height=<span class="string">&quot;match_parent&quot;</span></span><br><span class="line">        tools:context=<span class="string">&quot;me.huaqianlee.forme.MainActivity&quot;</span>&gt;</span><br><span class="line">    &lt;!--xmlns:app=<span class="string">&quot;http://schemas.android.com/apk/me.huaqianlee.forme&quot;</span>--&gt;</span><br><span class="line">    </span><br><span class="line">    &lt;android.support.design.widget.CoordinatorLayout</span><br><span class="line">            android:layout_width=<span class="string">&quot;match_parent&quot;</span></span><br><span class="line">            android:layout_height=<span class="string">&quot;match_parent&quot;</span>&gt;</span><br><span class="line">        </span><br><span class="line">        &lt;android.support.v7.widget.Toolbar</span><br><span class="line">                android:id=<span class="string">&quot;@+id/tool_bar&quot;</span></span><br><span class="line">                android:layout_width=<span class="string">&quot;match_parent&quot;</span></span><br><span class="line">                android:layout_height=<span class="string">&quot;?attr/actionBarSize&quot;</span></span><br><span class="line">                android:background=<span class="string">&quot;@color/colorPrimary&quot;</span></span><br><span class="line">                android:theme=<span class="string">&quot;@style/ThemeOverlay.AppCompat.Dark.ActionBar&quot;</span></span><br><span class="line">                app:popupTheme=<span class="string">&quot;@style/Theme.AppCompat.Light&quot;</span></span><br><span class="line">                app:layout_scrollFlags=<span class="string">&quot;enterAlways|snap|scroll&quot;</span></span><br><span class="line">        &gt;</span><br><span class="line">        &lt;/android.support.v7.widget.Toolbar&gt;</span><br><span class="line">        </span><br><span class="line">        &lt;FrameLayout</span><br><span class="line">                android:layout_width=<span class="string">&quot;match_parent&quot;</span></span><br><span class="line">                android:layout_height=<span class="string">&quot;match_parent&quot;</span></span><br><span class="line">        &gt;</span><br><span class="line">            </span><br><span class="line">            &lt;ImageView</span><br><span class="line">                    android:layout_width=<span class="string">&quot;match_parent&quot;</span></span><br><span class="line">                    android:layout_height=<span class="string">&quot;match_parent&quot;</span></span><br><span class="line">                    android:src=<span class="string">&quot;@drawable/lee&quot;</span>/&gt;</span><br><span class="line">            </span><br><span class="line">        &lt;/FrameLayout&gt;</span><br><span class="line">    </span><br><span class="line">    &lt;/android.support.design.widget.CoordinatorLayout&gt;</span><br><span class="line">    </span><br><span class="line">    &lt;RelativeLayout android:layout_width=<span class="string">&quot;match_parent&quot;</span></span><br><span class="line">                    android:layout_height=<span class="string">&quot;match_parent&quot;</span></span><br><span class="line">                    android:layout_gravity=<span class="string">&quot;start&quot;</span>&gt;</span><br><span class="line"></span><br><span class="line">        &lt;RelativeLayout xmlns:android=<span class="string">&quot;http://schemas.android.com/apk/res/android&quot;</span></span><br><span class="line">                        android:layout_width=<span class="string">&quot;match_parent&quot;</span></span><br><span class="line">                        android:layout_height=<span class="string">&quot;180dp&quot;</span></span><br><span class="line">                        android:id=<span class="string">&quot;@+id/nav_layout&quot;</span></span><br><span class="line">                        android:padding=<span class="string">&quot;10dp&quot;</span></span><br><span class="line">                        android:background=<span class="string">&quot;?attr/colorPrimary&quot;</span>&gt;</span><br><span class="line">            </span><br><span class="line">            &lt;de.hdodenhof.circleimageview.CircleImageView</span><br><span class="line">                    android:id=<span class="string">&quot;@+id/nav_icon&quot;</span></span><br><span class="line">                    android:layout_width=<span class="string">&quot;70dp&quot;</span></span><br><span class="line">                    android:layout_height=<span class="string">&quot;70dp&quot;</span></span><br><span class="line">                    android:layout_centerInParent=<span class="string">&quot;true&quot;</span></span><br><span class="line">                    android:src=<span class="string">&quot;@drawable/lee&quot;</span>/&gt;</span><br><span class="line">            </span><br><span class="line">            &lt;TextView android:layout_width=<span class="string">&quot;wrap_content&quot;</span></span><br><span class="line">                      android:layout_height=<span class="string">&quot;wrap_content&quot;</span></span><br><span class="line">                      android:textColor=<span class="string">&quot;#fff&quot;</span></span><br><span class="line">                      android:layout_above=<span class="string">&quot;@+id/mail&quot;</span></span><br><span class="line">                      android:id=<span class="string">&quot;@+id/usr&quot;</span></span><br><span class="line">                      android:textSize=<span class="string">&quot;15sp&quot;</span></span><br><span class="line">                      android:text=<span class="string">&quot;@string/me&quot;</span>/&gt;</span><br><span class="line">            </span><br><span class="line">            &lt;TextView android:layout_width=<span class="string">&quot;wrap_content&quot;</span></span><br><span class="line">                      android:layout_height=<span class="string">&quot;wrap_content&quot;</span></span><br><span class="line">                      android:id=<span class="string">&quot;@+id/mail&quot;</span></span><br><span class="line">                      android:text=<span class="string">&quot;huaqianlee@gmail.com&quot;</span></span><br><span class="line">                      android:layout_alignParentBottom=<span class="string">&quot;true&quot;</span></span><br><span class="line">                      android:textSize=<span class="string">&quot;15sp&quot;</span></span><br><span class="line">                      android:textColor=<span class="string">&quot;#fff&quot;</span></span><br><span class="line">            /&gt;</span><br><span class="line">        </span><br><span class="line">        </span><br><span class="line">        &lt;/RelativeLayout&gt;</span><br><span class="line">        </span><br><span class="line">        &lt;FrameLayout</span><br><span class="line">                android:layout_width=<span class="string">&quot;match_parent&quot;</span></span><br><span class="line">                android:layout_height=<span class="string">&quot;match_parent&quot;</span></span><br><span class="line">                android:background=<span class="string">&quot;#fff&quot;</span></span><br><span class="line">                android:layout_below=<span class="string">&quot;@+id/nav_layout&quot;</span>&gt;</span><br><span class="line">            </span><br><span class="line">            &lt;android.support.v7.widget.RecyclerView</span><br><span class="line">                    android:id=<span class="string">&quot;@+id/nav_recycler_view&quot;</span></span><br><span class="line">                    android:layout_width=<span class="string">&quot;match_parent&quot;</span></span><br><span class="line">                    android:layout_height=<span class="string">&quot;match_parent&quot;</span>&gt;</span><br><span class="line">            </span><br><span class="line">            &lt;/android.support.v7.widget.RecyclerView&gt;</span><br><span class="line">        &lt;/FrameLayout&gt;</span><br><span class="line">    </span><br><span class="line">    &lt;/RelativeLayout&gt;</span><br><span class="line">&lt;/android.support.v4.widget.DrawerLayout&gt;</span><br></pre></td></tr></table></figure><p>在写相关代码之前，先写好卡片的布局文件：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;utf-8&quot;</span>?&gt;</span><br><span class="line">&lt;android.support.v7.widget.CardView</span><br><span class="line">        xmlns:android=<span class="string">&quot;http://schemas.android.com/apk/res/android&quot;</span></span><br><span class="line">        xmlns:app=<span class="string">&quot;http://schemas.android.com/apk/res-auto&quot;</span></span><br><span class="line">        android:layout_width=<span class="string">&quot;match_parent&quot;</span></span><br><span class="line">        android:layout_height=<span class="string">&quot;wrap_content&quot;</span></span><br><span class="line">        android:layout_margin=<span class="string">&quot;2dp&quot;</span></span><br><span class="line">        app:cardCornerRadius=<span class="string">&quot;4dp&quot;</span>&gt;</span><br><span class="line">    </span><br><span class="line">    &lt;LinearLayout</span><br><span class="line">            android:id=<span class="string">&quot;@+id/nav_func_layout&quot;</span></span><br><span class="line">            android:layout_width=<span class="string">&quot;match_parent&quot;</span></span><br><span class="line">            android:layout_height=<span class="string">&quot;wrap_content&quot;</span></span><br><span class="line">            android:background=<span class="string">&quot;#fff&quot;</span></span><br><span class="line">            android:orientation=<span class="string">&quot;vertical&quot;</span>&gt;</span><br><span class="line">        </span><br><span class="line">        &lt;ImageView</span><br><span class="line">                android:id=<span class="string">&quot;@+id/nav_func_image&quot;</span> android:layout_margin=<span class="string">&quot;10dp&quot;</span> android:layout_width=<span class="string">&quot;match_parent&quot;</span> android:layout_height=<span class="string">&quot;100dp&quot;</span></span><br><span class="line">                android:background=<span class="string">&quot;@color/colorPrimary&quot;</span></span><br><span class="line">                android:scaleType=<span class="string">&quot;centerCrop&quot;</span>/&gt;</span><br><span class="line">        &lt;TextView</span><br><span class="line">                android:id=<span class="string">&quot;@+id/nav_func_name&quot;</span></span><br><span class="line">                android:layout_margin=<span class="string">&quot;5dp&quot;</span></span><br><span class="line">                android:textSize=<span class="string">&quot;16sp&quot;</span></span><br><span class="line">                android:layout_gravity=<span class="string">&quot;center&quot;</span></span><br><span class="line">                android:layout_width=<span class="string">&quot;wrap_content&quot;</span></span><br><span class="line">                android:layout_height=<span class="string">&quot;wrap_content&quot;</span>/&gt;</span><br><span class="line">    </span><br><span class="line">    &lt;/LinearLayout&gt;</span><br><span class="line">&lt;/android.support.v7.widget.CardView&gt;</span><br></pre></td></tr></table></figure><p>接下来就该卡片显示（RecylerView）的代码了。<br>首先实现卡片bean：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">package me.huaqianlee.forme.bean;</span><br><span class="line"></span><br><span class="line">public class Func &#123;</span><br><span class="line">    private String name;</span><br><span class="line">    private int imageId;</span><br><span class="line"></span><br><span class="line">    public <span class="function"><span class="title">Func</span></span>()&#123;&#125;</span><br><span class="line">    public Func (String name, int imageId) &#123;</span><br><span class="line">        this.name = name;</span><br><span class="line">        this.imageId = imageId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public String <span class="function"><span class="title">getName</span></span>() &#123;</span><br><span class="line">        <span class="built_in">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setName(String name) &#123;</span><br><span class="line">        this.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public int <span class="function"><span class="title">getImageId</span></span>() &#123;</span><br><span class="line">        <span class="built_in">return</span> imageId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setImageId(int imageId) &#123;</span><br><span class="line">        this.imageId = imageId;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>实现Adapter：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">public class NavFuncAdapter extends RecyclerView.Adapter&lt;NavFuncAdapter.ViewHolder&gt; &#123;</span><br><span class="line">    private Context mContext;</span><br><span class="line">    private List&lt;Func&gt; mLists;</span><br><span class="line"></span><br><span class="line">    public NavFuncAdapter(List&lt;Func&gt; lists) &#123;</span><br><span class="line">        mLists = lists;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public ViewHolder onCreateViewHolder(ViewGroup parent, int viewType) &#123;</span><br><span class="line">        <span class="keyword">if</span> (mContext == null) &#123;</span><br><span class="line">            mContext = parent.getContext();</span><br><span class="line">        &#125;</span><br><span class="line">        View view = LayoutInflater.from(mContext).inflate(R.layout.func_item, parent, <span class="literal">false</span>);</span><br><span class="line">        <span class="built_in">return</span> new ViewHolder(view);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void onBindViewHolder(ViewHolder holder, int position) &#123;</span><br><span class="line">        Func func = mLists.get(position);</span><br><span class="line">        holder.funcName.setText(func.getName());</span><br><span class="line">        Glide.with(mContext).load(func.getImageId()).into(holder.funcImage);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public int <span class="function"><span class="title">getItemCount</span></span>() &#123;</span><br><span class="line">          <span class="built_in">return</span> mLists.size();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public class ViewHolder extends RecyclerView.ViewHolder &#123;</span><br><span class="line">        CardView cardView;</span><br><span class="line">        ImageView funcImage;</span><br><span class="line">        TextView funcName;</span><br><span class="line"></span><br><span class="line">        public ViewHolder(View itemView) &#123;</span><br><span class="line">            super(itemView);</span><br><span class="line">            cardView = (CardView) itemView;</span><br><span class="line">            funcImage = (ImageView) itemView.findViewById(R.id.nav_func_image);</span><br><span class="line">            funcName = (TextView) itemView.findViewById(R.id.nav_func_name);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>添加卡片显示代码：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 初始化卡片</span></span><br><span class="line">private Func [] funcs = &#123;new Func (<span class="string">&quot;Call&quot;</span>,R.drawable.nav_call),new Func(<span class="string">&quot;Friends&quot;</span>,R.drawable.nav_friends),new Func(<span class="string">&quot;Location&quot;</span>,R.drawable.nav_location),</span><br><span class="line">new Func(<span class="string">&quot;Mail&quot;</span>, R.drawable.nav_mail), new Func(<span class="string">&quot;Tasks&quot;</span>,R.drawable.nav_task)&#125;;</span><br><span class="line">private void <span class="function"><span class="title">initFunc</span></span>() &#123;</span><br><span class="line">    funcList.clear();</span><br><span class="line">    Func toDoFunc = new Func();</span><br><span class="line">    toDoFunc.setImageId(R.drawable.todo_icon);</span><br><span class="line">    toDoFunc.setName(<span class="string">&quot;ToDO&quot;</span>);</span><br><span class="line">    funcList.add(toDoFunc);</span><br><span class="line"></span><br><span class="line">    Func toDoFunc2 = new Func(<span class="string">&quot;Lee&quot;</span>, R.drawable.lee);</span><br><span class="line">    funcList.add(toDoFunc2);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (int i = 0; i&lt;funcs.length;i++) &#123;</span><br><span class="line">        funcList.add(funcs[i]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># RecyclerView显示</span></span><br><span class="line">initFunc();</span><br><span class="line">RecyclerView recyclerView = (RecyclerView) findViewById(R.id.nav_recycler_view);</span><br><span class="line">GridLayoutManager layoutManager = new GridLayoutManager(this,2);</span><br><span class="line">recyclerView.setLayoutManager(layoutManager);</span><br><span class="line">NavFuncAdapter adapter = new NavFuncAdapter(funcList);</span><br><span class="line">recyclerView.setAdapter(adapter);</span><br></pre></td></tr></table></figure><p>这样子就实现了卡片式侧边栏了，效果如下：<br><img src="https://andylee-1258982386.cos.ap-chengdu.myqcloud.com/nav_card_p.jpg" alt="nav_custom"></p><p>Item选中效果的实现方式见：<a href="http://huaqianlee.github.io/2017/08/17/Android/the-selected-effect-of-recyclerview-item/">RecyclerView选中效果的实现</a> .</p><p>今天先这样子粗糙地写这篇博客，后续完善了有时间再更新一下。</p>]]></content>
      
      
      <categories>
          
          <category> Android </category>
          
      </categories>
      
      
        <tags>
            
            <tag> App </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>no no no, go go go</title>
      <link href="2017/07/20/Life/no-no-no-go-go-go/"/>
      <url>2017/07/20/Life/no-no-no-go-go-go/</url>
      
        <content type="html"><![CDATA[<p><img src="https://andylee-1258982386.cos.ap-chengdu.myqcloud.com/life/bing.jpg" alt="bing"></p><p>最近工作一忙起来，自己又懈怠了， 回家啥都不想做，大多数时候都是锻炼一下，然后撸两把王者，就睡觉了。 好忧伤，人越来越没有以前的激情了， 有时候都在想接受现状，拿着不算太差的工资，好好上班，不用花时间去折腾学习了。这种想法好可怕！</p><p>调整调整！</p>]]></content>
      
      
      <categories>
          
          <category> Life </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 成长 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>MTK Modem 问题集</title>
      <link href="2017/07/12/Android/MTK-Modem-%E9%97%AE%E9%A2%98%E9%9B%86/"/>
      <url>2017/07/12/Android/MTK-Modem-%E9%97%AE%E9%A2%98%E9%9B%86/</url>
      
        <content type="html"><![CDATA[<p>最近开始做MTK相关的工作，在第一步编译Modem时就遇到了挺多问题。特在此文整理和Modem相关的问题。</p><h1 id="编译相关问题"><a href="#编译相关问题" class="headerlink" title="编译相关问题"></a>编译相关问题</h1><a id="more"></a><h2 id="编译权限问题"><a href="#编译权限问题" class="headerlink" title="编译权限问题"></a>编译权限问题</h2><p>编译时提示如下权限问题：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">*******************************************</span><br><span class="line">* [OS]                : Linux</span><br><span class="line">* [PERL]              : v5.10.1 or v5.14.2</span><br><span class="line">* [MAKE]              : GNU Make v3.81</span><br><span class="line">* [SHELL]             : GNU bash v4.1.5</span><br><span class="line">* [GCC-ARM-NONE-EABI] : v4.6.2 or above</span><br><span class="line">* [NATIVE GCC(UBUNTU)]: v4.5 or above</span><br><span class="line"></span><br><span class="line">*******************************************</span><br><span class="line"> Start checking current Build Environment  </span><br><span class="line">*******************************************</span><br><span class="line">* [PERL]              : v5.14.2            [OK] !!!</span><br><span class="line">* [MAKE]              : GNU Make v3.81     [OK] !!!</span><br><span class="line">* [SHELL]             : GNU bash v4.2.25    [HIGHER THAN RECOMMENDED] !!!</span><br><span class="line">sh: 1: tools/GCC/4.6.2/linux/bin/arm-none-eabi-gcc: Permission denied</span><br><span class="line">* [GCC-ARM-NONE-EABI] : [UNKNOWN VERSION] !!!</span><br><span class="line">* [NATIVE GCC(UBUNTU)]: gcc (Ubuntu/Linaro 4.6.3-1ubuntu5) 4.6.3  [OK] !!!</span><br><span class="line"></span><br><span class="line">current Build Env. is not recommendation </span><br><span class="line">To avoid unexpected errors , please install the recommended Tool Chain.</span><br><span class="line">*******************************************</span><br><span class="line">  Build Environment is NOT RECOMMENDED!</span><br><span class="line">*******************************************</span><br><span class="line"></span><br><span class="line">makefile check is <span class="keyword">done</span></span><br><span class="line">/bin/bash: tools/init/strcmpex_linux.exe: Permission denied</span><br><span class="line">make: *** [getoptions] Error 126</span><br></pre></td></tr></table></figure><p>这种问题很好解决， 通过chmod对其提供执行权限即可。</p><h2 id="不能定位数据库问题"><a href="#不能定位数据库问题" class="headerlink" title="不能定位数据库问题"></a>不能定位数据库问题</h2><p>提示不能定位原始codegen 数据库，错误log如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[ERROR] Cannot determine the original codegen database: BPLGUInfoCustomApp_MT6735_S00_MOLY_LR9_W1444_MD_LWTG_MP_V94 BPLGUInfoCustomApp_MT6735_S00_MOLY_LR9_W1444_MD_LWTG_MP_V94_P1 BPLGUInfoCustomApp_MT6735_S00_MOLY_LR9_W1444_MD_LWTG_MP_V94_P10 BPLGUInfoCustomApp_MT6735_S00_MOLY_LR9_W1444_MD_LWTG_MP_V94_P11 BPLGUInfoCustomApp_MT6735_S00_MOLY_LR9_W1444_MD_LWTG_MP_V94_P12 BPLGUInfoCustomApp_MT6735_S00_MOLY_LR9_W1444_MD_LWTG_MP_V94_P13 BPLGUInfoCustomApp_MT6735_S00_MOLY_LR9_W1444_MD_LWTG_MP_V94_P14 BPLGUInfoCustomApp_MT6735_S00_MOLY_LR9_W1444_MD_LWTG_MP_V94_P15 BPLGUInfoCustomApp_MT6735_S00_MOLY_LR9_W1444_MD_LWTG_MP_V94_P16 BPLGUInfoCustomApp_MT6735_S00_MOLY_LR9_W1444_MD_LWTG_MP_V94_P17 BPLGUInfoCustomApp_MT6735_S00_MOLY_LR9_W1444_MD_LWTG_MP_V94_P18 BPLGUInfoCustomApp_MT6735_S00_MOLY_LR9_W1444_MD_LWTG_MP_V94_P19 BPLGUInfoCustomApp_MT6735_S00_MOLY_LR9_W1444_MD_LWTG_MP_V94_P2 BPLGUInfoCustomApp_MT6735_S00_MOLY_LR9_W1444_MD_LWTG_MP_V94_P20 BPLGUInfoCustomApp_MT6735_S00_MOLY_LR9_W1444_MD_LWTG_MP_V94_P21 BPLGUInfoCustomApp_MT6735_S00_MOLY_LR9_W1444_MD_LWTG_MP_V94_P3 BPLGUInfoCustomApp_MT6735_S00_MOLY_LR9_W1444_MD_LWTG_MP_V94_P4 BPLGUInfoCustomApp_MT6735_S00_MOLY_LR9_W1444_MD_LWTG_MP_V94_P5 BPLGUInfoCustomApp_MT6735_S00_MOLY_LR9_W1444_MD_LWTG_MP_V94_P6 BPLGUInfoCustomApp_MT6735_S00_MOLY_LR9_W1444_MD_LWTG_MP_V94_P7 BPLGUInfoCustomApp_MT6735_S00_MOLY_LR9_W1444_MD_LWTG_MP_V94_P8 BPLGUInfoCustomApp_MT6735_S00_MOLY_LR9_W1444_MD_LWTG_MP_V94_P9</span><br><span class="line">make[1]: *** [build/ZECHIN6737T_65_M0/LWG_DSDS_COTSX/bin/dep/codegen_dep/cgen_cfg_Modem.det] Error 2</span><br><span class="line">make: *** [cgen] Error 2</span><br></pre></td></tr></table></figure><p>此问题是因为[mt6735m_all_modem\mtk_rel\ZECHIN6737T_65_M0\LTG_DSDS\dhl\database]路径下面太多的数据库文件，只需要将多余的删除掉即可。</p><h2 id="编译工具链问题"><a href="#编译工具链问题" class="headerlink" title="编译工具链问题"></a>编译工具链问题</h2><p>提示某些工具不能找到，log如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">tools/GCC/4.6.2/linux/bin/arm-none-eabi-ld: cannot find -lnosys</span><br><span class="line">tools/GCC/4.6.2/linux/bin/arm-none-eabi-ld: cannot find -lm</span><br><span class="line">tools/GCC/4.6.2/linux/bin/arm-none-eabi-ld: cannot find -lc</span><br><span class="line">tools/GCC/4.6.2/linux/bin/arm-none-eabi-ld: cannot find -lgcc</span><br></pre></td></tr></table></figure><p>此问题是因为代码里面的gcc工具链有问题，需要重新安装正确的工具链，由于十分不好找，所以我上传了百度云：<a href="http://pan.baidu.com/s/1pLblCkN">GCC地址</a>。</p>]]></content>
      
      
      <categories>
          
          <category> Android </category>
          
      </categories>
      
      
        <tags>
            
            <tag> MTK </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>实现真正意义上的第一个APP之启程</title>
      <link href="2017/07/11/Android/%E5%AE%9E%E7%8E%B0%E7%9C%9F%E6%AD%A3%E6%84%8F%E4%B9%89%E4%B8%8A%E7%9A%84%E7%AC%AC%E4%B8%80%E4%B8%AAAPP%E4%B9%8B%E5%90%AF%E7%A8%8B/"/>
      <url>2017/07/11/Android/%E5%AE%9E%E7%8E%B0%E7%9C%9F%E6%AD%A3%E6%84%8F%E4%B9%89%E4%B8%8A%E7%9A%84%E7%AC%AC%E4%B8%80%E4%B8%AAAPP%E4%B9%8B%E5%90%AF%E7%A8%8B/</url>
      
        <content type="html"><![CDATA[<p>自学了这么久的Android，各种例程和Demo敲了不少，但是还未自己从头设计实现过一个完整的APP，今天准备根据自己的需求定制一款APP：ForMe（暂定此名）。第一次完全自己设计实现，可能会有很多问题，自己边学边优化。</p><a id="more"></a><h2 id="功能"><a href="#功能" class="headerlink" title="功能"></a>功能</h2><p>根据自己平时的生活，目前暂时拟定如下功能：<br>0. 可自由选择默认显示界面</p><ol><li>TODOLIST - 足够使用的精简模块</li><li>读取通讯录生日信息，查看提醒</li><li>英语学习，录入和复习</li><li>引入讯飞语音识别，思考所有功能与其结合</li><li>公交查询，自动播报还有几个站多少时间</li><li>支持MarkDown录入随笔博客，并可以导出</li><li>支持NFC读取卡片信息</li></ol><p>目前想到需要这些功能，一步步实现。</p><h2 id="UI设计"><a href="#UI设计" class="headerlink" title="UI设计"></a>UI设计</h2><p>虽然没有多少审美细胞，但是也想自己来设计UI。本想先设计出UI效果，但这方面接触太少，短时间内难以做出来，所以就先放一放，后期再来完整设计。</p><h2 id="TODOLIST"><a href="#TODOLIST" class="headerlink" title="TODOLIST"></a>TODOLIST</h2><p>一直需要一个TODOLIST来提醒自己，所以先实现此部分，做一个精简版的模块，使用Material Design语言来设计。碰巧在Github上面有看到一个类似项目<a href="https://github.com/avjinder/Minimal-Todo">Minimal-Todo</a>，UI风格我挺喜欢的，这部分的UI就准备直接借用此项目的图片了。</p><p>好的就这样了， 开始一步一步地做。</p><blockquote><p>在公司完成这个计划，现在公司空调有问题，热死了，感觉都要虚脱了的感觉。</p></blockquote>]]></content>
      
      
      <categories>
          
          <category> Android </category>
          
      </categories>
      
      
        <tags>
            
            <tag> App </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Android Kotlin之曲折HelloWord</title>
      <link href="2017/05/23/Kotlin/Kotlin-HElloWorld/"/>
      <url>2017/05/23/Kotlin/Kotlin-HElloWorld/</url>
      
        <content type="html"><![CDATA[<p>最近工作业余时间一直在自学Android，Google I/O 2017 惊闻Kotlin成为Google支持的官方语言，当然得紧跟“中央”的脚步，开始程序